<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ìœ íŠœë¸Œ ì‡¼ì¸  ì €ì‘ê¶Œ ì‚¬ì „ ê²€ì‚¬</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
<div class="container">
    <header class="header">
        <h1>ìœ íŠœë¸Œ ì‡¼ì¸  ì €ì‘ê¶Œ ì‚¬ì „ ê²€ì‚¬</h1>
        <nav class="nav-links">
            <a href="/ytdl" class="nav-link {% if nav_active == 'ytdl' %}active{% endif %}">â¬‡ï¸ ë‹¤ìš´ë¡œë“œ ë„êµ¬</a>
            <a href="/text-removal" class="nav-link {% if nav_active == 'text_removal' %}active{% endif %}">ğŸ§½ ì˜ìƒì—ì„œ ê¸€ì ì§€ìš°ê¸°</a>
            <a href="/video-analyzer" class="nav-link {% if nav_active == 'video_analyzer' %}active{% endif %}">ğŸ“¹ ì˜ìƒ ë¶„ì„ê¸°</a>
            <a href="/analysis" class="nav-link">ğŸ“Š ì˜ìƒë©”ì´ì»¤</a>
            <a href="/" class="nav-link">ğŸ  AI ì‡¼ì¸  ë©”ì´ì»¤</a>
            <a href="/similarity" class="nav-link {% if nav_active == 'similarity' %}active{% endif %}">ğŸï¸ ì˜ìƒ ìœ ì‚¬ë„ ê²€ì‚¬</a>
            <a href="/copyright" class="nav-link {% if nav_active == 'copyright' %}active{% endif %}">ğŸ›¡ï¸ ì €ì‘ê¶Œ ê²€ì‚¬</a>
        </nav>
    </header>

    <section class="panel">
        <h2>ê²€ì‚¬ ì„¤ì •</h2>
        <form method="post" action="/copyright" enctype="multipart/form-data" class="copyright-form">
            <div class="field">
                <label for="video_file">ì‡¼ì¸  ì˜ìƒ ì—…ë¡œë“œ</label>
                <input type="file" id="video_file" name="video_file" accept="video/*" required>
            </div>
            <div class="field">
                <label for="reference_dir">ë¹„êµ ê¸°ì¤€ í´ë” (ì„ íƒ)</label>
                <input type="text" id="reference_dir" name="reference_dir" value="{{ form_values.reference_dir }}" placeholder="/path/to/reference_videos">
                <span class="hint-text">í´ë” ë‚´ì˜ mp4/mov/mkv/webm íŒŒì¼ê³¼ ìœ ì‚¬ë„ë¥¼ ë¹„êµí•©ë‹ˆë‹¤.</span>
            </div>
            <div class="field inline">
                <label for="fps">ìƒ˜í”Œ FPS</label>
                <input type="number" step="0.1" min="0.1" id="fps" name="fps" value="{{ form_values.fps }}">
                <label for="hash">í•´ì‹œ ë°©ì‹</label>
                <select id="hash" name="hash">
                    {% for option in ['phash','ahash','dhash'] %}
                    <option value="{{ option }}" {% if form_values.hash == option %}selected{% endif %}>{{ option|upper }}</option>
                    {% endfor %}
                </select>
                <label for="resize">ë¦¬ì‚¬ì´ì¦ˆ</label>
                <input type="text" id="resize" name="resize" value="{{ form_values.resize }}" placeholder="256x256">
                <label for="max_frames">ìµœëŒ€ í”„ë ˆì„</label>
                <input type="number" min="1" id="max_frames" name="max_frames" value="{{ form_values.max_frames }}" placeholder="ë¬´ì œí•œ">
            </div>
            <div class="field inline">
                <label for="hamming_th">í•´ë° ì„ê³„ê°’</label>
                <input type="number" min="0" id="hamming_th" name="hamming_th" value="{{ form_values.hamming_th }}">
                <label for="high_th">HIGH ê¸°ì¤€</label>
                <input type="number" step="0.01" min="0" id="high_th" name="high_th" value="{{ form_values.high_th }}">
                <label for="med_th">MED ê¸°ì¤€</label>
                <input type="number" step="0.01" min="0" id="med_th" name="med_th" value="{{ form_values.med_th }}">
            </div>
            <div class="field inline">
                <label><input type="checkbox" name="audio_only" {% if form_values.audio_only %}checked{% endif %}> ì˜¤ë””ì˜¤ë§Œ ê²€ì‚¬</label>
                <label for="report_dir">ë¦¬í¬íŠ¸ ì €ì¥ í´ë”</label>
                <input type="text" id="report_dir" name="report_dir" value="{{ form_values.report_dir }}" placeholder="ê¸°ë³¸: {{ default_report_dir }}">
            </div>
            <div class="form-actions">
                <button type="button" id="copyright-save-settings" class="btn-secondary">ì„¤ì • ì €ì¥</button>
                <button type="submit">ê²€ì‚¬ ì‹¤í–‰</button>
            </div>
        </form>
    </section>

    {% if error %}
    <div class="alert error">
        <strong>ì˜¤ë¥˜:</strong> {{ error }}
    </div>
    {% endif %}

    {% if result_payload %}
    <section class="panel result-panel">
        <h2>ê²€ì‚¬ ê²°ê³¼</h2>
        <div class="result-summary">
            <span class="risk-badge risk-{{ result_payload.result.risk | lower }}">{{ result_payload.result.risk }}</span>
            <div class="result-meta">
                <p><strong>ì—…ë¡œë“œ íŒŒì¼:</strong> {{ result_payload.uploaded_filename }}</p>
                <p><strong>ìƒì„± ì‹œê°:</strong> {{ result_payload.result.created_at }}</p>
            </div>
        </div>

        <div class="result-grid">
            <section>
                <h3>ì˜¤ë””ì˜¤ ê²€ì‚¬</h3>
                {% set audio = result_payload.result.audio %}
                {% if audio.hit %}
                <p>ğŸ” ACRCloud ê°ì§€ ê²°ê³¼ <strong>HIT</strong></p>
                <ul>
                    <li><strong>ê³¡ëª…:</strong> {{ audio.title }}</li>
                    <li><strong>ì•„í‹°ìŠ¤íŠ¸:</strong> {{ audio.artists or 'ì•Œ ìˆ˜ ì—†ìŒ' }}</li>
                    <li><strong>ì ìˆ˜:</strong> {{ audio.score }}</li>
                    <li><strong>ACRID:</strong> {{ audio.acrid }}</li>
                </ul>
                {% elif audio.error %}
                <p>âš ï¸ ì˜¤ë””ì˜¤ ì¶”ì¶œ ì‹¤íŒ¨: {{ audio.error }}</p>
                {% else %}
                <p>âœ… ì¼ì¹˜í•˜ëŠ” ìŒì•…ì´ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
                {% endif %}
            </section>
            <section>
                <h3>ì˜ìƒ ê²€ì‚¬</h3>
                {% set video = result_payload.result.reference_compare %}
                {% if video.best_match %}
                <p>ìµœê³  ìœ ì‚¬ë„: <strong>{{ '%.4f'|format(result_payload.match_ratio) }}</strong></p>
                <p>íŒŒì¼: {{ video.best_match.ref or 'ì—†ìŒ' }}</p>
                <p>ëŒ€ìƒ í´ë”: {{ video.total_refs }}ê°œ ë¹„êµ</p>
                {% elif video.note %}
                <p>{{ video.note }}</p>
                {% else %}
                <p>ì˜ìƒ ë¹„êµ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                {% endif %}
                {% if result_payload.result.video_hash.error %}
                <p>âš ï¸ í”„ë ˆì„ í•´ì‹± ì˜¤ë¥˜: {{ result_payload.result.video_hash.error }}</p>
                {% elif result_payload.result.video_hash.frames %}
                <p>ìƒ˜í”Œë§ í”„ë ˆì„ ìˆ˜: {{ result_payload.result.video_hash.frames }}</p>
                {% endif %}
            </section>
        </div>

        <details class="advanced">
            <summary>ì…ë ¥ íŒŒë¼ë¯¸í„° í™•ì¸</summary>
            <table class="params-table">
                <tbody>
                {% for key, value in result_payload.result.params.items() %}
                    <tr>
                        <th scope="row">{{ key }}</th>
                        <td>{{ value }}</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </details>
    </section>

    <section class="panel">
        <h2>ê²°ê³¼ íŒŒì¼</h2>
        <ul class="file-list">
            <li><strong>JSON ë¦¬í¬íŠ¸</strong>: <code>{{ result_payload.report_json }}</code></li>
            {% if result_payload.matches_csv %}
            <li><strong>CSV ë§¤ì¹­ ë¡œê·¸</strong>: <code>{{ result_payload.matches_csv }}</code></li>
            {% endif %}
            {% if result_payload.temp_audio %}
            <li><strong>ì¶”ì¶œ WAV</strong>: <code>{{ result_payload.temp_audio }}</code></li>
            {% endif %}
        </ul>
    </section>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const form = document.querySelector('.copyright-form');
    const saveButton = document.getElementById('copyright-save-settings');
    if (!form || !saveButton) {
        return;
    }

    saveButton.addEventListener('click', async () => {
        const formData = new FormData(form);
        const payload = {};

        formData.forEach((value, key) => {
            if (key === 'video_file') {
                return;
            }
            if (key === 'audio_only') {
                payload.audio_only = true;
            } else {
                payload[key] = value;
            }
        });

        if (!Object.prototype.hasOwnProperty.call(payload, 'audio_only')) {
            payload.audio_only = false;
        }

        saveButton.disabled = true;
        const originalText = saveButton.textContent;
        saveButton.textContent = 'ì €ì¥ ì¤‘...';

        try {
            const response = await fetch('/api/copyright/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            });

            if (!response.ok) {
                const errorPayload = await response.json().catch(() => ({}));
                const detail = errorPayload.detail || response.statusText || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜';
                throw new Error(detail);
            }

            const result = await response.json().catch(() => ({}));
            alert(result.message || 'ê¸°ë³¸ ì„¤ì •ì„ ì €ì¥í–ˆìŠµë‹ˆë‹¤.');
        } catch (error) {
            console.error('Failed to save copyright settings:', error);
            alert(`ì„¤ì •ì„ ì €ì¥í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: ${error.message}`);
        } finally {
            saveButton.disabled = false;
            saveButton.textContent = originalText;
        }
    });
});
</script>

<style>
.form-actions {
    display: flex;
    gap: 10px;
    align-items: center;
    justify-content: flex-end;
}
</style>
</body>
</html>
