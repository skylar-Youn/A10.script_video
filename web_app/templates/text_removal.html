<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì˜ìƒì—ì„œ ê¸€ì ì§€ìš°ê¸°</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        .canvas-wrapper {
            margin-top: 16px;
            border: 1px solid #444;
            border-radius: 8px;
            background: #111;
            padding: 12px;
            display: none;
        }
        .canvas-wrapper.active {
            display: block;
        }
        #roi-canvas {
            max-width: 100%;
            border-radius: 4px;
            cursor: crosshair;
        }
        .canvas-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
        }
        .boxes-list {
            width: 100%;
            min-height: 80px;
            font-family: monospace;
        }
        .hidden {
            display: none !important;
        }
        .status-text {
            margin-top: 8px;
            font-size: 0.95rem;
            color: #9ad7ff;
        }
        .status-text.error {
            color: #ff8a8a;
        }
        .status-text.success {
            color: #8af5a6;
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 12px;
        }
        .form-grid label {
            display: flex;
            flex-direction: column;
            gap: 4px;
            font-weight: 500;
        }
        .result-link {
            margin-top: 12px;
        }
        .result-link a {
            color: #8af5a6;
            text-decoration: underline;
        }
    </style>
</head>
<body>
<div class="container">
    <header class="header">
        <h1>ì˜ìƒì—ì„œ ê¸€ì ì§€ìš°ê¸°</h1>
        <nav class="nav-links">
            <a href="/ytdl" class="nav-link {% if nav_active == 'ytdl' %}active{% endif %}">â¬‡ï¸ ë‹¤ìš´ë¡œë“œ ë„êµ¬</a>
            <a href="/text-removal" class="nav-link {% if nav_active == 'text_removal' %}active{% endif %}">ğŸ§½ ì˜ìƒì—ì„œ ê¸€ì ì§€ìš°ê¸°</a>
            <a href="/analysis" class="nav-link">ğŸ“Š ë¶„ì„ ë„êµ¬</a>
            <a href="/" class="nav-link">ğŸ  AI ì‡¼ì¸  ë©”ì´ì»¤</a>
            <a href="/similarity" class="nav-link {% if nav_active == 'similarity' %}active{% endif %}">ğŸï¸ ì˜ìƒ ìœ ì‚¬ë„ ê²€ì‚¬</a>
            <a href="/copyright" class="nav-link {% if nav_active == 'copyright' %}active{% endif %}">ğŸ›¡ï¸ ì €ì‘ê¶Œ ê²€ì‚¬</a>
        </nav>
        <p class="page-description">ì˜ìƒ ì²« í”„ë ˆì„ì—ì„œ ì§€ìš¸ ì˜ì—­ì„ ì§ì ‘ ì§€ì •í•˜ê³ , Stable Diffusion ì¸í˜ì¸íŒ… ë˜ëŠ” OpenCV ë°°ê²½ ì±„ìš°ê¸°ë¡œ í…ìŠ¤íŠ¸ë¥¼ ì œê±°í•´ ë³´ì„¸ìš”.</p>
    </header>

    <section class="panel">
        <h2>ğŸ§  ì‚¬ìš© íë¦„</h2>
        <ol>
            <li><strong>ì˜ìƒ ì—…ë¡œë“œ</strong>: ì²« í”„ë ˆì„ì„ ì¶”ì¶œí•´ ë¸Œë¼ìš°ì €ì—ì„œ ë°”ë¡œ ì˜ì—­ì„ ì§€ì •í•©ë‹ˆë‹¤.</li>
            <li><strong>ì˜ì—­ ì§€ì •</strong>: ìº”ë²„ìŠ¤ì—ì„œ ë“œë˜ê·¸í•˜ì—¬ ì§€ìš¸ í…ìŠ¤íŠ¸/ì›Œí„°ë§ˆí¬ ì˜ì—­ì„ ì—¬ëŸ¬ ê°œ ê·¸ë¦½ë‹ˆë‹¤.</li>
            <li><strong>ê¸€ì ì§€ìš°ê³  ì¸í˜ì¸íŒ… ì˜ìƒ ë³µì›</strong>: Stable Diffusion(runwayml/stable-diffusion-inpainting)ìœ¼ë¡œ í”„ë ˆì„ ì „ì²´ë¥¼ ë³µì›í•©ë‹ˆë‹¤.</li>
            <li><strong>ê¸€ìë¥¼ ë°°ê²½ìƒ‰ìœ¼ë¡œ ê°€ë¦¬ê¸°</strong>: OpenCV ì¸í˜ì¸íŠ¸ë¥¼ í™œìš©í•´ ì§€ì •í•œ ë°•ìŠ¤ë¥¼ ì£¼ë³€ ë°°ê²½ìƒ‰ìœ¼ë¡œ ë¹ ë¥´ê²Œ ë®ìŠµë‹ˆë‹¤.</li>
        </ol>
        <p class="hint-text">ì²˜ë¦¬ì—ëŠ” GPUê°€ ê¶Œì¥ë©ë‹ˆë‹¤. CPU ëª¨ë“œë„ ê°€ëŠ¥í•˜ì§€ë§Œ ì‹œê°„ì´ ì˜¤ë˜ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    </section>

    <section class="panel">
        <h3>1ï¸âƒ£ ì˜ìƒ ì—…ë¡œë“œ & ë¯¸ë¦¬ë³´ê¸°</h3>
        <form id="preview-form" class="text-removal-form" enctype="multipart/form-data">
            <div class="form-grid">
                <label>ì˜ìƒ íŒŒì¼ ì„ íƒ
                    <input type="file" id="video-file" name="video" accept="video/*" required>
                </label>
            </div>
            <div class="action-buttons">
                <button type="submit" class="primary">
                    <span class="label">ì²« í”„ë ˆì„ ë¶ˆëŸ¬ì˜¤ê¸°</span>
                    <span class="progress" id="preview-progress"></span>
                </button>
                <button type="button" id="split-media" class="secondary" disabled>
                    <span class="label">ìŒì„±Â·ì˜ìƒÂ·ìë§‰ ë¶„ë¦¬</span>
                    <span class="progress" id="split-progress"></span>
                </button>
            </div>
            <div class="trim-controls">
                <div class="trim-inputs">
                    <label>ì‹œì‘ ì‹œê°„(ì´ˆ)
                        <input type="number" id="trim-start" value="0" min="0" step="0.1">
                    </label>
                    <label>ì˜ë¼ë‚¼ ê¸¸ì´(ì´ˆ)
                        <input type="number" id="trim-duration" value="4" min="0.1" step="0.1">
                    </label>
                    <button type="button" id="trim-preview" class="secondary" disabled>
                        <span class="label">ì„ íƒ ì˜ìƒ ë¯¸ë¦¬ë³´ê¸° ë° ìë¥´ê¸°</span>
                        <span class="progress" id="trim-progress"></span>
                    </button>
                    <button type="button" id="trim-download" class="secondary" disabled>
                        <span class="label">ë‹¤ë¥¸ ì´ë¦„ìœ¼ë¡œ ì €ì¥</span>
                    </button>
                </div>
                <p id="trim-status" class="status-text"></p>
                <div id="trim-preview-wrapper" class="trim-preview hidden">
                    <video id="trim-video" controls preload="metadata"></video>
                </div>
            </div>
            <p id="preview-status" class="status-text"></p>
        </form>

        <div id="canvas-wrapper" class="canvas-wrapper">
            <canvas id="roi-canvas" width="640" height="360"></canvas>
            <div class="canvas-controls">
                <div>
                    <strong>ì§€ì •ëœ ì˜ì—­:</strong> <span id="box-count">0</span>ê°œ
                </div>
                <div>
                    <button type="button" id="undo-box" class="btn-secondary" disabled>ë§ˆì§€ë§‰ ì˜ì—­ ì·¨ì†Œ</button>
                    <button type="button" id="clear-boxes" class="btn-secondary" disabled>ëª¨ë‘ ì´ˆê¸°í™”</button>
                </div>
            </div>
        </div>
    </section>

    <section class="panel hidden" id="process-panel">
        <h3>2ï¸âƒ£ ì¸í˜ì¸íŒ… ì„¤ì •</h3>
        <form id="process-form">
            <input type="hidden" id="session-id" name="session_id">
            <div class="form-grid">
                <label>Prompt
                    <input type="text" id="prompt" value="clean smooth surface, natural background, seamless texture">
                </label>
                <label>Negative Prompt
                    <input type="text" id="negative-prompt" value="text, watermark, caption, letters, words, characters">
                </label>
                <label>ëª¨ë¸ ID
                    <select id="model-id">
                        <option value="stabilityai/stable-diffusion-2-inpainting" selected>SD 2.0 Inpainting (ì¶”ì²œ, ê³ í’ˆì§ˆ)</option>
                        <option value="runwayml/stable-diffusion-inpainting">SD 1.5 Inpainting (ë¹ ë¦„)</option>
                        <option value="diffusers/stable-diffusion-xl-1.0-inpainting-0.1">SDXL Inpainting (ìµœê³ í’ˆì§ˆ, ëŠë¦¼)</option>
                    </select>
                </label>
                <label>Guidance Scale
                    <input type="number" step="0.1" id="guidance-scale" value="7.5">
                </label>
                <label>Strength
                    <input type="number" step="0.05" min="0" max="1" id="strength" value="0.9">
                </label>
                <label>Diffusion Steps
                    <input type="number" min="1" max="100" id="inference-steps" value="30">
                </label>
                <label>Mask Dilate (px)
                    <input type="number" min="0" max="32" id="dilate" value="10">
                </label>
                <label>ë””ë°”ì´ìŠ¤
                    <select id="device">
                        {% if torch_cuda_available %}
                        <option value="cuda">cuda (GPU)</option>
                        <option value="cpu">cpu</option>
                        {% else %}
                        <option value="cpu" selected>cpu</option>
                        <option value="cuda" disabled>cuda (GPU)</option>
                        {% endif %}
                    </select>
                </label>
                <label>dtype
                    <select id="dtype">
                        <option value="float16">float16</option>
                        <option value="float32">float32</option>
                    </select>
                </label>
                <label>Seed (ì„ íƒ)
                    <input type="number" id="seed" placeholder="ëœë¤">
                </label>
                <label>FPS Override (ì„ íƒ)
                    <input type="number" step="0.01" id="fps-override" placeholder="ì›ë³¸ ìœ ì§€">
                </label>
                <label>Max Frames (ì„ íƒ)
                    <input type="number" id="max-frames" placeholder="ì „ì²´ ì²˜ë¦¬">
                </label>
            </div>

            <label>ì˜ì—­ ëª©ë¡ (JSON)
                <textarea id="boxes-json" class="boxes-list" readonly></textarea>
            </label>

            <div class="action-buttons">
                <button type="submit" id="process-submit" class="primary" disabled>
                    <span class="label">ê¸€ì ì§€ìš°ê³  ì¸í˜ì¸íŒ… ì˜ìƒ ë³µì›</span>
                    <span class="progress" id="process-progress"></span>
                </button>
                <button type="button" id="fill-background" class="secondary" disabled>
                    <span class="label">ê¸€ìë¥¼ ë°°ê²½ìƒ‰ìœ¼ë¡œ ë®ì–´ ê°€ë¦¬ê¸°</span>
                    <span class="progress" id="fill-progress"></span>
                </button>
            </div>
            <p id="process-status" class="status-text"></p>
            <div id="result-link" class="result-link"></div>
        </form>
    </section>
</div>

<script>
(() => {
    const previewForm = document.getElementById('preview-form');
    const previewStatus = document.getElementById('preview-status');
    const previewSubmit = previewForm.querySelector('button[type="submit"]');
    const previewProgress = document.getElementById('preview-progress');
    const canvasWrapper = document.getElementById('canvas-wrapper');
    const canvas = document.getElementById('roi-canvas');
    const ctx = canvas.getContext('2d');
    const undoBtn = document.getElementById('undo-box');
    const clearBtn = document.getElementById('clear-boxes');
    const boxCount = document.getElementById('box-count');
    const processPanel = document.getElementById('process-panel');
    const sessionInput = document.getElementById('session-id');
    const boxesTextarea = document.getElementById('boxes-json');
    const processForm = document.getElementById('process-form');
    const processStatus = document.getElementById('process-status');
    const processSubmit = document.getElementById('process-submit');
    const fillBackgroundBtn = document.getElementById('fill-background');
    const splitMediaBtn = document.getElementById('split-media');
    const resultLink = document.getElementById('result-link');
    const processLabel = processSubmit.querySelector('.label');
    const processProgress = document.getElementById('process-progress');
    const fillLabel = fillBackgroundBtn.querySelector('.label');
    const fillProgress = document.getElementById('fill-progress');
    const splitLabel = splitMediaBtn.querySelector('.label');
    const splitProgress = document.getElementById('split-progress');
    const trimButton = document.getElementById('trim-preview');
    const trimLabel = trimButton.querySelector('.label');
    const trimProgress = document.getElementById('trim-progress');
    const trimDownloadButton = document.getElementById('trim-download');
    const trimStatus = document.getElementById('trim-status');
    const trimStartInput = document.getElementById('trim-start');
    const trimDurationInput = document.getElementById('trim-duration');
    const trimWrapper = document.getElementById('trim-preview-wrapper');
    const trimVideo = document.getElementById('trim-video');
    const DEFAULT_PROCESS_LABEL = processLabel.textContent.trim();
    const DEFAULT_FILL_LABEL = fillLabel.textContent.trim();
    const DEFAULT_SPLIT_LABEL = splitLabel.textContent.trim();
    const DEFAULT_TRIM_LABEL = trimLabel.textContent.trim();

    const promptInput = document.getElementById('prompt');
    const negativePromptInput = document.getElementById('negative-prompt');
    const modelInput = document.getElementById('model-id');
    const guidanceInput = document.getElementById('guidance-scale');
    const strengthInput = document.getElementById('strength');
    const stepsInput = document.getElementById('inference-steps');
    const dilateInput = document.getElementById('dilate');
    const deviceSelect = document.getElementById('device');
    const dtypeSelect = document.getElementById('dtype');
    const seedInput = document.getElementById('seed');
    const fpsInput = document.getElementById('fps-override');
    const maxFramesInput = document.getElementById('max-frames');

    let sessionId = null;
    let previewImage = new Image();
    let nativeWidth = 0;
    let nativeHeight = 0;
    let scale = 1;
    let boxes = [];
    let isDrawing = false;
    let startPoint = { x: 0, y: 0 };
    let tempPoint = { x: 0, y: 0 };
    let processingMode = null;

    function setStatus(el, message, type = '') {
        el.textContent = message || '';
        el.classList.remove('error', 'success');
        if (type) {
            el.classList.add(type);
        }
    }

function setProcessingState(mode, message = '') {
    processingMode = mode;
    const isDiffusion = mode === 'diffusion';
    const isFill = mode === 'fill';
    const isSplit = mode === 'split';
    const isTrim = mode === 'trim';

        processLabel.textContent = isDiffusion ? (message || 'ë³µì› ì¤‘...') : DEFAULT_PROCESS_LABEL;
        processProgress.textContent = isDiffusion ? 'ì§„í–‰ ì¤‘...' : '';
        processSubmit.classList.toggle('is-processing', isDiffusion);

        fillLabel.textContent = isFill ? (message || 'ë°°ê²½ ì±„ìš°ëŠ” ì¤‘...') : DEFAULT_FILL_LABEL;
        fillProgress.textContent = isFill ? 'ì§„í–‰ ì¤‘...' : '';
        fillBackgroundBtn.classList.toggle('is-processing', isFill);

        splitLabel.textContent = isSplit ? (message || 'ë¶„ë¦¬ ì¤‘...') : DEFAULT_SPLIT_LABEL;
        splitProgress.textContent = isSplit ? 'ì§„í–‰ ì¤‘...' : '';
        splitMediaBtn.classList.toggle('is-processing', isSplit);

        trimLabel.textContent = isTrim ? (message || 'ìë¥´ëŠ” ì¤‘...') : DEFAULT_TRIM_LABEL;
        trimProgress.textContent = isTrim ? 'ì§„í–‰ ì¤‘...' : '';
        trimButton.classList.toggle('is-processing', isTrim);

        if (mode) {
            processSubmit.disabled = true;
            fillBackgroundBtn.disabled = true;
            previewSubmit.disabled = true;
            splitMediaBtn.disabled = true;
            trimButton.disabled = true;
            trimDownloadButton.disabled = true;
        } else {
            const disabled = !sessionId || boxes.length === 0;
            processSubmit.disabled = disabled;
            fillBackgroundBtn.disabled = disabled;
            previewSubmit.disabled = false;
            splitMediaBtn.disabled = !sessionId;
            trimButton.disabled = !sessionId;
            trimDownloadButton.disabled = !trimVideo.src;
        }
}

    function resetTrimPreview() {
        if (!trimVideo.paused) {
            trimVideo.pause();
        }
        trimVideo.removeAttribute('src');
        trimVideo.load();
        trimWrapper.classList.add('hidden');
        setStatus(trimStatus, '');
        trimDownloadButton.disabled = true;
        delete trimDownloadButton.dataset.downloadUrl;
    }

    async function parseJSONResponse(response) {
        const contentType = response.headers.get('content-type') || '';
        if (contentType.includes('application/json')) {
            try {
                return await response.json();
            } catch (error) {
                return { detail: 'ì„œë²„ ì‘ë‹µì„ í•´ì„í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.' };
            }
        }
        const text = await response.text();
        return { detail: text || response.statusText || 'ìš”ì²­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' };
    }

    function renderResultLink(links, defaultLabel = 'ì²˜ë¦¬ëœ ì˜ìƒ ë‚´ë ¤ë°›ê¸°') {
        if (!links) {
            resultLink.innerHTML = '';
            return;
        }
        const items = Array.isArray(links)
            ? links
            : [typeof links === 'string' ? { url: links, label: defaultLabel } : links];
        const markup = items
            .filter((item) => item && item.url)
            .map((item) => `<a href="${item.url}" target="_blank" rel="noopener">${item.label || defaultLabel}</a>`)
            .join(' ');
        resultLink.innerHTML = markup;
    }

    function serializeBoxes() {
        return boxes.map((box) => ({
            x: Math.round(box.x),
            y: Math.round(box.y),
            width: Math.round(box.width),
            height: Math.round(box.height),
        }));
    }

    function buildDiffusionPayload() {
        return {
            session_id: sessionId,
            prompt: promptInput.value.trim() || 'clean smooth surface, natural background, seamless texture',
            negative_prompt: negativePromptInput.value.trim() || 'text, watermark, caption, letters, words, characters',
            model_id: modelInput.value.trim() || 'stabilityai/stable-diffusion-2-inpainting',
            guidance_scale: parseFloat(guidanceInput.value) || 7.5,
            strength: Math.min(Math.max(parseFloat(strengthInput.value) || 0.9, 0), 1),
            num_inference_steps: Math.max(parseInt(stepsInput.value, 10) || 30, 1),
            dilate: Math.max(parseInt(dilateInput.value, 10) || 10, 0),
            device: deviceSelect.value,
            dtype: dtypeSelect.value,
            seed: seedInput.value ? parseInt(seedInput.value, 10) : null,
            fps: fpsInput.value ? parseFloat(fpsInput.value) : null,
            max_frames: maxFramesInput.value ? parseInt(maxFramesInput.value, 10) : null,
            boxes: serializeBoxes(),
        };
    }

    function buildFillPayload() {
        return {
            session_id: sessionId,
            dilate: Math.max(parseInt(dilateInput.value, 10) || 0, 0),
            fps: fpsInput.value ? parseFloat(fpsInput.value) : null,
            max_frames: maxFramesInput.value ? parseInt(maxFramesInput.value, 10) : null,
            boxes: serializeBoxes(),
        };
    }

    function updateBoxesUI() {
        boxesTextarea.value = JSON.stringify(boxes, null, 2);
        boxCount.textContent = boxes.length.toString();
        undoBtn.disabled = boxes.length === 0;
        clearBtn.disabled = boxes.length === 0;
        if (!processingMode) {
            const disabled = !sessionId || boxes.length === 0;
            processSubmit.disabled = disabled;
            fillBackgroundBtn.disabled = disabled;
            splitMediaBtn.disabled = !sessionId;
        }
        renderCanvas();
    }

    function renderCanvas(tempRect = null) {
        if (!previewImage.src) {
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            return;
        }
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(previewImage, 0, 0, canvas.width, canvas.height);

        ctx.lineWidth = 2;
        boxes.forEach((box) => {
            ctx.strokeStyle = 'rgba(0, 255, 180, 0.9)';
            ctx.fillStyle = 'rgba(0, 255, 180, 0.15)';
            ctx.beginPath();
            ctx.rect(box.x * scale, box.y * scale, box.width * scale, box.height * scale);
            ctx.fill();
            ctx.stroke();
        });

        if (tempRect) {
            ctx.strokeStyle = 'rgba(255, 200, 0, 0.9)';
            ctx.fillStyle = 'rgba(255, 200, 0, 0.2)';
            ctx.beginPath();
            ctx.rect(tempRect.x * scale, tempRect.y * scale, tempRect.width * scale, tempRect.height * scale);
            ctx.fill();
            ctx.stroke();
        }
    }

    function toVideoCoords(evt) {
        const rect = canvas.getBoundingClientRect();
        const x = (evt.clientX - rect.left) / scale;
        const y = (evt.clientY - rect.top) / scale;
        return {
            x: Math.min(Math.max(x, 0), nativeWidth),
            y: Math.min(Math.max(y, 0), nativeHeight),
        };
    }

    canvas.addEventListener('mousedown', (evt) => {
        if (!sessionId || !previewImage.src) return;
        isDrawing = true;
        startPoint = toVideoCoords(evt);
        tempPoint = { ...startPoint };
    });

    canvas.addEventListener('mousemove', (evt) => {
        if (!isDrawing) return;
        tempPoint = toVideoCoords(evt);
        const rect = normalizeRect(startPoint, tempPoint);
        renderCanvas(rect);
    });

    function normalizeRect(a, b) {
        const x = Math.min(a.x, b.x);
        const y = Math.min(a.y, b.y);
        const width = Math.abs(b.x - a.x);
        const height = Math.abs(b.y - a.y);
        return { x, y, width, height };
    }

    function finalizeRect() {
        if (!isDrawing) return;
        isDrawing = false;
        const rect = normalizeRect(startPoint, tempPoint);
        if (rect.width < 5 || rect.height < 5) {
            renderCanvas();
            return;
        }
        boxes.push(rect);
        updateBoxesUI();
    }

    canvas.addEventListener('mouseup', finalizeRect);
    canvas.addEventListener('mouseleave', () => {
        if (!isDrawing) return;
        finalizeRect();
    });

    undoBtn.addEventListener('click', () => {
        boxes.pop();
        updateBoxesUI();
    });

    clearBtn.addEventListener('click', () => {
        boxes = [];
        updateBoxesUI();
    });

    previewForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        renderResultLink(null);
        boxes = [];
        updateBoxesUI();
        setProcessingState(null);
        setStatus(processStatus, '');
        processSubmit.disabled = true;
        fillBackgroundBtn.disabled = true;
        resetTrimPreview();
        trimStartInput.value = '0';
        trimDurationInput.value = '4';
        trimButton.disabled = true;

        const fileInput = document.getElementById('video-file');
        if (!fileInput.files || fileInput.files.length === 0) {
            setStatus(previewStatus, 'ì˜ìƒ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.', 'error');
            return;
        }

        const formData = new FormData();
        formData.append('video', fileInput.files[0]);
        setStatus(previewStatus, 'ë¯¸ë¦¬ë³´ê¸°ë¥¼ ìƒì„±í•˜ëŠ” ì¤‘...', '');
        previewProgress.textContent = 'ì§„í–‰ ì¤‘...';
        previewSubmit.disabled = true;
        splitMediaBtn.disabled = true;

        try {
            const response = await fetch('/api/text-removal/preview', {
                method: 'POST',
                body: formData,
            });

            const data = await parseJSONResponse(response);
            if (!response.ok) {
                const message = (data && typeof data === 'object' && data.detail)
                    ? data.detail
                    : 'ë¯¸ë¦¬ë³´ê¸°ë¥¼ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.';
                throw new Error(message);
            }

            sessionId = data.session_id;
            sessionInput.value = sessionId;

            nativeWidth = data.width;
            nativeHeight = data.height;
            scale = Math.min(720 / nativeWidth, 1);
            canvas.width = Math.round(nativeWidth * scale);
            canvas.height = Math.round(nativeHeight * scale);

            previewImage = new Image();
            previewImage.onload = () => {
                canvasWrapper.classList.add('active');
                processPanel.classList.remove('hidden');
                updateBoxesUI();
            };
            previewImage.src = data.preview_image;

            setStatus(previewStatus, 'ë¯¸ë¦¬ë³´ê¸°ê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤. ìº”ë²„ìŠ¤ì—ì„œ ì˜ì—­ì„ ì§€ì •í•˜ì„¸ìš”.', 'success');
            previewProgress.textContent = 'ì™„ë£Œ';
            previewSubmit.disabled = false;
            splitMediaBtn.disabled = false;
            trimButton.disabled = false;
        } catch (error) {
            sessionId = null;
            sessionInput.value = '';
            previewImage = new Image();
            canvasWrapper.classList.remove('active');
            processPanel.classList.add('hidden');
            setStatus(previewStatus, error.message || 'ë¯¸ë¦¬ë³´ê¸°ë¥¼ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.', 'error');
            previewProgress.textContent = '';
            previewSubmit.disabled = false;
            splitMediaBtn.disabled = true;
            trimButton.disabled = true;
            resetTrimPreview();
        }
    });

trimButton.addEventListener('click', async () => {
        if (!sessionId) {
            setStatus(trimStatus, 'ë¨¼ì € ì˜ìƒì„ ì—…ë¡œë“œí•˜ê³  ë¯¸ë¦¬ë³´ê¸°ë¥¼ ìƒì„±í•˜ì„¸ìš”.', 'error');
            return;
        }

        const start = Number(trimStartInput.value ?? 0);
        const duration = Number(trimDurationInput.value ?? 0);
        if (Number.isNaN(start) || start < 0) {
            setStatus(trimStatus, 'ì‹œì‘ ì‹œê°„ì€ 0 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.', 'error');
            return;
        }
        if (Number.isNaN(duration) || duration <= 0) {
            setStatus(trimStatus, 'ì˜ë¼ë‚¼ ê¸¸ì´ëŠ” 0ë³´ë‹¤ ì»¤ì•¼ í•©ë‹ˆë‹¤.', 'error');
            return;
        }

        resetTrimPreview();
        setStatus(trimStatus, 'ì˜ìƒ ìë¥´ëŠ” ì¤‘...', '');
        setProcessingState('trim', 'íŠ¸ë¦¬ë° ì¤‘...');

        try {
            const response = await fetch('/api/text-removal/trim', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    session_id: sessionId,
                    start,
                    duration,
                }),
            });
            const data = await parseJSONResponse(response);
            if (!response.ok) {
                const message = (data && typeof data === 'object' && data.detail)
                    ? data.detail
                    : 'ì˜ìƒ ìë¥´ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                throw new Error(message);
            }

            const videoUrl = `${data.video_url}?v=${Date.now()}`;
            trimStartInput.value = (data.start ?? start).toString();
            trimDurationInput.value = (data.duration ?? duration).toString();
            trimVideo.src = videoUrl;
            trimVideo.load();
            trimWrapper.classList.remove('hidden');
            trimVideo.play().catch(() => {});
            setStatus(
                trimStatus,
                `ì‹œì‘ ${Number(trimStartInput.value).toFixed(2)}ì´ˆ, ê¸¸ì´ ${Number(trimDurationInput.value).toFixed(2)}ì´ˆë¡œ ì˜ëìŠµë‹ˆë‹¤.`,
                'success',
            );
            trimDownloadButton.disabled = false;
            trimDownloadButton.dataset.downloadUrl = videoUrl;
        } catch (error) {
            setStatus(trimStatus, error.message || 'ì˜ìƒ ìë¥´ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        } finally {
            setProcessingState(null);
        }
});

trimDownloadButton.addEventListener('click', () => {
    if (!trimDownloadButton.dataset.downloadUrl) {
        return;
    }

    const url = trimDownloadButton.dataset.downloadUrl;
    const fileName = prompt('ì €ì¥í•  íŒŒì¼ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš” (í™•ì¥ì ì œì™¸)', 'trimmed_clip');
    if (fileName === null) {
        return;
    }

    const anchor = document.createElement('a');
    anchor.href = url;
    anchor.download = `${fileName || 'trimmed_clip'}.mp4`;
    document.body.appendChild(anchor);
    anchor.click();
    document.body.removeChild(anchor);
});

    splitMediaBtn.addEventListener('click', async () => {
        if (!sessionId) {
            setStatus(previewStatus, 'ë¨¼ì € ì˜ìƒì„ ì—…ë¡œë“œí•˜ê³  ë¯¸ë¦¬ë³´ê¸°ë¥¼ ìƒì„±í•˜ì„¸ìš”.', 'error');
            return;
        }

        setProcessingState('split', 'ë¶„ë¦¬ ì¤‘...');
        setStatus(processStatus, 'ì˜ìƒì—ì„œ ìŒì„±, ì˜ìƒ, ìë§‰ì„ ë¶„ë¦¬í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...', '');
        renderResultLink(null);

        try {
            const response = await fetch('/api/text-removal/split-media', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    session_id: sessionId,
                }),
            });

            const data = await parseJSONResponse(response);
            if (!response.ok) {
                const message = (data && typeof data === 'object' && data.detail)
                    ? data.detail
                    : 'ë¯¸ë””ì–´ ë¶„ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                throw new Error(message);
            }

            setStatus(processStatus, 'ìŒì„±Â·ì˜ìƒÂ·ìë§‰ ë¶„ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            splitProgress.textContent = 'ì™„ë£Œ';
            const links = [];
            if (data.audio_url) {
                links.push({ url: data.audio_url, label: 'ìŒì„± íŠ¸ë™ ë‹¤ìš´ë¡œë“œ' });
            }
            if (data.video_url) {
                links.push({ url: data.video_url, label: 'ì˜ìƒ(ë¬´ìŒ) ë‹¤ìš´ë¡œë“œ' });
            }
            if (data.subtitle_url) {
                links.push({ url: data.subtitle_url, label: 'ìë§‰ ë‹¤ìš´ë¡œë“œ' });
            }
            renderResultLink(links);
        } catch (error) {
            setStatus(processStatus, error.message || 'ë¯¸ë””ì–´ ë¶„ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        } finally {
            setTimeout(() => {
                setProcessingState(null);
                updateBoxesUI();
            }, 600);
        }
    });

    processForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        if (!sessionId) {
            setStatus(processStatus, 'ë¨¼ì € ì˜ìƒì„ ì—…ë¡œë“œí•˜ê³  ë¯¸ë¦¬ë³´ê¸°ë¥¼ ìƒì„±í•˜ì„¸ìš”.', 'error');
            return;
        }
        if (boxes.length === 0) {
            setStatus(processStatus, 'ì¸í˜ì¸íŒ…í•  ì˜ì—­ì„ ìµœì†Œ í•œ ê°œ ì´ìƒ ì§€ì •í•˜ì„¸ìš”.', 'error');
            return;
        }

        setProcessingState('diffusion', 'ë³µì› ì¤‘...');
        setStatus(processStatus, 'Stable Diffusionìœ¼ë¡œ ì˜ìƒì„ ë³µì›í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì‹œê°„ì´ ë‹¤ì†Œ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤...', '');
        renderResultLink(null);

        const payload = buildDiffusionPayload();

        try {
            const response = await fetch('/api/text-removal/process', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload),
            });

            const data = await parseJSONResponse(response);
            if (!response.ok) {
                const message = (data && typeof data === 'object' && data.detail)
                    ? data.detail
                    : 'ì˜ìƒ ë³µì›ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                throw new Error(message);
            }

            setStatus(processStatus, 'ì˜ìƒ ë³µì›ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            processProgress.textContent = 'ì™„ë£Œ';
            renderResultLink(data.video_url, 'ë³µì›ëœ ì˜ìƒ ë‚´ë ¤ë°›ê¸°');
        } catch (error) {
            setStatus(processStatus, error.message || 'ì˜ìƒ ë³µì› ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        } finally {
            setTimeout(() => {
                setProcessingState(null);
                updateBoxesUI();
            }, 600);
        }
    });

    fillBackgroundBtn.addEventListener('click', async () => {
        if (!sessionId) {
            setStatus(processStatus, 'ë¨¼ì € ì˜ìƒì„ ì—…ë¡œë“œí•˜ê³  ë¯¸ë¦¬ë³´ê¸°ë¥¼ ìƒì„±í•˜ì„¸ìš”.', 'error');
            return;
        }
        if (boxes.length === 0) {
            setStatus(processStatus, 'ë¨¼ì € ê°€ë¦´ ì˜ì—­ì„ ì§€ì •í•˜ì„¸ìš”.', 'error');
            return;
        }

        setProcessingState('fill', 'ë°°ê²½ ì±„ìš°ëŠ” ì¤‘...');
        setStatus(processStatus, 'OpenCV ì¸í˜ì¸íŠ¸ë¡œ í…ìŠ¤íŠ¸ ì˜ì—­ì„ ë°°ê²½ì— ë§ì¶° ë®ëŠ” ì¤‘ì…ë‹ˆë‹¤...', '');
        renderResultLink(null);

        const payload = buildFillPayload();

        try {
            const response = await fetch('/api/text-removal/fill-background', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload),
            });

            const data = await parseJSONResponse(response);
            if (!response.ok) {
                const message = (data && typeof data === 'object' && data.detail)
                    ? data.detail
                    : 'ë°°ê²½ ì±„ìš°ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                throw new Error(message);
            }

            setStatus(processStatus, 'ë°°ê²½ ê°€ë¦¬ê¸°ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            fillProgress.textContent = 'ì™„ë£Œ';
            renderResultLink(data.video_url, 'ë°°ê²½ ì²˜ë¦¬ëœ ì˜ìƒ ë‚´ë ¤ë°›ê¸°');
        } catch (error) {
            setStatus(processStatus, error.message || 'ë°°ê²½ ì±„ìš°ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        } finally {
            setTimeout(() => {
                setProcessingState(null);
                updateBoxesUI();
            }, 600);
        }
    });
})();
</script>
</body>
</html>
