<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ìœ íŠœë¸Œ ë‹¤ìš´ë¡œë“œ ë„êµ¬</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
<div class="container">
    <header class="header">
        <h1>ìœ íŠœë¸Œ ë‹¤ìš´ë¡œë“œ ë„êµ¬</h1>
        <nav class="nav-links">
            <a href="/ytdl" class="nav-link {% if nav_active == 'ytdl' %}active{% endif %}">â¬‡ï¸ ë‹¤ìš´ë¡œë“œ ë„êµ¬</a>
            <a href="/text-removal" class="nav-link {% if nav_active == 'text_removal' %}active{% endif %}">ğŸ§½ ì˜ìƒì—ì„œ ê¸€ì ì§€ìš°ê¸°</a>
            <a href="/video-analyzer" class="nav-link {% if nav_active == 'video_analyzer' %}active{% endif %}">ğŸ“¹ ì˜ìƒ ë¶„ì„ê¸°</a>
            <a href="/analysis" class="nav-link">ğŸ“Š ì˜ìƒë©”ì´ì»¤</a>
            <a href="/" class="nav-link">ğŸ  AI ì‡¼ì¸  ë©”ì´ì»¤</a>
            <a href="/similarity" class="nav-link {% if nav_active == 'similarity' %}active{% endif %}">ğŸï¸ ì˜ìƒ ìœ ì‚¬ë„ ê²€ì‚¬</a>
            <a href="/copyright" class="nav-link {% if nav_active == 'copyright' %}active{% endif %}">ğŸ›¡ï¸ ì €ì‘ê¶Œ ê²€ì‚¬</a>
        </nav>
    </header>

    <section class="panel">
        <h2>ë‹¤ìš´ë¡œë“œ ì„¤ì •</h2>
        <form id="ytdl-form" method="post" action="/ytdl" class="ytdl-form">
            <div class="field">
                <label for="urls">ìœ íŠœë¸Œ URL (ì—¬ëŸ¬ ì¤„ ì…ë ¥ ê°€ëŠ¥)</label>
                <textarea id="urls" name="urls" rows="4">{{ form_values.urls }}</textarea>
            </div>
            <div class="field inline">
                <label for="output_dir">ì €ì¥ í´ë”</label>
                <input type="text" id="output_dir" name="output_dir" placeholder="í˜„ì¬ ë””ë ‰í„°ë¦¬" value="{{ form_values.output_dir }}">
                <label for="sub_langs">ìë§‰ ì–¸ì–´</label>
                <input type="text" id="sub_langs" name="sub_langs" value="{{ form_values.sub_langs }}" placeholder="ì˜ˆ: ko,en">
                <label for="sub_format">ìë§‰ í˜•ì‹</label>
                <input type="text" id="sub_format" name="sub_format" value="{{ form_values.sub_format }}">
            </div>
            <div class="field inline">
                <label><input type="checkbox" id="download_subs" name="download_subs" {% if form_values.download_subs %}checked{% endif %}> ìë§‰ ë‹¤ìš´ë¡œë“œ</label>
                <label><input type="checkbox" id="auto_subs" name="auto_subs" {% if form_values.auto_subs %}checked{% endif %}> ìë™ ìƒì„± ìë§‰ í¬í•¨</label>
                <label><input type="checkbox" id="dry_run" name="dry_run" {% if form_values.dry_run %}checked{% endif %}> ë“œë¼ì´ëŸ°(ë¯¸ë¦¬ë³´ê¸°)</label>
                <label><input type="checkbox" name="save_settings"> í˜„ì¬ ìƒíƒœë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì €ì¥</label>
            </div>
            <button type="submit" id="download-btn">ì‹¤í–‰</button>
        </form>

        <!-- ì§„í–‰ìœ¨ í‘œì‹œ ì˜ì—­ -->
        <div id="progress-container" style="display: none; margin-top: 20px;">
            <div class="progress-header">
                <h3>ë‹¤ìš´ë¡œë“œ ì§„í–‰ ì¤‘</h3>
                <span id="progress-status">ì¤€ë¹„ ì¤‘...</span>
            </div>
            <div class="progress-bar-container">
                <div class="progress-bar" id="progress-bar" style="width: 0%;">
                    <span id="progress-text">0%</span>
                </div>
            </div>
            <div id="progress-message" class="progress-message">ë‹¤ìš´ë¡œë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...</div>
        </div>
    </section>

    {% if settings_saved %}
    <div class="alert success">
        í˜„ì¬ ì„¤ì •ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ì €ì¥í–ˆìŠµë‹ˆë‹¤.
    </div>
    {% endif %}

    {% if error %}
    <div class="alert error">
        <strong>ì˜¤ë¥˜:</strong> {{ error }}
    </div>
    {% endif %}

    {% if result %}
    <section class="panel">
        <h2>ê²°ê³¼</h2>
        <p>
            {% if result.dry_run %}
            ë‹¤ìš´ë¡œë“œ ì˜ˆì • íŒŒì¼ ({{ result.count }}ê°œ)
            {% else %}
            ë‹¤ìš´ë¡œë“œ ì™„ë£Œ íŒŒì¼ ({{ result.count }}ê°œ)
            {% endif %}
        </p>
        <p>ìë§‰ ì–¸ì–´: {{ result.langs | join(", ") }}</p>
        <ul class="file-list">
            {% for item in result.files %}
            <li><code>{{ item }}</code></li>
            {% endfor %}
        </ul>
    </section>
    {% endif %}

    <section class="panel">
        <h2>ë‹¤ìš´ë¡œë“œ ê¸°ë¡</h2>
        <div id="download-history">
            <div class="loading">ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
    </section>

    <section class="panel info">
        <h2>ì‚¬ìš© íŒ</h2>
        <ul>
            <li>`ìë§‰ ì–¸ì–´`ì— `ko,en`ì²˜ëŸ¼ ì½¤ë§ˆë¡œ êµ¬ë¶„í•˜ë©´ ì—¬ëŸ¬ ì–¸ì–´ë¥¼ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
            <li>ì˜ìƒ ì—†ì´ ìë§‰ë§Œ í™•ì¸í•˜ë ¤ë©´ `ë“œë¼ì´ëŸ°`ì„ ì²´í¬í•˜ì„¸ìš”.</li>
            <li>`ìë™ ìƒì„± ìë§‰ í¬í•¨`ì„ í•´ì œí•˜ë©´ ì—…ë¡œë“œëœ ìë§‰ë§Œ ë‚´ë ¤ë°›ìŠµë‹ˆë‹¤.</li>
            <li>ìƒë‹¨ì˜ 'ì˜ìƒ ìœ ì‚¬ë„ ê²€ì‚¬' íƒ­ì—ì„œ í´ë” ì „ì²´ ë¹„êµì™€ ìƒì„¸ ì§€í‘œë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
        </ul>
    </section>
</div>

<script>
let pollInterval = null;

// í¼ ì œì¶œ ì´ë²¤íŠ¸ ê°€ë¡œì±„ê¸°
document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('ytdl-form');
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        await startDownload();
    });

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë‹¤ìš´ë¡œë“œ ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    loadDownloadHistory();
});

async function startDownload() {
    // í¼ ë°ì´í„° ìˆ˜ì§‘
    const urls = document.getElementById('urls').value;
    const outputDir = document.getElementById('output_dir').value;
    const subLangs = document.getElementById('sub_langs').value;
    const subFormat = document.getElementById('sub_format').value;
    const downloadSubs = document.getElementById('download_subs').checked;
    const autoSubs = document.getElementById('auto_subs').checked;
    const dryRun = document.getElementById('dry_run').checked;

    if (!urls.trim()) {
        alert('ìµœì†Œ í•˜ë‚˜ì˜ URLì„ ì…ë ¥í•˜ì„¸ìš”.');
        return;
    }

    // ì§„í–‰ìœ¨ UI í‘œì‹œ
    document.getElementById('progress-container').style.display = 'block';
    document.getElementById('download-btn').disabled = true;
    updateProgress(0, 'ë‹¤ìš´ë¡œë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...', 'starting');

    try {
        // ë°±ê·¸ë¼ìš´ë“œ ë‹¤ìš´ë¡œë“œ ì‹œì‘
        const response = await fetch('/api/ytdl/start', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                urls: urls,
                output_dir: outputDir,
                sub_langs: subLangs,
                sub_format: subFormat,
                download_subs: downloadSubs,
                auto_subs: autoSubs,
                dry_run: dryRun,
            })
        });

        if (!response.ok) {
            throw new Error('ë‹¤ìš´ë¡œë“œ ì‹œì‘ ì‹¤íŒ¨');
        }

        const result = await response.json();
        const taskId = result.task_id;

        // ì§„í–‰ ìƒíƒœ í´ë§ ì‹œì‘
        pollProgress(taskId);
    } catch (error) {
        console.error('Error:', error);
        updateProgress(0, 'ì˜¤ë¥˜ ë°œìƒ: ' + error.message, 'error');
        document.getElementById('download-btn').disabled = false;
    }
}

function pollProgress(taskId) {
    // ê¸°ì¡´ í´ë§ ì¤‘ì§€
    if (pollInterval) {
        clearInterval(pollInterval);
    }

    // 1ì´ˆë§ˆë‹¤ ì§„í–‰ ìƒíƒœ í™•ì¸
    pollInterval = setInterval(async () => {
        try {
            const response = await fetch(`/api/ytdl/status/${taskId}`);
            if (!response.ok) {
                throw new Error('ìƒíƒœ ì¡°íšŒ ì‹¤íŒ¨');
            }

            const status = await response.json();
            updateProgress(status.progress, status.message, status.status);

            // ì™„ë£Œë˜ë©´ í´ë§ ì¤‘ì§€
            if (status.completed) {
                clearInterval(pollInterval);
                pollInterval = null;
                document.getElementById('download-btn').disabled = false;

                if (status.status === 'completed') {
                    // ë‹¤ìš´ë¡œë“œ ê¸°ë¡ ìƒˆë¡œê³ ì¹¨
                    setTimeout(() => {
                        loadDownloadHistory();
                        // ì§„í–‰ìœ¨ UI ìˆ¨ê¸°ê¸° (3ì´ˆ í›„)
                        setTimeout(() => {
                            document.getElementById('progress-container').style.display = 'none';
                        }, 3000);
                    }, 1000);
                }
            }
        } catch (error) {
            console.error('í´ë§ ì˜¤ë¥˜:', error);
            clearInterval(pollInterval);
            pollInterval = null;
            updateProgress(0, 'ìƒíƒœ í™•ì¸ ì‹¤íŒ¨: ' + error.message, 'error');
            document.getElementById('download-btn').disabled = false;
        }
    }, 1000);
}

function updateProgress(percent, message, status) {
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const progressMessage = document.getElementById('progress-message');
    const progressStatus = document.getElementById('progress-status');

    progressBar.style.width = percent + '%';
    progressText.textContent = Math.round(percent) + '%';
    progressMessage.textContent = message;

    // ìƒíƒœì— ë”°ë¼ ìƒ‰ìƒ ë³€ê²½
    if (status === 'error') {
        progressBar.style.background = '#ef4444';
        progressStatus.textContent = 'âŒ ì˜¤ë¥˜';
        progressStatus.style.color = '#ef4444';
    } else if (status === 'completed') {
        progressBar.style.background = '#10b981';
        progressStatus.textContent = 'âœ“ ì™„ë£Œ';
        progressStatus.style.color = '#10b981';
    } else if (status === 'downloading') {
        progressBar.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
        progressStatus.textContent = 'â¬ ë‹¤ìš´ë¡œë“œ ì¤‘';
        progressStatus.style.color = '#667eea';
    } else {
        progressBar.style.background = '#fbbf24';
        progressStatus.textContent = 'â³ ì¤€ë¹„ ì¤‘';
        progressStatus.style.color = '#fbbf24';
    }
}

// Load and display download history
async function loadDownloadHistory() {
    try {
        const response = await fetch('/api/ytdl/history');
        const history = await response.json();
        displayHistory(history);
    } catch (error) {
        document.getElementById('download-history').innerHTML =
            '<div class="alert error">ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + error.message + '</div>';
    }
}

function displayHistory(history) {
    const container = document.getElementById('download-history');

    if (history.length === 0) {
        container.innerHTML = '<div class="info">ì•„ì§ ë‹¤ìš´ë¡œë“œ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
    }

    let html = '';
    history.forEach((record, index) => {
        const date = new Date(record.timestamp).toLocaleString('ko-KR');
        const urls = record.urls.join('<br>');

        html += `
            <div class="history-item">
                <div class="history-header">
                    <span class="timestamp">${date}</span>
                    <button class="delete-btn" onclick="deleteFiles(${index}, ${JSON.stringify(record.files).replace(/"/g, '&quot;')})">
                        íŒŒì¼ ì‚­ì œ
                    </button>
                </div>
                <div class="history-urls">
                    <strong>URL:</strong><br>
                    <small>${urls}</small>
                </div>
                <div class="history-files">
                    <strong>íŒŒì¼ (${record.files.length}ê°œ):</strong>
                    <ul class="file-list small">
                        ${record.files.map(file => `<li><code>${file}</code></li>`).join('')}
                    </ul>
                </div>
                <div class="history-settings">
                    <small>ì„¤ì •: ${record.settings.sub_langs} | ${record.settings.download_subs ? 'ìë§‰O' : 'ìë§‰X'}</small>
                </div>
            </div>
        `;
    });

    container.innerHTML = html;
}

async function deleteFiles(recordIndex, filePaths) {
    if (!confirm('ì„ íƒí•œ íŒŒì¼ë“¤ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
    }

    try {
        const response = await fetch('/api/ytdl/files', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(filePaths)
        });

        const result = await response.json();

        if (result.errors && result.errors.length > 0) {
            alert('ì¼ë¶€ íŒŒì¼ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:\n' + result.errors.join('\n'));
        } else {
            alert(`${result.deleted.length}ê°œ íŒŒì¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
        }

        // Reload history to reflect changes
        loadDownloadHistory();
    } catch (error) {
        alert('íŒŒì¼ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
    }
}
</script>

<style>
.history-item {
    border: 1px solid #ddd;
    border-radius: 4px;
    margin-bottom: 10px;
    padding: 15px;
    background: #f9f9f9;
}

.history-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.timestamp {
    font-weight: bold;
    color: #666;
}

.delete-btn {
    background: #ff4444;
    color: white;
    border: none;
    padding: 5px 10px;
    border-radius: 3px;
    cursor: pointer;
    font-size: 12px;
}

.delete-btn:hover {
    background: #cc0000;
}

.history-urls, .history-files, .history-settings {
    margin-bottom: 8px;
}

.file-list.small {
    font-size: 11px;
    max-height: 100px;
    overflow-y: auto;
}

.loading {
    text-align: center;
    color: #666;
    font-style: italic;
}

.info {
    text-align: center;
    color: #888;
    font-style: italic;
    padding: 20px;
}

/* ì§„í–‰ìœ¨ í‘œì‹œ ìŠ¤íƒ€ì¼ */
#progress-container {
    background: rgba(0, 0, 0, 0.2);
    padding: 20px;
    border-radius: 8px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.progress-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.progress-header h3 {
    margin: 0;
    font-size: 1.2rem;
    color: #e0e6ed;
}

#progress-status {
    font-weight: 600;
    font-size: 1rem;
}

.progress-bar-container {
    width: 100%;
    height: 30px;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 15px;
    overflow: hidden;
    margin-bottom: 10px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.progress-bar {
    height: 100%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: width 0.3s ease;
    border-radius: 15px;
}

#progress-text {
    color: white;
    font-weight: 600;
    font-size: 0.9rem;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
}

.progress-message {
    color: #c8d8e8;
    font-size: 0.95rem;
    text-align: center;
    margin-top: 10px;
}

#download-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

</style>

</body>
</html>
