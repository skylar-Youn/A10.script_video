<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì˜ìƒ ë¶„ì„ê¸°</title>

    <style>
        /* ë¡œì»¬ í•œêµ­ì–´ í°íŠ¸ ì •ì˜ */
        @font-face {
            font-family: 'Noto Sans KR Local';
            src: url('/static/fonts/NotoSansKR-Regular.ttf') format('truetype');
            font-weight: 400;
            font-style: normal;
            font-display: swap;
        }

        /* ë¡œì»¬ ì¼ë³¸ì–´ í°íŠ¸ ì •ì˜ */
        @font-face {
            font-family: 'Noto Sans JP Local';
            src: url('/static/fonts/NotoSansJP-Regular.ttf') format('truetype');
            font-weight: 400;
            font-style: normal;
            font-display: swap;
        }

        /* ì „ì²´ í˜ì´ì§€ì— ê¸°ë³¸ í°íŠ¸ ì ìš© */
        body, * {
            font-family: 'Noto Sans KR Local', 'Noto Sans JP Local', 'ë§‘ì€ ê³ ë”•', 'Malgun Gothic', Arial, 'Apple Color Emoji', 'Segoe UI Emoji', 'Noto Color Emoji', 'Segoe UI Symbol', sans-serif !important;
        }

        /* ë¹„ë””ì˜¤ ì˜¤ë²„ë ˆì´ í…ìŠ¤íŠ¸ì— í°íŠ¸ ê°•ì œ ì ìš© */
        #video-container .video-title-overlay,
        #video-container .video-subtitle-overlay,
        #video-container .custom-subtitle-overlay {
            font-family: 'Noto Sans KR Local', 'Noto Sans JP Local', 'ë§‘ì€ ê³ ë”•', 'Malgun Gothic', Arial, 'Apple Color Emoji', 'Segoe UI Emoji', 'Noto Color Emoji', 'Segoe UI Symbol', sans-serif;
        }
    </style>

    <link rel="stylesheet" href="/static/style.css">
    <style>
        /* íƒ€ì„ë¼ì¸ ì—ë””í„° ìŠ¤íƒ€ì¼ */
        .timeline-editor {
            background: #1a1a2e;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .timeline-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
        }

        .playback-controls {
            display: flex;
            gap: 8px;
        }

        .playback-controls button,
        .zoom-controls button {
            background: #2d3748;
            border: 1px solid #4a5568;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            color: #e2e8f0;
            font-size: 16px;
            transition: all 0.2s;
        }

        .playback-controls button:hover,
        .zoom-controls button:hover {
            background: #4a5568;
            transform: scale(1.05);
        }

        .zoom-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .zoom-controls label {
            color: #a0aec0;
            font-size: 14px;
        }

        .zoom-controls input[type="range"] {
            width: 150px;
        }

        #zoom-display {
            color: #e2e8f0;
            font-weight: bold;
            min-width: 40px;
        }

        .time-display {
            display: flex;
            gap: 5px;
            align-items: center;
            color: #e2e8f0;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            font-weight: bold;
        }

        .timeline-container {
            overflow-x: auto;
            overflow-y: hidden;
            border: 1px solid #2d3748;
            border-radius: 6px;
            background: #16213e;
            position: relative;
            max-width: 100%;  /* ë¶€ëª¨ ì»¨í…Œì´ë„ˆì— ë§ì¶¤ */
        }

        .timeline-content {
            position: relative;
            min-height: 300px;  /* ë†’ì´ ì¤„ì„ */
            width: max-content;  /* ë‚´ìš©ë¬¼ í¬ê¸°ì— ë§ì¶° ëŠ˜ì–´ë‚¨ */
            min-width: 100%;  /* ìµœì†Œ ë„ˆë¹„ëŠ” ì»¨í…Œì´ë„ˆ ë„ˆë¹„ */
        }

        .timeline-ruler {
            display: flex;  /* ìˆ˜í‰ ë ˆì´ì•„ì›ƒ */
            height: 30px;
            background: #0f172a;
            border-bottom: 2px solid #2d3748;
        }

        .timeline-ruler-header {
            width: 180px;  /* íŠ¸ë™ í—¤ë”ì™€ ë™ì¼í•œ ë„ˆë¹„ */
            flex-shrink: 0;
            background: #0f172a;
            border-right: 1px solid #334155;
        }

        .timeline-ruler-content {
            flex: 1;
            position: relative;
            background: #0f172a;
        }

        .time-marker {
            position: absolute;
            top: 0;
            color: #94a3b8;
            font-size: 11px;
            padding: 5px;
            border-left: 1px solid #334155;
        }

        .time-marker.major {
            color: #e2e8f0;
            font-weight: bold;
            border-left: 2px solid #475569;
        }

        .time-marker.zero-marker {
            border-left: 3px solid #ef4444;
        }

        /* ì¬ìƒ í—¤ë“œ */
        .playhead {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #ef4444;
            z-index: 1000;
            pointer-events: none;
            transition: left 0.1s linear;
        }

        .playhead::before {
            content: '';
            position: absolute;
            top: -8px;
            left: -6px;
            width: 0;
            height: 0;
            border-left: 7px solid transparent;
            border-right: 7px solid transparent;
            border-top: 8px solid #ef4444;
        }

        .playhead-time {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: #ef4444;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
        }

        .timeline-track {
            border-bottom: 1px solid #2d3748;
            height: 50px;  /* ê³ ì • ë†’ì´ */
            position: relative;
            display: flex;  /* ìˆ˜í‰ ë ˆì´ì•„ì›ƒ */
        }

        .track-header {
            display: flex;
            flex-direction: row;  /* ê°€ë¡œ ë°°ì¹˜ */
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #1e293b;
            border-right: 1px solid #334155;  /* ì˜¤ë¥¸ìª½ ê²½ê³„ì„  */
            width: 180px;  /* ê³ ì • ë„ˆë¹„ */
            flex-shrink: 0;  /* ì¶•ì†Œ ë°©ì§€ */
            gap: 8px;
        }

        .track-header label {
            color: #e2e8f0;
            font-size: 14px;
            font-weight: 500;
        }

        .track-title {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }

        .track-controls {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .track-controls button {
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 16px;
            padding: 4px;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .track-controls button:hover {
            opacity: 1;
        }

        .audio-edit-toolbar {
            display: none;  /* í¸ì§‘ íˆ´ë°” ìˆ¨ê¹€ */
            justify-content: space-between;
            align-items: center;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 6px;
            padding: 6px 10px;
            margin: 6px 12px;
            gap: 10px;
            flex-wrap: wrap;
        }

        .audio-edit-toolbar .audio-selection-info {
            color: #f8fafc;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .audio-edit-toolbar .audio-edit-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .audio-action-btn {
            background: rgba(37, 99, 235, 0.15);
            border: 1px solid rgba(59, 130, 246, 0.4);
            color: #bfdbfe;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .audio-action-btn:hover:not(:disabled) {
            background: rgba(59, 130, 246, 0.25);
            transform: translateY(-1px);
        }

        .audio-action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .audio-selection-marker {
            position: absolute;
            top: -6px;
            width: 2px;
            height: calc(100% + 12px);
            background: #f97316;
            pointer-events: none;
            box-shadow: 0 0 8px rgba(249, 115, 22, 0.6);
            z-index: 5;
        }

        .track-content {
            height: 100%;  /* ë¶€ëª¨ ë†’ì´ì— ë§ì¶¤ */
            position: relative;
            background: rgba(255, 255, 255, 0.02);
            flex: 1;  /* ë‚¨ì€ ê³µê°„ ì±„ìš°ê¸° */
            overflow: visible;  /* ìº”ë²„ìŠ¤ê°€ ì»¨í…Œì´ë„ˆ ë°–ìœ¼ë¡œ í‘œì‹œë˜ë„ë¡ í—ˆìš© */
        }

        .track-content canvas {
            width: auto;  /* JavaScriptì—ì„œ ì„¤ì •í•œ ë„ˆë¹„ ì‚¬ìš© */
            display: block;
        }

        .playhead {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #ef4444;
            z-index: 100;
            pointer-events: none;
        }

        .playhead::before {
            content: '';
            position: absolute;
            top: -5px;
            left: -5px;
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 8px solid #ef4444;
        }
    </style>
    <!-- JSZip library for ZIP file creation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body>
<div class="container">
    <header class="header">
        <h1>ì˜ìƒ ë¶„ì„ê¸°</h1>
        <nav class="nav-links">
            <a href="/ytdl" class="nav-link">â¬‡ï¸ ë‹¤ìš´ë¡œë“œ ë„êµ¬</a>
            <a href="/text-removal" class="nav-link">ğŸ§½ ì˜ìƒì—ì„œ ê¸€ì ì§€ìš°ê¸°</a>
            <a href="/video-analyzer" class="nav-link {% if nav_active == 'video_analyzer' %}active{% endif %}">ğŸ“¹ ì˜ìƒ ë¶„ì„ê¸°</a>
            <a href="/analysis" class="nav-link">ğŸ“Š ì˜ìƒë©”ì´ì»¤</a>
            <a href="/" class="nav-link">ğŸ  AI ì‡¼ì¸  ë©”ì´ì»¤</a>
            <a href="/similarity" class="nav-link">ğŸï¸ ì˜ìƒ ìœ ì‚¬ë„ ê²€ì‚¬</a>
            <a href="/copyright" class="nav-link">ğŸ›¡ï¸ ì €ì‘ê¶Œ ê²€ì‚¬</a>
        </nav>
    </header>

    <section class="panel">
        <h2>ë‹¤ìš´ë¡œë“œí•œ ì˜ìƒ ìë§‰ ê°€ì ¸ì˜¤ê¸°</h2>
        <p class="panel-sub">ë¡œì»¬ì— ì €ì¥ëœ ì˜ìƒ íŒŒì¼ì—ì„œ ìë§‰ì„ ì¶”ì¶œí•˜ê±°ë‚˜, í•¨ê»˜ ë‹¤ìš´ë¡œë“œëœ ìë§‰ íŒŒì¼(.srt, .vtt ë“±)ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.</p>

        <form method="post" action="/video-analyzer" enctype="multipart/form-data" class="analyzer-form">
            <div class="field">
                <label for="video_file">ì˜ìƒ íŒŒì¼ ì„ íƒ</label>
                <input type="file" id="video_file" name="video_file" accept="video/*">
                <span class="hint-text">ë˜ëŠ” ì•„ë˜ ì˜ìƒí´ë”ì—ì„œ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.</span>
            </div>

            <div class="field">
                <label for="video_path">ì˜ìƒ íŒŒì¼ ë˜ëŠ” í´ë” ê²½ë¡œ</label>
                <input type="text" id="video_path" name="video_path" value="{{ form_values.video_path }}" placeholder="/path/to/videos ë˜ëŠ” /path/to/video.mp4">
                <span class="hint-text">ğŸ“ í´ë” ê²½ë¡œ ë˜ëŠ” ğŸ“¹ ì˜ìƒ íŒŒì¼ ê²½ë¡œë¥¼ ì…ë ¥í•˜ì„¸ìš”. ì˜ìƒ ë¯¸ë¦¬ë³´ê¸°ì—ì„œ ì„ íƒ ì‹œ ìë™ìœ¼ë¡œ ì…ë ¥ë©ë‹ˆë‹¤.</span>
            </div>

            <div class="field">
                <label for="subtitle_file">ìë§‰ íŒŒì¼ ì„ íƒ (ì„ íƒì‚¬í•­)</label>
                <input type="file" id="subtitle_file" name="subtitle_file" accept=".srt,.vtt,.ass,.ssa,.sub">
                <span class="hint-text">ìë§‰ íŒŒì¼ì´ ìˆë‹¤ë©´ ì—…ë¡œë“œí•˜ì„¸ìš”. ì—†ìœ¼ë©´ ìë™ìœ¼ë¡œ ì°¾ìŠµë‹ˆë‹¤.</span>
            </div>

            <div class="field inline">
                <label for="search_directory">ìë§‰ ê²€ìƒ‰ í´ë”</label>
                <input type="text" id="search_directory" name="search_directory" value="{{ form_values.search_directory }}" placeholder="ìë§‰ íŒŒì¼ì´ ìˆëŠ” í´ë”">
                <label><input type="checkbox" name="auto_search" {% if form_values.auto_search %}checked{% endif %}> ìë™ ê²€ìƒ‰</label>
            </div>

            <button type="submit">ìë§‰ ë¶ˆëŸ¬ì˜¤ê¸°</button>
        </form>
    </section>

    <!-- AI ë¶„ì„ ë¹ ë¥¸ ì ‘ê·¼ ë²„íŠ¼ -->
    <section class="panel" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: 2px solid rgba(102, 126, 234, 0.5);">
        <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; margin-bottom: 15px;">
            <button onclick="scrollToFrameAnalysis()" class="btn-primary" style="padding: 15px 30px; font-size: 1.1rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: 2px solid rgba(255, 255, 255, 0.3); box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);">
                ğŸ¤– AI í”„ë ˆì„ ë¶„ì„
            </button>
            <button onclick="scrollToSubtitleAnalysis()" class="btn-primary" style="padding: 15px 30px; font-size: 1.1rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: 2px solid rgba(255, 255, 255, 0.3); box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);">
                ğŸ¤– AI ìë§‰ ë¶„ì„
            </button>
        </div>
        <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-top: 10px;">
            <button onclick="clearFrameAnalysisContent()" class="btn-secondary" style="padding: 8px 16px; font-size: 0.9rem; background: #ef4444; border: 1px solid rgba(255, 255, 255, 0.3);">
                ğŸ—‘ï¸ í”„ë ˆì„ ë¶„ì„ ë‚´ìš© ë¹„ìš°ê¸°
            </button>
            <button onclick="clearSubtitleAnalysisContent()" class="btn-secondary" style="padding: 8px 16px; font-size: 0.9rem; background: #ef4444; border: 1px solid rgba(255, 255, 255, 0.3);">
                ğŸ—‘ï¸ ìë§‰ ë¶„ì„ ë‚´ìš© ë¹„ìš°ê¸°
            </button>
        </div>
        <p style="text-align: center; color: rgba(255, 255, 255, 0.8); margin-top: 10px; margin-bottom: 0; font-size: 0.9rem;">
            ğŸ’¡ ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ í•´ë‹¹ AI ë¶„ì„ ì„¹ì…˜ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤
        </p>
    </section>

    <section class="panel">
        <h2>ì˜ìƒ íŒŒì¼ ëª©ë¡</h2>
        <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
            <button type="button" onclick="loadVideoFilesFromFolder()" class="btn-primary" style="padding: 8px 16px;">ğŸ“ í´ë” ë‚´ìš© ë¶ˆëŸ¬ì˜¤ê¸°</button>
            <button type="button" id="merge-videos-btn" onclick="mergeSelectedVideos()" class="btn-secondary" style="padding: 8px 16px; background: #10b981; display: none;">ğŸ¬ ì„ íƒëœ ì˜ìƒ í•©ì¹˜ê¸° (<span id="selected-count">0</span>ê°œ)</button>
            <span id="folder-status" style="color: #a0aec0; font-size: 0.9rem;"></span>
        </div>
        <div id="video-list-container">
            <div class="empty-state">ì˜ìƒí´ë” ê²½ë¡œë¥¼ ì…ë ¥í•˜ê³  'í´ë” ë‚´ìš© ë¶ˆëŸ¬ì˜¤ê¸°' ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</div>
        </div>
    </section>

    <!-- ì˜ìƒ ë¯¸ë¦¬ë³´ê¸° ì„¹ì…˜ -->
    <section class="panel" id="video-preview-section" style="display: none;">
        <h2>ì˜ìƒ ë¯¸ë¦¬ë³´ê¸°</h2>

        <!-- í…ìŠ¤íŠ¸ ì˜¤ë²„ë ˆì´ ì»¨íŠ¸ë¡¤ íŒ¨ë„ -->
        <div class="text-overlay-controls" style="margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; border: 2px solid rgba(102, 126, 234, 0.5);">
            <h3 style="margin: 0 0 15px 0; color: white;">ğŸ¨ í…ìŠ¤íŠ¸ ì˜¤ë²„ë ˆì´</h3>

            <!-- AI ì œëª©/ë¶€ì œëª© ìƒì„± ë²„íŠ¼ -->
            <div style="margin-bottom: 15px; padding: 12px; background: rgba(0, 0, 0, 0.3); border-radius: 6px;">
                <div style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
                    <div style="flex: 1;">
                        <label style="display: block; color: white; margin-bottom: 5px; font-size: 0.9rem;">ğŸ¤– AI ëª¨ë¸ ì„ íƒ</label>
                        <select id="ai-model-select" style="width: 100%; padding: 8px; background: rgba(255, 255, 255, 0.9); border: none; border-radius: 4px; color: #1a1a1a; font-size: 14px; cursor: pointer;">
                            <option value="claude">Claude 3.5 Sonnet (Anthropic)</option>
                            <option value="gpt">GPT-4o Mini (OpenAI)</option>
                        </select>
                    </div>
                </div>
                <button onclick="generateAITitleSubtitle()" class="btn-primary" style="padding: 10px 20px; width: 100%; background: linear-gradient(135deg, #FF6B6B 0%, #FFE66D 100%); color: #1a1a1a; font-weight: bold; font-size: 16px; border: none; border-radius: 6px; cursor: pointer; transition: transform 0.2s;">
                    ğŸ¤– AI ì œëª© & ë¶€ì œëª© ë§Œë“¤ê¸°
                </button>
                <div id="ai-generation-status" style="margin-top: 8px; padding: 10px; background: rgba(255, 255, 255, 0.1); border-radius: 4px; color: #94a3b8; font-size: 0.85rem; text-align: center; display: none;">
                    <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <div class="spinner" style="width: 16px; height: 16px; border: 2px solid rgba(255, 255, 255, 0.3); border-top-color: #60a5fa; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <span id="ai-status-text">â³ AIê°€ ì œëª©ê³¼ ë¶€ì œëª©ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</span>
                    </div>
                    <div id="ai-status-timer" style="margin-top: 5px; font-size: 0.75rem; color: #64748b;"></div>
                </div>
                <style>
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                </style>
            </div>

            <!-- ì œëª© ì»¨íŠ¸ë¡¤ -->
            <div style="margin-bottom: 15px; padding: 12px; background: rgba(0, 0, 0, 0.3); border-radius: 6px;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                    <label style="color: white; font-weight: bold; margin: 0;">ğŸ“ ì œëª©</label>
                    <input type="checkbox" id="hide-title-overlay" style="cursor: pointer;" />
                    <label for="hide-title-overlay" style="cursor: pointer; color: #94a3b8; font-size: 0.85rem; margin: 0;" title="ì²´í¬í•˜ë©´ ì¶œì²˜ ì˜¤ë²„ë ˆì´ë¥¼ ìˆ¨ê¹ë‹ˆë‹¤">ğŸ™ˆ í™”ë©´ì—ì„œ ìˆ¨ê¸°ê¸°</label>
                </div>
                <input type="text" id="overlay-title-input" placeholder="ì˜ìƒ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”"
                       style="width: 100%; padding: 8px; background: rgba(255, 255, 255, 0.9); border: none; border-radius: 4px; margin-bottom: 8px; color: #1a1a1a;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                    <div>
                        <label style="color: #1a1a1a; font-size: 0.9rem; background: rgba(255, 255, 255, 0.9); padding: 2px 6px; border-radius: 3px; display: inline-block; margin-bottom: 4px;">í¬ê¸°: <span id="title-size-display">48px</span></label>
                        <input type="range" id="overlay-title-size" min="24" max="120" value="48" step="2"
                               style="width: 100%;">
                    </div>
                    <div>
                        <label style="color: #1a1a1a; font-size: 0.9rem; background: rgba(255, 255, 255, 0.9); padding: 2px 6px; border-radius: 3px; display: inline-block; margin-bottom: 4px;">ìƒ‰ìƒ</label>
                        <input type="color" id="overlay-title-color" value="#ffffff"
                               style="width: 100%; height: 36px; border: none; border-radius: 4px;">
                    </div>
                    <div>
                        <label style="color: #1a1a1a; font-size: 0.9rem; background: rgba(255, 255, 255, 0.9); padding: 2px 6px; border-radius: 3px; display: inline-block; margin-bottom: 4px;">ì •ì  íš¨ê³¼</label>
                        <select id="overlay-title-static-effect"
                                style="width: 100%; padding: 6px; background: rgba(255, 255, 255, 0.9); border: none; border-radius: 4px; color: #1a1a1a;">
                            <option value="none">ì—†ìŒ</option>
                            <option value="outline" selected>ì™¸ê³½ì„ </option>
                            <option value="shadow">ê·¸ë¦¼ì</option>
                            <option value="glow">ê¸€ë¡œìš°</option>
                            <option value="gradient">ê·¸ë¼ë°ì´ì…˜</option>
                            <option value="neon">ë„¤ì˜¨</option>
                        </select>
                    </div>
                    <div>
                        <label style="color: #1a1a1a; font-size: 0.9rem; background: rgba(255, 255, 255, 0.9); padding: 2px 6px; border-radius: 3px; display: inline-block; margin-bottom: 4px;">ë™ì  íš¨ê³¼</label>
                        <select id="overlay-title-dynamic-effect"
                                style="width: 100%; padding: 6px; background: rgba(255, 255, 255, 0.9); border: none; border-radius: 4px; color: #1a1a1a;">
                            <option value="none" selected>ì—†ìŒ</option>
                            <option value="fade">âœ¨ í˜ì´ë“œ</option>
                            <option value="slide-in">â¡ï¸ ìŠ¬ë¼ì´ë“œ ì¸</option>
                            <option value="slide-up">â¬†ï¸ ìŠ¬ë¼ì´ë“œ ì—…</option>
                            <option value="bounce">â¬‡ï¸ ë°”ìš´ìŠ¤</option>
                            <option value="scale">ğŸ” ìŠ¤ì¼€ì¼</option>
                            <option value="glow">ğŸ’« ê¸€ë¡œìš°</option>
                            <option value="pulse">ğŸ’“ í„ìŠ¤</option>
                        </select>
                    </div>
                </div>
                <button onclick="applyTitle()" class="btn-primary" style="margin-top: 10px; padding: 8px 16px; width: 100%; background: #10b981;">âœ… ì œëª© ì ìš©</button>
            </div>

            <!-- ë¶€ì œëª© ì»¨íŠ¸ë¡¤ -->
            <div style="margin-bottom: 15px; padding: 12px; background: rgba(0, 0, 0, 0.3); border-radius: 6px;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                    <label style="color: white; font-weight: bold; margin: 0;">ğŸ“‹ ë¶€ì œëª©</label>
                    <input type="checkbox" id="hide-subtitle-overlay" style="cursor: pointer;" />
                    <label for="hide-subtitle-overlay" style="cursor: pointer; color: #94a3b8; font-size: 0.85rem; margin: 0;" title="ì²´í¬í•˜ë©´ ì¶œì²˜ ì˜¤ë²„ë ˆì´ë¥¼ ìˆ¨ê¹ë‹ˆë‹¤">ğŸ™ˆ í™”ë©´ì—ì„œ ìˆ¨ê¸°ê¸°</label>
                </div>
                <input type="text" id="overlay-subtitle-input" placeholder="ë¶€ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”"
                       style="width: 100%; padding: 8px; background: rgba(255, 255, 255, 0.9); border: none; border-radius: 4px; margin-bottom: 8px; color: #1a1a1a;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                    <div>
                        <label style="color: #1a1a1a; font-size: 0.9rem; background: rgba(255, 255, 255, 0.9); padding: 2px 6px; border-radius: 3px; display: inline-block; margin-bottom: 4px;">í¬ê¸°: <span id="subtitle-size-display">32px</span></label>
                        <input type="range" id="overlay-subtitle-size" min="20" max="96" value="32" step="2"
                               style="width: 100%;">
                    </div>
                    <div>
                        <label style="color: #1a1a1a; font-size: 0.9rem; background: rgba(255, 255, 255, 0.9); padding: 2px 6px; border-radius: 3px; display: inline-block; margin-bottom: 4px;">ìƒ‰ìƒ</label>
                        <input type="color" id="overlay-subtitle-color" value="#ffe14d"
                               style="width: 100%; height: 36px; border: none; border-radius: 4px;">
                    </div>
                    <div>
                        <label style="color: #1a1a1a; font-size: 0.9rem; background: rgba(255, 255, 255, 0.9); padding: 2px 6px; border-radius: 3px; display: inline-block; margin-bottom: 4px;">ì •ì  íš¨ê³¼</label>
                        <select id="overlay-subtitle-static-effect"
                                style="width: 100%; padding: 6px; background: rgba(255, 255, 255, 0.9); border: none; border-radius: 4px; color: #1a1a1a;">
                            <option value="none">ì—†ìŒ</option>
                            <option value="outline" selected>ì™¸ê³½ì„ </option>
                            <option value="shadow">ê·¸ë¦¼ì</option>
                            <option value="glow">ê¸€ë¡œìš°</option>
                            <option value="gradient">ê·¸ë¼ë°ì´ì…˜</option>
                            <option value="neon">ë„¤ì˜¨</option>
                        </select>
                    </div>
                    <div>
                        <label style="color: #1a1a1a; font-size: 0.9rem; background: rgba(255, 255, 255, 0.9); padding: 2px 6px; border-radius: 3px; display: inline-block; margin-bottom: 4px;">ë™ì  íš¨ê³¼</label>
                        <select id="overlay-subtitle-dynamic-effect"
                                style="width: 100%; padding: 6px; background: rgba(255, 255, 255, 0.9); border: none; border-radius: 4px; color: #1a1a1a;">
                            <option value="none" selected>ì—†ìŒ</option>
                            <option value="fade">âœ¨ í˜ì´ë“œ</option>
                            <option value="slide-in">â¡ï¸ ìŠ¬ë¼ì´ë“œ ì¸</option>
                            <option value="slide-down">â¬‡ï¸ ìŠ¬ë¼ì´ë“œ ë‹¤ìš´</option>
                            <option value="slide-up">â¬†ï¸ ìŠ¬ë¼ì´ë“œ ì—…</option>
                            <option value="bounce">â¬‡ï¸ ë°”ìš´ìŠ¤</option>
                            <option value="scale">ğŸ” ìŠ¤ì¼€ì¼</option>
                            <option value="glow">ğŸ’« ê¸€ë¡œìš°</option>
                            <option value="pulse">ğŸ’“ í„ìŠ¤</option>
                        </select>
                    </div>
                </div>
                <button onclick="applySubtitle()" class="btn-primary" style="margin-top: 10px; padding: 8px 16px; width: 100%; background: #10b981;">âœ… ë¶€ì œëª© ì ìš©</button>
            </div>

            <!-- ì¶œì²˜ í‘œì‹œ ì»¨íŠ¸ë¡¤ -->
            <div style="margin-bottom: 15px; padding: 12px; background: rgba(0, 0, 0, 0.3); border-radius: 6px;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                    <label style="color: white; font-weight: bold; margin: 0;">ğŸ”— ì¶œì²˜ í‘œì‹œ</label>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="source-overlay-hide" style="cursor: pointer; width: 16px; height: 16px;">
                        <label for="source-overlay-hide" style="cursor: pointer; color: #94a3b8; font-size: 0.85rem; margin: 0;" title="ì²´í¬í•˜ë©´ ì¶œì²˜ ì˜¤ë²„ë ˆì´ë¥¼ ìˆ¨ê¹ë‹ˆë‹¤">ğŸ™ˆ í™”ë©´ì—ì„œ ìˆ¨ê¸°ê¸°</label>
                    </div>
                </div>
                <input type="text" id="overlay-source-input" placeholder="ì¶œì²˜ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì¶œì²˜: YouTube)"
                       style="width: 100%; padding: 8px; background: rgba(255, 255, 255, 0.9); border: none; border-radius: 4px; margin-bottom: 8px; color: #1a1a1a;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                    <div>
                        <label style="color: #1a1a1a; font-size: 0.9rem; background: rgba(255, 255, 255, 0.9); padding: 2px 6px; border-radius: 3px; display: inline-block; margin-bottom: 4px;">í¬ê¸°: <span id="source-size-display">18px</span></label>
                        <input type="range" id="overlay-source-size" min="12" max="48" value="18" step="2"
                               style="width: 100%;">
                    </div>
                    <div>
                        <label style="color: #1a1a1a; font-size: 0.9rem; background: rgba(255, 255, 255, 0.9); padding: 2px 6px; border-radius: 3px; display: inline-block; margin-bottom: 4px;">ìƒ‰ìƒ</label>
                        <input type="color" id="overlay-source-color" value="#cccccc"
                               style="width: 100%; height: 36px; border: none; border-radius: 4px;">
                    </div>
                    <div>
                        <label style="color: #1a1a1a; font-size: 0.9rem; background: rgba(255, 255, 255, 0.9); padding: 2px 6px; border-radius: 3px; display: inline-block; margin-bottom: 4px;">X ìœ„ì¹˜ (%)</label>
                        <input type="number" id="overlay-source-x" min="0" max="100" value="50"
                               style="width: 100%; padding: 6px; background: rgba(255, 255, 255, 0.9); border: none; border-radius: 4px; color: #1a1a1a;">
                    </div>
                    <div>
                        <label style="color: #1a1a1a; font-size: 0.9rem; background: rgba(255, 255, 255, 0.9); padding: 2px 6px; border-radius: 3px; display: inline-block; margin-bottom: 4px;">Y ìœ„ì¹˜ (%)</label>
                        <input type="number" id="overlay-source-y" min="0" max="100" value="95"
                               style="width: 100%; padding: 6px; background: rgba(255, 255, 255, 0.9); border: none; border-radius: 4px; color: #1a1a1a;">
                    </div>
                    <div>
                        <label style="color: #1a1a1a; font-size: 0.9rem; background: rgba(255, 255, 255, 0.9); padding: 2px 6px; border-radius: 3px; display: inline-block; margin-bottom: 4px;">ì •ì  íš¨ê³¼</label>
                        <select id="overlay-source-static-effect"
                                style="width: 100%; padding: 6px; background: rgba(255, 255, 255, 0.9); border: none; border-radius: 4px; color: #1a1a1a;">
                            <option value="none">ì—†ìŒ</option>
                            <option value="outline" selected>ì™¸ê³½ì„ </option>
                            <option value="shadow">ê·¸ë¦¼ì</option>
                            <option value="glow">ê¸€ë¡œìš°</option>
                            <option value="gradient">ê·¸ë¼ë°ì´ì…˜</option>
                            <option value="neon">ë„¤ì˜¨</option>
                        </select>
                    </div>
                    <div>
                        <label style="color: #1a1a1a; font-size: 0.9rem; background: rgba(255, 255, 255, 0.9); padding: 2px 6px; border-radius: 3px; display: inline-block; margin-bottom: 4px;">ë™ì  íš¨ê³¼</label>
                        <select id="overlay-source-dynamic-effect"
                                style="width: 100%; padding: 6px; background: rgba(255, 255, 255, 0.9); border: none; border-radius: 4px; color: #1a1a1a;">
                            <option value="none" selected>ì—†ìŒ</option>
                            <option value="fade">âœ¨ í˜ì´ë“œ</option>
                            <option value="slide-in">â¡ï¸ ìŠ¬ë¼ì´ë“œ ì¸</option>
                            <option value="slide-up">â¬†ï¸ ìŠ¬ë¼ì´ë“œ ì—…</option>
                            <option value="bounce">â¬‡ï¸ ë°”ìš´ìŠ¤</option>
                            <option value="scale">ğŸ” ìŠ¤ì¼€ì¼</option>
                            <option value="glow">ğŸ’« ê¸€ë¡œìš°</option>
                            <option value="pulse">ğŸ’“ í„ìŠ¤</option>
                        </select>
                    </div>
                </div>
                <button onclick="applySource()" class="btn-primary" style="margin-top: 10px; padding: 8px 16px; width: 100%; background: #10b981;">âœ… ì¶œì²˜ ì ìš©</button>
            </div>

            <!-- ë©”ì¸ ìë§‰ ì»¨íŠ¸ë¡¤ (ì¼ë³¸ì–´) -->
            <div style="margin-bottom: 15px; padding: 12px; background: rgba(0, 0, 0, 0.3); border-radius: 6px;">
                <label style="display: block; color: white; margin-bottom: 8px; font-weight: bold;">ğŸŒ ë©”ì¸ ìë§‰ (ì¼ë³¸ì–´)</label>
                <textarea id="overlay-japanese-input" placeholder="ãƒ¡ã‚¤ãƒ³å­—å¹•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" rows="2"
                       style="width: 100%; padding: 8px; background: rgba(255, 255, 255, 0.9); border: none; border-radius: 4px; margin-bottom: 8px; font-family: 'Noto Sans JP', 'Yu Gothic', Meiryo, sans-serif; resize: vertical; color: #1a1a1a;"></textarea>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                    <div>
                        <label style="color: #1a1a1a; font-size: 0.9rem; background: rgba(255, 255, 255, 0.9); padding: 2px 6px; border-radius: 3px; display: inline-block; margin-bottom: 4px;">í¬ê¸°: <span id="japanese-size-display">50px</span></label>
                        <input type="range" id="overlay-japanese-size" min="18" max="96" value="50" step="2"
                               style="width: 100%;"
                               oninput="document.getElementById('japanese-size-display').textContent = this.value + 'px'">
                    </div>
                    <div>
                        <label style="color: #1a1a1a; font-size: 0.9rem; background: rgba(255, 255, 255, 0.9); padding: 2px 6px; border-radius: 3px; display: inline-block; margin-bottom: 4px;">ìƒ‰ìƒ</label>
                        <input type="color" id="overlay-japanese-color" value="#000000"
                               style="width: 100%; height: 36px; border: none; border-radius: 4px;">
                    </div>
                    <div>
                        <label style="color: #1a1a1a; font-size: 0.9rem; background: rgba(255, 255, 255, 0.9); padding: 2px 6px; border-radius: 3px; display: inline-block; margin-bottom: 4px;">X ìœ„ì¹˜ (%)</label>
                        <input type="number" id="overlay-japanese-x" min="0" max="100" value="50"
                               style="width: 100%; padding: 6px; background: rgba(255, 255, 255, 0.9); border: none; border-radius: 4px; color: #1a1a1a;">
                    </div>
                    <div>
                        <label style="color: #1a1a1a; font-size: 0.9rem; background: rgba(255, 255, 255, 0.9); padding: 2px 6px; border-radius: 3px; display: inline-block; margin-bottom: 4px;">Y ìœ„ì¹˜ (%)</label>
                        <input type="number" id="overlay-japanese-y" min="0" max="100" value="73"
                               style="width: 100%; padding: 6px; background: rgba(255, 255, 255, 0.9); border: none; border-radius: 4px; color: #1a1a1a;">
                    </div>
                    <div>
                        <label style="color: #1a1a1a; font-size: 0.9rem; background: rgba(255, 255, 255, 0.9); padding: 2px 6px; border-radius: 3px; display: inline-block; margin-bottom: 4px;">ì •ì  íš¨ê³¼</label>
                        <select id="overlay-japanese-static-effect"
                                style="width: 100%; padding: 6px; background: rgba(255, 255, 255, 0.9); border: none; border-radius: 4px; color: #1a1a1a;">
                            <option value="none">ì—†ìŒ</option>
                            <option value="outline" selected>ì™¸ê³½ì„ </option>
                            <option value="shadow">ê·¸ë¦¼ì</option>
                            <option value="glow">ê¸€ë¡œìš°</option>
                            <option value="gradient">ê·¸ë¼ë°ì´ì…˜</option>
                            <option value="neon">ë„¤ì˜¨</option>
                        </select>
                    </div>
                    <div>
                        <label style="color: #1a1a1a; font-size: 0.9rem; background: rgba(255, 255, 255, 0.9); padding: 2px 6px; border-radius: 3px; display: inline-block; margin-bottom: 4px;">ë™ì  íš¨ê³¼</label>
                        <select id="overlay-japanese-dynamic-effect"
                                style="width: 100%; padding: 6px; background: rgba(255, 255, 255, 0.9); border: none; border-radius: 4px; color: #1a1a1a;">
                            <option value="none" selected>ì—†ìŒ</option>
                            <option value="fade">âœ¨ í˜ì´ë“œ</option>
                            <option value="slide-in">â¡ï¸ ìŠ¬ë¼ì´ë“œ ì¸</option>
                            <option value="slide-up">â¬†ï¸ ìŠ¬ë¼ì´ë“œ ì—…</option>
                            <option value="bounce">â¬‡ï¸ ë°”ìš´ìŠ¤</option>
                            <option value="scale">ğŸ” ìŠ¤ì¼€ì¼</option>
                            <option value="glow">ğŸ’« ê¸€ë¡œìš°</option>
                            <option value="pulse">ğŸ’“ í„ìŠ¤</option>
                        </select>
                    </div>
                </div>
                <button onclick="applyJapaneseSubtitle()" class="btn-primary" style="margin-top: 10px; padding: 8px 16px; width: 100%; background: #10b981;">âœ… ë©”ì¸ ìë§‰ ì ìš©</button>
            </div>

            <!-- ì£¼ ìë§‰ ì»¨íŠ¸ë¡¤ -->
            <div style="margin-bottom: 15px; padding: 12px; background: rgba(0, 0, 0, 0.3); border-radius: 6px;">
                <label style="display: block; color: white; margin-bottom: 8px; font-weight: bold;">ğŸ“ ì£¼ ìë§‰</label>
                <textarea id="overlay-korean-input" placeholder="ì£¼ ìë§‰ì„ ì…ë ¥í•˜ì„¸ìš”" rows="2"
                       style="width: 100%; padding: 8px; background: rgba(255, 255, 255, 0.9); border: none; border-radius: 4px; margin-bottom: 8px; font-family: 'Nanum Gothic', sans-serif; resize: vertical; color: #1a1a1a;"></textarea>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                    <div>
                        <label style="color: #1a1a1a; font-size: 0.9rem; background: rgba(255, 255, 255, 0.9); padding: 2px 6px; border-radius: 3px; display: inline-block; margin-bottom: 4px;">í¬ê¸°: <span id="korean-size-display">50px</span></label>
                        <input type="range" id="overlay-korean-size" min="18" max="96" value="50" step="2"
                               style="width: 100%;">
                    </div>
                    <div>
                        <label style="color: #1a1a1a; font-size: 0.9rem; background: rgba(255, 255, 255, 0.9); padding: 2px 6px; border-radius: 3px; display: inline-block; margin-bottom: 4px;">ìƒ‰ìƒ</label>
                        <input type="color" id="overlay-korean-color" value="#ffffff"
                               style="width: 100%; height: 36px; border: none; border-radius: 4px;">
                    </div>
                    <div>
                        <label style="color: #1a1a1a; font-size: 0.9rem; background: rgba(255, 255, 255, 0.9); padding: 2px 6px; border-radius: 3px; display: inline-block; margin-bottom: 4px;">X ìœ„ì¹˜ (%)</label>
                        <input type="number" id="overlay-korean-x" min="0" max="100" value="50"
                               style="width: 100%; padding: 6px; background: rgba(255, 255, 255, 0.9); border: none; border-radius: 4px; color: #1a1a1a;">
                    </div>
                    <div>
                        <label style="color: #1a1a1a; font-size: 0.9rem; background: rgba(255, 255, 255, 0.9); padding: 2px 6px; border-radius: 3px; display: inline-block; margin-bottom: 4px;">Y ìœ„ì¹˜ (%)</label>
                        <input type="number" id="overlay-korean-y" min="0" max="100" value="65"
                               style="width: 100%; padding: 6px; background: rgba(255, 255, 255, 0.9); border: none; border-radius: 4px; color: #1a1a1a;">
                    </div>
                    <div>
                        <label style="color: #1a1a1a; font-size: 0.9rem; background: rgba(255, 255, 255, 0.9); padding: 2px 6px; border-radius: 3px; display: inline-block; margin-bottom: 4px;">ì •ì  íš¨ê³¼</label>
                        <select id="overlay-korean-static-effect"
                                style="width: 100%; padding: 6px; background: rgba(255, 255, 255, 0.9); border: none; border-radius: 4px; color: #1a1a1a;">
                            <option value="none">ì—†ìŒ</option>
                            <option value="outline" selected>ì™¸ê³½ì„ </option>
                            <option value="shadow">ê·¸ë¦¼ì</option>
                            <option value="glow">ê¸€ë¡œìš°</option>
                            <option value="gradient">ê·¸ë¼ë°ì´ì…˜</option>
                            <option value="neon">ë„¤ì˜¨</option>
                        </select>
                    </div>
                    <div>
                        <label style="color: #1a1a1a; font-size: 0.9rem; background: rgba(255, 255, 255, 0.9); padding: 2px 6px; border-radius: 3px; display: inline-block; margin-bottom: 4px;">ë™ì  íš¨ê³¼</label>
                        <select id="overlay-korean-dynamic-effect"
                                style="width: 100%; padding: 6px; background: rgba(255, 255, 255, 0.9); border: none; border-radius: 4px; color: #1a1a1a;">
                            <option value="none" selected>ì—†ìŒ</option>
                            <option value="fade">âœ¨ í˜ì´ë“œ</option>
                            <option value="slide-in">â¡ï¸ ìŠ¬ë¼ì´ë“œ ì¸</option>
                            <option value="slide-up">â¬†ï¸ ìŠ¬ë¼ì´ë“œ ì—…</option>
                            <option value="bounce">â¬‡ï¸ ë°”ìš´ìŠ¤</option>
                            <option value="scale">ğŸ” ìŠ¤ì¼€ì¼</option>
                            <option value="glow">ğŸ’« ê¸€ë¡œìš°</option>
                            <option value="pulse">ğŸ’“ í„ìŠ¤</option>
                        </select>
                    </div>
                </div>
                <button onclick="applyKoreanSubtitle()" class="btn-primary" style="margin-top: 10px; padding: 8px 16px; width: 100%; background: #10b981;">âœ… ì£¼ ìë§‰ ì ìš©</button>
            </div>

            <!-- ë³´ì¡° ìë§‰ ì»¨íŠ¸ë¡¤ -->
            <div style="margin-bottom: 15px; padding: 12px; background: rgba(0, 0, 0, 0.3); border-radius: 6px;">
                <label style="display: block; color: white; margin-bottom: 8px; font-weight: bold;">ğŸ“‹ ë³´ì¡° ìë§‰</label>
                <textarea id="overlay-english-input" placeholder="ë³´ì¡° ìë§‰ì„ ì…ë ¥í•˜ì„¸ìš”" rows="2"
                       style="width: 100%; padding: 8px; background: rgba(255, 255, 255, 0.9); border: none; border-radius: 4px; margin-bottom: 8px; resize: vertical; color: #1a1a1a;"></textarea>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                    <div>
                        <label style="color: #1a1a1a; font-size: 0.9rem; background: rgba(255, 255, 255, 0.9); padding: 2px 6px; border-radius: 3px; display: inline-block; margin-bottom: 4px;">í¬ê¸°: <span id="english-size-display">50px</span></label>
                        <input type="range" id="overlay-english-size" min="18" max="96" value="50" step="2"
                               style="width: 100%;">
                    </div>
                    <div>
                        <label style="color: #1a1a1a; font-size: 0.9rem; background: rgba(255, 255, 255, 0.9); padding: 2px 6px; border-radius: 3px; display: inline-block; margin-bottom: 4px;">ìƒ‰ìƒ</label>
                        <input type="color" id="overlay-english-color" value="#ffe14d"
                               style="width: 100%; height: 36px; border: none; border-radius: 4px;">
                    </div>
                    <div>
                        <label style="color: #1a1a1a; font-size: 0.9rem; background: rgba(255, 255, 255, 0.9); padding: 2px 6px; border-radius: 3px; display: inline-block; margin-bottom: 4px;">X ìœ„ì¹˜ (%)</label>
                        <input type="number" id="overlay-english-x" min="0" max="100" value="50"
                               style="width: 100%; padding: 6px; background: rgba(255, 255, 255, 0.9); border: none; border-radius: 4px; color: #1a1a1a;">
                    </div>
                    <div>
                        <label style="color: #1a1a1a; font-size: 0.9rem; background: rgba(255, 255, 255, 0.9); padding: 2px 6px; border-radius: 3px; display: inline-block; margin-bottom: 4px;">Y ìœ„ì¹˜ (%)</label>
                        <input type="number" id="overlay-english-y" min="0" max="100" value="95"
                               style="width: 100%; padding: 6px; background: rgba(255, 255, 255, 0.9); border: none; border-radius: 4px; color: #1a1a1a;">
                    </div>
                    <div>
                        <label style="color: #1a1a1a; font-size: 0.9rem; background: rgba(255, 255, 255, 0.9); padding: 2px 6px; border-radius: 3px; display: inline-block; margin-bottom: 4px;">ì •ì  íš¨ê³¼</label>
                        <select id="overlay-english-static-effect"
                                style="width: 100%; padding: 6px; background: rgba(255, 255, 255, 0.9); border: none; border-radius: 4px; color: #1a1a1a;">
                            <option value="none">ì—†ìŒ</option>
                            <option value="outline" selected>ì™¸ê³½ì„ </option>
                            <option value="shadow">ê·¸ë¦¼ì</option>
                            <option value="glow">ê¸€ë¡œìš°</option>
                            <option value="gradient">ê·¸ë¼ë°ì´ì…˜</option>
                            <option value="neon">ë„¤ì˜¨</option>
                        </select>
                    </div>
                    <div>
                        <label style="color: #1a1a1a; font-size: 0.9rem; background: rgba(255, 255, 255, 0.9); padding: 2px 6px; border-radius: 3px; display: inline-block; margin-bottom: 4px;">ë™ì  íš¨ê³¼</label>
                        <select id="overlay-english-dynamic-effect"
                                style="width: 100%; padding: 6px; background: rgba(255, 255, 255, 0.9); border: none; border-radius: 4px; color: #1a1a1a;">
                            <option value="none" selected>ì—†ìŒ</option>
                            <option value="fade">âœ¨ í˜ì´ë“œ</option>
                            <option value="slide-in">â¡ï¸ ìŠ¬ë¼ì´ë“œ ì¸</option>
                            <option value="slide-up">â¬†ï¸ ìŠ¬ë¼ì´ë“œ ì—…</option>
                            <option value="bounce">â¬‡ï¸ ë°”ìš´ìŠ¤</option>
                            <option value="scale">ğŸ” ìŠ¤ì¼€ì¼</option>
                            <option value="glow">ğŸ’« ê¸€ë¡œìš°</option>
                            <option value="pulse">ğŸ’“ í„ìŠ¤</option>
                        </select>
                    </div>
                </div>
                <button onclick="applyEnglishSubtitle()" class="btn-primary" style="margin-top: 10px; padding: 8px 16px; width: 100%; background: #10b981;">âœ… ë³´ì¡° ìë§‰ ì ìš©</button>
            </div>

            <!-- ê²€ì • ë°°ê²½ ì»¨íŠ¸ë¡¤ -->
            <div style="margin-bottom: 15px; padding: 12px; background: rgba(0, 0, 0, 0.3); border-radius: 6px;">
                <label style="display: block; color: white; margin-bottom: 8px; font-weight: bold;">â¬› ê²€ì • ë°°ê²½</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <!-- ìƒë‹¨ ë°°ê²½ -->
                    <div style="padding: 10px; background: rgba(255, 255, 255, 0.05); border-radius: 4px;">
                        <div style="display: flex; align-items: center; margin-bottom: 8px;">
                            <input type="checkbox" id="top-bar-enable" onchange="toggleBlackBar('top')" style="margin-right: 8px;">
                            <label style="color: white; font-weight: bold; margin: 0;">â¬†ï¸ ìƒë‹¨ ë°°ê²½</label>
                        </div>
                        <div>
                            <label style="color: #1a1a1a; font-size: 0.9rem; background: rgba(255, 255, 255, 0.9); padding: 2px 6px; border-radius: 3px; display: inline-block; margin-bottom: 4px;">ë†’ì´: <span id="top-bar-height-display">15%</span></label>
                            <input type="range" id="top-bar-height" min="5" max="40" value="15" step="1" oninput="updateBlackBar('top')" style="width: 100%;">
                        </div>
                        <div style="margin-top: 8px;">
                            <label style="color: #1a1a1a; font-size: 0.9rem; background: rgba(255, 255, 255, 0.9); padding: 2px 6px; border-radius: 3px; display: inline-block; margin-bottom: 4px;">íˆ¬ëª…ë„: <span id="top-bar-opacity-display">80%</span></label>
                            <input type="range" id="top-bar-opacity" min="0" max="100" value="80" step="5" oninput="updateBlackBar('top')" style="width: 100%;">
                        </div>
                    </div>

                    <!-- í•˜ë‹¨ ë°°ê²½ -->
                    <div style="padding: 10px; background: rgba(255, 255, 255, 0.05); border-radius: 4px;">
                        <div style="display: flex; align-items: center; margin-bottom: 8px;">
                            <input type="checkbox" id="bottom-bar-enable" onchange="toggleBlackBar('bottom')" style="margin-right: 8px;">
                            <label style="color: white; font-weight: bold; margin: 0;">â¬‡ï¸ í•˜ë‹¨ ë°°ê²½</label>
                        </div>
                        <div>
                            <label style="color: #1a1a1a; font-size: 0.9rem; background: rgba(255, 255, 255, 0.9); padding: 2px 6px; border-radius: 3px; display: inline-block; margin-bottom: 4px;">ë†’ì´: <span id="bottom-bar-height-display">15%</span></label>
                            <input type="range" id="bottom-bar-height" min="5" max="40" value="15" step="1" oninput="updateBlackBar('bottom')" style="width: 100%;">
                        </div>
                        <div style="margin-top: 8px;">
                            <label style="color: #1a1a1a; font-size: 0.9rem; background: rgba(255, 255, 255, 0.9); padding: 2px 6px; border-radius: 3px; display: inline-block; margin-bottom: 4px;">íˆ¬ëª…ë„: <span id="bottom-bar-opacity-display">80%</span></label>
                            <input type="range" id="bottom-bar-opacity" min="0" max="100" value="80" step="5" oninput="updateBlackBar('bottom')" style="width: 100%;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- í˜„ì¬ ì„¤ì • ìƒíƒœ í‘œì‹œ -->
            <div id="current-settings-status" style="margin-bottom: 10px; padding: 10px; background: rgba(59, 130, 246, 0.1); border-radius: 6px; border-left: 3px solid #3b82f6;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                    <span style="font-weight: bold; color: #3b82f6;">ğŸ“Š í˜„ì¬ ì ìš© ì¤‘ì¸ ì„¤ì •</span>
                </div>
                <div id="settings-info" style="font-size: 0.85rem; color: #1e293b;">
                    <span id="saved-settings-name">ê¸°ë³¸ ì„¤ì •</span> |
                    <span id="saved-settings-time">ë¯¸ì €ì¥</span>
                </div>
            </div>

            <!-- í•´ìƒë„ ì„ íƒ -->
            <div style="margin-bottom: 15px; padding: 12px; background: rgba(0, 0, 0, 0.3); border-radius: 6px;">
                <label style="display: block; color: white; margin-bottom: 8px; font-weight: bold;">ğŸ“ ë¯¸ë¦¬ë³´ê¸° í•´ìƒë„</label>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="setPreviewResolution('youtube')" id="btn-youtube-res" class="btn-primary" style="padding: 10px 20px; background: #3b82f6; font-size: 0.95rem;">
                        ğŸ“º ìœ íŠœë¸Œ (16:9)<br>
                        <span style="font-size: 0.8rem; opacity: 0.8;">1920Ã—1080</span>
                    </button>
                    <button onclick="setPreviewResolution('shorts')" id="btn-shorts-res" class="btn-primary" style="padding: 10px 20px; background: #8b5cf6; font-size: 0.95rem;">
                        ğŸ“± ì‡¼ì¸  (9:16)<br>
                        <span style="font-size: 0.8rem; opacity: 0.8;">1080Ã—1920</span>
                    </button>
                    <button onclick="setPreviewResolution('4k')" id="btn-4k-res" class="btn-primary" style="padding: 10px 20px; background: #10b981; font-size: 0.95rem;">
                        ğŸ¬ 4K (16:9)<br>
                        <span style="font-size: 0.8rem; opacity: 0.8;">3840Ã—2160</span>
                    </button>
                    <button onclick="setPreviewResolution('custom')" id="btn-custom-res" class="btn-secondary" style="padding: 10px 20px; font-size: 0.95rem;">
                        âš™ï¸ ì»¤ìŠ¤í…€<br>
                        <span style="font-size: 0.8rem; opacity: 0.8;">ì§ì ‘ ì…ë ¥</span>
                    </button>
                </div>
                <div id="custom-resolution-input" style="display: none; margin-top: 10px; padding: 10px; background: rgba(255, 255, 255, 0.05); border-radius: 4px;">
                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <div>
                            <label style="color: white; font-size: 0.9rem; display: block; margin-bottom: 4px;">ë„ˆë¹„</label>
                            <input type="number" id="custom-width" value="1920" min="320" max="7680" style="width: 100px; padding: 6px; border-radius: 4px; border: 1px solid #4a5568; background: #2d3748; color: white;">
                        </div>
                        <div>
                            <label style="color: white; font-size: 0.9rem; display: block; margin-bottom: 4px;">ë†’ì´</label>
                            <input type="number" id="custom-height" value="1080" min="240" max="4320" style="width: 100px; padding: 6px; border-radius: 4px; border: 1px solid #4a5568; background: #2d3748; color: white;">
                        </div>
                        <button onclick="applyCustomResolution()" class="btn-primary" style="padding: 8px 16px; margin-top: 20px; background: #10b981;">âœ… ì ìš©</button>
                    </div>
                </div>
                <div id="current-resolution-display" style="margin-top: 8px; color: #a0aec0; font-size: 0.85rem;">
                    í˜„ì¬: <span id="current-res-text">1920Ã—1080 (16:9)</span>
                </div>
            </div>

            <!-- ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼ -->
            <div style="display: flex; gap: 10px; justify-content: flex-end; flex-wrap: wrap;">
                <button onclick="saveTextOverlaySettings()" class="btn-primary" style="padding: 8px 16px; background: #10b981;">ğŸ’¾ ì„¤ì • ì €ì¥</button>
                <button onclick="saveTextOverlaySettingsAs()" class="btn-primary" style="padding: 8px 16px; background: #059669;">ğŸ’¾ ë‹¤ë¥¸ ì´ë¦„ìœ¼ë¡œ ì €ì¥</button>
                <button onclick="loadTextOverlaySettings()" class="btn-secondary" style="padding: 8px 16px; background: #3b82f6;">ğŸ“‚ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°</button>
                <button onclick="browseSettingsFile()" class="btn-secondary" style="padding: 8px 16px; background: #6366f1;">ğŸ” íŒŒì¼ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                <button onclick="clearTextOverlay()" class="btn-secondary" style="padding: 8px 16px; background: #ef4444;">ğŸ—‘ï¸ í…ìŠ¤íŠ¸ ì§€ìš°ê¸°</button>
            </div>
        </div>

        <div class="video-preview-container" style="position: relative; display: inline-block;">
            <!-- ë¹„ë””ì˜¤ í”Œë ˆì´ì–´ Wrapper -->
            <div class="video-subtitle-wrapper" style="position: relative; display: inline-block;">
                <!-- Canvas ë¯¸ë¦¬ë³´ê¸° (FFmpegì™€ ë™ì¼í•œ ë Œë”ë§) -->
                <canvas id="video-canvas-preview"
                        style="width: 100%; max-width: 800px; border-radius: 8px; display: none; position: absolute; top: 0; left: 0; z-index: 100; cursor: default;">
                </canvas>

                <!-- ê¸°ì¡´ ë¹„ë””ì˜¤ í”Œë ˆì´ì–´ (ìˆ¨ê¹€ ì²˜ë¦¬) -->
                <video id="video-preview-player" controls crossorigin="anonymous"
                       style="width: 100%; max-width: 800px; border-radius: 8px; display: block;">
                    <source id="video-preview-source" src="" type="video/mp4">
                    <track id="video-subtitle-track" kind="subtitles" src="" srclang="ko" label="í•œêµ­ì–´ (ì›ë³¸)">
                    <track id="video-translation-track" kind="subtitles" src="" srclang="en" label="ì£¼ìë§‰">
                    ë¸Œë¼ìš°ì €ê°€ ë¹„ë””ì˜¤ íƒœê·¸ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                </video>

                <!-- ìƒë‹¨ ê²€ì • ë°°ê²½ -->
                <div id="top-black-bar" style="position: absolute; top: 0; left: 0; width: 100%; height: 15%; background: rgba(0, 0, 0, 0.8); z-index: 5; display: none; pointer-events: none;"></div>

                <!-- í•˜ë‹¨ ê²€ì • ë°°ê²½ -->
                <div id="bottom-black-bar" style="position: absolute; bottom: 0; left: 0; width: 100%; height: 15%; background: rgba(0, 0, 0, 0.8); z-index: 5; display: none; pointer-events: none;"></div>

                <!-- í…ìŠ¤íŠ¸ ì˜¤ë²„ë ˆì´ë“¤ -->
                <div class="video-title-overlay video-text-overlay" id="video-title-overlay"
                     style="position: absolute; top: 80%; left: 50%; transform: translateX(-50%);
                            color: white; font-size: 48px; font-weight: bold;
                            font-family: 'ë§‘ì€ ê³ ë”•', 'Malgun Gothic', 'Apple SD Gothic Neo', 'Hiragino Kaku Gothic ProN', 'Yu Gothic', Meiryo, 'Noto Sans KR', 'Noto Sans JP', sans-serif;
                            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
                            cursor: move; user-select: none; z-index: 10;
                            pointer-events: auto; display: block; opacity: 1;
                            white-space: nowrap;">
                    ì˜ìƒ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”
                </div>

                <div class="video-subtitle-overlay video-text-overlay" id="video-subtitle-overlay"
                     style="position: absolute; top: 90%; left: 50%; transform: translateX(-50%);
                            color: #ffe14d; font-size: 32px; font-weight: bold;
                            font-family: 'ë§‘ì€ ê³ ë”•', 'Malgun Gothic', 'Apple SD Gothic Neo', 'Hiragino Kaku Gothic ProN', 'Yu Gothic', Meiryo, 'Noto Sans KR', 'Noto Sans JP', sans-serif;
                            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
                            cursor: move; user-select: none; z-index: 9;
                            pointer-events: auto; display: block; opacity: 1;
                            white-space: nowrap;">
                    ë¶€ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”
                </div>

                <!-- í•œê¸€ ìë§‰ ì˜¤ë²„ë ˆì´ (ì£¼ ìë§‰) -->
                <div class="custom-subtitle-overlay" id="korean-subtitle-overlay" data-lang="korean"
                     style="position: absolute; top: 65%; left: 50%; transform: translateX(-50%);
                            color: #000000; font-size: 32px; font-weight: bold;
                            text-shadow: -0.04em -0.04em 0 #fff, 0.04em -0.04em 0 #fff, -0.04em 0.04em 0 #fff, 0.04em 0.04em 0 #fff, -0.06em 0 0 #fff, 0.06em 0 0 #fff, 0 -0.06em 0 #fff, 0 0.06em 0 #fff;
                            cursor: move; user-select: none; z-index: 8;
                            pointer-events: auto; display: none; padding: 8px 16px;
                            background: rgba(255, 255, 255, 0.2); border-radius: 4px; opacity: 1;
                            white-space: nowrap;">
                </div>

                <!-- ì¼ë³¸ì–´ ìë§‰ ì˜¤ë²„ë ˆì´ (ë©”ì¸ ìë§‰) -->
                <div class="custom-subtitle-overlay" id="japanese-subtitle-overlay" data-lang="japanese"
                     style="position: absolute; top: 73%; left: 50%; transform: translateX(-50%);
                            color: #000000; font-size: 30px; font-weight: bold;
                            text-shadow: -0.04em -0.04em 0 #fff, 0.04em -0.04em 0 #fff, -0.04em 0.04em 0 #fff, 0.04em 0.04em 0 #fff, -0.06em 0 0 #fff, 0.06em 0 0 #fff, 0 -0.06em 0 #fff, 0 0.06em 0 #fff;
                            cursor: move; user-select: none; z-index: 7;
                            pointer-events: auto; display: none; padding: 8px 16px;
                            background: rgba(255, 255, 255, 0.2); border-radius: 4px; opacity: 1;
                            white-space: nowrap;">
                </div>

                <!-- ì˜ì–´ ìë§‰ ì˜¤ë²„ë ˆì´ (ë³´ì¡° ìë§‰) -->
                <div class="custom-subtitle-overlay" id="english-subtitle-overlay" data-lang="english"
                     style="position: absolute; top: 95%; left: 50%; transform: translateX(-50%);
                            color: #000000; font-size: 28px; font-weight: bold;
                            text-shadow: -0.04em -0.04em 0 #fff, 0.04em -0.04em 0 #fff, -0.04em 0.04em 0 #fff, 0.04em 0.04em 0 #fff, -0.06em 0 0 #fff, 0.06em 0 0 #fff, 0 -0.06em 0 #fff, 0 0.06em 0 #fff;
                            cursor: move; user-select: none; z-index: 6;
                            pointer-events: auto; display: none; padding: 8px 16px;
                            background: rgba(255, 255, 255, 0.2); border-radius: 4px; opacity: 1;
                            white-space: nowrap;">
                </div>

                <!-- ì¶œì²˜ í‘œì‹œ ì˜¤ë²„ë ˆì´ -->
                <div class="custom-subtitle-overlay" id="source-overlay" data-lang="source"
                     style="position: absolute; top: 98%; left: 50%; transform: translateX(-50%);
                            color: #cccccc; font-size: 18px; font-weight: normal;
                            text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;
                            cursor: move; user-select: none; z-index: 6;
                            pointer-events: auto; display: block; padding: 4px 12px;
                            background: rgba(0, 0, 0, 0.1); border-radius: 4px; opacity: 0.5;
                            white-space: nowrap;">
                    ì¶œì²˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”
                </div>
            </div>
            <div class="video-preview-info" style="margin-top: 15px;">
                <p><strong>íŒŒì¼ëª…:</strong> <span id="preview-filename"></span></p>
                <p><strong>ê²½ë¡œ:</strong> <span id="preview-filepath"></span></p>
            </div>

            <!-- íƒ€ì„ë¼ì¸ ì—ë””í„° -->
            <div class="timeline-editor" style="margin-top: 20px;">
                <div class="timeline-controls">
                    <div class="playback-controls">
                        <button id="play-pause-btn" style="display: flex; opacity: 1; visibility: visible;">â–¶ï¸</button>
                        <button id="stop-btn">â¹ï¸</button>
                        <button id="rewind-btn">âª</button>
                        <button id="forward-btn">â©</button>
                        <button id="skip-to-start-btn" title="ë§¨ ì²˜ìŒìœ¼ë¡œ">â®ï¸</button>
                        <button id="skip-to-end-btn" title="ë§¨ ëìœ¼ë¡œ">â­ï¸</button>
                        <button id="playback-speed-btn" title="ì¬ìƒ ì†ë„">1.0x</button>
                        <button id="set-point-a-btn" title="A ì§€ì  ì„¤ì • (í˜„ì¬ ìœ„ì¹˜)">ğŸ…°ï¸ Aì </button>
                        <button id="set-point-b-btn" title="B ì§€ì  ì„¤ì • (í˜„ì¬ ìœ„ì¹˜)">ğŸ…±ï¸ Bì </button>
                        <button id="toggle-ab-repeat-btn" title="A-B êµ¬ê°„ ë°˜ë³µ" style="background: #4a5568;">ğŸ” OFF</button>
                    </div>

                    <div class="zoom-controls">
                        <label>ğŸ” íƒ€ì„ë¼ì¸ í™•ëŒ€/ì¶•ì†Œ:</label>
                        <input type="range" id="timeline-zoom" min="1" max="20" value="1" step="0.5">
                        <span id="zoom-display">1x</span>
                        <button id="fit-to-subtitles">ğŸ“ ìë§‰ì— ë§ì¶¤</button>
                    </div>

                    <div class="time-display">
                        <span id="current-time">0:00</span> / <span id="total-time">5:00</span>
                    </div>
                </div>

                <!-- ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•œ íƒ€ì„ë¼ì¸ ì»¨í…Œì´ë„ˆ -->
                <div class="timeline-container" id="timeline-container">
                    <div class="timeline-content" id="timeline-content">
                        <!-- ì¬ìƒ í—¤ë“œ -->
                        <div class="playhead" id="playhead" style="left: 0px; display: none;">
                            <div class="playhead-time" id="playhead-time">0:00</div>
                        </div>

                        <!-- ì‹œê°„ ëˆˆê¸ˆì -->
                        <div class="timeline-ruler" id="timeline-ruler">
                            <div class="timeline-ruler-header"></div>
                            <div class="timeline-ruler-content">
                                <div class="time-marker major zero-marker" style="color: rgb(255, 68, 68); font-weight: bold; z-index: 100; left: 0px;">0:00</div>
                                <div class="time-marker" style="left: 500px;">0:10</div>
                                <div class="time-marker" style="left: 1000px;">0:20</div>
                                <div class="time-marker" style="left: 1500px;">0:30</div>
                                <div class="time-marker" style="left: 2000px;">0:40</div>
                                <div class="time-marker major" style="left: 2500px;">0:50</div>
                                <div class="time-marker" style="left: 3000px;">1:00</div>
                                <div class="time-marker" style="left: 3500px;">1:10</div>
                                <div class="time-marker" style="left: 4000px;">1:20</div>
                                <div class="time-marker" style="left: 4500px;">1:30</div>
                                <div class="time-marker major" style="left: 5000px;">1:40</div>
                                <div class="time-marker" style="left: 5500px;">1:50</div>
                                <div class="time-marker" style="left: 6000px;">2:00</div>
                                <div class="time-marker" style="left: 6500px;">2:10</div>
                                <div class="time-marker" style="left: 7000px;">2:20</div>
                                <div class="time-marker major" style="left: 7500px;">2:30</div>
                                <div class="time-marker" style="left: 8000px;">2:40</div>
                                <div class="time-marker" style="left: 8500px;">2:50</div>
                                <div class="time-marker" style="left: 9000px;">3:00</div>
                                <div class="time-marker" style="left: 9500px;">3:10</div>
                                <div class="time-marker major" style="left: 10000px;">3:20</div>
                                <div class="time-marker" style="left: 10500px;">3:30</div>
                                <div class="time-marker" style="left: 11000px;">3:40</div>
                                <div class="time-marker" style="left: 11500px;">3:50</div>
                                <div class="time-marker" style="left: 12000px;">4:00</div>
                                <div class="time-marker major" style="left: 12500px;">4:10</div>
                                <div class="time-marker" style="left: 13000px;">4:20</div>
                                <div class="time-marker" style="left: 13500px;">4:30</div>
                                <div class="time-marker" style="left: 14000px;">4:40</div>
                                <div class="time-marker" style="left: 14500px;">4:50</div>
                                <div class="time-marker major" style="left: 15000px;">5:00</div>
                            </div>
                        </div>

                        <!-- ì˜ìƒ íŠ¸ë™ -->
                        <div class="timeline-track video-track">
                            <div class="track-header">
                                <div class="track-title">
                                    <input type="checkbox" id="track-video-enable" checked style="cursor: pointer; width: 18px; height: 18px;">
                                    <label for="track-video-enable" style="cursor: pointer;">ğŸ“¹ ì˜ìƒ</label>
                                </div>
                                <div class="track-controls">
                                    <input type="file" id="video-file-input" accept="video/*" style="display: none;">
                                    <button class="track-load" onclick="document.getElementById('video-file-input').click()" title="ì˜ìƒ íŒŒì¼ ë¡œë“œ">ğŸ“‚</button>
                                    <button class="track-clear" onclick="clearMediaTrack('video')" title="íŠ¸ë™ ë¹„ìš°ê¸°">ğŸ—‘ï¸</button>
                                    <button id="video-mute-btn" style="background: none; border: none; cursor: pointer; font-size: 16px; padding: 4px 8px;" title="ì˜ìƒ ìŒì†Œê±° í•´ì œ">ğŸ”‡</button>
                                </div>
                            </div>
                            <div class="track-content" id="video-track">
                                <!-- ì˜ìƒ í´ë¦½ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                            </div>
                        </div>

                        <!-- ìŒì„± íŒŒí˜• íŠ¸ë™ -->
                        <div class="timeline-track audio-track">
                            <div class="track-header">
                                <div class="track-title">
                                    <input type="checkbox" id="track-audio-enable" checked style="cursor: pointer; width: 18px; height: 18px;">
                                    <label for="track-audio-enable" style="cursor: pointer;">ğŸµ ìŒì„±</label>
                                </div>
                                <div class="track-controls">
                                    <input type="file" id="audio-file-input" accept="audio/*" style="display: none;">
                                    <button class="track-load" onclick="document.getElementById('audio-file-input').click()" title="ìŒì„± íŒŒì¼ ë¡œë“œ">ğŸ“‚</button>
                                    <button class="track-clear" onclick="clearMediaTrack('audio')" title="íŠ¸ë™ ë¹„ìš°ê¸°">ğŸ—‘ï¸</button>
                                </div>
                            </div>
                            <div class="audio-edit-toolbar" data-track="audio">
                                <div class="audio-selection-info" id="audio-selection-info-audio">ì„ íƒ ìœ„ì¹˜: ì—†ìŒ</div>
                                <div class="audio-edit-actions">
                                    <button type="button" class="audio-action-btn" data-audio-action="trim-to-video" data-track="audio">âœ‚ï¸ ì˜ìƒ ê¸¸ì´ ë§ì¶”ê¸°</button>
                                    <button type="button" class="audio-action-btn" data-audio-action="delete-from-selection" data-track="audio">ğŸ—‘ï¸ ì„ íƒ ì´í›„ ì‚­ì œ</button>
                                    <button type="button" class="audio-action-btn" data-audio-action="clear-selection" data-track="audio">âŒ ì„ íƒ í•´ì œ</button>
                                </div>
                            </div>
                            <div class="track-content" id="audio-track">
                                <canvas id="timeline-waveform" height="50"></canvas>
                            </div>
                        </div>

                        <!-- í•´ì„¤ ìŒì„± íŒŒí˜• íŠ¸ë™ -->
                        <div class="timeline-track audio-track">
                            <div class="track-header">
                                <div class="track-title">
                                    <input type="checkbox" id="track-commentary-enable" checked style="cursor: pointer; width: 18px; height: 18px;">
                                    <label for="track-commentary-enable" style="cursor: pointer;">ğŸ™ï¸ í•´ì„¤ ìŒì„±</label>
                                </div>
                                <div class="track-controls">
                                    <input type="file" id="commentary-file-input" accept="audio/*" style="display: none;">
                                    <button class="track-load" onclick="document.getElementById('commentary-file-input').click()" title="í•´ì„¤ ìŒì„± íŒŒì¼ ë¡œë“œ">ğŸ“‚</button>
                                    <button class="track-clear" onclick="clearMediaTrack('commentary')" title="íŠ¸ë™ ë¹„ìš°ê¸°">ğŸ—‘ï¸</button>
                                </div>
                            </div>
                            <div class="audio-edit-toolbar" data-track="commentary">
                                <div class="audio-selection-info" id="audio-selection-info-commentary">ì„ íƒ ìœ„ì¹˜: ì—†ìŒ</div>
                                <div class="audio-edit-actions">
                                    <button type="button" class="audio-action-btn" data-audio-action="trim-to-video" data-track="commentary">âœ‚ï¸ ì˜ìƒ ê¸¸ì´ ë§ì¶”ê¸°</button>
                                    <button type="button" class="audio-action-btn" data-audio-action="delete-from-selection" data-track="commentary">ğŸ—‘ï¸ ì„ íƒ ì´í›„ ì‚­ì œ</button>
                                    <button type="button" class="audio-action-btn" data-audio-action="clear-selection" data-track="commentary">âŒ ì„ íƒ í•´ì œ</button>
                                </div>
                            </div>
                            <div class="track-content" id="commentary-audio-track">
                                <canvas id="commentary-waveform" height="50"></canvas>
                            </div>
                        </div>

                        <!-- ë°°ê²½ ìŒì•… íŒŒí˜• íŠ¸ë™ -->
                        <div class="timeline-track audio-track">
                            <div class="track-header">
                                <div class="track-title">
                                    <input type="checkbox" id="track-bgm-enable" checked style="cursor: pointer; width: 18px; height: 18px;">
                                    <label for="track-bgm-enable" style="cursor: pointer;">ğŸµ ë°°ê²½ ìŒì•…</label>
                                </div>
                                <div class="track-controls">
                                    <input type="file" id="bgm-file-input" accept="audio/*" style="display: none;">
                                    <button class="track-load" onclick="document.getElementById('bgm-file-input').click()" title="ë°°ê²½ ìŒì•… íŒŒì¼ ë¡œë“œ">ğŸ“‚</button>
                                    <button class="track-clear" onclick="clearMediaTrack('bgm')" title="íŠ¸ë™ ë¹„ìš°ê¸°">ğŸ—‘ï¸</button>
                                </div>
                            </div>
                            <div class="audio-edit-toolbar" data-track="bgm">
                                <div class="audio-selection-info" id="audio-selection-info-bgm">ì„ íƒ ìœ„ì¹˜: ì—†ìŒ</div>
                                <div class="audio-edit-actions">
                                    <button type="button" class="audio-action-btn" data-audio-action="trim-to-video" data-track="bgm">âœ‚ï¸ ì˜ìƒ ê¸¸ì´ ë§ì¶”ê¸°</button>
                                    <button type="button" class="audio-action-btn" data-audio-action="delete-from-selection" data-track="bgm">ğŸ—‘ï¸ ì„ íƒ ì´í›„ ì‚­ì œ</button>
                                    <button type="button" class="audio-action-btn" data-audio-action="clear-selection" data-track="bgm">âŒ ì„ íƒ í•´ì œ</button>
                                </div>
                            </div>
                            <div class="track-content" id="bgm-audio-track">
                                <canvas id="bgm-waveform" height="50"></canvas>
                            </div>
                        </div>

                        <!-- í•˜ì´ë¸Œë¦¬ë“œ ìë§‰ íŠ¸ë™ ì‹œìŠ¤í…œ -->
                        <!-- ë©”ì¸ ìë§‰ íŠ¸ë™ (ì›ì–´ ëŒ€ì‚¬) -->
                        <div class="timeline-track subtitle-track main-subtitle-track" id="main-subtitle-track">
                            <div class="track-header">
                                <div class="track-title" style="display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" id="track-main-subtitle-enable" checked="" style="cursor: pointer; width: 16px; height: 16px;">
                                    <label for="track-main-subtitle-enable" style="cursor: pointer; color: #f0f4f8;">ğŸ“ ë©”ì¸ ìë§‰</label>
                                </div>
                                <div class="track-controls">
                                    <input type="file" id="main-subtitle-file-input" accept=".srt,.vtt,.ass,.ssa" style="display: none;">
                                    <button class="track-load" onclick="document.getElementById('main-subtitle-file-input').click()" title="ìë§‰ íŒŒì¼ ë¡œë“œ">ğŸ“‚</button>
                                    <button class="track-clear" data-track="main" title="íŠ¸ë™ ë¹„ìš°ê¸°">ğŸ—‘ï¸</button>
                                </div>
                            </div>
                            <div class="track-content" id="main-subtitle-content">
                                <!-- ë©”ì¸ ìë§‰ ë¸”ë¡ë“¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                            </div>
                        </div>

                        <!-- ë²ˆì—­/ë”ë¹™ ìë§‰ íŠ¸ë™ -->
                        <div class="timeline-track subtitle-track translation-subtitle-track" id="translation-subtitle-track">
                            <div class="track-header">
                                <div class="track-title" style="display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" id="track-translation-subtitle-enable" checked="" style="cursor: pointer; width: 16px; height: 16px;">
                                    <label for="track-translation-subtitle-enable" style="cursor: pointer; color: #f0f4f8;">ğŸŒ ì£¼ìë§‰</label>
                                </div>
                                <div class="track-controls">
                                    <input type="file" id="translation-subtitle-file-input" accept=".srt,.vtt,.ass,.ssa" style="display: none;">
                                    <button class="track-load" onclick="document.getElementById('translation-subtitle-file-input').click()" title="ìë§‰ íŒŒì¼ ë¡œë“œ">ğŸ“‚</button>
                                    <button class="track-clear" data-track="translation" title="íŠ¸ë™ ë¹„ìš°ê¸°">ğŸ—‘ï¸</button>
                                </div>
                            </div>
                            <div class="track-content" id="translation-subtitle-content">
                                <!-- ì£¼ìë§‰ ë¸”ë¡ë“¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                            </div>
                        </div>

                        <!-- ì„¤ëª…/íš¨ê³¼ìŒ ìë§‰ íŠ¸ë™ -->
                        <div class="timeline-track subtitle-track description-subtitle-track" id="description-subtitle-track">
                            <div class="track-header">
                                <div class="track-title" style="display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" id="track-description-subtitle-enable" checked="" style="cursor: pointer; width: 16px; height: 16px;">
                                    <label for="track-description-subtitle-enable" style="cursor: pointer; color: #f0f4f8;">ğŸ”Š ë³´ì¡°ìë§‰</label>
                                </div>
                                <div class="track-controls">
                                    <input type="file" id="description-subtitle-file-input" accept=".srt,.vtt,.ass,.ssa" style="display: none;">
                                    <button class="track-load" onclick="document.getElementById('description-subtitle-file-input').click()" title="ìë§‰ íŒŒì¼ ë¡œë“œ">ğŸ“‚</button>
                                    <button class="track-clear" data-track="description" title="íŠ¸ë™ ë¹„ìš°ê¸°">ğŸ—‘ï¸</button>
                                </div>
                            </div>
                            <div class="track-content" id="description-subtitle-content">
                                <!-- ë³´ì¡°ìë§‰ ë¸”ë¡ë“¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                            </div>
                        </div>

                        <!-- ì¬ìƒ í—¤ë“œ -->
                        <div class="playhead" id="playhead" style="left: 0px;"></div>
                    </div>
                </div>
            </div>

            <!-- ìë§‰ ìŠ¤íƒ€ì¼ ì„¤ì • -->
            <div class="subtitle-style-settings" style="margin-top: 20px; padding: 15px; background: rgba(26, 30, 46, 0.6); border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.1);">
                <h4 style="margin: 0 0 15px 0; color: #f0f4f8; font-size: 1rem;">ğŸ­ ìë§‰ ë ˆì´ì•„ì›ƒ í…œí”Œë¦¿</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px;">
                    <label style="display: flex; align-items: center; gap: 10px; padding: 12px; background: rgba(42, 46, 62, 0.8); border-radius: 6px; border: 2px solid transparent; cursor: pointer; transition: all 0.3s ease;" onmouseenter="this.style.borderColor='rgba(74, 158, 255, 0.5)'" onmouseleave="if(!this.querySelector('input').checked) this.style.borderColor='transparent'">
                        <input type="radio" name="subtitle-template-video" value="classic" checked style="width: 18px; height: 18px; cursor: pointer;" onchange="toggleBannerControls()">
                        <div>
                            <strong style="display: block; color: #f0f4f8; font-size: 0.95rem;">Classic</strong>
                            <small style="color: #b0c4de; font-size: 0.85rem;">í•˜ë‹¨ ì‹¤ì‹œê°„ ìë§‰</small>
                        </div>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; padding: 12px; background: rgba(42, 46, 62, 0.8); border-radius: 6px; border: 2px solid transparent; cursor: pointer; transition: all 0.3s ease;" onmouseenter="this.style.borderColor='rgba(74, 158, 255, 0.5)'" onmouseleave="if(!this.querySelector('input').checked) this.style.borderColor='transparent'">
                        <input type="radio" name="subtitle-template-video" value="banner" style="width: 18px; height: 18px; cursor: pointer;" onchange="toggleBannerControls()">
                        <div>
                            <strong style="display: block; color: #f0f4f8; font-size: 0.95rem;">Banner</strong>
                            <small style="color: #b0c4de; font-size: 0.85rem;">ìƒë‹¨ ë°°ë„ˆ + ìë§‰</small>
                        </div>
                    </label>
                </div>

                <div id="banner-controls-video" style="display: none; padding: 12px; background: rgba(42, 46, 62, 0.5); border-radius: 6px;">
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; margin-bottom: 5px; color: #b0c4de; font-size: 0.9rem;">ì£¼ í…ìŠ¤íŠ¸ (ìƒë‹¨)</label>
                        <input type="text" id="banner-primary-video" placeholder="ì˜ˆ: ì¶©ê²©ì ì¸ ì‚¬ê±´!" style="width: 100%; padding: 8px; background: rgba(26, 30, 46, 0.8); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 4px; color: #f0f4f8; font-size: 0.9rem;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; color: #b0c4de; font-size: 0.9rem;">ë³´ì¡° í…ìŠ¤íŠ¸ (í•˜ë‹¨) - ë¹„ì›Œë‘ë©´ ì‹¤ì‹œê°„ ìë§‰ í‘œì‹œ</label>
                        <input type="text" id="banner-secondary-video" placeholder="ë¹„ì›Œë‘ë©´ ì‹¤ì‹œê°„ ìë§‰ì´ í‘œì‹œë©ë‹ˆë‹¤" style="width: 100%; padding: 8px; background: rgba(26, 30, 46, 0.8); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 4px; color: #f0f4f8; font-size: 0.9rem;">
                    </div>
                    <p style="margin: 10px 0 0 0; padding: 8px; background: rgba(0, 255, 136, 0.05); border-left: 3px solid #00ff88; border-radius: 4px; color: #b0c4de; font-size: 0.85rem;">ğŸ’¡ íŒ: ë³´ì¡° í…ìŠ¤íŠ¸ë¥¼ ë¹„ì›Œë‘ë©´ í•˜ë‹¨ì—ì„œë„ ì‹¤ì‹œê°„ ìë§‰ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                </div>
            </div>

            <!-- ë¸Œë¼ìš°ì € ê¸°ëŠ¥ ì§„ë‹¨ íŒ¨ë„ -->
            <div class="browser-diagnostic-panel" style="margin-top: 20px; padding: 15px; background: rgba(26, 30, 46, 0.6); border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; cursor: pointer;" onclick="toggleBrowserPanel()">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span id="browser-panel-toggle" style="color: #f0f4f8; font-size: 1.2rem; transition: transform 0.3s;">â–¶</span>
                        <h4 style="margin: 0; color: #f0f4f8; font-size: 1rem;">ğŸ” ë¸Œë¼ìš°ì € ê¸°ëŠ¥ ì§„ë‹¨</h4>
                    </div>
                    <button onclick="event.stopPropagation(); runBrowserDiagnostics()" class="btn-primary" style="padding: 6px 12px; background: #3b82f6; font-size: 0.9rem;">
                        ì§„ë‹¨ ì‹¤í–‰
                    </button>
                </div>
                <div id="browser-panel-content" style="display: none;">
                    <div id="browser-diagnostic-results" style="display: none;">
                        <!-- ì§„ë‹¨ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                    <p style="margin: 10px 0 0 0; padding: 8px; background: rgba(59, 130, 246, 0.05); border-left: 3px solid #3b82f6; border-radius: 4px; color: #b0c4de; font-size: 0.85rem;">
                        ğŸ’¡ ì´ ì§„ë‹¨ì€ ë¸Œë¼ìš°ì €ê°€ WebCodecs, WebGL2, SharedArrayBuffer ë“± ìµœì‹  ê¸°ëŠ¥ì„ ì§€ì›í•˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
                    </p>
                </div>
            </div>

            <!-- ì„±ëŠ¥ ëŒ€ì‹œë³´ë“œ íŒ¨ë„ -->
            <div class="performance-dashboard-panel" style="margin-top: 20px; padding: 15px; background: rgba(26, 30, 46, 0.6); border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; cursor: pointer;" onclick="togglePerformancePanel()">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span id="performance-panel-toggle" style="color: #f0f4f8; font-size: 1.2rem; transition: transform 0.3s;">â–¶</span>
                        <h4 style="margin: 0; color: #f0f4f8; font-size: 1rem;">ğŸ“Š ì„±ëŠ¥ ëŒ€ì‹œë³´ë“œ</h4>
                    </div>
                    <div style="display: flex; gap: 8px;" onclick="event.stopPropagation();">
                        <button onclick="showPerformanceReport()" class="btn-primary" style="padding: 6px 12px; background: #10b981; font-size: 0.9rem;">
                            ë¦¬í¬íŠ¸ í‘œì‹œ
                        </button>
                        <button onclick="clearPerformanceData()" class="btn-secondary" style="padding: 6px 12px; background: #ef4444; font-size: 0.9rem;">
                            ë°ì´í„° ì´ˆê¸°í™”
                        </button>
                    </div>
                </div>
                <div id="performance-panel-content" style="display: none;">
                    <div id="performance-dashboard-results" style="display: none;">
                        <!-- ì„±ëŠ¥ ë¦¬í¬íŠ¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                    <p style="margin: 10px 0 0 0; padding: 8px; background: rgba(16, 185, 129, 0.05); border-left: 3px solid #10b981; border-radius: 4px; color: #b0c4de; font-size: 0.85rem;">
                        ğŸ’¡ API í˜¸ì¶œ, DOM ë Œë”ë§, ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ë“± ì‹¤ì‹œê°„ ì„±ëŠ¥ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•©ë‹ˆë‹¤. ì½˜ì†”ì—ì„œë„ í™•ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤.
                    </p>
                </div>
            </div>

            <div class="video-preview-actions" style="margin-top: 15px;">
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <button onclick="useThisVideo()" class="btn-primary">ì´ ì˜ìƒìœ¼ë¡œ ìë§‰ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                    <button onclick="createFinalVideo()" class="btn-primary" style="background: #f59e0b;">ğŸ¬ ì˜ìƒì œì‘í•˜ê¸°</button>
                    <button onclick="closeVideoPreview()" class="btn-secondary" style="background: #666;">ë‹«ê¸°</button>
                </div>
                <div style="margin-bottom: 10px;">
                    <button onclick="toggleFrameExtractionButtons()" class="btn-secondary" style="padding: 6px 16px; background: #6366f1; font-size: 0.9rem; width: 100%;">
                        <span id="frame-extraction-toggle-icon">â–¼</span> í”„ë ˆì„ ì¶”ì¶œ ë²„íŠ¼
                    </button>
                </div>
                <div id="frame-extraction-buttons" style="display: none; gap: 10px; flex-wrap: wrap; align-items: center;">
                    <button onclick="extractFirstFrame()" class="btn-secondary" style="background: #10b981;">ğŸ“¸ ë§¨ ì• í”„ë ˆì„</button>
                    <button onclick="extractLastFrame()" class="btn-secondary" style="background: #10b981;">ğŸ“¸ ë§¨ ë’¤ í”„ë ˆì„</button>
                    <div style="display: flex; align-items: center; gap: 5px; background: rgba(0, 0, 0, 0.2); padding: 8px 12px; border-radius: 6px;">
                        <button onclick="decreaseInterval()" class="btn-secondary" style="background: #ef4444; padding: 4px 12px; min-width: 40px;">âˆ’</button>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <input type="number" id="frame-interval" value="5" min="1" max="60" style="width: 60px; padding: 6px; border: 1px solid #555; border-radius: 4px; background: #1a1a1a; color: #e0e6ed; text-align: center; font-size: 14px;">
                            <span style="color: #c8d8e8;">ì´ˆ ê°„ê²©</span>
                        </div>
                        <button onclick="increaseInterval()" class="btn-secondary" style="background: #10b981; padding: 4px 12px; min-width: 40px;">+</button>
                        <button onclick="extractFramesByCurrentInterval()" class="btn-secondary" style="background: #3b82f6; padding: 6px 12px;">â±ï¸ ì¶”ì¶œ</button>
                    </div>
                    <div style="display: flex; align-items: center; gap: 5px; background: rgba(139, 92, 246, 0.2); padding: 8px 12px; border-radius: 6px; border: 1px solid rgba(139, 92, 246, 0.4);">
                        <button onclick="decreaseSegmentFrames()" class="btn-secondary" style="background: #ef4444; padding: 4px 12px; min-width: 40px;">âˆ’</button>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <input type="number" id="frames-per-segment" value="2" min="1" max="10" style="width: 60px; padding: 6px; border: 1px solid #555; border-radius: 4px; background: #1a1a1a; color: #e0e6ed; text-align: center; font-size: 14px;">
                            <span style="color: #c8d8e8;">ê°œ</span>
                        </div>
                        <button onclick="increaseSegmentFrames()" class="btn-secondary" style="background: #10b981; padding: 4px 12px; min-width: 40px;">+</button>
                        <button onclick="extractFramesBySegments()" class="btn-secondary" style="background: #8b5cf6; padding: 6px 12px;">ğŸ¯ ê° ì˜ìƒë§ˆë‹¤ ì¶”ì¶œ</button>
                    </div>
                    <button onclick="extractFramesBySubtitles()" class="btn-secondary" style="background: #f59e0b;">ğŸ“ ìë§‰ ê¸°ì¤€ í”„ë ˆì„ ì¶”ì¶œ</button>
                    <button onclick="extractVideoClipsBySubtitles()" class="btn-secondary" style="background: #ef4444;">âœ‚ï¸ ìë§‰ ê¸°ì¤€ ì˜ìƒ ìë¥´ê¸°</button>
                </div>
            </div>
            <div id="extracted-frames-gallery" style="display: none; margin-top: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h3 style="margin: 0;">ì¶”ì¶œëœ ì´ë¯¸ì§€</h3>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="downloadAllFrames()" class="btn-secondary" style="background: #10b981; padding: 6px 12px;">ğŸ’¾ ì´ë¯¸ì§€,íŠ¸ë™ì €ì¥</button>
                        <button onclick="clearAllFrames()" class="btn-secondary" style="background: #ef4444; padding: 6px 12px;">ğŸ—‘ï¸ ì „ì²´ ì‚­ì œ</button>
                    </div>
                </div>

                <!-- AI í”„ë ˆì„ ë¶„ì„ -->
                <div id="frame-analysis-section" style="margin-bottom: 15px; padding: 15px; background: rgba(102, 126, 234, 0.1); border-radius: 8px; border: 1px solid rgba(102, 126, 234, 0.3); scroll-margin-top: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <h4 style="margin: 0; color: #8ac5ff;">ğŸ¤– AI í”„ë ˆì„ ë¶„ì„</h4>
                            <button onclick="toggleFrameAnalysisSection()" class="btn-secondary" style="padding: 4px 10px; font-size: 0.85rem; background: #6366f1;">
                                <span id="frame-analysis-toggle-icon">â–¼</span> í¼ì¹˜ê¸°/ì ‘ê¸°
                            </button>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="selectAllFrames()" class="btn-secondary" style="padding: 4px 10px; font-size: 0.85rem; background: #3b82f6;">âœ“ ì „ì²´ ì„ íƒ</button>
                            <button onclick="deselectAllFrames()" class="btn-secondary" style="padding: 4px 10px; font-size: 0.85rem; background: #6b7280;">âœ— ì„ íƒ í•´ì œ</button>
                        </div>
                    </div>
                    <div id="frame-analysis-content-area" style="display: none;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 10px; margin-bottom: 10px;">
                        <div>
                            <label style="display: block; color: #a0aec0; font-size: 0.85rem; margin-bottom: 5px;">AI ëª¨ë¸</label>
                            <select id="frame-ai-model-select" onchange="updateFrameAnalysisCost()" style="width: 100%; padding: 8px 12px; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 6px; color: #e0e6ed; font-size: 0.9rem;">
                                <option value="gpt-4o-mini">GPT-4o Mini</option>
                                <option value="sonnet" selected>Claude Sonnet</option>
                                <option value="haiku">Claude Haiku</option>
                                <option value="gpt-4o">GPT-4o</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; color: #a0aec0; font-size: 0.85rem; margin-bottom: 5px;">ë¶„ì„ ìœ í˜•</label>
                            <select id="frame-analysis-type" style="width: 100%; padding: 8px 12px; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 6px; color: #e0e6ed; font-size: 0.9rem;">
                                <option value="shorts-production" selected>ğŸ¥ ì‡¼ì¸  ì œì‘ìš©</option>
                                <option value="scene-description">ğŸ¬ ì¥ë©´ ì„¤ëª…</option>
                                <option value="object-detection">ğŸ” ê°ì²´ ì¸ì‹</option>
                                <option value="text-extraction">ğŸ“ í…ìŠ¤íŠ¸ ì¶”ì¶œ</option>
                                <option value="story-flow">ğŸ“– ìŠ¤í† ë¦¬ íë¦„</option>
                                <option value="thumbnail-suggest">ğŸ–¼ï¸ ì¸ë„¤ì¼ ì¶”ì²œ</option>
                                <option value="custom">âœï¸ ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; color: #a0aec0; font-size: 0.85rem; margin-bottom: 5px;">ì£¼ ìë§‰ ì–¸ì–´ (ìƒë‹¨)</label>
                            <select id="subtitle-language-primary" style="width: 100%; padding: 8px 12px; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 6px; color: #e0e6ed; font-size: 0.9rem;">
                                <option value="korean" selected>ğŸ‡°ğŸ‡· í•œêµ­ì–´</option>
                                <option value="english">ğŸ‡ºğŸ‡¸ English</option>
                                <option value="japanese">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; color: #a0aec0; font-size: 0.85rem; margin-bottom: 5px;">ë³´ì¡° ìë§‰ ì–¸ì–´ (í•˜ë‹¨)</label>
                            <select id="subtitle-language-secondary" style="width: 100%; padding: 8px 12px; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 6px; color: #e0e6ed; font-size: 0.9rem;">
                                <option value="">ì—†ìŒ</option>
                                <option value="korean">ğŸ‡°ğŸ‡· í•œêµ­ì–´</option>
                                <option value="english" selected>ğŸ‡ºğŸ‡¸ English</option>
                                <option value="japanese">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; color: #a0aec0; font-size: 0.85rem; margin-bottom: 5px;">ë¶„ì„ í…œí”Œë¦¿</label>
                            <select id="frame-analysis-template" onchange="loadFrameAnalysisTemplate()" style="width: 100%; padding: 8px 12px; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 6px; color: #e0e6ed; font-size: 0.9rem;">
                                <option value="">ìƒˆ ë¶„ì„</option>
                            </select>
                        </div>
                        <div style="display: flex; align-items: flex-end;">
                            <button onclick="analyzeFramesWithAI()" class="btn-secondary" style="padding: 10px 20px; font-size: 0.95rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); white-space: nowrap;">ğŸ¤– ë¶„ì„ ì‹œì‘</button>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <p style="margin: 0; color: #a0aec0; font-size: 0.85rem;">
                                ğŸ’¡ í”„ë ˆì„ ê°ê°ì— ì²´í¬ë°•ìŠ¤ë¥¼ í´ë¦­í•˜ì—¬ ë¶„ì„í•  í”„ë ˆì„ì„ ì„ íƒí•˜ì„¸ìš”.
                            </p>
                            <div style="display: flex; gap: 15px; align-items: center;">
                                <label style="display: flex; align-items: center; gap: 6px; color: #e0e6ed; font-size: 0.9rem; cursor: pointer;">
                                    <input type="checkbox" id="include-extracted-frames" style="width: 16px; height: 16px; cursor: pointer;">
                                    <span>ğŸ–¼ï¸ AI ì¶”ì¶œëœ í”„ë ˆì„ í¬í•¨</span>
                                </label>
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <label style="display: flex; align-items: center; gap: 6px; color: #e0e6ed; font-size: 0.9rem; cursor: pointer;">
                                        <input type="checkbox" id="include-title-subtitle" style="width: 16px; height: 16px; cursor: pointer;">
                                        <span>ğŸ“Œ ì œëª©ìë§‰ í¬í•¨</span>
                                    </label>
                                    <input type="file" id="quick-subtitle-file-input" accept=".srt,.vtt,.ass,.ssa" style="display: none;">
                                    <button onclick="document.getElementById('quick-subtitle-file-input').click()"
                                            style="background: rgba(16, 185, 129, 0.2); border: 1px solid #10b981; color: #10b981;
                                                   padding: 4px 10px; border-radius: 4px; font-size: 0.85rem; cursor: pointer;
                                                   transition: all 0.2s; display: flex; align-items: center; gap: 4px;"
                                            onmouseover="this.style.background='rgba(16, 185, 129, 0.3)'"
                                            onmouseout="this.style.background='rgba(16, 185, 129, 0.2)'"
                                            title="ìë§‰ íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°">
                                        ğŸ“‚ ìë§‰ ë¶ˆëŸ¬ì˜¤ê¸°
                                    </button>
                                    <button onclick="clearQuickSubtitle()"
                                            style="background: rgba(239, 68, 68, 0.2); border: 1px solid #ef4444; color: #ef4444;
                                                   padding: 4px 10px; border-radius: 4px; font-size: 0.85rem; cursor: pointer;
                                                   transition: all 0.2s; display: flex; align-items: center; gap: 4px;"
                                            onmouseover="this.style.background='rgba(239, 68, 68, 0.3)'"
                                            onmouseout="this.style.background='rgba(239, 68, 68, 0.2)'"
                                            title="ë¶ˆëŸ¬ì˜¨ ìë§‰ ë¹„ìš°ê¸°">
                                        ğŸ—‘ï¸ ë¹„ìš°ê¸°
                                    </button>
                                    <span id="loaded-subtitle-files" style="color: #10b981; font-size: 0.85rem; font-weight: 500;"></span>
                                </div>
                            </div>
                        </div>
                        <div id="frame-analysis-cost" style="color: #fbbf24; font-size: 0.9rem; font-weight: 600;">
                            ì˜ˆìƒ ë¹„ìš©: ê³„ì‚° ì¤‘...
                        </div>
                    </div>
                    <!-- ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸ ì…ë ¥ -->
                    <div id="custom-prompt-container" style="display: none; margin-top: 10px;">
                        <label style="display: block; color: #a0aec0; font-size: 0.85rem; margin-bottom: 5px;">ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸</label>
                        <textarea id="custom-prompt-input" style="width: 100%; padding: 10px; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 6px; color: #e0e6ed; font-size: 0.9rem; min-height: 100px;" placeholder="ë¶„ì„ì— ì‚¬ìš©í•  í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                        <div style="display: flex; gap: 10px; margin-top: 5px;">
                            <button onclick="saveFrameAnalysisTemplate()" class="btn-secondary" style="padding: 4px 10px; font-size: 0.85rem; background: #10b981;">ğŸ’¾ í…œí”Œë¦¿ìœ¼ë¡œ ì €ì¥</button>
                        </div>
                    </div>
                    </div>
                </div>

                <!-- AI í”„ë ˆì„ ë¶„ì„ ê²°ê³¼ -->
                <div id="frame-analysis-result" style="margin-bottom: 15px; padding: 15px; background: rgba(16, 185, 129, 0.1); border-radius: 8px; border: 1px solid rgba(16, 185, 129, 0.3);">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <h4 style="margin: 0; color: #10b981;">ğŸ“Š AI ë¶„ì„ ê²°ê³¼ <span style="font-size: 0.75rem; color: #a0aec0; font-weight: normal;">(í¸ì§‘ ê°€ëŠ¥)</span></h4>
                            <div style="display: flex; gap: 5px;">
                                <button onclick="saveAnalysisToStorage()" class="btn-secondary" style="padding: 4px 10px; background: #3b82f6; font-size: 0.8rem;" title="ë¸Œë¼ìš°ì €ì— ì„ì‹œ ì €ì¥ (ìµœëŒ€ 20ê°œ)">ğŸ“Œ ë³´ê´€í•¨ì— ì €ì¥</button>
                                <button onclick="showLoadAnalysisDialog()" class="btn-secondary" style="padding: 4px 10px; background: #6366f1; font-size: 0.8rem;" title="ì €ì¥ëœ ë¶„ì„ ê²°ê³¼ ë¶ˆëŸ¬ì˜¤ê¸°">ğŸ“‚ ë³´ê´€í•¨ ì—´ê¸°</button>
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <div style="display: flex; gap: 8px;">
                                <button onclick="exportSubtitles()" class="btn-secondary" style="padding: 6px 12px; background: #8b5cf6; font-size: 0.85rem;" title="ìë§‰ë§Œ SRT íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ">ğŸ’¬ ìë§‰</button>
                                <button onclick="exportKoreanSubtitles()" class="btn-secondary" style="padding: 6px 12px; background: #f59e0b; font-size: 0.85rem; font-weight: 600;" title="AI ë¶„ì„ ê²°ê³¼ì—ì„œ í•œê¸€ìë§‰(2-0)ì„ ì¶”ì¶œí•˜ì—¬ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤">ğŸ“¥ í•œê¸€ìë§‰2-0</button>
                                <button onclick="exportMainSubtitles()" class="btn-secondary" style="padding: 6px 12px; background: #10b981; font-size: 0.85rem; font-weight: 600;" title="AI ë¶„ì„ ê²°ê³¼ì—ì„œ ì£¼ìë§‰ì„ ì¶”ì¶œí•˜ì—¬ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤">ğŸ“¥ ì£¼ìë§‰2-1</button>
                                <button onclick="exportSecondarySubtitles()" class="btn-secondary" style="padding: 6px 12px; background: #06b6d4; font-size: 0.85rem; font-weight: 600;" title="AI ë¶„ì„ ê²°ê³¼ì—ì„œ ë³´ì¡°ìë§‰ì„ ì¶”ì¶œí•˜ì—¬ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤">ğŸ“¥ ë³´ì¡° ìë§‰2-2</button>
                                <button onclick="exportNarration()" class="btn-secondary" style="padding: 6px 12px; background: #f59e0b; font-size: 0.85rem;" title="ë‚˜ë ˆì´ì…˜ë§Œ TXT íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ">ğŸ™ï¸ ë‚˜ë ˆì´ì…˜</button>
                                <button onclick="exportImagePrompts()" class="btn-secondary" style="padding: 6px 12px; background: #ec4899; font-size: 0.85rem;" title="ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ë§Œ TXT íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ">ğŸ¨ ì´ë¯¸ì§€</button>
                                <button onclick="exportVideoPrompts()" class="btn-secondary" style="padding: 6px 12px; background: #06b6d4; font-size: 0.85rem;" title="ì˜ìƒ í”„ë¡¬í”„íŠ¸ë§Œ TXT íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ">ğŸ¥ ì˜ìƒ</button>
                                <button onclick="saveFrameAnalysisResult()" class="btn-secondary" style="padding: 6px 12px; background: #10b981; font-size: 0.85rem;" title="ì „ì²´ ê²°ê³¼ë¥¼ TXT íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ">ğŸ“¥ ì „ì²´</button>
                                <button onclick="document.getElementById('file-upload-input').click()" class="btn-secondary" style="padding: 6px 12px; background: #059669; font-size: 0.85rem;" title="ë‹¤ìš´ë¡œë“œí•œ TXT íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°">ğŸ“„ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                                <input type="file" id="file-upload-input" accept=".txt" style="display: none;" onchange="loadAnalysisFromFile(event)">
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="copyImagePrompts()" class="btn-secondary" style="padding: 6px 12px; background: #d946ef; font-size: 0.85rem;" title="ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ë¥¼ í´ë¦½ë³´ë“œì— ë³µì‚¬">ğŸ“‹ ì´ë¯¸ì§€ ì „ì²´ ë³µì‚¬</button>
                                <button onclick="copyVideoPrompts()" class="btn-secondary" style="padding: 6px 12px; background: #0891b2; font-size: 0.85rem;" title="ì˜ìƒ í”„ë¡¬í”„íŠ¸ë¥¼ í´ë¦½ë³´ë“œì— ë³µì‚¬">ğŸ“‹ ì˜ìƒ ì „ì²´ ë³µì‚¬</button>
                                <button onclick="showScenePromptSelector()" class="btn-secondary" style="padding: 6px 12px; background: #a855f7; font-size: 0.85rem;" title="ì¥ë©´ë³„ë¡œ ê°œë³„ í”„ë¡¬í”„íŠ¸ ë³µì‚¬">ğŸ¬ ì¥ë©´ë³„ ë³µì‚¬</button>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="generateNewShortsContent()" class="btn-secondary" style="padding: 6px 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-size: 0.85rem; font-weight: 600;" title="AIë¡œ ì™„ì „íˆ ìƒˆë¡œìš´ ì‡¼ì¸  ì½˜í…ì¸  ìƒì„±">ğŸ¬ ìƒˆ ì‡¼ì¸  ì½˜í…ì¸  ìƒì„±</button>
                                <button onclick="continueGeneratingShortsContent()" class="btn-secondary" style="padding: 6px 12px; background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%); font-size: 0.85rem; font-weight: 600;" title="ê¸°ì¡´ ë‚´ìš©ì— ì´ì–´ì„œ ì¶”ê°€ ì½˜í…ì¸  ìƒì„±">â• ì´ì–´ì„œ ìƒì„±</button>
                            </div>
                        </div>
                    </div>
                    <textarea id="frame-analysis-content" style="width: 100%; min-height: 300px; padding: 15px; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 6px; color: #e0e6ed; font-family: 'Noto Sans KR', sans-serif; font-size: 0.95rem; line-height: 1.6; resize: vertical;" placeholder="âœ¨ í”„ë ˆì„ì„ ì„ íƒí•˜ê³  &quot;ğŸ¤– ë¶„ì„ ì‹œì‘&quot; ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ ì‡¼ì¸  ì œì‘ì„ ìœ„í•œ ì¢…í•© ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.

ğŸ“ í¬í•¨ ë‚´ìš©: ì‹œì²­ììš© ì½˜í…ì¸  ì„¤ëª…, í™”ë©´ í…ìŠ¤íŠ¸(ìë§‰), ë‚˜ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸, AI ì´ë¯¸ì§€ ìƒì„± í”„ë¡¬í”„íŠ¸, í¸ì§‘ ë…¸íŠ¸

ğŸ’¡ ë¶„ì„ ê²°ê³¼ë¥¼ ì§ì ‘ ìˆ˜ì •í•  ìˆ˜ ìˆìœ¼ë©°, ê° ìš”ì†Œë³„ë¡œ ì¶”ì¶œí•˜ê±°ë‚˜ ì „ì²´ë¥¼ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."></textarea>
                </div>

                <div id="frames-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-top: 10px;"></div>
            </div>
        </div>

    </section>

    {% if error %}
    <div class="alert error">
        <strong>ì˜¤ë¥˜:</strong> {{ error }}
    </div>
    {% endif %}

    {% if result %}
    <section class="panel result-panel">
        <h2>ìë§‰ ì •ë³´</h2>
        <div class="subtitle-info">
            <p><strong>ì˜ìƒ íŒŒì¼:</strong> {{ result.video_name }}</p>
            {% if result.subtitle_file %}
            <p><strong>ìë§‰ íŒŒì¼:</strong> {{ result.subtitle_file }}</p>
            {% endif %}
            <p><strong>ìë§‰ ë¼ì¸ ìˆ˜:</strong> {{ result.subtitle_count }}ê°œ</p>
        </div>

        {% if result.subtitles %}
        <div class="subtitle-content">
            <!-- AI ë¶„ì„ ë²„íŠ¼ -->
            <div id="subtitle-analysis-section" style="margin-bottom: 20px; padding: 15px; background: rgba(102, 126, 234, 0.1); border-radius: 8px; border: 1px solid rgba(102, 126, 234, 0.3); scroll-margin-top: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <h3 style="margin: 0; color: #8ac5ff;">ğŸ¤– AI ìë§‰ ë¶„ì„</h3>
                        <button onclick="toggleSubtitleAnalysisSection()" class="btn-secondary" style="padding: 4px 10px; font-size: 0.85rem; background: #6366f1;">
                            <span id="subtitle-analysis-toggle-icon">â–¼</span> í¼ì¹˜ê¸°/ì ‘ê¸°
                        </button>
                    </div>
                </div>

                <div id="subtitle-analysis-content-area" style="display: none;">
                <!-- ëª¨ë¸ ë° ë¶„ì„ íƒ€ì… ì„ íƒ -->
                <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px; margin-bottom: 10px;">
                    <div>
                        <label style="display: block; color: #a0aec0; font-size: 0.85rem; margin-bottom: 5px;">AI ëª¨ë¸ ì„ íƒ</label>
                        <select id="ai-model-select" style="width: 100%; padding: 8px 12px; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 6px; color: #e0e6ed; font-size: 0.9rem;">
                            <option value="gpt-4o-mini">GPT-4o Mini ($0.01 - ê°€ì¥ ì €ë ´)</option>
                            <option value="sonnet" selected>Claude Sonnet ($0.06 - í•œêµ­ì–´ ìµœê³ )</option>
                            <option value="haiku">Claude Haiku ($0.015 - ê°€ì„±ë¹„)</option>
                            <option value="gpt-4o">GPT-4o ($0.05 - ê· í˜•)</option>
                        </select>
                    </div>

                    <div>
                        <label style="display: block; color: #a0aec0; font-size: 0.85rem; margin-bottom: 5px;">ë¶„ì„ íƒ€ì…</label>
                        <select id="analysis-type-select" style="width: 100%; padding: 8px 12px; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 6px; color: #e0e6ed; font-size: 0.9rem;">
                            <option value="enhanced-shorts" selected>ğŸ¬ 60ì´ˆ ì‡¼ì¸  (ì‚­ì œ 60-70%)</option>
                            <option value="enhanced-summary">ğŸ“Š ê¸´ ì˜ìƒ ìš”ì•½ (3-5ë¶„)</option>
                            <option value="enhanced-education">ğŸ“š êµìœ¡ ì½˜í…ì¸ </option>
                            <option value="enhanced">âœ¨ ê¸°ë³¸ Enhanced</option>
                            <option value="shorts">âš¡ ê¸°ë³¸ Shorts</option>
                        </select>
                    </div>

                    <div style="display: flex; align-items: flex-end;">
                        <button onclick="analyzeSubtitlesWithAI()" class="btn-secondary" style="padding: 10px 20px; font-size: 0.95rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); white-space: nowrap;">ğŸ¤– ë¶„ì„ ì‹œì‘</button>
                    </div>
                </div>

                <p style="margin: 0; color: #a0aec0; font-size: 0.85rem;">
                    ğŸ’¡ ìë§‰ì„ AIë¡œ ë¶„ì„í•˜ì—¬ ì‡¼ì¸  ìµœì í™”, ì˜ìƒ ìš”ì•½, êµìœ¡ ì½˜í…ì¸  ì œì‘ì„ ìœ„í•œ í¸ì§‘ ì œì•ˆì„ ë°›ìœ¼ì„¸ìš”.
                </p>
                </div>
                </div>
            </div>

            <!-- ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼ (í•­ìƒ í‘œì‹œ) -->
            <div style="background: rgba(0, 0, 0, 0.2); border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                <h4 style="margin: 0 0 10px 0; color: #e0e6ed;">ğŸ’¾ ì‘ì—… ê´€ë¦¬</h4>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="saveAnalysisResult()" class="btn-secondary" style="padding: 8px 16px; font-size: 0.9rem; background: #3b82f6;">ğŸ’¾ ì €ì¥ (ë‹¤ìš´ë¡œë“œ)</button>
                    <button onclick="saveSubtitleAnalysisToLocalStorage()" class="btn-secondary" style="padding: 8px 16px; font-size: 0.9rem; background: #10b981;">ğŸ’¾ ë¸Œë¼ìš°ì €ì— ì €ì¥</button>
                    <button onclick="showSubtitleAnalysisDialog()" class="btn-secondary" style="padding: 8px 16px; font-size: 0.9rem; background: #8b5cf6;">ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                    <button onclick="loadAnalysisFromFile()" class="btn-secondary" style="padding: 8px 16px; font-size: 0.9rem; background: #6366f1;">ğŸ“ íŒŒì¼ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                </div>
                <p style="margin: 10px 0 0 0; color: #a0aec0; font-size: 0.8rem;">
                    ğŸ’¡ ë¶„ì„ ì‘ì—…ì„ ë¸Œë¼ìš°ì €ì— ì €ì¥í•˜ê±°ë‚˜ íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </p>
            </div>

            <!-- ìˆ¨ê²¨ì§„ íŒŒì¼ ì…ë ¥ (ë¶ˆëŸ¬ì˜¤ê¸°ìš©) -->
            <input type="file" id="load-analysis-input" accept=".json" style="display: none;" onchange="handleAnalysisFileLoad(event)">

            <!-- AI ë¶„ì„ ê²°ê³¼ ì„¹ì…˜ (ìˆ¨ê¹€ ìƒíƒœë¡œ ì‹œì‘) -->
            <div id="ai-analysis-result" style="display: none;">
                <!-- ìš”ì•½ í†µê³„ -->
                <div class="analysis-summary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div class="stat-card" style="background: rgba(16, 185, 129, 0.15); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 8px; padding: 15px;">
                        <div style="color: #10b981; font-size: 0.85rem; margin-bottom: 5px;">ì›ë³¸ ì „ì²´ ê¸¸ì´</div>
                        <div style="color: #fff; font-size: 1.5rem; font-weight: 600;" id="original-duration">-</div>
                    </div>
                    <div class="stat-card" style="background: rgba(59, 130, 246, 0.15); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 8px; padding: 15px;">
                        <div style="color: #3b82f6; font-size: 0.85rem; margin-bottom: 5px;">ìš”ì•½ë³¸ ê¸¸ì´</div>
                        <div style="color: #fff; font-size: 1.5rem; font-weight: 600;" id="summary-duration">-</div>
                    </div>
                    <div class="stat-card" style="background: rgba(168, 85, 247, 0.15); border: 1px solid rgba(168, 85, 247, 0.3); border-radius: 8px; padding: 15px;">
                        <div style="color: #a855f7; font-size: 0.85rem; margin-bottom: 5px;">ì‚­ì œìœ¨</div>
                        <div style="color: #fff; font-size: 1.5rem; font-weight: 600;" id="deletion-rate">-</div>
                    </div>
                </div>

                <!-- ì í•©ë„ ì²´í¬ -->
                <div class="suitability-check" style="background: rgba(0, 0, 0, 0.2); border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 15px 0; color: #e0e6ed;">ğŸ“Š ì½˜í…ì¸  ì í•©ë„</h4>
                    <div style="display: grid; gap: 10px;">
                        <div class="suitability-item" style="display: flex; align-items: center; padding: 10px; background: rgba(255, 255, 255, 0.05); border-radius: 6px;">
                            <input type="checkbox" id="suitable-shorts" style="margin-right: 10px; width: 18px; height: 18px;">
                            <label for="suitable-shorts" style="color: #e0e6ed; cursor: pointer; flex: 1;">ğŸ¬ ì‡¼ì¸ ìš© ì í•© (60ì´ˆ ì´ë‚´)</label>
                            <span id="shorts-score" style="color: #10b981; font-weight: 600;">-</span>
                        </div>
                        <div class="suitability-item" style="display: flex; align-items: center; padding: 10px; background: rgba(255, 255, 255, 0.05); border-radius: 6px;">
                            <input type="checkbox" id="suitable-summary" style="margin-right: 10px; width: 18px; height: 18px;">
                            <label for="suitable-summary" style="color: #e0e6ed; cursor: pointer; flex: 1;">ğŸ“Š ê¸´ ì˜ìƒ ìš”ì•½ ì í•© (3-5ë¶„)</label>
                            <span id="summary-score" style="color: #3b82f6; font-weight: 600;">-</span>
                        </div>
                        <div class="suitability-item" style="display: flex; align-items: center; padding: 10px; background: rgba(255, 255, 255, 0.05); border-radius: 6px;">
                            <input type="checkbox" id="suitable-education" style="margin-right: 10px; width: 18px; height: 18px;">
                            <label for="suitable-education" style="color: #e0e6ed; cursor: pointer; flex: 1;">ğŸ“š êµìœ¡ ì½˜í…ì¸  ì í•©</label>
                            <span id="education-score" style="color: #a855f7; font-weight: 600;">-</span>
                        </div>
                    </div>
                </div>

                <!-- ìë§‰ í¸ì§‘ ë²„íŠ¼ -->
                <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                    <button onclick="batchDeleteMarkedForDeletion()" class="btn-secondary" style="padding: 8px 16px; font-size: 0.9rem; background: #ef4444;">ğŸ—‘ï¸ ì‚­ì œ í‘œì‹œ ì¼ê´„ ì‚­ì œ</button>
                    <button onclick="downloadEditedSubtitles()" class="btn-secondary" style="padding: 8px 16px; font-size: 0.9rem; background: #10b981;">ğŸ“¥ ìë§‰ ë‹¤ìš´ë¡œë“œ (SRT)</button>
                    <button onclick="clearAllSubtitles()" class="btn-secondary" style="padding: 8px 16px; font-size: 0.9rem; background: #ef4444;">ğŸ—‘ï¸ ì „ì²´ ì‚­ì œ</button>
                </div>

                <!-- 4ê°€ì§€ ë¶„ë¥˜ë³„ ìë§‰ í‘œì‹œ -->
                <div class="classified-subtitles">
                    <!-- ì›ë³¸ ìë§‰ ìœ ì§€ -->
                    <div class="subtitle-category" style="margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; padding: 10px; background: rgba(16, 185, 129, 0.2); border-radius: 6px;">
                            <h4 style="margin: 0; color: #10b981;">âœ… ì›ë³¸ ìë§‰ ìœ ì§€ (<span id="kept-count">0</span>ê°œ)</h4>
                            <button onclick="toggleCategory('kept-originals')" class="btn-secondary" style="padding: 4px 12px; font-size: 0.85rem; background: #10b981;">ì ‘ê¸°/í¼ì¹˜ê¸°</button>
                        </div>
                        <div id="kept-originals" class="category-list"></div>
                    </div>

                    <!-- ì‚­ì œ ëŒ€ìƒ -->
                    <div class="subtitle-category" style="margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; padding: 10px; background: rgba(239, 68, 68, 0.2); border-radius: 6px;">
                            <h4 style="margin: 0; color: #ef4444;">âŒ ì‚­ì œ ëŒ€ìƒ (<span id="deletions-count">0</span>ê°œ)</h4>
                            <button onclick="toggleCategory('deletions')" class="btn-secondary" style="padding: 4px 12px; font-size: 0.85rem; background: #ef4444;">ì ‘ê¸°/í¼ì¹˜ê¸°</button>
                        </div>
                        <div id="deletions" class="category-list"></div>
                    </div>

                    <!-- í…ìŠ¤íŠ¸ ì¶”ê°€ -->
                    <div class="subtitle-category" style="margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; padding: 10px; background: rgba(59, 130, 246, 0.2); border-radius: 6px;">
                            <h4 style="margin: 0; color: #3b82f6;">â• í…ìŠ¤íŠ¸ ì¶”ê°€ (í™”ë©´ë§Œ) (<span id="text-additions-count">0</span>ê°œ)</h4>
                            <button onclick="toggleCategory('text-additions')" class="btn-secondary" style="padding: 4px 12px; font-size: 0.85rem; background: #3b82f6;">ì ‘ê¸°/í¼ì¹˜ê¸°</button>
                        </div>
                        <div id="text-additions" class="category-list"></div>
                    </div>

                    <!-- ë‚˜ë ˆì´ì…˜ ì¶”ê°€ -->
                    <div class="subtitle-category" style="margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; padding: 10px; background: rgba(168, 85, 247, 0.2); border-radius: 6px;">
                            <h4 style="margin: 0; color: #a855f7;">â•ğŸ™ï¸ ë‚˜ë ˆì´ì…˜ ì¶”ê°€ (ìŒì„±) (<span id="narration-additions-count">0</span>ê°œ)</h4>
                            <button onclick="toggleCategory('narration-additions')" class="btn-secondary" style="padding: 4px 12px; font-size: 0.85rem; background: #a855f7;">ì ‘ê¸°/í¼ì¹˜ê¸°</button>
                        </div>
                        <div id="narration-additions" class="category-list"></div>
                    </div>
                </div>
            </div>

            <!-- ê¸°ë³¸ ìë§‰ í‘œì‹œ (AI ë¶„ì„ ì „) -->
            <div id="default-subtitle-view">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;">ìë§‰ ë‚´ìš©</h3>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="downloadEditedSubtitles()" class="btn-secondary" style="padding: 8px 16px; font-size: 0.9rem; background: #10b981;">ğŸ“¥ ìˆ˜ì •ëœ ìë§‰ ë‹¤ìš´ë¡œë“œ</button>
                        <button onclick="clearAllSubtitles()" class="btn-secondary" style="padding: 8px 16px; font-size: 0.9rem; background: #ef4444;">ğŸ—‘ï¸ ì „ì²´ ì‚­ì œ</button>
                    </div>
                </div>
                <div class="subtitle-list" id="subtitle-list">
                    {% for sub in result.subtitles %}
                    <div class="subtitle-item" data-index="{{ loop.index0 }}" data-start="{{ sub.start }}" data-end="{{ sub.end }}" data-text="{{ sub.text }}">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="flex: 1;">
                                <div class="subtitle-time">
                                    <span class="time-badge">{{ sub.start }} â†’ {{ sub.end }}</span>
                                </div>
                                <div class="subtitle-text">{{ sub.text }}</div>
                            </div>
                            <button onclick="deleteSubtitleItem(this)" class="delete-subtitle-btn" title="ì´ ìë§‰ ì‚­ì œ">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        {% if result.download_url %}
        <div class="download-section">
            <a href="{{ result.download_url }}" class="btn-primary" download>ğŸ“¥ ìë§‰ íŒŒì¼ ë‹¤ìš´ë¡œë“œ</a>
        </div>
        {% endif %}
    </section>
    {% endif %}

    <section class="panel info">
        <h2>ì‚¬ìš© íŒ</h2>
        <ul>
            <li><strong>ì˜ìƒí´ë”</strong>ì— ê²½ë¡œë¥¼ ì…ë ¥í•˜ê³  Enterë¥¼ ëˆ„ë¥´ë©´ í•´ë‹¹ í´ë”ì˜ ì˜ìƒ íŒŒì¼ ëª©ë¡ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
            <li><strong>ì˜ìƒ íŒŒì¼ ëª©ë¡</strong>ì—ì„œ ì˜ìƒì„ í´ë¦­í•˜ë©´ ë¯¸ë¦¬ë³´ê¸°ë¡œ ì˜ìƒ ë‚´ìš©ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
            <li>ì›í•˜ëŠ” ì˜ìƒì„ ì„ íƒí•˜ë©´ ê°™ì€ ì´ë¦„ì˜ ìë§‰ íŒŒì¼ì„ ìë™ìœ¼ë¡œ ì°¾ìŠµë‹ˆë‹¤.</li>
            <li>ìë§‰ íŒŒì¼(.srt, .vtt ë“±)ì„ ì§ì ‘ ì—…ë¡œë“œí•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.</li>
            <li>'ìë™ ê²€ìƒ‰'ì„ ì²´í¬í•˜ë©´ ì§€ì •í•œ í´ë”ì—ì„œ ìë§‰ íŒŒì¼ì„ ì°¾ìŠµë‹ˆë‹¤.</li>
        </ul>
    </section>
</div>

<style>
.panel-sub {
    margin: 0 0 20px 0;
    color: #c8d8e8;
    font-size: 0.95rem;
}

.analyzer-form .field {
    margin-bottom: 20px;
}

.hint-text {
    display: block;
    margin-top: 6px;
    font-size: 0.85rem;
    color: #a0aec0;
}

.result-panel {
    margin-top: 30px;
}

.subtitle-info {
    background: rgba(0, 0, 0, 0.2);
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
}

.subtitle-info p {
    margin: 8px 0;
    color: #e0e6ed;
}

.subtitle-content {
    margin-top: 20px;
}

.subtitle-list {
    max-height: 600px;
    overflow-y: auto;
    background: rgba(0, 0, 0, 0.28);
    border-radius: 8px;
    padding: 15px;
}

.subtitle-item {
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.subtitle-item:last-child {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
}

.subtitle-time {
    margin-bottom: 8px;
}

.time-badge {
    display: inline-block;
    background: rgba(100, 180, 255, 0.2);
    color: #8ac5ff;
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 0.85rem;
    font-family: monospace;
}

.subtitle-text {
    color: #ffffff;
    line-height: 1.6;
    font-size: 1rem;
}

.download-section {
    margin-top: 20px;
    text-align: center;
}

.btn-primary {
    display: inline-block;
    padding: 12px 24px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    text-decoration: none;
    border-radius: 8px;
    font-weight: 600;
    transition: transform 0.2s;
}

.btn-primary:hover {
    transform: translateY(-2px);
}

.loading {
    text-align: center;
    color: #666;
    font-style: italic;
    padding: 20px;
}

.video-list {
    display: grid;
    gap: 10px;
    margin-top: 15px;
}

.video-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 15px;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 6px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    cursor: pointer;
    transition: all 0.2s;
}

.video-item:hover {
    background: rgba(0, 0, 0, 0.3);
    border-color: rgba(100, 180, 255, 0.5);
    transform: translateX(5px);
}

.video-item-info {
    flex: 1;
}

.video-item-name {
    color: #ffffff;
    font-weight: 600;
    margin-bottom: 4px;
}

.video-item-details {
    font-size: 0.85rem;
    color: #a0aec0;
}

.video-item-size {
    color: #8ac5ff;
    margin-right: 10px;
}

.video-item-path {
    font-size: 0.75rem;
    color: #718096;
    margin-top: 4px;
}

.video-item-action {
    padding: 6px 12px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 0.85rem;
    cursor: pointer;
    transition: opacity 0.2s;
}

.video-item-action:hover {
    opacity: 0.8;
}

.empty-state {
    text-align: center;
    color: #888;
    font-style: italic;
    padding: 30px;
}

.video-preview-container {
    display: flex;
    flex-direction: column;
    align-items: center;
}

.video-preview-info {
    width: 100%;
    max-width: 800px;
    background: rgba(0, 0, 0, 0.2);
    padding: 15px;
    border-radius: 8px;
}

.video-preview-info p {
    margin: 8px 0;
    color: #e0e6ed;
    word-break: break-all;
}

.video-preview-actions {
    width: 100%;
    max-width: 800px;
}

.btn-secondary {
    display: inline-block;
    padding: 12px 24px;
    color: white;
    text-decoration: none;
    border-radius: 8px;
    font-weight: 600;
    transition: transform 0.2s;
    border: none;
    cursor: pointer;
    font-size: 1rem;
}

.btn-secondary:hover {
    opacity: 0.8;
}

.delete-subtitle-btn {
    background: #ef4444;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 6px 10px;
    cursor: pointer;
    font-size: 1rem;
    transition: all 0.2s;
    margin-left: 10px;
}

.delete-subtitle-btn:hover {
    background: #dc2626;
    transform: scale(1.1);
}

.subtitle-item {
    transition: all 0.3s;
}

.subtitle-item.removing {
    opacity: 0;
    transform: translateX(-20px);
}

.category-list {
    max-height: 400px;
    overflow-y: auto;
    background: rgba(0, 0, 0, 0.15);
    border-radius: 6px;
    padding: 10px;
}

.category-list.collapsed {
    display: none;
}

.category-item {
    margin-bottom: 15px;
    padding: 12px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 6px;
    border-left: 3px solid;
    transition: all 0.3s;
}

.category-item.kept {
    border-left-color: #10b981;
}

.category-item.deletion {
    border-left-color: #ef4444;
    opacity: 0.7;
}

.category-item.text-add {
    border-left-color: #3b82f6;
}

.category-item.narration-add {
    border-left-color: #a855f7;
}

.category-item.removing {
    opacity: 0;
    transform: translateX(-20px);
}

.category-item-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 8px;
}

.category-item-time {
    color: #8ac5ff;
    font-size: 0.85rem;
    font-family: monospace;
}

.category-item-text {
    color: #e0e6ed;
    line-height: 1.6;
    margin-top: 8px;
}

.category-item-reason {
    margin-top: 8px;
    padding: 6px 10px;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 4px;
    font-size: 0.85rem;
    color: #a0aec0;
}

.item-delete-btn {
    background: #ef4444;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 4px 8px;
    cursor: pointer;
    font-size: 0.85rem;
    transition: all 0.2s;
}

.item-delete-btn:hover {
    background: #dc2626;
    transform: scale(1.05);
}

/* AI ë¶„ì„ select ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
select#ai-model-select,
select#analysis-type-select {
    cursor: pointer;
    transition: all 0.2s;
}

select#ai-model-select:hover,
select#analysis-type-select:hover {
    border-color: rgba(102, 126, 234, 0.5);
    background: rgba(0, 0, 0, 0.4);
}

select#ai-model-select:focus,
select#analysis-type-select:focus {
    outline: none;
    border-color: rgba(102, 126, 234, 0.8);
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

select option {
    background: #1a1a2e;
    color: #e0e6ed;
    padding: 8px;
}

/* ë°˜ì‘í˜• ë””ìì¸ */
@media (max-width: 768px) {
    .analysis-summary {
        grid-template-columns: 1fr !important;
    }

    #ai-model-select,
    #analysis-type-select {
        font-size: 0.85rem !important;
    }
}

/* ==================== í…ìŠ¤íŠ¸ ì˜¤ë²„ë ˆì´ íš¨ê³¼ ==================== */

/* ê¸°ë³¸ ìë§‰ ì˜¤ë²„ë ˆì´ ìŠ¤íƒ€ì¼ */
.custom-subtitle-overlay {
    /* ê¸°ë³¸ ì™¸ê³½ì„  íš¨ê³¼ (ê²€ì€ ë°°ê²½ìš© í°ìƒ‰ ì™¸ê³½ì„ ) */
    text-shadow:
        -0.04em -0.04em 0 #fff,
         0.04em -0.04em 0 #fff,
        -0.04em  0.04em 0 #fff,
         0.04em  0.04em 0 #fff,
        -0.06em  0      0 #fff,
         0.06em  0      0 #fff,
         0      -0.06em 0 #fff,
         0       0.06em 0 #fff;
}

/* ì •ì  íš¨ê³¼ (ìŠ¤íƒ€ì¼) */
.effect-outline {
    text-shadow:
        -0.04em -0.04em 0 #000,
         0.04em -0.04em 0 #000,
        -0.04em  0.04em 0 #000,
         0.04em  0.04em 0 #000,
        -0.06em  0      0 #000,
         0.06em  0      0 #000,
         0      -0.06em 0 #000,
         0       0.06em 0 #000 !important;
}

.effect-shadow {
    text-shadow: 4px 4px 8px rgba(0, 0, 0, 0.8) !important;
}

.effect-glow {
    text-shadow:
        0 0 10px rgba(255, 255, 255, 0.8),
        0 0 20px rgba(255, 255, 255, 0.6),
        0 0 30px rgba(255, 255, 255, 0.4) !important;
}

.effect-gradient {
    background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.effect-neon {
    text-shadow:
        0 0 5px #fff,
        0 0 10px #fff,
        0 0 20px #fff,
        0 0 40px #ff00de,
        0 0 80px #ff00de,
        0 0 90px #ff00de !important;
}

/* ë™ì  íš¨ê³¼ (ëª¨ì…˜) */
@keyframes fadeIn {
    from {
        opacity: 0;
    }
    to {
        opacity: 1;
    }
}

.effect-fade {
    animation: fadeIn 1s ease-in-out infinite alternate;
}

@keyframes slideUp {
    from {
        transform: translateY(20px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.effect-slide-up {
    animation: slideUp 1s ease-in-out infinite alternate;
}

@keyframes slideDown {
    from {
        transform: translateY(-20px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.effect-slide-down {
    animation: slideDown 1s ease-in-out infinite alternate;
}

@keyframes bounce {
    0%, 100% {
        transform: translateY(0);
    }
    50% {
        transform: translateY(-20px);
    }
}

.effect-bounce {
    animation: bounce 1s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.1);
    }
}

.effect-pulse {
    animation: pulse 1.5s ease-in-out infinite;
}

@keyframes slideInRight {
    from {
        transform: translateX(100px);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

/* ìŠ¬ë¼ì´ë“œ ì¸ (ì™¼ìª½ì—ì„œ) */
@keyframes slideIn {
    from {
        transform: translateX(-50px);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

.effect-slide-in {
    animation: slideIn 0.8s ease-out;
}

/* ìŠ¤ì¼€ì¼ (í™•ëŒ€/ì¶•ì†Œ) */
@keyframes scaleAnimation {
    0%, 100% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.15);
    }
}

.effect-scale {
    animation: scaleAnimation 2s ease-in-out infinite;
}

/* ê¸€ë¡œìš° (ë¹›ë‚˜ëŠ” íš¨ê³¼) */
@keyframes glowAnimation {
    0%, 100% {
        text-shadow:
            0 0 5px #fff,
            0 0 10px #fff,
            0 0 15px #fff,
            0 0 20px #ff6b6b;
    }
    50% {
        text-shadow:
            0 0 10px #fff,
            0 0 20px #fff,
            0 0 30px #fff,
            0 0 40px #ff6b6b,
            0 0 50px #ff6b6b,
            0 0 60px #ff6b6b;
    }
}

.effect-glow {
    animation: glowAnimation 2s ease-in-out infinite;
}

</style>

<script>
// localStorage keys
const STORAGE_KEY = 'video_analyzer_settings';
const FRAMES_STORAGE_KEY = 'video_analyzer_frames';
const VIDEO_INFO_STORAGE_KEY = 'video_analyzer_current_video';

// ì„¤ì • ì €ì¥
function saveSettings() {
    const settings = {
        video_path: document.getElementById('video_path').value,
        search_directory: document.getElementById('search_directory').value,
        auto_search: document.querySelector('input[name="auto_search"]').checked,
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(settings));
}

// ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
function loadSettings() {
    const savedSettings = localStorage.getItem(STORAGE_KEY);
    const videoPathInput = document.getElementById('video_path');
    const searchDirInput = document.getElementById('search_directory');

    if (savedSettings) {
        try {
            const settings = JSON.parse(savedSettings);

            // ì €ì¥ëœ ê°’ì´ ìˆìœ¼ë©´ ì…ë ¥ í•„ë“œì— ì„¤ì •
            if (settings.video_path) {
                videoPathInput.value = settings.video_path;
            }
            if (settings.search_directory) {
                searchDirInput.value = settings.search_directory;
            }
            if (settings.auto_search !== undefined) {
                document.querySelector('input[name="auto_search"]').checked = settings.auto_search;
            }
        } catch (e) {
            console.error('Failed to load settings:', e);
        }
    }

    // ì €ì¥ëœ ê°’ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ í´ë” ì„¤ì •
    if (!videoPathInput.value) {
        videoPathInput.value = '/home/sk/ws/youtubeanalysis/youtube/download';
        searchDirInput.value = '/home/sk/ws/youtubeanalysis/youtube/download';
        saveSettings();
    }
}

// Load video files list
async function loadVideoFiles(folderPath) {
    console.log('ğŸ” loadVideoFiles í•¨ìˆ˜ í˜¸ì¶œë¨, folderPath:', folderPath);
    const container = document.getElementById('video-list-container');
    const statusEl = document.getElementById('folder-status');

    if (!container) {
        console.error('âŒ video-list-container ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        return;
    }

    if (!statusEl) {
        console.error('âŒ folder-status ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        return;
    }

    try {
        container.innerHTML = '<div class="loading">ğŸ“ ì˜ìƒ íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
        statusEl.textContent = '';
        console.log('ğŸ“ ì˜ìƒ íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸° ì‹œì‘...');

        const url = folderPath
            ? `/api/video-analyzer/videos?folder=${encodeURIComponent(folderPath)}`
            : '/api/video-analyzer/videos';

        console.log('ğŸŒ API í˜¸ì¶œ:', url);
        const response = await fetch(url);

        if (!response.ok) {
            console.error('âŒ ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜:', response.status);
            throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ${response.status}`);
        }

        const videos = await response.json();
        console.log(`âœ… ${videos.length}ê°œì˜ ì˜ìƒ íŒŒì¼ ë°›ìŒ`);

        // í˜„ì¬ í´ë” ê²½ë¡œ ì €ì¥
        currentFolderPath = folderPath || '';

        // ì €ì¥ëœ ìˆœì„œ ë¶ˆëŸ¬ì˜¤ê¸°
        const orderedVideos = loadVideoListOrder(videos, currentFolderPath);

        displayVideoList(orderedVideos);

        if (videos.length > 0) {
            statusEl.textContent = `âœ“ ${videos.length}ê°œì˜ ì˜ìƒ íŒŒì¼ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤.`;
            statusEl.style.color = '#4ade80';
        } else {
            statusEl.textContent = 'âš  ì˜ìƒ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
            statusEl.style.color = '#fbbf24';
        }
    } catch (error) {
        console.error('âŒ loadVideoFiles ì˜¤ë¥˜:', error);
        container.innerHTML = '<div class="alert error">ì˜ìƒ íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + error.message + '</div>';
        statusEl.textContent = 'âœ— ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨';
        statusEl.style.color = '#ef4444';
    }
}

// ì˜ìƒí´ë” í•„ë“œì—ì„œ ê²½ë¡œë¥¼ ê°€ì ¸ì™€ì„œ ì˜ìƒ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
async function loadVideoFilesFromFolder() {
    const folderPath = document.getElementById('video_path').value.trim();

    if (!folderPath) {
        const statusEl = document.getElementById('folder-status');
        statusEl.textContent = 'âš  ì˜ìƒí´ë” ê²½ë¡œë¥¼ ì…ë ¥í•˜ì„¸ìš”.';
        statusEl.style.color = '#fbbf24';

        // ì˜ìƒí´ë” ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤
        document.getElementById('video_path').focus();
        return;
    }

    await loadVideoFiles(folderPath);
}

// ì„ íƒëœ ì˜ìƒ ëª©ë¡ ê´€ë¦¬
let selectedVideos = [];

// ì „ì—­ ë³€ìˆ˜: í˜„ì¬ ì˜ìƒ ëª©ë¡ ì €ì¥
let currentVideoList = [];
let currentFolderPath = '';

// ì˜ìƒ ëª©ë¡ ë“œë˜ê·¸ ì•¤ ë“œë¡­ ê´€ë ¨ ì „ì—­ ë³€ìˆ˜
let videoListDraggedElement = null;
let videoListDraggedIndex = null;

// ì˜ìƒ ìˆœì„œë¥¼ localStorageì— ì €ì¥
function saveVideoListOrder() {
    if (!currentFolderPath || currentVideoList.length === 0) return;

    const orderKey = 'videoListOrder_' + currentFolderPath;
    const videoPaths = currentVideoList.map(v => v.path);

    try {
        localStorage.setItem(orderKey, JSON.stringify(videoPaths));
        console.log('âœ… ì˜ìƒ ìˆœì„œ ì €ì¥ë¨:', videoPaths.length, 'ê°œ');
    } catch (e) {
        console.error('âŒ ì˜ìƒ ìˆœì„œ ì €ì¥ ì‹¤íŒ¨:', e);
    }
}

// ì €ì¥ëœ ì˜ìƒ ìˆœì„œ ë¶ˆëŸ¬ì˜¤ê¸°
function loadVideoListOrder(videos, folderPath) {
    if (!folderPath || videos.length === 0) return videos;

    const orderKey = 'videoListOrder_' + folderPath;

    try {
        const savedOrderJson = localStorage.getItem(orderKey);
        if (!savedOrderJson) return videos;

        const savedPaths = JSON.parse(savedOrderJson);
        if (!Array.isArray(savedPaths) || savedPaths.length === 0) return videos;

        console.log('ğŸ“‚ ì €ì¥ëœ ì˜ìƒ ìˆœì„œ ë¶ˆëŸ¬ì˜¤ê¸°:', savedPaths.length, 'ê°œ');

        // ê²½ë¡œë¥¼ í‚¤ë¡œ í•˜ëŠ” ë§µ ìƒì„±
        const videoMap = new Map();
        videos.forEach(v => videoMap.set(v.path, v));

        // ì €ì¥ëœ ìˆœì„œëŒ€ë¡œ ì¬ì •ë ¬
        const reorderedVideos = [];
        savedPaths.forEach(path => {
            if (videoMap.has(path)) {
                reorderedVideos.push(videoMap.get(path));
                videoMap.delete(path);
            }
        });

        // ì €ì¥ë˜ì§€ ì•Šì€ ìƒˆë¡œìš´ ì˜ìƒë“¤ì€ ë’¤ì— ì¶”ê°€
        videoMap.forEach(v => reorderedVideos.push(v));

        console.log('âœ… ì˜ìƒ ìˆœì„œ ë³µì› ì™„ë£Œ:', reorderedVideos.length, 'ê°œ');
        return reorderedVideos;

    } catch (e) {
        console.error('âŒ ì˜ìƒ ìˆœì„œ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', e);
        return videos;
    }
}

// ì˜ìƒ ëª©ë¡ ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
function handleVideoListDragStart(event) {
    videoListDraggedElement = event.currentTarget;
    videoListDraggedIndex = parseInt(videoListDraggedElement.getAttribute('data-index'));
    event.currentTarget.style.opacity = '0.5';
    event.dataTransfer.effectAllowed = 'move';
}

function handleVideoListDragOver(event) {
    event.preventDefault();
    event.dataTransfer.dropEffect = 'move';
    return false;
}

function handleVideoListDragEnter(event) {
    const targetElement = event.currentTarget;
    if (targetElement !== videoListDraggedElement && targetElement.classList.contains('video-item')) {
        targetElement.style.borderTop = '3px solid #3b82f6';
    }
}

function handleVideoListDragLeave(event) {
    const targetElement = event.currentTarget;
    targetElement.style.borderTop = '';
}

function handleVideoListDrop(event) {
    event.preventDefault();
    event.stopPropagation();

    const dropTarget = event.currentTarget;
    dropTarget.style.borderTop = '';

    if (videoListDraggedElement === dropTarget) {
        return false;
    }

    const dropIndex = parseInt(dropTarget.getAttribute('data-index'));

    // ë°°ì—´ì—ì„œ ë“œë˜ê·¸ëœ ìš”ì†Œ ì œê±°
    const [removed] = currentVideoList.splice(videoListDraggedIndex, 1);

    // ìƒˆ ìœ„ì¹˜ì— ì‚½ì…
    currentVideoList.splice(dropIndex, 0, removed);

    // ì„ íƒ ìƒíƒœ ì €ì¥
    const selectedPaths = selectedVideos.map(v => v.path);

    // ì˜ìƒ ìˆœì„œë¥¼ localStorageì— ì €ì¥
    saveVideoListOrder();

    // í™”ë©´ ê°±ì‹ 
    displayVideoList(currentVideoList);

    // ì„ íƒ ìƒíƒœ ë³µì›
    restoreVideoSelection(selectedPaths);

    return false;
}

function handleVideoListDragEnd(event) {
    event.currentTarget.style.opacity = '';

    // ëª¨ë“  í…Œë‘ë¦¬ ì œê±°
    document.querySelectorAll('.video-item').forEach(item => {
        item.style.borderTop = '';
    });

    videoListDraggedElement = null;
    videoListDraggedIndex = null;
}

// ë“œë˜ê·¸ ì•¤ ë“œë¡­ í›„ ì„ íƒ ìƒíƒœ ë³µì›
function restoreVideoSelection(selectedPaths) {
    const checkboxes = document.querySelectorAll('.video-checkbox');

    checkboxes.forEach(cb => {
        const path = cb.getAttribute('data-path');
        if (selectedPaths.includes(path)) {
            cb.checked = true;
        }
    });

    updateVideoSelection();
}

function displayVideoList(videos) {
    const container = document.getElementById('video-list-container');

    if (videos.length === 0) {
        container.innerHTML = '<div class="empty-state">ì˜ìƒ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
    }

    // í˜„ì¬ ì˜ìƒ ëª©ë¡ ì €ì¥
    currentVideoList = [...videos];

    // ì„ íƒ ì´ˆê¸°í™”
    selectedVideos = [];
    updateSelectedCount();

    let html = '<div class="video-list">';
    videos.forEach((video, index) => {
        const date = new Date(video.modified).toLocaleString('ko-KR');
        const escapedPath = video.path.replace(/\\/g, '\\\\').replace(/'/g, "\\'");
        const escapedDir = video.directory.replace(/\\/g, '\\\\').replace(/'/g, "\\'");
        const escapedName = video.name.replace(/'/g, "\\'");

        html += `
            <div class="video-item"
                 draggable="true"
                 data-index="${index}"
                 ondragstart="handleVideoListDragStart(event)"
                 ondragover="handleVideoListDragOver(event)"
                 ondrop="handleVideoListDrop(event)"
                 ondragend="handleVideoListDragEnd(event)"
                 ondragenter="handleVideoListDragEnter(event)"
                 ondragleave="handleVideoListDragLeave(event)">
                <div style="display: flex; align-items: center; gap: 10px; width: 100%;">
                    <span style="cursor: move; font-size: 1.2rem; color: #a0aec0; padding: 5px;" title="ë“œë˜ê·¸í•˜ì—¬ ìˆœì„œ ë³€ê²½">â‹®â‹®</span>
                    <input type="checkbox"
                           id="video-checkbox-${index}"
                           class="video-checkbox"
                           data-path="${escapedPath}"
                           data-name="${escapedName}"
                           data-dir="${escapedDir}"
                           onchange="updateVideoSelection()"
                           style="width: 20px; height: 20px; cursor: pointer;">
                    <div class="video-item-info" onclick="previewVideo('${escapedPath}', '${escapedName}', '${escapedDir}', '${video.subtitle_path ? video.subtitle_path.replace(/\\/g, '\\\\').replace(/'/g, "\\'") : ''}')" style="flex: 1; cursor: pointer;">
                        <div class="video-item-name">
                            ğŸ“¹ ${video.name}
                            ${video.has_subtitle ? '<span style="margin-left: 10px; padding: 2px 8px; background: #10b981; color: white; border-radius: 4px; font-size: 0.8rem; font-weight: bold;">ğŸ“Œ ì œëª©ìë§‰</span>' : '<span style="margin-left: 10px; padding: 2px 8px; background: #6b7280; color: white; border-radius: 4px; font-size: 0.8rem;">âŒ ìë§‰ ì—†ìŒ</span>'}
                        </div>
                        <div class="video-item-details">
                            <span class="video-item-size">${video.size_mb} MB</span>
                            <span class="video-item-date">${date}</span>
                        </div>
                        <div class="video-item-path">${video.directory}</div>
                    </div>
                    <button class="video-item-action" onclick="previewVideo('${escapedPath}', '${escapedName}', '${escapedDir}', '${video.subtitle_path ? video.subtitle_path.replace(/\\/g, '\\\\').replace(/'/g, "\\'") : ''}')">
                        ì˜ìƒ ë³´ê¸°
                    </button>
                    ${video.has_subtitle ? `<button class="video-item-action" onclick="previewSubtitle('${video.subtitle_path.replace(/\\/g, '\\\\').replace(/'/g, "\\'")}', '${escapedName}'); event.stopPropagation();" style="background: #10b981; margin-left: 5px;">ğŸ“Œ ì œëª©ìë§‰ ë¯¸ë¦¬ë³´ê¸°</button>` : ''}
                    <button class="video-item-action" onclick="renameVideoFile('${escapedPath}', '${escapedName}', '${escapedDir}'); event.stopPropagation();" style="background: #3b82f6; margin-left: 5px;">
                        âœï¸ ì´ë¦„ ë°”ê¾¸ê¸°
                    </button>
                    <button class="video-item-action" onclick="deleteVideoFile('${escapedPath}', '${escapedName}'); event.stopPropagation();" style="background: #ef4444; margin-left: 5px;">
                        ğŸ—‘ï¸ ì‚­ì œ
                    </button>
                </div>
            </div>
        `;
    });
    html += '</div>';

    container.innerHTML = html;
}

function updateVideoSelection() {
    selectedVideos = [];
    const checkboxes = document.querySelectorAll('.video-checkbox:checked');

    checkboxes.forEach(cb => {
        selectedVideos.push({
            path: cb.getAttribute('data-path'),
            name: cb.getAttribute('data-name'),
            directory: cb.getAttribute('data-dir')
        });
    });

    updateSelectedCount();
}

function updateSelectedCount() {
    const countEl = document.getElementById('selected-count');
    const mergeBtn = document.getElementById('merge-videos-btn');

    countEl.textContent = selectedVideos.length;

    // 2ê°œ ì´ìƒ ì„ íƒë˜ì–´ì•¼ í•©ì¹˜ê¸° ë²„íŠ¼ í‘œì‹œ
    if (selectedVideos.length >= 2) {
        mergeBtn.style.display = 'inline-block';
    } else {
        mergeBtn.style.display = 'none';
    }
}

// ì „ì—­ ë³€ìˆ˜ë¡œ í˜„ì¬ ì„ íƒëœ ì˜ìƒ ì •ë³´ ì €ì¥
let currentVideoInfo = {
    path: '',
    name: '',
    directory: '',
    isLocal: false  // ë¡œì»¬ íŒŒì¼ì¸ì§€ ì„œë²„ íŒŒì¼ì¸ì§€ êµ¬ë¶„
};

async function previewVideo(videoPath, videoName, directory, subtitlePath) {
    // í˜„ì¬ ì˜ìƒ ì •ë³´ ì €ì¥
    currentVideoInfo = {
        path: videoPath,
        name: videoName,
        directory: directory,
        isLocal: false,  // ì„œë²„ íŒŒì¼
        subtitlePath: subtitlePath || null
    };

    // ë¹„ë””ì˜¤ í”Œë ˆì´ì–´ ì„¤ì •
    const videoPlayer = document.getElementById('video-preview-player');
    const videoSource = document.getElementById('video-preview-source');
    const subtitleTrack = document.getElementById('video-subtitle-track');

    // ì˜ìƒ íŒŒì¼ì„ ì„œë²„ì—ì„œ ì œê³µí•˜ëŠ” URLë¡œ ë³€ê²½
    // videoPathë¥¼ URL ì¸ì½”ë”©í•˜ì—¬ ì„œë²„ì— ìš”ì²­
    const encodedPath = encodeURIComponent(videoPath);
    videoSource.src = `/api/video-analyzer/stream?path=${encodedPath}`;

    // ìë§‰ íŒŒì¼ì´ ìˆìœ¼ë©´ ë¡œë“œ
    if (subtitlePath) {
        const encodedSubtitlePath = encodeURIComponent(subtitlePath);
        subtitleTrack.src = `/api/video-analyzer/stream?path=${encodedSubtitlePath}`;

        // ìë§‰ íŠ¸ë™ í™œì„±í™” - load() í˜¸ì¶œ ì „ì— ì„¤ì •
        subtitleTrack.default = true;
        subtitleTrack.mode = 'showing';

        console.log('ğŸ“Œ ì œëª©ìë§‰ ë¡œë“œë¨:', subtitlePath);

        // ìë§‰ íŒŒì¼ì„ loadedSubtitlesì—ë„ ìë™ ë¡œë“œ
        try {
            const response = await fetch(`/api/video-analyzer/stream?path=${encodedSubtitlePath}`);
            if (response.ok) {
                const content = await response.text();
                parseSubtitle(content, 'main');  // ì œëª© ìë§‰ì„ main íŠ¸ë™ì— ë¡œë“œ
                console.log('âœ… ì œëª©ìë§‰ì´ main íŠ¸ë™ì— ìë™ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤');

                // ìë§‰ ì²´í¬ë°•ìŠ¤ ìë™ í™œì„±í™”
                const mainSubtitleCheckbox = document.getElementById('track-main-subtitle-enable');
                if (mainSubtitleCheckbox) {
                    mainSubtitleCheckbox.checked = true;
                }
            }
        } catch (error) {
            console.error('âŒ ì œëª©ìë§‰ ìë™ ë¡œë“œ ì‹¤íŒ¨:', error);
        }
    } else {
        subtitleTrack.src = '';
        subtitleTrack.default = false;
        subtitleTrack.mode = 'hidden';
    }

    // ë¹„ë””ì˜¤ ë¡œë“œ
    videoPlayer.load();

    // loadedmetadata ì´ë²¤íŠ¸ì—ì„œ ìë§‰ íŠ¸ë™ ê°•ì œ í™œì„±í™”
    videoPlayer.addEventListener('loadedmetadata', () => {
        if (subtitlePath) {
            // ëª¨ë“  ìë§‰ íŠ¸ë™ì„ í™•ì¸í•˜ê³  í™œì„±í™”
            const tracks = videoPlayer.textTracks;
            console.log('ìë§‰ íŠ¸ë™ ê°œìˆ˜:', tracks.length);

            for (let i = 0; i < tracks.length; i++) {
                tracks[i].mode = 'showing';
                console.log(`ìë§‰ íŠ¸ë™ ${i} í™œì„±í™”:`, tracks[i]);
            }
        }
    }, { once: true });

    // ë¯¸ë¦¬ë³´ê¸° ì •ë³´ í‘œì‹œ
    document.getElementById('preview-filename').textContent = videoName;
    document.getElementById('preview-filepath').textContent = videoPath;

    // ë¯¸ë¦¬ë³´ê¸° ì„¹ì…˜ í‘œì‹œ
    document.getElementById('video-preview-section').style.display = 'block';

    // ë¯¸ë¦¬ë³´ê¸° ì„¹ì…˜ìœ¼ë¡œ ìŠ¤í¬ë¡¤
    document.getElementById('video-preview-section').scrollIntoView({ behavior: 'smooth', block: 'start' });

    // ë¹„ë””ì˜¤ ì •ë³´ ì €ì¥
    saveCurrentVideoInfo();
}

function useThisVideo() {
    // ë¡œì»¬ íŒŒì¼ì¸ ê²½ìš° í¼ ì œì¶œ
    if (currentVideoInfo.isLocal) {
        // ë¡œì»¬ íŒŒì¼ì€ ì´ë¯¸ video_file inputì— ì„ íƒë˜ì–´ ìˆìœ¼ë¯€ë¡œ í¼ ì œì¶œ
        const form = document.querySelector('.analyzer-form');
        if (form) {
            alert('ë¡œì»¬ íŒŒì¼ì´ ì„ íƒë˜ì–´ ìˆìŠµë‹ˆë‹¤. ìë§‰ ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ìë§‰ì„ ì¶”ì¶œí•˜ì„¸ìš”.');
            // í˜ì´ì§€ ë§¨ ìœ„ë¡œ ìŠ¤í¬ë¡¤
            window.scrollTo({ top: 0, behavior: 'smooth' });
            // ë¯¸ë¦¬ë³´ê¸° ë‹«ê¸°
            closeVideoPreview();
        }
        return;
    }

    // ì„œë²„ íŒŒì¼ì¸ ê²½ìš° ê²½ë¡œ ì„¤ì •
    // ì˜ìƒ íŒŒì¼ì˜ ì „ì²´ ê²½ë¡œë¥¼ video_pathì— ì„¤ì •
    document.getElementById('video_path').value = currentVideoInfo.path;

    // ìë§‰ ê²€ìƒ‰ ë””ë ‰í† ë¦¬ë„ ìë™ìœ¼ë¡œ ì„¤ì •
    document.getElementById('search_directory').value = currentVideoInfo.directory;

    // ìë™ ê²€ìƒ‰ ì²´í¬ë°•ìŠ¤ í™œì„±í™”
    document.querySelector('input[name="auto_search"]').checked = true;

    // ì„¤ì • ì €ì¥
    saveSettings();

    // ìë§‰ ë¶ˆëŸ¬ì˜¤ê¸° í¼ ìë™ ì œì¶œ
    const form = document.querySelector('.analyzer-form');
    if (form) {
        // í¼ ì œì¶œ - ì„ íƒí•œ ì˜ìƒì˜ ìë§‰ì„ ë°”ë¡œ ë¶ˆëŸ¬ì˜´
        form.submit();
    }
}

function closeVideoPreview() {
    const videoPlayer = document.getElementById('video-preview-player');
    videoPlayer.pause();
    videoPlayer.currentTime = 0;

    document.getElementById('video-preview-section').style.display = 'none';
}

// ì§„í–‰ë¥  ëª¨ë‹¬ í‘œì‹œ/ìˆ¨ê¹€ í•¨ìˆ˜
function showProgressModal() {
    document.getElementById('progress-modal').style.display = 'flex';
    updateProgress(0, 'í”„ë¦¬ë·° ì˜ìƒ ìƒì„± ì¤€ë¹„ ì¤‘...');
}

function hideProgressModal() {
    document.getElementById('progress-modal').style.display = 'none';
}

function updateProgress(percentage, message) {
    document.getElementById('progress-percentage').textContent = percentage + '%';
    document.getElementById('progress-bar').style.width = percentage + '%';
    document.getElementById('progress-message').textContent = message;
}

function parsePixelValue(value) {
    const numeric = parseFloat(value);
    return Number.isFinite(numeric) ? numeric : 0;
}

function extractOutlineColor(computedStyle, overlayType) {
    if (!computedStyle) {
        return (overlayType === 'korean' || overlayType === 'english')
            ? 'rgba(255, 255, 255, 1)'
            : 'rgba(0, 0, 0, 0.85)';
    }

    const textShadow = computedStyle.textShadow;
    if (textShadow && textShadow !== 'none') {
        const matches = textShadow.match(/(rgba?\([^)]*\)|#[0-9a-fA-F]{3,8})/g);
        if (matches && matches.length) {
            const solid = matches.find((color) => !/rgba?\([^)]*,\s*0(?:\.0+)?\)/.test(color.trim()));
            return (solid || matches[0]).trim();
        }
    }

    return (overlayType === 'korean' || overlayType === 'english')
        ? 'rgba(255, 255, 255, 1)'
        : 'rgba(0, 0, 0, 0.85)';
}

async function createPreviewVideo() {
    if (!currentVideoInfo || !currentVideoInfo.path) {
        alert('ë¨¼ì € ì˜ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }

    // ë¹„ë””ì˜¤ í”Œë ˆì´ì–´ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    const videoPlayer = document.getElementById('video-preview-player');
    const videoWidth = videoPlayer.videoWidth;
    const videoHeight = videoPlayer.videoHeight;
    const displayWidth = videoPlayer.offsetWidth;
    const displayHeight = videoPlayer.offsetHeight;

    if (!videoWidth || !videoHeight) {
        alert('ì˜ìƒì´ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        return;
    }

    console.log('ğŸ“ ë¹„ë””ì˜¤ ì •ë³´:', { videoWidth, videoHeight, displayWidth, displayHeight });

    // ì§„í–‰ë¥  ëª¨ë‹¬ í‘œì‹œ
    showProgressModal();

    // ì˜¤ë²„ë ˆì´ ì„¤ì • ìˆ˜ì§‘ í•¨ìˆ˜
    function getOverlaySettings(elementId, overlayType) {
        const element = document.getElementById(elementId);
        if (!element || element.style.display === 'none' || element.style.opacity === '0') {
            return null;
        }

        const rect = element.getBoundingClientRect();
        const videoRect = videoPlayer.getBoundingClientRect();

        // ë¹„ë””ì˜¤ í”Œë ˆì´ì–´ ê¸°ì¤€ ìƒëŒ€ ìœ„ì¹˜ ê³„ì‚°
        const relativeX = (rect.left + rect.width / 2 - videoRect.left) / videoRect.width;
        const relativeY = (rect.top + rect.height / 2 - videoRect.top) / videoRect.height;

        // í…ìŠ¤íŠ¸ ë‚´ìš©
        const text = element.textContent.trim();
        if (!text) {
            return null;
        }

        // ìŠ¤íƒ€ì¼ ì •ë³´
        const computedStyle = window.getComputedStyle(element);
        const fontSize = parseInt(computedStyle.fontSize);
        const color = computedStyle.color;
        const fontWeight = computedStyle.fontWeight;
        const outlineColor = extractOutlineColor(computedStyle, overlayType);
        const fontFamily = computedStyle.fontFamily;
        const fontStyle = computedStyle.fontStyle;
        const letterSpacing = computedStyle.letterSpacing;
        const textShadow = computedStyle.textShadow;
        const backgroundColor = computedStyle.backgroundColor;
        const opacity = parseFloat(computedStyle.opacity || element.style.opacity || '1');
        const textAlign = computedStyle.textAlign;
        const textTransform = computedStyle.textTransform;
        const lineHeight = computedStyle.lineHeight;
        const padding = {
            top: parsePixelValue(computedStyle.paddingTop),
            right: parsePixelValue(computedStyle.paddingRight),
            bottom: parsePixelValue(computedStyle.paddingBottom),
            left: parsePixelValue(computedStyle.paddingLeft)
        };

        return {
            text: text,
            x: Math.round(relativeX * videoWidth),
            y: Math.round(relativeY * videoHeight),
            fontSize: Math.round(fontSize * videoWidth / displayWidth),
            color: color,
            fontWeight: fontWeight,
            outlineColor: outlineColor,
            fontFamily: fontFamily,
            fontStyle: fontStyle,
            letterSpacing: letterSpacing,
            textShadow: textShadow,
            backgroundColor: backgroundColor,
            opacity: Number.isFinite(opacity) ? opacity : 1,
            textAlign: textAlign,
            textTransform: textTransform,
            lineHeight: lineHeight,
            padding: padding,
            type: overlayType
        };
    }

    // ëª¨ë“  ì˜¤ë²„ë ˆì´ ì„¤ì • ìˆ˜ì§‘
    const overlays = {
        title: getOverlaySettings('video-title-overlay', 'title'),
        subtitle: getOverlaySettings('video-subtitle-overlay', 'subtitle'),
        korean: getOverlaySettings('korean-subtitle-overlay', 'korean'),
        japanese: getOverlaySettings('japanese-subtitle-overlay', 'japanese'),
        english: getOverlaySettings('english-subtitle-overlay', 'english')
    };

    // ê²€ì • ë°°ê²½ ì„¤ì • ìˆ˜ì§‘
    const blackBars = {
        top: {
            enabled: document.getElementById('top-bar-enable').checked,
            height: parseInt(document.getElementById('top-bar-height').value),
            opacity: parseInt(document.getElementById('top-bar-opacity').value) / 100
        },
        bottom: {
            enabled: document.getElementById('bottom-bar-enable').checked,
            height: parseInt(document.getElementById('bottom-bar-height').value),
            opacity: parseInt(document.getElementById('bottom-bar-opacity').value) / 100
        }
    };

    // íŠ¸ë™ ì²´í¬ë°•ìŠ¤ ìƒíƒœ í™•ì¸ ë° íŒŒì¼ ê²½ë¡œ ìˆ˜ì§‘
    const tracks = {
        video: {
            enabled: document.getElementById('track-video-enable')?.checked || false,
            muted: document.getElementById('video-audio-mute')?.classList.contains('muted') || false
        },
        audio: {
            enabled: document.getElementById('track-audio-enable')?.checked || false,
            file: loadedMedia.audio?.file || null,
            fileName: loadedMedia.audio?.fileName || null
        },
        commentary: {
            enabled: document.getElementById('track-commentary-enable')?.checked || false,
            file: loadedMedia.commentary?.file || null,
            fileName: loadedMedia.commentary?.fileName || null
        },
        bgm: {
            enabled: document.getElementById('track-bgm-enable')?.checked || false,
            file: loadedMedia.bgm?.file || null,
            fileName: loadedMedia.bgm?.fileName || null
        },
        mainSubtitle: {
            enabled: document.getElementById('track-main-subtitle-enable')?.checked || false,
            data: loadedSubtitles.main || null
        },
        translationSubtitle: {
            enabled: document.getElementById('track-translation-subtitle-enable')?.checked || false,
            data: loadedSubtitles.translation || null
        },
        descriptionSubtitle: {
            enabled: document.getElementById('track-description-subtitle-enable')?.checked || false,
            data: loadedSubtitles.description || null
        }
    };

    console.log('ğŸ“‹ íŠ¸ë™ ìƒíƒœ:', tracks);

    // API ìš”ì²­ ë°ì´í„°
    const requestData = {
        video_path: currentVideoInfo.path,
        subtitle_path: currentVideoInfo.subtitlePath || null,
        video_width: videoWidth,
        video_height: videoHeight,
        overlays: overlays,
        black_bars: blackBars,
        tracks: {
            video: {
                enabled: tracks.video.enabled,
                muted: tracks.video.muted
            },
            mainSubtitle: tracks.mainSubtitle,
            translationSubtitle: tracks.translationSubtitle,
            descriptionSubtitle: tracks.descriptionSubtitle
        }
    };

    console.log('ğŸ¬ í”„ë¦¬ë·° ì˜ìƒ ìƒì„± ìš”ì²­:', requestData);

    // ê°€ì§œ ì§„í–‰ë¥  ì‹œë®¬ë ˆì´ì…˜ (ì‹¤ì œ FFmpeg ì§„í–‰ë¥  ëŒ€ì‹ )
    let progress = 0;
    const progressInterval = setInterval(() => {
        if (progress < 90) {
            progress += Math.random() * 10;
            if (progress > 90) progress = 90;
            updateProgress(Math.floor(progress), 'FFmpeg ì²˜ë¦¬ ì¤‘...');
        }
    }, 500);

    try {
        updateProgress(10, 'ì˜ìƒ ì²˜ë¦¬ ì‹œì‘...');

        const response = await fetch('/api/video-analyzer/create-preview-video', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        });

        clearInterval(progressInterval);

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'í”„ë¦¬ë·° ì˜ìƒ ìƒì„± ì‹¤íŒ¨');
        }

        const result = await response.json();
        console.log('âœ… í”„ë¦¬ë·° ì˜ìƒ ìƒì„± ì™„ë£Œ:', result);

        // 100% ì™„ë£Œ í‘œì‹œ
        updateProgress(100, 'ì™„ë£Œ!');

        // ì ì‹œ í›„ ëª¨ë‹¬ ë‹«ê¸°
        setTimeout(() => {
            hideProgressModal();

            // ì„±ê³µ ë©”ì‹œì§€ì™€ í•¨ê»˜ ë‹¤ìš´ë¡œë“œ ë§í¬ ì œê³µ
            const downloadPath = result.preview_path;
            const fileName = result.file_name;

            if (confirm(`í”„ë¦¬ë·° ì˜ìƒì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!\níŒŒì¼ëª…: ${fileName}\n\nì§€ê¸ˆ ë‹¤ìš´ë¡œë“œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                // ë‹¤ìš´ë¡œë“œ
                const encodedPath = encodeURIComponent(downloadPath);
                window.location.href = `/api/video-analyzer/download?path=${encodedPath}`;
            }

            // ìƒì„±ëœ í”„ë¦¬ë·° ì˜ìƒì„ ì˜ìƒ ëª©ë¡ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆë„ë¡ ì•ˆë‚´
            alert('í”„ë¦¬ë·° ì˜ìƒì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.\nì˜ìƒ ëª©ë¡ì„ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ í™•ì¸í•˜ì„¸ìš”.');
        }, 1000);

    } catch (error) {
        clearInterval(progressInterval);
        hideProgressModal();

        console.error('âŒ í”„ë¦¬ë·° ì˜ìƒ ìƒì„± ì˜¤ë¥˜:', error);
        alert(`í”„ë¦¬ë·° ì˜ìƒ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:\n${error.message}`);
    }
}

// ìµœì¢… ì˜ìƒ ì œì‘ (ì²´í¬ëœ íŠ¸ë™ë§Œ í¬í•¨)
async function createFinalVideo() {
    if (!currentVideoInfo || !currentVideoInfo.path) {
        alert('ë¨¼ì € ì˜ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }

    // ë¹„ë””ì˜¤ í”Œë ˆì´ì–´ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    const videoPlayer = document.getElementById('video-preview-player');
    const videoWidth = videoPlayer.videoWidth;
    const videoHeight = videoPlayer.videoHeight;
    const displayWidth = videoPlayer.offsetWidth;
    const displayHeight = videoPlayer.offsetHeight;

    if (!videoWidth || !videoHeight) {
        alert('ì˜ìƒì´ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        return;
    }

    console.log('ğŸ“ ë¹„ë””ì˜¤ ì •ë³´:', { videoWidth, videoHeight, displayWidth, displayHeight });

    // ì§„í–‰ë¥  ëª¨ë‹¬ í‘œì‹œ
    showProgressModal();

    // ì €ì¥ëœ ì„¤ì •ì—ì„œ ì›ë³¸ í°íŠ¸ í¬ê¸° ê°€ì ¸ì˜¤ê¸°
    let savedSettings = null;
    try {
        const saved = localStorage.getItem('videoAnalyzerTextOverlay');
        if (saved) {
            savedSettings = JSON.parse(saved);
        }
    } catch (e) {
        console.error('ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', e);
    }

    // ì˜¤ë²„ë ˆì´ ì„¤ì • ìˆ˜ì§‘ í•¨ìˆ˜
    function getOverlaySettings(elementId, overlayType, savedSize) {
        const element = document.getElementById(elementId);
        if (!element || element.style.display === 'none' || element.style.opacity === '0') {
            return null;
        }

        const rect = element.getBoundingClientRect();
        const videoRect = videoPlayer.getBoundingClientRect();

        // ë¹„ë””ì˜¤ í”Œë ˆì´ì–´ ê¸°ì¤€ ìƒëŒ€ ìœ„ì¹˜ ê³„ì‚°
        const relativeX = (rect.left + rect.width / 2 - videoRect.left) / videoRect.width;
        const relativeY = (rect.top + rect.height / 2 - videoRect.top) / videoRect.height;

        // í…ìŠ¤íŠ¸ ë‚´ìš©
        const text = element.textContent.trim();
        if (!text) {
            return null;
        }

        // ìŠ¤íƒ€ì¼ ì •ë³´
        const computedStyle = window.getComputedStyle(element);
        const color = computedStyle.color;
        const fontWeight = computedStyle.fontWeight;
        const outlineColor = extractOutlineColor(computedStyle, overlayType);
        const fontFamily = computedStyle.fontFamily;
        const fontStyle = computedStyle.fontStyle;
        const letterSpacing = computedStyle.letterSpacing;
        const textShadow = computedStyle.textShadow;
        const backgroundColor = computedStyle.backgroundColor;
        const opacity = parseFloat(computedStyle.opacity || element.style.opacity || '1');
        const textAlign = computedStyle.textAlign;
        const textTransform = computedStyle.textTransform;
        const lineHeight = computedStyle.lineHeight;
        const padding = {
            top: parsePixelValue(computedStyle.paddingTop),
            right: parsePixelValue(computedStyle.paddingRight),
            bottom: parsePixelValue(computedStyle.paddingBottom),
            left: parsePixelValue(computedStyle.paddingLeft)
        };

        // í°íŠ¸ í¬ê¸°: ì €ì¥ëœ ì„¤ì • ê°’ ì‚¬ìš© (ìŠ¤ì¼€ì¼ë§ ì—†ì´ ì›ë³¸ í¬ê¸° ìœ ì§€)
        // ì €ì¥ëœ ì„¤ì •ì´ ì—†ìœ¼ë©´ í˜„ì¬ í‘œì‹œëœ í¬ê¸°ë¥¼ ë¹„ë””ì˜¤ í•´ìƒë„ì— ë§ê²Œ ìŠ¤ì¼€ì¼ë§
        let fontSize;
        if (savedSize) {
            fontSize = parseInt(savedSize);
            console.log(`ğŸ“ ${overlayType} í°íŠ¸ í¬ê¸°: ${fontSize}px (ì €ì¥ëœ ì„¤ì • ì‚¬ìš©)`);
        } else {
            const displayFontSize = parseInt(computedStyle.fontSize);
            fontSize = Math.round(displayFontSize * videoWidth / displayWidth);
            console.log(`ğŸ“ ${overlayType} í°íŠ¸ í¬ê¸°: ${fontSize}px (ìŠ¤ì¼€ì¼ë§: ${displayFontSize}px â†’ ${fontSize}px)`);
        }

        return {
            text: text,
            x: Math.round(relativeX * videoWidth),
            y: Math.round(relativeY * videoHeight),
            fontSize: fontSize,
            color: color,
            fontWeight: fontWeight,
            type: overlayType,
            outlineColor: outlineColor,
            fontFamily: fontFamily,
            fontStyle: fontStyle,
            letterSpacing: letterSpacing,
            textShadow: textShadow,
            backgroundColor: backgroundColor,
            opacity: Number.isFinite(opacity) ? opacity : 1,
            textAlign: textAlign,
            textTransform: textTransform,
            lineHeight: lineHeight,
            padding: padding
        };
    }

    const canvasElement = document.getElementById('video-canvas-preview');
    const isCanvasActive = canvasElement && canvasElement.style.display !== 'none';

    const overlays = {};

    // Canvasê°€ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ Canvas ì˜¤ë²„ë ˆì´ë§Œ ì‚¬ìš©
    if (canvasPreview && isCanvasActive && Array.isArray(canvasPreview.overlays) && canvasPreview.overlays.length > 0) {
        console.log('ğŸ¨ Canvas ì˜¤ë²„ë ˆì´ ì‚¬ìš© (CSS ì˜¤ë²„ë ˆì´ ë¬´ì‹œ)');
        console.log('ğŸ“¦ canvasPreview.overlays ì›ë³¸:', canvasPreview.overlays);

        // Canvas ì˜¤ë²„ë ˆì´ ë°ì´í„°ë¥¼ ì§ì ‘ ì‚¬ìš©
        canvasPreview.overlays.forEach((overlay, index) => {
            const overlayType = overlay.type || `overlay_${index}`;

            const canvasData = {
                text: overlay.text,
                x: Math.round(overlay.x ?? videoWidth / 2),
                y: Math.round(overlay.y ?? videoHeight / 2),
                fontSize: overlay.fontSize || 48,
                color: overlay.color || '#ffffff',
                fontWeight: overlay.fontWeight || 'bold',
                type: overlayType,
                outlineColor: overlay.borderColor || '#000000',
                fontFamily: overlay.fontFamily || 'Noto Sans KR',
                opacity: overlay.opacity !== undefined ? overlay.opacity : 1
            };

            overlays[overlayType] = canvasData;
            console.log(`  âœ… [${index}] ${overlayType}: text="${overlay.text?.substring(0, 20)}...", pos=(${canvasData.x}, ${canvasData.y}), y%=${(canvasData.y/videoHeight*100).toFixed(1)}%`);
        });
    } else {
        // Canvasê°€ ë¹„í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ CSS ì˜¤ë²„ë ˆì´ ì‚¬ìš©
        console.log('ğŸ“„ CSS ì˜¤ë²„ë ˆì´ ì‚¬ìš© (Canvas ë¹„í™œì„±í™”)');

        const appendOverlayFromDom = (elementId, overlayType, savedSize) => {
            const overlayData = getOverlaySettings(elementId, overlayType, savedSize);
            if (overlayData) {
                overlays[overlayType] = overlayData;
            }
        };

        appendOverlayFromDom('video-title-overlay', 'title', savedSettings?.title?.size);
        appendOverlayFromDom('video-subtitle-overlay', 'subtitle', savedSettings?.subtitle?.size);
        appendOverlayFromDom('korean-subtitle-overlay', 'korean', savedSettings?.korean?.size);
        appendOverlayFromDom('japanese-subtitle-overlay', 'japanese', savedSettings?.japanese?.size);
        appendOverlayFromDom('english-subtitle-overlay', 'english', savedSettings?.english?.size);
        appendOverlayFromDom('source-overlay', 'source', savedSettings?.source?.size);
    }

    const filteredOverlays = Object.fromEntries(
        Object.entries(overlays).filter(([, value]) => value && typeof value.text === 'string' && value.text.trim().length > 0)
    );

    console.log('ğŸ“ ìˆ˜ì§‘ëœ ì˜¤ë²„ë ˆì´ (í•„í„°ë§ ì „):', overlays);
    console.log('ğŸ“ ìˆ˜ì§‘ëœ ì˜¤ë²„ë ˆì´ (í•„í„°ë§ í›„):', filteredOverlays);
    console.log('ğŸ¨ Canvas í™œì„±í™” ìƒíƒœ:', isCanvasActive);
    console.log('ğŸ¨ Canvas ì˜¤ë²„ë ˆì´ ê°œìˆ˜:', canvasPreview?.overlays?.length || 0);

    // ê²€ì • ë°°ê²½ ì„¤ì • ìˆ˜ì§‘
    const blackBars = {
        top: {
            enabled: document.getElementById('top-bar-enable').checked,
            height: parseInt(document.getElementById('top-bar-height').value),
            opacity: parseInt(document.getElementById('top-bar-opacity').value) / 100
        },
        bottom: {
            enabled: document.getElementById('bottom-bar-enable').checked,
            height: parseInt(document.getElementById('bottom-bar-height').value),
            opacity: parseInt(document.getElementById('bottom-bar-opacity').value) / 100
        }
    };

    // íŠ¸ë™ ì²´í¬ë°•ìŠ¤ ìƒíƒœ í™•ì¸ ë° íŒŒì¼ ê²½ë¡œ ìˆ˜ì§‘
    const tracks = {
        video: {
            enabled: document.getElementById('track-video-enable')?.checked || false,
            muted: document.getElementById('video-audio-mute')?.classList.contains('muted') || false
        },
        audio: {
            enabled: document.getElementById('track-audio-enable')?.checked || false,
            file: loadedMedia.audio?.file || null,
            fileName: loadedMedia.audio?.fileName || null
        },
        commentary: {
            enabled: document.getElementById('track-commentary-enable')?.checked || false,
            file: loadedMedia.commentary?.file || null,
            fileName: loadedMedia.commentary?.fileName || null
        },
        bgm: {
            enabled: document.getElementById('track-bgm-enable')?.checked || false,
            file: loadedMedia.bgm?.file || null,
            fileName: loadedMedia.bgm?.fileName || null
        },
        mainSubtitle: {
            enabled: document.getElementById('track-main-subtitle-enable')?.checked || false,
            data: loadedSubtitles.main || null
        },
        translationSubtitle: {
            enabled: document.getElementById('track-translation-subtitle-enable')?.checked || false,
            data: loadedSubtitles.translation || null
        },
        descriptionSubtitle: {
            enabled: document.getElementById('track-description-subtitle-enable')?.checked || false,
            data: loadedSubtitles.description || null
        }
    };

    console.log('ğŸ“‹ íŠ¸ë™ ìƒíƒœ:', tracks);

    // ìë§‰ í…œí”Œë¦¿ ì„¤ì • ìˆ˜ì§‘
    const subtitleTemplate = document.querySelector('input[name="subtitle-template-video"]:checked')?.value || 'classic';
    const bannerPrimaryText = document.getElementById('banner-primary-video')?.value || '';
    const bannerSecondaryText = document.getElementById('banner-secondary-video')?.value || '';

    const subtitleStyleSettings = {
        template: subtitleTemplate,
        banner_primary_text: bannerPrimaryText || null,
        banner_secondary_text: bannerSecondaryText || null
    };

    console.log('ğŸ­ ìë§‰ í…œí”Œë¦¿ ì„¤ì •:', subtitleStyleSettings);

    // Canvas ìë§‰ ìœ„ì¹˜ ì •ë³´ ìˆ˜ì§‘
    const canvasSubtitlePositions = canvasPreview ? {
        main: {
            yPosition: canvasPreview.subtitleStyles.main.yPosition,
            fontSize: canvasPreview.subtitleStyles.main.fontSize,
            color: canvasPreview.subtitleStyles.main.color,
            borderWidth: canvasPreview.subtitleStyles.main.borderWidth,
            borderColor: canvasPreview.subtitleStyles.main.borderColor
        },
        translation: {
            yPosition: canvasPreview.subtitleStyles.translation.yPosition,
            fontSize: canvasPreview.subtitleStyles.translation.fontSize,
            color: canvasPreview.subtitleStyles.translation.color,
            borderWidth: canvasPreview.subtitleStyles.translation.borderWidth,
            borderColor: canvasPreview.subtitleStyles.translation.borderColor
        },
        description: {
            yPosition: canvasPreview.subtitleStyles.description.yPosition,
            fontSize: canvasPreview.subtitleStyles.description.fontSize,
            color: canvasPreview.subtitleStyles.description.color,
            borderWidth: canvasPreview.subtitleStyles.description.borderWidth,
            borderColor: canvasPreview.subtitleStyles.description.borderColor
        }
    } : null;

    console.log('ğŸ“ Canvas ìë§‰ ìœ„ì¹˜ ì •ë³´:', canvasSubtitlePositions);

    // FormData ìƒì„± (íŒŒì¼ ì—…ë¡œë“œë¥¼ ìœ„í•´)
    const formData = new FormData();
    formData.append('video_path', currentVideoInfo.path);
    formData.append('video_width', videoWidth);
    formData.append('video_height', videoHeight);
    formData.append('overlays', JSON.stringify(filteredOverlays));
    formData.append('black_bars', JSON.stringify(blackBars));
    formData.append('subtitle_style', JSON.stringify(subtitleStyleSettings));
    formData.append('canvas_subtitle_positions', JSON.stringify(canvasSubtitlePositions));
    formData.append('tracks', JSON.stringify({
        video: tracks.video,
        mainSubtitle: tracks.mainSubtitle,
        translationSubtitle: tracks.translationSubtitle,
        descriptionSubtitle: tracks.descriptionSubtitle
    }));

    // ìŒì„± íŒŒì¼ ì¶”ê°€ (ì²´í¬ëœ íŠ¸ë™ë§Œ)
    if (tracks.audio.enabled && tracks.audio.file) {
        formData.append('audio_file', tracks.audio.file, tracks.audio.fileName);
    }
    if (tracks.commentary.enabled && tracks.commentary.file) {
        formData.append('commentary_file', tracks.commentary.file, tracks.commentary.fileName);
    }
    if (tracks.bgm.enabled && tracks.bgm.file) {
        formData.append('bgm_file', tracks.bgm.file, tracks.bgm.fileName);
    }

    // ê°€ì§œ ì§„í–‰ë¥  ì‹œë®¬ë ˆì´ì…˜
    let progress = 0;
    const progressInterval = setInterval(() => {
        if (progress < 90) {
            progress += Math.random() * 10;
            if (progress > 90) progress = 90;
            updateProgress(Math.floor(progress), 'FFmpegë¡œ ì˜ìƒ í•©ì„± ì¤‘...');
        }
    }, 500);

    try {
        updateProgress(10, 'ìµœì¢… ì˜ìƒ ì œì‘ ì‹œì‘...');

        const response = await fetch('/api/video-analyzer/create-final-video', {
            method: 'POST',
            body: formData
        });

        clearInterval(progressInterval);

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'ìµœì¢… ì˜ìƒ ìƒì„± ì‹¤íŒ¨');
        }

        const result = await response.json();
        console.log('âœ… ìµœì¢… ì˜ìƒ ìƒì„± ì™„ë£Œ:', result);

        // 100% ì™„ë£Œ í‘œì‹œ
        updateProgress(100, 'ì™„ë£Œ!');

        // ì ì‹œ í›„ ëª¨ë‹¬ ë‹«ê¸°
        setTimeout(() => {
            hideProgressModal();

            // ì„±ê³µ ë©”ì‹œì§€ì™€ í•¨ê»˜ ë‹¤ìš´ë¡œë“œ ë§í¬ ì œê³µ
            const downloadPath = result.output_path;
            const fileName = result.file_name;
            const subtitles = result.subtitles || {};

            // ìë§‰ íŒŒì¼ ì •ë³´ ìƒì„±
            let subtitleInfo = '';
            const subtitleTypes = {
                'translation': 'ì£¼ìë§‰ (2-1)',
                'description': 'ë³´ì¡°ìë§‰ (2-2)',
                'japanese': 'ì¼ë³¸ì–´ìë§‰',
                'main': 'ë©”ì¸ìë§‰'
            };

            if (Object.keys(subtitles).length > 0) {
                subtitleInfo = '\n\nğŸ“ ìƒì„±ëœ ìë§‰ íŒŒì¼:\n';
                Object.keys(subtitles).forEach(type => {
                    const label = subtitleTypes[type] || type;
                    subtitleInfo += `  - ${label}\n`;
                });
            }

            if (confirm(`ìµœì¢… ì˜ìƒì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!\níŒŒì¼ëª…: ${fileName}${subtitleInfo}\n\nì§€ê¸ˆ ë¹„ë””ì˜¤ë¥¼ ë‹¤ìš´ë¡œë“œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                // ë¹„ë””ì˜¤ ë‹¤ìš´ë¡œë“œ
                const encodedPath = encodeURIComponent(downloadPath);
                window.location.href = `/api/video-analyzer/download?path=${encodedPath}`;

                // ìë§‰ íŒŒì¼ë„ ë‹¤ìš´ë¡œë“œ
                if (Object.keys(subtitles).length > 0) {
                    setTimeout(() => {
                        if (confirm('ìë§‰ íŒŒì¼ë„ ë‹¤ìš´ë¡œë“œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                            Object.entries(subtitles).forEach(([type, path], index) => {
                                setTimeout(() => {
                                    const encodedSubPath = encodeURIComponent(path);
                                    const link = document.createElement('a');
                                    link.href = `/api/video-analyzer/download?path=${encodedSubPath}`;
                                    link.download = '';
                                    link.click();
                                }, index * 500); // 500ms ê°„ê²©ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œ
                            });
                        }
                    }, 1000);
                }
            }

            alert('ìµœì¢… ì˜ìƒì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.\nì˜ìƒ ëª©ë¡ì„ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ í™•ì¸í•˜ì„¸ìš”.');
        }, 1000);

    } catch (error) {
        clearInterval(progressInterval);
        hideProgressModal();

        console.error('âŒ ìµœì¢… ì˜ìƒ ìƒì„± ì˜¤ë¥˜:', error);
        alert(`ìµœì¢… ì˜ìƒ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:\n${error.message}`);
    }
}

function selectVideo(videoPath, directory) {
    // ì´ì „ í•¨ìˆ˜ í˜¸í™˜ì„±ì„ ìœ„í•´ ìœ ì§€
    document.getElementById('video_path').value = videoPath;
    document.getElementById('search_directory').value = directory;
    document.querySelector('input[name="auto_search"]').checked = true;
    saveSettings();
    window.scrollTo({ top: 0, behavior: 'smooth' });

    const videoPathInput = document.getElementById('video_path');
    videoPathInput.style.background = 'rgba(100, 180, 255, 0.1)';
    setTimeout(() => {
        videoPathInput.style.background = '';
    }, 1000);
}

// ì…ë ¥ í•„ë“œ ë³€ê²½ ì‹œ ìë™ ì €ì¥
function setupAutoSave() {
    const videoPathInput = document.getElementById('video_path');
    const searchDirInput = document.getElementById('search_directory');
    const autoSearchCheckbox = document.querySelector('input[name="auto_search"]');

    // ì…ë ¥ í•„ë“œê°€ ë³€ê²½ë˜ë©´ ì €ì¥
    videoPathInput.addEventListener('input', saveSettings);
    searchDirInput.addEventListener('input', saveSettings);
    autoSearchCheckbox.addEventListener('change', saveSettings);

    // ì˜ìƒí´ë” ì…ë ¥ í•„ë“œì—ì„œ Enter í‚¤ë¥¼ ëˆ„ë¥´ë©´ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    videoPathInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            loadVideoFilesFromFolder();
        }
    });
}

// ì˜ìƒ íŒŒì¼ ì„ íƒ ì‹œ ë¯¸ë¦¬ë³´ê¸°
function handleVideoFileSelect(event) {
    const file = event.target.files[0];
    if (!file) return;

    // ë¹„ë””ì˜¤ íŒŒì¼ì¸ì§€ í™•ì¸
    if (!file.type.startsWith('video/')) {
        alert('ë¹„ë””ì˜¤ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }

    // ë¡œì»¬ íŒŒì¼ URL ìƒì„±
    const fileURL = URL.createObjectURL(file);

    // ë¯¸ë¦¬ë³´ê¸° ì„¹ì…˜ í‘œì‹œ
    const videoPlayer = document.getElementById('video-preview-player');
    const videoSource = document.getElementById('video-preview-source');

    videoSource.src = fileURL;
    videoPlayer.load();

    // ë¯¸ë¦¬ë³´ê¸° ì •ë³´ í‘œì‹œ
    document.getElementById('preview-filename').textContent = file.name;
    document.getElementById('preview-filepath').textContent = 'ë¡œì»¬ íŒŒì¼: ' + file.name;

    // ë¯¸ë¦¬ë³´ê¸° ì„¹ì…˜ í‘œì‹œ
    document.getElementById('video-preview-section').style.display = 'block';

    // í˜„ì¬ ì˜ìƒ ì •ë³´ ì €ì¥
    currentVideoInfo = {
        path: file.name,
        name: file.name,
        directory: '',
        isLocal: true  // ë¡œì»¬ íŒŒì¼
    };

    // ë¯¸ë¦¬ë³´ê¸° ì„¹ì…˜ìœ¼ë¡œ ìŠ¤í¬ë¡¤
    document.getElementById('video-preview-section').scrollIntoView({ behavior: 'smooth', block: 'start' });

    // ì˜ìƒ íŒŒì¼ ëª©ë¡ì— ì„ íƒëœ íŒŒì¼ë§Œ í‘œì‹œ
    displaySingleVideoInList(file);

    // ë¹„ë””ì˜¤ ì •ë³´ ì €ì¥ (ë¡œì»¬ íŒŒì¼ì€ ê²½ë¡œë§Œ ì €ì¥)
    saveCurrentVideoInfo();
}

// ì„ íƒëœ ì˜ìƒ íŒŒì¼ë§Œ ëª©ë¡ì— í‘œì‹œ
function displaySingleVideoInList(file) {
    const container = document.getElementById('video-list-container');
    const statusEl = document.getElementById('folder-status');

    const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
    const date = new Date(file.lastModified).toLocaleString('ko-KR');

    const html = `
        <div class="video-list">
            <div class="video-item" style="border: 2px solid #667eea;">
                <div class="video-item-info">
                    <div class="video-item-name">ğŸ“¹ ${file.name} <span style="color: #4ade80; margin-left: 10px;">âœ“ ì„ íƒë¨</span></div>
                    <div class="video-item-details">
                        <span class="video-item-size">${sizeMB} MB</span>
                        <span class="video-item-date">${date}</span>
                    </div>
                    <div class="video-item-path">ë¡œì»¬ íŒŒì¼</div>
                </div>
            </div>
        </div>
    `;

    container.innerHTML = html;
    statusEl.textContent = 'âœ“ ì„ íƒëœ ì˜ìƒ íŒŒì¼';
    statusEl.style.color = '#4ade80';
}

// í”„ë ˆì„ ì¶”ì¶œ í•¨ìˆ˜ë“¤
async function extractFirstFrame() {
    const videoPath = currentVideoInfo.path;
    if (!videoPath) {
        alert('ë¨¼ì € ì˜ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }

    // ë¡œì»¬ íŒŒì¼ì¸ ê²½ìš° ë¸Œë¼ìš°ì €ì—ì„œ ì§ì ‘ í”„ë ˆì„ ì¶”ì¶œ
    if (currentVideoInfo.isLocal) {
        extractFrameFromVideoElement(0, 'ë§¨ ì• í”„ë ˆì„ (0ì´ˆ)');
        return;
    }

    // ì„œë²„ íŒŒì¼ì¸ ê²½ìš° API í˜¸ì¶œ
    try {
        const response = await fetch('/api/video-analyzer/extract-frame', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                video_path: videoPath,
                frame_type: 'first'
            })
        });

        if (!response.ok) {
            throw new Error('í”„ë ˆì„ ì¶”ì¶œ ì‹¤íŒ¨');
        }

        const result = await response.json();
        displayExtractedFrame(result.frame_data, 'ë§¨ ì• í”„ë ˆì„ (0ì´ˆ)');
    } catch (error) {
        console.error('Error:', error);
        alert('ë§¨ ì• í”„ë ˆì„ ì¶”ì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
}

async function extractLastFrame() {
    const videoPath = currentVideoInfo.path;
    if (!videoPath) {
        alert('ë¨¼ì € ì˜ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }

    // ë¡œì»¬ íŒŒì¼ì¸ ê²½ìš° ë¸Œë¼ìš°ì €ì—ì„œ ì§ì ‘ í”„ë ˆì„ ì¶”ì¶œ
    if (currentVideoInfo.isLocal) {
        const video = document.getElementById('video-preview-player');
        const lastTime = video.duration - 0.1;
        extractFrameFromVideoElement(lastTime, `ë§¨ ë’¤ í”„ë ˆì„ (${lastTime.toFixed(1)}ì´ˆ)`);
        return;
    }

    // ì„œë²„ íŒŒì¼ì¸ ê²½ìš° API í˜¸ì¶œ
    try {
        const response = await fetch('/api/video-analyzer/extract-frame', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                video_path: videoPath,
                frame_type: 'last'
            })
        });

        if (!response.ok) {
            throw new Error('í”„ë ˆì„ ì¶”ì¶œ ì‹¤íŒ¨');
        }

        const result = await response.json();
        displayExtractedFrame(result.frame_data, `ë§¨ ë’¤ í”„ë ˆì„ (${result.timestamp}ì´ˆ)`);
    } catch (error) {
        console.error('Error:', error);
        alert('ë§¨ ë’¤ í”„ë ˆì„ ì¶”ì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
}

// ê°„ê²© ì¦ê°€ í•¨ìˆ˜
function increaseInterval() {
    const input = document.getElementById('frame-interval');
    let currentValue = parseInt(input.value) || 5;
    if (currentValue < 60) {
        input.value = currentValue + 1;
    }
}

// ê°„ê²© ê°ì†Œ í•¨ìˆ˜
function decreaseInterval() {
    const input = document.getElementById('frame-interval');
    let currentValue = parseInt(input.value) || 5;
    if (currentValue > 1) {
        input.value = currentValue - 1;
    }
}

// ê° ì˜ìƒë§ˆë‹¤ ì¶”ì¶œí•  í”„ë ˆì„ ê°œìˆ˜ ì¦ê°€
function increaseSegmentFrames() {
    const input = document.getElementById('frames-per-segment');
    let currentValue = parseInt(input.value) || 2;
    if (currentValue < 10) {
        input.value = currentValue + 1;
    }
}

// ê° ì˜ìƒë§ˆë‹¤ ì¶”ì¶œí•  í”„ë ˆì„ ê°œìˆ˜ ê°ì†Œ
function decreaseSegmentFrames() {
    const input = document.getElementById('frames-per-segment');
    let currentValue = parseInt(input.value) || 2;
    if (currentValue > 1) {
        input.value = currentValue - 1;
    }
}

// ê° ì˜ìƒ êµ¬ê°„ë§ˆë‹¤ ê· ë“±í•˜ê²Œ í”„ë ˆì„ ì¶”ì¶œ
async function extractFramesBySegments() {
    const videoPath = currentVideoInfo.path;
    if (!videoPath) {
        alert('ë¨¼ì € ì˜ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }

    const framesPerSegment = parseInt(document.getElementById('frames-per-segment').value) || 2;

    if (framesPerSegment < 1 || framesPerSegment > 10) {
        alert('ê°œìˆ˜ëŠ” 1ê°œì—ì„œ 10ê°œ ì‚¬ì´ë¡œ ì„¤ì •í•´ì£¼ì„¸ìš”.');
        return;
    }

    // ìë§‰ íŒŒì¼ ê²½ë¡œ ìë™ ìƒì„± ë˜ëŠ” ì…ë ¥ë°›ê¸°
    let subtitlePath = currentVideoInfo.directory ?
        `${currentVideoInfo.directory}/${currentVideoInfo.name.replace(/\.[^.]+$/, '.srt')}` :
        '';

    subtitlePath = prompt('ìë§‰ íŒŒì¼ ê²½ë¡œë¥¼ ì…ë ¥í•˜ì„¸ìš” (mergeëœ ì˜ìƒì˜ ìë§‰ íŒŒì¼):', subtitlePath);

    if (!subtitlePath) {
        return; // ì·¨ì†Œí•œ ê²½ìš°
    }

    // ê¸°ì¡´ í”„ë ˆì„ ê°¤ëŸ¬ë¦¬ ì´ˆê¸°í™”
    const framesGrid = document.getElementById('frames-grid');
    framesGrid.innerHTML = '';

    try {
        // ì„œë²„ API í˜¸ì¶œ
        const response = await fetch('/api/video-analyzer/extract-frames-by-segments', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                video_path: videoPath,
                subtitle_path: subtitlePath,
                frames_per_segment: framesPerSegment
            })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.detail || 'í”„ë ˆì„ ì¶”ì¶œ ì‹¤íŒ¨');
        }

        const result = await response.json();

        // ëª¨ë“  í”„ë ˆì„ í‘œì‹œ
        result.frames.forEach((frame) => {
            const label = `[${frame.segment_index}] ${frame.timestamp}ì´ˆ (${frame.frame_in_segment}/${framesPerSegment})`;
            displayExtractedFrame(frame.frame_data, label);
        });

        alert(`ì´ ${result.total_segments}ê°œ ì˜ìƒì—ì„œ ê°ê° ${framesPerSegment}ê°œì”©, ì´ ${result.total_frames}ê°œì˜ í”„ë ˆì„ì„ ì¶”ì¶œí–ˆìŠµë‹ˆë‹¤.`);
    } catch (error) {
        console.error('Error:', error);
        alert('ê° ì˜ìƒë§ˆë‹¤ í”„ë ˆì„ ì¶”ì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
    }
}

// í˜„ì¬ ì„¤ì •ëœ ê°„ê²©ìœ¼ë¡œ í”„ë ˆì„ ì¶”ì¶œ
async function extractFramesByCurrentInterval() {
    const input = document.getElementById('frame-interval');
    const intervalSeconds = parseInt(input.value) || 5;

    if (intervalSeconds < 1 || intervalSeconds > 60) {
        alert('ê°„ê²©ì€ 1ì´ˆì—ì„œ 60ì´ˆ ì‚¬ì´ë¡œ ì„¤ì •í•´ì£¼ì„¸ìš”.');
        return;
    }

    await extractFramesByInterval(intervalSeconds);
}

async function extractFramesByInterval(intervalSeconds) {
    const videoPath = currentVideoInfo.path;
    if (!videoPath) {
        alert('ë¨¼ì € ì˜ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }

    // ê¸°ì¡´ í”„ë ˆì„ ê°¤ëŸ¬ë¦¬ ì´ˆê¸°í™”
    const framesGrid = document.getElementById('frames-grid');
    framesGrid.innerHTML = '';

    // ë¡œì»¬ íŒŒì¼ì¸ ê²½ìš° ë¸Œë¼ìš°ì €ì—ì„œ ì§ì ‘ í”„ë ˆì„ ì¶”ì¶œ
    if (currentVideoInfo.isLocal) {
        const video = document.getElementById('video-preview-player');
        const duration = video.duration;
        let frameCount = 0;
        let times = [];

        // 0ì´ˆë¶€í„° interval ê°„ê²©ìœ¼ë¡œ ì¶”ê°€
        for (let time = 0; time < duration; time += intervalSeconds) {
            times.push(time);
        }

        // ë§ˆì§€ë§‰ í”„ë ˆì„ ì¶”ê°€ (durationì´ intervalì˜ ë°°ìˆ˜ê°€ ì•„ë‹ ê²½ìš°)
        if (times[times.length - 1] < duration - 0.1) {
            times.push(duration - 0.1);
        }

        // ëª¨ë“  í”„ë ˆì„ ì¶”ì¶œ
        for (let time of times) {
            await extractFrameFromVideoElement(time, `${time.toFixed(1)}ì´ˆ`);
            frameCount++;
        }

        alert(`${frameCount}ê°œì˜ í”„ë ˆì„ì„ ${intervalSeconds}ì´ˆ ê°„ê²©ìœ¼ë¡œ ì¶”ì¶œí–ˆìŠµë‹ˆë‹¤.`);
        return;
    }

    // ì„œë²„ íŒŒì¼ì¸ ê²½ìš° API í˜¸ì¶œ
    try {
        const response = await fetch('/api/video-analyzer/extract-frames-interval', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                video_path: videoPath,
                interval: intervalSeconds
            })
        });

        if (!response.ok) {
            throw new Error('í”„ë ˆì„ ì¶”ì¶œ ì‹¤íŒ¨');
        }

        const result = await response.json();

        // ëª¨ë“  í”„ë ˆì„ í‘œì‹œ
        result.frames.forEach((frame, index) => {
            displayExtractedFrame(frame.frame_data, `${frame.timestamp}ì´ˆ`);
        });

        alert(`${result.frames.length}ê°œì˜ í”„ë ˆì„ì„ ${intervalSeconds}ì´ˆ ê°„ê²©ìœ¼ë¡œ ì¶”ì¶œí–ˆìŠµë‹ˆë‹¤.`);
    } catch (error) {
        console.error('Error:', error);
        alert('í”„ë ˆì„ ì¶”ì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
}

// ìë§‰ ê¸°ì¤€ í”„ë ˆì„ ì¶”ì¶œ
async function extractFramesBySubtitles() {
    const videoPath = currentVideoInfo.path;
    if (!videoPath) {
        alert('ë¨¼ì € ì˜ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }

    // ìë§‰ íŒŒì¼ ê²½ë¡œ ì…ë ¥ ë°›ê¸°
    let subtitlePath = prompt('ìë§‰ íŒŒì¼ ê²½ë¡œë¥¼ ì…ë ¥í•˜ì„¸ìš”:', currentVideoInfo.directory ? `${currentVideoInfo.directory}/${currentVideoInfo.name.replace(/\.[^.]+$/, '.srt')}` : '');

    if (!subtitlePath) {
        return; // ì·¨ì†Œí•œ ê²½ìš°
    }

    // ê¸°ì¡´ í”„ë ˆì„ ê°¤ëŸ¬ë¦¬ ì´ˆê¸°í™”
    const framesGrid = document.getElementById('frames-grid');
    framesGrid.innerHTML = '';

    try {
        // ìë§‰ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const response = await fetch('/api/video-analyzer/get-subtitle-times', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                subtitle_path: subtitlePath
            })
        });

        if (!response.ok) {
            throw new Error('ìë§‰ íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }

        const result = await response.json();
        const times = result.times;

        if (times.length === 0) {
            alert('ìë§‰ ì‹œê°„ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        // ë¡œì»¬ íŒŒì¼ì¸ ê²½ìš° ë¸Œë¼ìš°ì €ì—ì„œ ì§ì ‘ í”„ë ˆì„ ì¶”ì¶œ
        if (currentVideoInfo.isLocal) {
            let frameCount = 0;
            for (let time of times) {
                await extractFrameFromVideoElement(time, `${time.toFixed(1)}ì´ˆ (ìë§‰)`);
                frameCount++;
            }
            alert(`${frameCount}ê°œì˜ í”„ë ˆì„ì„ ì¶”ì¶œí–ˆìŠµë‹ˆë‹¤.`);
            return;
        }

        // ì„œë²„ íŒŒì¼ì¸ ê²½ìš° API í˜¸ì¶œ
        const extractResponse = await fetch('/api/video-analyzer/extract-frames-by-times', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                video_path: videoPath,
                times: times
            })
        });

        if (!extractResponse.ok) {
            throw new Error('í”„ë ˆì„ ì¶”ì¶œ ì‹¤íŒ¨');
        }

        const extractResult = await extractResponse.json();

        // ëª¨ë“  í”„ë ˆì„ í‘œì‹œ
        extractResult.frames.forEach((frame, index) => {
            displayExtractedFrame(frame.frame_data, `${frame.timestamp.toFixed(1)}ì´ˆ (ìë§‰)`);
        });

        alert(`${extractResult.frames.length}ê°œì˜ í”„ë ˆì„ì„ ì¶”ì¶œí–ˆìŠµë‹ˆë‹¤.`);
    } catch (error) {
        console.error('Error:', error);
        alert('ìë§‰ ê¸°ì¤€ í”„ë ˆì„ ì¶”ì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
    }
}

// ìë§‰ ê¸°ì¤€ ì˜ìƒ ìë¥´ê¸°
async function extractVideoClipsBySubtitles() {
    const videoPath = currentVideoInfo.path;
    if (!videoPath) {
        alert('ë¨¼ì € ì˜ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }

    if (currentVideoInfo.isLocal) {
        alert('ë¡œì»¬ íŒŒì¼ì€ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì„œë²„ì— ìˆëŠ” ì˜ìƒ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }

    // ìë§‰ íŒŒì¼ ê²½ë¡œ ì…ë ¥ ë°›ê¸°
    let subtitlePath = prompt('ìë§‰ íŒŒì¼ ê²½ë¡œë¥¼ ì…ë ¥í•˜ì„¸ìš”:', currentVideoInfo.directory ? `${currentVideoInfo.directory}/${currentVideoInfo.name.replace(/\.[^.]+$/, '.srt')}` : '');

    if (!subtitlePath) {
        return; // ì·¨ì†Œí•œ ê²½ìš°
    }

    try {
        alert('ì˜ìƒì„ ìë¥´ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤...');

        // ì„œë²„ì—ì„œ ìë§‰ ê¸°ì¤€ ì˜ìƒ ìë¥´ê¸°
        const response = await fetch('/api/video-analyzer/cut-by-subtitles', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                video_path: videoPath,
                subtitle_path: subtitlePath
            })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.detail || 'ì˜ìƒ ìë¥´ê¸° ì‹¤íŒ¨');
        }

        // ZIP íŒŒì¼ ë‹¤ìš´ë¡œë“œ
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `${currentVideoInfo.name.replace(/\.[^.]+$/, '')}_clips.zip`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        window.URL.revokeObjectURL(url);

        alert('ì˜ìƒ í´ë¦½ì´ ì„±ê³µì ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!');
    } catch (error) {
        console.error('Error:', error);
        alert('ì˜ìƒ ìë¥´ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
    }
}

// ë¹„ë””ì˜¤ ìš”ì†Œì—ì„œ íŠ¹ì • ì‹œê°„ì˜ í”„ë ˆì„ì„ ì¶”ì¶œí•˜ëŠ” í•¨ìˆ˜
async function extractFrameFromVideoElement(time, label) {
    return new Promise((resolve, reject) => {
        const video = document.getElementById('video-preview-player');
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');

        // ë¹„ë””ì˜¤ê°€ ì¤€ë¹„ë˜ì§€ ì•Šì€ ê²½ìš°
        if (video.readyState < 2) {
            alert('ë¹„ë””ì˜¤ê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            reject('Video not ready');
            return;
        }

        // ìº”ë²„ìŠ¤ í¬ê¸°ë¥¼ ë¹„ë””ì˜¤ í¬ê¸°ë¡œ ì„¤ì •
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        // íŠ¹ì • ì‹œê°„ìœ¼ë¡œ ì´ë™
        video.currentTime = time;

        // seeked ì´ë²¤íŠ¸: ë¹„ë””ì˜¤ê°€ íŠ¹ì • ì‹œê°„ìœ¼ë¡œ ì´ë™í–ˆì„ ë•Œ
        const onSeeked = () => {
            video.removeEventListener('seeked', onSeeked);

            // ìº”ë²„ìŠ¤ì— í˜„ì¬ í”„ë ˆì„ ê·¸ë¦¬ê¸°
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            // ìº”ë²„ìŠ¤ë¥¼ Base64 ì´ë¯¸ì§€ë¡œ ë³€í™˜
            canvas.toBlob((blob) => {
                const reader = new FileReader();
                reader.onloadend = () => {
                    // data:image/jpeg;base64, ë¶€ë¶„ ì œê±°
                    const base64data = reader.result.split(',')[1];
                    displayExtractedFrame(base64data, label, time);
                    resolve();
                };
                reader.readAsDataURL(blob);
            }, 'image/jpeg', 0.95);
        };

        video.addEventListener('seeked', onSeeked);
    });
}

function displayExtractedFrame(frameData, label, time) {
    const framesGrid = document.getElementById('frames-grid');
    const gallery = document.getElementById('extracted-frames-gallery');

    const frameItem = document.createElement('div');
    frameItem.className = 'frame-item';
    frameItem.draggable = true;
    frameItem.style.cssText = 'border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; overflow: hidden; background: rgba(0,0,0,0.3); cursor: move; transition: all 0.2s;';
    frameItem.dataset.frame = frameData;
    frameItem.dataset.label = label;
    frameItem.dataset.time = time; // íƒ€ì„ìŠ¤íƒ¬í”„ ì €ì¥

    frameItem.innerHTML = `
        <div style="background: rgba(102, 126, 234, 0.2); padding: 4px; display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; color: #667eea;">
            <input type="checkbox" class="frame-select-checkbox" checked style="margin-left: 5px; width: 16px; height: 16px; cursor: pointer;" onchange="updateFrameAnalysisCost()">
            <span style="cursor: move; flex: 1; text-align: center;">â‹®â‹® ë“œë˜ê·¸í•˜ì—¬ ìˆœì„œ ë³€ê²½</span>
        </div>
        <img src="data:image/jpeg;base64,${frameData}" style="width: 100%; height: auto; display: block;" alt="${label}">
        <div style="padding: 8px; text-align: center;">
            <div style="color: #e0e6ed; font-size: 0.9rem; margin-bottom: 8px;">${label}</div>
            <div style="display: flex; gap: 5px; justify-content: center;">
                <button onclick="downloadFrame(this)" class="btn-secondary" style="padding: 4px 8px; font-size: 0.85rem; background: #667eea;" data-frame="${frameData}">ğŸ“¥ ë‹¤ìš´ë¡œë“œ</button>
                <button onclick="deleteFrame(this)" class="btn-secondary" style="padding: 4px 8px; font-size: 0.85rem; background: #ef4444;">ğŸ—‘ï¸ ì‚­ì œ</button>
            </div>
        </div>
    `;

    // ë“œë˜ê·¸ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì¶”ê°€
    frameItem.addEventListener('dragstart', handleDragStart);
    frameItem.addEventListener('dragover', handleDragOver);
    frameItem.addEventListener('drop', handleDrop);
    frameItem.addEventListener('dragenter', handleDragEnter);
    frameItem.addEventListener('dragleave', handleDragLeave);
    frameItem.addEventListener('dragend', handleDragEnd);

    framesGrid.appendChild(frameItem);
    gallery.style.display = 'block';

    // í”„ë ˆì„ ì €ì¥
    saveExtractedFrames();
}

function downloadFrame(button) {
    const frameData = button.getAttribute('data-frame');
    const link = document.createElement('a');
    link.href = `data:image/jpeg;base64,${frameData}`;
    link.download = `frame_${Date.now()}.jpg`;
    link.click();
}

function deleteFrame(button) {
    // í”„ë ˆì„ ì•„ì´í…œ ì°¾ê¸°
    const frameItem = button.closest('.frame-item');

    if (frameItem) {
        // ì‚­ì œ í™•ì¸
        if (confirm('ì´ í”„ë ˆì„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            frameItem.remove();

            // ê°¤ëŸ¬ë¦¬ê°€ ë¹„ì–´ìˆìœ¼ë©´ ìˆ¨ê¸°ê¸°
            const framesGrid = document.getElementById('frames-grid');
            const gallery = document.getElementById('extracted-frames-gallery');

            if (framesGrid.children.length === 0) {
                gallery.style.display = 'none';
            }

            // í”„ë ˆì„ ì €ì¥
            saveExtractedFrames();
        }
    }
}

// ì¶”ì¶œëœ í”„ë ˆì„ ì¼ê´„ ì €ì¥
async function downloadAllFrames() {
    const frameItems = document.querySelectorAll('.frame-item');

    // í”„ë ˆì„ì´ ì—†ìœ¼ë©´ ë¦¬í„´
    if (frameItems.length === 0) {
        alert('ì €ì¥í•  í”„ë ˆì„ì´ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    // ì €ì¥ ë°©ì‹ ì„ íƒ (ê°œë³„ íŒŒì¼ ë˜ëŠ” ZIP ì••ì¶•)
    const useZip = frameItems.length > 5; // 5ê°œ ì´ˆê³¼ ì‹œ ZIP ì‚¬ìš© ê¶Œì¥
    let downloadMethod = 'zip'; // ê¸°ë³¸ê°’: ZIP

    if (frameItems.length <= 5) {
        // 5ê°œ ì´í•˜ì¼ ë•ŒëŠ” ì‚¬ìš©ìì—ê²Œ ì„ íƒê¶Œ ì œê³µ
        const userChoice = confirm(
            `${frameItems.length}ê°œì˜ í”„ë ˆì„ì„ ì €ì¥í•©ë‹ˆë‹¤.\n\n` +
            `[í™•ì¸] ZIP íŒŒì¼ë¡œ ì••ì¶•í•˜ì—¬ ì €ì¥ (ê¶Œì¥)\n` +
            `[ì·¨ì†Œ] ê°œë³„ íŒŒì¼ë¡œ ì €ì¥`
        );
        downloadMethod = userChoice ? 'zip' : 'individual';
    } else {
        // 5ê°œ ì´ˆê³¼ ì‹œ ZIPë§Œ ì‚¬ìš© (ë¸Œë¼ìš°ì € ë‹¤ìš´ë¡œë“œ ì œí•œ ë°©ì§€)
        if (!confirm(`${frameItems.length}ê°œì˜ í”„ë ˆì„ì„ ZIP íŒŒì¼ë¡œ ì••ì¶•í•˜ì—¬ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nğŸ’¡ í”„ë ˆì„ì´ ë§ì•„ ë¸Œë¼ìš°ì € ë‹¤ìš´ë¡œë“œ ì œí•œì„ ë°©ì§€í•˜ê¸° ìœ„í•´ ZIP íŒŒì¼ë¡œ ì €ì¥í•©ë‹ˆë‹¤.`)) {
            return;
        }
    }

    // í˜„ì¬ ì˜ìƒ ì´ë¦„ ê°€ì ¸ì˜¤ê¸° (íŒŒì¼ëª…ìœ¼ë¡œ ì‚¬ìš©)
    const videoName = currentVideoInfo.name || 'video';
    const baseName = videoName.replace(/\.[^/.]+$/, ''); // í™•ì¥ì ì œê±°

    if (downloadMethod === 'zip') {
        // ZIP íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ
        try {
            // JSZipì´ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
            if (typeof JSZip === 'undefined') {
                alert('âš ï¸ ZIP ì••ì¶• ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê°œë³„ íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œë¥¼ ì‹œë„í•©ë‹ˆë‹¤.');
                downloadMethod = 'individual';
            } else {
                const zip = new JSZip();
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);

                // ëª¨ë“  í”„ë ˆì„ì„ ZIPì— ì¶”ê°€
                for (let i = 0; i < frameItems.length; i++) {
                    const frameItem = frameItems[i];
                    const frameData = frameItem.dataset.frame;
                    const label = frameItem.dataset.label || `frame_${i + 1}`;

                    // Base64 ë°ì´í„°ë¥¼ Blobìœ¼ë¡œ ë³€í™˜
                    const byteString = atob(frameData);
                    const ab = new ArrayBuffer(byteString.length);
                    const ia = new Uint8Array(ab);
                    for (let j = 0; j < byteString.length; j++) {
                        ia[j] = byteString.charCodeAt(j);
                    }

                    // íŒŒì¼ëª…: í”„ë ˆì„ë²ˆí˜¸_ë ˆì´ë¸”.jpg
                    const fileName = `${String(i + 1).padStart(3, '0')}_${label.replace(/[^a-zA-Z0-9ê°€-í£_-]/g, '_')}.jpg`;
                    zip.file(fileName, ab);
                }

                // ZIP íŒŒì¼ ìƒì„±
                const zipBlob = await zip.generateAsync({
                    type: 'blob',
                    compression: 'DEFLATE',
                    compressionOptions: { level: 6 }
                });

                // ZIP íŒŒì¼ ë‹¤ìš´ë¡œë“œ
                const url = URL.createObjectURL(zipBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${baseName}_frames_${timestamp}.zip`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                alert(`âœ… ${frameItems.length}ê°œì˜ í”„ë ˆì„ì´ ZIP íŒŒì¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.\n\níŒŒì¼ëª…: ${baseName}_frames_${timestamp}.zip`);
                return;
            }
        } catch (error) {
            console.error('ZIP ìƒì„± ì‹¤íŒ¨:', error);
            alert(`âš ï¸ ZIP íŒŒì¼ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}\n\nê°œë³„ íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œë¥¼ ì‹œë„í•©ë‹ˆë‹¤.`);
            downloadMethod = 'individual';
        }
    }

    if (downloadMethod === 'individual') {
        // ê°œë³„ íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ (ê¸°ì¡´ ë°©ì‹)
        let downloadedCount = 0;

        // ë¸Œë¼ìš°ì € ë‹¤ìš´ë¡œë“œ ê¶Œí•œ ì•ˆë‚´
        if (frameItems.length > 3) {
            alert('âš ï¸ ì—¬ëŸ¬ íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤.\n\në¸Œë¼ìš°ì €ì—ì„œ "ì—¬ëŸ¬ íŒŒì¼ ë‹¤ìš´ë¡œë“œ í—ˆìš©" ë©”ì‹œì§€ê°€ í‘œì‹œë˜ë©´ [í—ˆìš©]ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        }

        for (let i = 0; i < frameItems.length; i++) {
            const frameItem = frameItems[i];
            const frameData = frameItem.dataset.frame;
            const label = frameItem.dataset.label || `frame_${i + 1}`;

            try {
                // Base64 ë°ì´í„°ë¥¼ Blobìœ¼ë¡œ ë³€í™˜
                const byteString = atob(frameData);
                const ab = new ArrayBuffer(byteString.length);
                const ia = new Uint8Array(ab);
                for (let j = 0; j < byteString.length; j++) {
                    ia[j] = byteString.charCodeAt(j);
                }
                const blob = new Blob([ab], { type: 'image/jpeg' });

                // ë‹¤ìš´ë¡œë“œ ë§í¬ ìƒì„±
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');

                // íŒŒì¼ëª…: ì˜ìƒì´ë¦„_í”„ë ˆì„ë²ˆí˜¸_ë ˆì´ë¸”.jpg
                const fileName = `${baseName}_${String(i + 1).padStart(3, '0')}_${label.replace(/[^a-zA-Z0-9ê°€-í£_-]/g, '_')}.jpg`;
                a.href = url;
                a.download = fileName;

                // ë‹¤ìš´ë¡œë“œ ì‹¤í–‰
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);

                // URL í•´ì œ
                URL.revokeObjectURL(url);

                downloadedCount++;

                // ë¸Œë¼ìš°ì €ê°€ ë‹¤ìš´ë¡œë“œë¥¼ ì²˜ë¦¬í•  ì‹œê°„ ì£¼ê¸° (200ms ê°„ê²©ìœ¼ë¡œ ì¦ê°€)
                await new Promise(resolve => setTimeout(resolve, 200));
            } catch (error) {
                console.error(`í”„ë ˆì„ ${i + 1} ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨:`, error);
            }
        }

        alert(`${downloadedCount}ê°œì˜ í”„ë ˆì„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    }
}

// ì¶”ì¶œëœ í”„ë ˆì„ ì „ì²´ ì‚­ì œ
function clearAllFrames() {
    const framesGrid = document.getElementById('frames-grid');
    const gallery = document.getElementById('extracted-frames-gallery');

    // í”„ë ˆì„ì´ ì—†ìœ¼ë©´ ë¦¬í„´
    if (framesGrid.children.length === 0) {
        alert('ì‚­ì œí•  í”„ë ˆì„ì´ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    // ì‚­ì œ í™•ì¸
    if (confirm(`${framesGrid.children.length}ê°œì˜ ëª¨ë“  í”„ë ˆì„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        // ëª¨ë“  í”„ë ˆì„ ì‚­ì œ
        framesGrid.innerHTML = '';

        // ê°¤ëŸ¬ë¦¬ ìˆ¨ê¸°ê¸°
        gallery.style.display = 'none';

        // í”„ë ˆì„ ì €ì¥ (ë¹ˆ ìƒíƒœë¡œ)
        saveExtractedFrames();

        alert('ëª¨ë“  í”„ë ˆì„ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
    }
}

// ì¶”ì¶œëœ í”„ë ˆì„ë“¤ì„ localStorageì— ì €ì¥
function saveExtractedFrames() {
    const frameItems = document.querySelectorAll('.frame-item');
    const frames = [];

    frameItems.forEach(item => {
        frames.push({
            frameData: item.dataset.frame,
            label: item.dataset.label
        });
    });

    try {
        localStorage.setItem(FRAMES_STORAGE_KEY, JSON.stringify(frames));
    } catch (e) {
        console.error('í”„ë ˆì„ ì €ì¥ ì‹¤íŒ¨ (ìš©ëŸ‰ ì´ˆê³¼ì¼ ìˆ˜ ìˆìŒ):', e);

        // ì‚¬ìš©ìì—ê²Œ ê²½ê³  ë©”ì‹œì§€ í‘œì‹œ
        if (e.name === 'QuotaExceededError' || e.code === 22) {
            // localStorage ìš©ëŸ‰ ì´ˆê³¼ ì‹œ
            const sizeInMB = (JSON.stringify(frames).length / (1024 * 1024)).toFixed(2);
            alert(`âš ï¸ ì €ì¥ ì‹¤íŒ¨: ë¸Œë¼ìš°ì € ì €ì¥ ê³µê°„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.\n\n` +
                  `- ì¶”ì¶œëœ í”„ë ˆì„ ìˆ˜: ${frames.length}ê°œ\n` +
                  `- í•„ìš”í•œ ìš©ëŸ‰: ì•½ ${sizeInMB}MB\n` +
                  `- ë¸Œë¼ìš°ì € ì œí•œ: ì•½ 5-10MB\n\n` +
                  `ğŸ’¡ í•´ê²° ë°©ë²•:\n` +
                  `1. "ğŸ’¾ ì¼ê´„ ì €ì¥" ë²„íŠ¼ìœ¼ë¡œ ì¦‰ì‹œ íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”\n` +
                  `2. ì¼ë¶€ í”„ë ˆì„ì„ ì‚­ì œí•œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”\n` +
                  `3. í•œ ë²ˆì— ì¶”ì¶œí•˜ëŠ” í”„ë ˆì„ ìˆ˜ë¥¼ ì¤„ì´ì„¸ìš”`);
            return false;
        }
    }
    return true;
}

// í˜„ì¬ ë¹„ë””ì˜¤ ì •ë³´ ì €ì¥
function saveCurrentVideoInfo() {
    try {
        localStorage.setItem(VIDEO_INFO_STORAGE_KEY, JSON.stringify(currentVideoInfo));
    } catch (e) {
        console.error('ë¹„ë””ì˜¤ ì •ë³´ ì €ì¥ ì‹¤íŒ¨:', e);
    }
}

// localStorageì—ì„œ í”„ë ˆì„ë“¤ ë³µì›
function restoreExtractedFrames() {
    try {
        const savedFrames = localStorage.getItem(FRAMES_STORAGE_KEY);
        if (!savedFrames) return;

        const frames = JSON.parse(savedFrames);
        if (!frames || frames.length === 0) return;

        // í”„ë ˆì„ ê°¤ëŸ¬ë¦¬ ì´ˆê¸°í™”
        const framesGrid = document.getElementById('frames-grid');
        framesGrid.innerHTML = '';

        // ì €ì¥ëœ í”„ë ˆì„ë“¤ ë³µì›
        frames.forEach(frame => {
            displayExtractedFrameWithoutSave(frame.frameData, frame.label);
        });

        console.log(`${frames.length}ê°œì˜ í”„ë ˆì„ì„ ë³µì›í–ˆìŠµë‹ˆë‹¤.`);
    } catch (e) {
        console.error('í”„ë ˆì„ ë³µì› ì‹¤íŒ¨:', e);
    }
}

// ì €ì¥í•˜ì§€ ì•Šê³  í”„ë ˆì„ë§Œ í‘œì‹œ (ë³µì› ì‹œ ì‚¬ìš©)
function displayExtractedFrameWithoutSave(frameData, label) {
    const framesGrid = document.getElementById('frames-grid');
    const gallery = document.getElementById('extracted-frames-gallery');

    const frameItem = document.createElement('div');
    frameItem.className = 'frame-item';
    frameItem.draggable = true;
    frameItem.style.cssText = 'border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; overflow: hidden; background: rgba(0,0,0,0.3); cursor: move; transition: all 0.2s;';
    frameItem.dataset.frame = frameData;
    frameItem.dataset.label = label;

    frameItem.innerHTML = `
        <div style="background: rgba(102, 126, 234, 0.2); padding: 4px; display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; color: #667eea;">
            <input type="checkbox" class="frame-select-checkbox" checked style="margin-left: 5px; width: 16px; height: 16px; cursor: pointer;" onchange="updateFrameAnalysisCost()">
            <span style="cursor: move; flex: 1; text-align: center;">â‹®â‹® ë“œë˜ê·¸í•˜ì—¬ ìˆœì„œ ë³€ê²½</span>
        </div>
        <img src="data:image/jpeg;base64,${frameData}" style="width: 100%; height: auto; display: block;" alt="${label}">
        <div style="padding: 8px; text-align: center;">
            <div style="color: #e0e6ed; font-size: 0.9rem; margin-bottom: 8px;">${label}</div>
            <div style="display: flex; gap: 5px; justify-content: center;">
                <button onclick="downloadFrame(this)" class="btn-secondary" style="padding: 4px 8px; font-size: 0.85rem; background: #667eea;" data-frame="${frameData}">ğŸ“¥ ë‹¤ìš´ë¡œë“œ</button>
                <button onclick="deleteFrame(this)" class="btn-secondary" style="padding: 4px 8px; font-size: 0.85rem; background: #ef4444;">ğŸ—‘ï¸ ì‚­ì œ</button>
            </div>
        </div>
    `;

    // ë“œë˜ê·¸ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì¶”ê°€
    frameItem.addEventListener('dragstart', handleDragStart);
    frameItem.addEventListener('dragover', handleDragOver);
    frameItem.addEventListener('drop', handleDrop);
    frameItem.addEventListener('dragenter', handleDragEnter);
    frameItem.addEventListener('dragleave', handleDragLeave);
    frameItem.addEventListener('dragend', handleDragEnd);

    framesGrid.appendChild(frameItem);
    gallery.style.display = 'block';
}

// ë¹„ë””ì˜¤ ì •ë³´ ë³µì›
function restoreCurrentVideoInfo() {
    try {
        const savedVideoInfo = localStorage.getItem(VIDEO_INFO_STORAGE_KEY);
        if (!savedVideoInfo) return;

        const videoInfo = JSON.parse(savedVideoInfo);
        if (!videoInfo || !videoInfo.path) return;

        // ë¹„ë””ì˜¤ ì •ë³´ ë³µì›
        currentVideoInfo = videoInfo;

        // ì„œë²„ íŒŒì¼ì¸ ê²½ìš° ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
        if (!videoInfo.isLocal && videoInfo.path) {
            const videoPlayer = document.getElementById('video-preview-player');
            const videoSource = document.getElementById('video-preview-source');

            const encodedPath = encodeURIComponent(videoInfo.path);
            videoSource.src = `/api/video-analyzer/stream?path=${encodedPath}`;
            videoPlayer.load();

            document.getElementById('preview-filename').textContent = videoInfo.name;
            document.getElementById('preview-filepath').textContent = videoInfo.path;

            document.getElementById('video-preview-section').style.display = 'block';

            console.log('ë¹„ë””ì˜¤ ì •ë³´ë¥¼ ë³µì›í–ˆìŠµë‹ˆë‹¤:', videoInfo.name);
        }
    } catch (e) {
        console.error('ë¹„ë””ì˜¤ ì •ë³´ ë³µì› ì‹¤íŒ¨:', e);
    }
}

// ìë§‰ ì‚­ì œ í•¨ìˆ˜
function deleteSubtitleItem(button) {
    const subtitleItem = button.closest('.subtitle-item');

    if (!subtitleItem) {
        return;
    }

    // ì‚­ì œ ì• ë‹ˆë©”ì´ì…˜
    subtitleItem.classList.add('removing');

    // ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ í›„ ìš”ì†Œ ì œê±°
    setTimeout(() => {
        subtitleItem.remove();
        updateSubtitleCount();
    }, 300);
}

// ì „ì²´ ìë§‰ ì‚­ì œ
function clearAllSubtitles() {
    if (!confirm('ëª¨ë“  ìë§‰ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
    }

    const subtitleList = document.getElementById('subtitle-list');
    if (subtitleList) {
        subtitleList.innerHTML = '';
        updateSubtitleCount();
    }
}

// ìë§‰ ê°œìˆ˜ ì—…ë°ì´íŠ¸
function updateSubtitleCount() {
    const subtitleItems = document.querySelectorAll('.subtitle-item');
    const countElement = document.querySelector('.subtitle-info p:last-child strong');

    if (countElement) {
        const parent = countElement.parentElement;
        parent.innerHTML = `<strong>ìë§‰ ë¼ì¸ ìˆ˜:</strong> ${subtitleItems.length}ê°œ`;
    }
}

// ìˆ˜ì •ëœ ìë§‰ ë‹¤ìš´ë¡œë“œ (SRT í˜•ì‹)
function downloadEditedSubtitles() {
    const subtitleItems = document.querySelectorAll('.subtitle-item');

    if (subtitleItems.length === 0) {
        alert('ë‹¤ìš´ë¡œë“œí•  ìë§‰ì´ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    // SRT í˜•ì‹ìœ¼ë¡œ ë³€í™˜
    let srtContent = '';
    subtitleItems.forEach((item, index) => {
        const start = item.dataset.start;
        const end = item.dataset.end;
        const text = item.dataset.text;

        srtContent += `${index + 1}\n`;
        srtContent += `${start} --> ${end}\n`;
        srtContent += `${text}\n\n`;
    });

    // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
    const blob = new Blob([srtContent], { type: 'text/plain;charset=utf-8' });
    const url = window.URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `edited_subtitles_${Date.now()}.srt`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    window.URL.revokeObjectURL(url);

    alert('ìˆ˜ì •ëœ ìë§‰ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!');
}

// ë“œë˜ê·¸ ì•¤ ë“œë¡­ ê´€ë ¨ ë³€ìˆ˜
let draggedElement = null;

function handleDragStart(e) {
    draggedElement = this;
    this.style.opacity = '0.5';
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/html', this.innerHTML);
}

function handleDragOver(e) {
    if (e.preventDefault) {
        e.preventDefault();
    }
    e.dataTransfer.dropEffect = 'move';
    return false;
}

function handleDragEnter(e) {
    if (this !== draggedElement) {
        this.style.borderColor = '#667eea';
        this.style.borderWidth = '2px';
        this.style.transform = 'scale(1.05)';
    }
}

function handleDragLeave(e) {
    this.style.borderColor = 'rgba(255,255,255,0.2)';
    this.style.borderWidth = '1px';
    this.style.transform = 'scale(1)';
}

function handleDrop(e) {
    if (e.stopPropagation) {
        e.stopPropagation();
    }

    // ìê¸° ìì‹ ì—ê²Œ ë“œë¡­í•˜ëŠ” ê²½ìš° ë¬´ì‹œ
    if (draggedElement !== this) {
        // ë“œë˜ê·¸ëœ ìš”ì†Œì™€ ë“œë¡­ ëŒ€ìƒì˜ ìœ„ì¹˜ë¥¼ êµí™˜
        const allItems = Array.from(document.querySelectorAll('.frame-item'));
        const draggedIndex = allItems.indexOf(draggedElement);
        const targetIndex = allItems.indexOf(this);

        const framesGrid = document.getElementById('frames-grid');

        if (draggedIndex < targetIndex) {
            // ë’¤ë¡œ ì´ë™: íƒ€ê²Ÿ ë‹¤ìŒì— ì‚½ì…
            framesGrid.insertBefore(draggedElement, this.nextSibling);
        } else {
            // ì•ìœ¼ë¡œ ì´ë™: íƒ€ê²Ÿ ì•ì— ì‚½ì…
            framesGrid.insertBefore(draggedElement, this);
        }

        // ìˆœì„œê°€ ë³€ê²½ë˜ì—ˆìœ¼ë¯€ë¡œ ì €ì¥
        saveExtractedFrames();
    }

    // ìŠ¤íƒ€ì¼ ë³µì›
    this.style.borderColor = 'rgba(255,255,255,0.2)';
    this.style.borderWidth = '1px';
    this.style.transform = 'scale(1)';

    return false;
}

function handleDragEnd(e) {
    this.style.opacity = '1';

    // ëª¨ë“  í”„ë ˆì„ ì•„ì´í…œì˜ ìŠ¤íƒ€ì¼ ë³µì›
    document.querySelectorAll('.frame-item').forEach(item => {
        item.style.borderColor = 'rgba(255,255,255,0.2)';
        item.style.borderWidth = '1px';
        item.style.transform = 'scale(1)';
    });
}

// ============================================
// AI í”„ë ˆì„ ë¶„ì„ ê´€ë ¨ í•¨ìˆ˜ë“¤
// ============================================

// í”„ë ˆì„ ì „ì²´ ì„ íƒ
function selectAllFrames() {
    const checkboxes = document.querySelectorAll('.frame-select-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = true;
    });
    updateFrameAnalysisCost();
}

// í”„ë ˆì„ ì „ì²´ ì„ íƒ í•´ì œ
function deselectAllFrames() {
    const checkboxes = document.querySelectorAll('.frame-select-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
    updateFrameAnalysisCost();
}

// AI í”„ë ˆì„ ë¶„ì„ ë¹„ìš© ê³„ì‚° ë° ì—…ë°ì´íŠ¸
function updateFrameAnalysisCost() {
    const selectedFrames = document.querySelectorAll('.frame-select-checkbox:checked').length;
    const selectedModel = document.getElementById('frame-ai-model-select').value;
    const costDisplay = document.getElementById('frame-analysis-cost');

    // ëª¨ë¸ë³„ ë¹„ìš© (1000 í† í°ë‹¹ USD ê¸°ì¤€)
    const modelCosts = {
        'gpt-4o-mini': { input: 0.00015, output: 0.0006, imageTokens: 2833 },  // GPT-4o Mini: ì´ë¯¸ì§€ë‹¹ ì•½ 2833 í† í°
        'sonnet': { input: 0.003, output: 0.015, imageTokens: 1600 },  // Claude Sonnet: ì´ë¯¸ì§€ë‹¹ ì•½ 1600 í† í°
        'haiku': { input: 0.0008, output: 0.004, imageTokens: 1600 },  // Claude Haiku: ì´ë¯¸ì§€ë‹¹ ì•½ 1600 í† í°
        'gpt-4o': { input: 0.0025, output: 0.01, imageTokens: 2833 }   // GPT-4o: ì´ë¯¸ì§€ë‹¹ ì•½ 2833 í† í°
    };

    const cost = modelCosts[selectedModel];
    if (!cost) {
        costDisplay.textContent = 'ì˜ˆìƒ ë¹„ìš©: ê³„ì‚° ë¶ˆê°€';
        return;
    }

    // ì…ë ¥ ë¹„ìš©: í”„ë ˆì„ ì´ë¯¸ì§€ í† í° + í”„ë¡¬í”„íŠ¸ í† í° (ì•½ 500 í† í°)
    const inputTokens = (selectedFrames * cost.imageTokens) + 500;
    const outputTokens = 2000; // ì˜ˆìƒ ì¶œë ¥ í† í°

    const inputCost = (inputTokens / 1000) * cost.input;
    const outputCost = (outputTokens / 1000) * cost.output;
    const totalCost = inputCost + outputCost;

    // USDë¥¼ ì›í™”ë¡œ ë³€í™˜ (ì•½ 1300ì›)
    const totalCostKRW = totalCost * 1300;

    if (selectedFrames === 0) {
        costDisplay.textContent = 'ì˜ˆìƒ ë¹„ìš©: ì„ íƒëœ í”„ë ˆì„ì´ ì—†ìŠµë‹ˆë‹¤';
        costDisplay.style.color = '#ef4444';
    } else {
        costDisplay.textContent = `ì˜ˆìƒ ë¹„ìš©: ${selectedFrames}ê°œ í”„ë ˆì„ - ì•½ $${totalCost.toFixed(4)} (â‚©${totalCostKRW.toFixed(0)})`;
        costDisplay.style.color = '#fbbf24';
    }
}

// í”„ë ˆì„ ë¶„ì„ í…œí”Œë¦¿ ë¡œë“œ
function loadFrameAnalysisTemplate() {
    const templateSelect = document.getElementById('frame-analysis-template');
    const selectedTemplate = templateSelect.value;

    if (!selectedTemplate) {
        return; // 'ìƒˆ ë¶„ì„' ì„ íƒ ì‹œ ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•ŠìŒ
    }

    // localStorageì—ì„œ í…œí”Œë¦¿ ë¶ˆëŸ¬ì˜¤ê¸°
    const templates = JSON.parse(localStorage.getItem('frameAnalysisTemplates') || '{}');
    const template = templates[selectedTemplate];

    if (template) {
        // í…œí”Œë¦¿ ì„¤ì • ì ìš©
        document.getElementById('frame-ai-model-select').value = template.model;
        document.getElementById('frame-analysis-type').value = template.analysisType;

        if (template.analysisType === 'custom' && template.customPrompt) {
            document.getElementById('custom-prompt-input').value = template.customPrompt;
            document.getElementById('custom-prompt-container').style.display = 'block';
        }

        updateFrameAnalysisCost();
    }
}

// í”„ë ˆì„ ë¶„ì„ í…œí”Œë¦¿ ì €ì¥
function saveFrameAnalysisTemplate() {
    const templateName = prompt('í…œí”Œë¦¿ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:');
    if (!templateName) {
        return;
    }

    // í˜„ì¬ ì„¤ì • ìˆ˜ì§‘
    const template = {
        model: document.getElementById('frame-ai-model-select').value,
        analysisType: document.getElementById('frame-analysis-type').value,
        customPrompt: document.getElementById('custom-prompt-input').value
    };

    // localStorageì— ì €ì¥
    const templates = JSON.parse(localStorage.getItem('frameAnalysisTemplates') || '{}');
    templates[templateName] = template;
    localStorage.setItem('frameAnalysisTemplates', JSON.stringify(templates));

    // í…œí”Œë¦¿ ë“œë¡­ë‹¤ìš´ì— ì¶”ê°€
    const templateSelect = document.getElementById('frame-analysis-template');
    const option = document.createElement('option');
    option.value = templateName;
    option.textContent = templateName;
    templateSelect.appendChild(option);
    templateSelect.value = templateName;

    alert(`í…œí”Œë¦¿ '${templateName}'ì´(ê°€) ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì €ì¥ëœ í…œí”Œë¦¿ ë¶ˆëŸ¬ì˜¤ê¸°
function loadSavedTemplates() {
    const templates = JSON.parse(localStorage.getItem('frameAnalysisTemplates') || '{}');
    const templateSelect = document.getElementById('frame-analysis-template');

    // ê¸°ì¡´ ì˜µì…˜ ì œê±° (ì²« ë²ˆì§¸ 'ìƒˆ ë¶„ì„' ì˜µì…˜ ì œì™¸)
    while (templateSelect.options.length > 1) {
        templateSelect.remove(1);
    }

    // ì €ì¥ëœ í…œí”Œë¦¿ ì¶”ê°€
    Object.keys(templates).forEach(templateName => {
        const option = document.createElement('option');
        option.value = templateName;
        option.textContent = templateName;
        templateSelect.appendChild(option);
    });
}

// í”„ë ˆì„ ë¶„ì„ ì„¤ì • ì €ì¥
function saveFrameAnalysisSettings() {
    const settings = {
        model: document.getElementById('frame-ai-model-select').value,
        analysisType: document.getElementById('frame-analysis-type').value,
        subtitleLanguagePrimary: document.getElementById('subtitle-language-primary').value,
        subtitleLanguageSecondary: document.getElementById('subtitle-language-secondary').value
    };
    localStorage.setItem('frameAnalysisSettings', JSON.stringify(settings));
}

// í”„ë ˆì„ ë¶„ì„ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
function loadFrameAnalysisSettings() {
    const savedSettings = localStorage.getItem('frameAnalysisSettings');
    if (!savedSettings) return;

    try {
        const settings = JSON.parse(savedSettings);

        const modelSelect = document.getElementById('frame-ai-model-select');
        const typeSelect = document.getElementById('frame-analysis-type');
        const languagePrimarySelect = document.getElementById('subtitle-language-primary');
        const languageSecondarySelect = document.getElementById('subtitle-language-secondary');

        if (settings.model && modelSelect) {
            modelSelect.value = settings.model;
        }

        if (settings.analysisType && typeSelect) {
            typeSelect.value = settings.analysisType;

            // ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸ì¸ ê²½ìš° ì…ë ¥ì°½ í‘œì‹œ
            if (settings.analysisType === 'custom') {
                document.getElementById('custom-prompt-container').style.display = 'block';
            }
        }

        if (settings.subtitleLanguagePrimary && languagePrimarySelect) {
            languagePrimarySelect.value = settings.subtitleLanguagePrimary;
        }

        if (settings.subtitleLanguageSecondary !== undefined && languageSecondarySelect) {
            languageSecondarySelect.value = settings.subtitleLanguageSecondary;
        }

        // ë¹„ìš© ì—…ë°ì´íŠ¸
        updateFrameAnalysisCost();
    } catch (e) {
        console.error('ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', e);
    }
}

// ìë§‰ ì¶”ì¶œ (SRT í˜•ì‹)
function exportSubtitles() {
    const content = document.getElementById('frame-analysis-content').value;

    if (!content || content.trim() === '') {
        alert('ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    // "í™”ë©´ í…ìŠ¤íŠ¸" ë˜ëŠ” "ìë§‰" ì„¹ì…˜ ì¶”ì¶œ
    const subtitleRegex = /###\s*2\.\s*í™”ë©´\s*í…ìŠ¤íŠ¸[^\n]*\n([\s\S]*?)(?=###|$)/gi;
    const matches = content.matchAll(subtitleRegex);

    let srtContent = '';
    let index = 1;
    let startTime = 0;

    for (const match of matches) {
        const text = match[1].trim()
            .replace(/^-\s*/gm, '')  // ë¦¬ìŠ¤íŠ¸ ë§ˆì»¤ ì œê±°
            .split('\n')
            .filter(line => line.trim() && !line.includes('ê°•ì¡°'))
            .join(' ')
            .trim();

        if (text) {
            const endTime = startTime + 3; // 3ì´ˆ ê°„ê²©
            srtContent += `${index}\n`;
            srtContent += `00:00:${String(startTime).padStart(2, '0')},000 --> 00:00:${String(endTime).padStart(2, '0')},000\n`;
            srtContent += `${text}\n\n`;
            index++;
            startTime = endTime;
        }
    }

    if (!srtContent) {
        alert('ìë§‰ ë‚´ìš©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    downloadFile(srtContent, 'subtitles.srt', 'text/plain;charset=utf-8');
    alert('ğŸ’¬ ìë§‰ íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. (SRT í˜•ì‹)\n\ní”„ë¦¬ë¯¸ì–´ í”„ë¡œ, ë‹¤ë¹ˆì¹˜ ë¦¬ì¡¸ë¸Œ ë“±ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.');
}

// í•œê¸€ìë§‰2-0 ë‹¤ìš´ë¡œë“œ (AI ë¶„ì„ ê²°ê³¼ì˜ "2-0. í•œê¸€ ìë§‰" ì„¹ì…˜)
function exportKoreanSubtitles() {
    const content = document.getElementById('frame-analysis-content').value;

    if (!content || content.trim() === '') {
        alert('ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    // "2-0. í•œê¸€ ìë§‰" ì„¹ì…˜ ì¶”ì¶œ (ë‹¤ì–‘í•œ í˜•ì‹ ì§€ì›)
    // ### 2-0. í•œê¸€ ìë§‰, ### 2-0.í•œê¸€ìë§‰, ### 2-0 í•œê¸€ìë§‰ ë“± ëª¨ë‘ ì§€ì›
    const subtitleRegex = /###\s*2[-.]?\s*0\s*[.:)~-]?\s*í•œê¸€\s*ìë§‰[^\n]*\n([\s\S]*?)(?=###|$)/gi;
    const matches = Array.from(content.matchAll(subtitleRegex));

    if (matches.length === 0) {
        alert('í•œê¸€ìë§‰ ë‚´ìš©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\në¶„ì„ ê²°ê³¼ì— "### 2-0. í•œê¸€ ìë§‰" ì„¹ì…˜ì´ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.');
        return;
    }

    let srtContent = '';
    let index = 1;

    // ë¡œë“œëœ ìë§‰ ì •ë³´ê°€ ìˆëŠ”ì§€ í™•ì¸
    const hasLoadedSubtitles = loadedSubtitles.main && loadedSubtitles.main.length > 0;

    if (hasLoadedSubtitles && loadedSubtitles.main.length === matches.length) {
        // ìë§‰ ë¶ˆëŸ¬ì˜¤ê¸°ì—ì„œ ë¡œë“œëœ ì‹œê°„ ì •ë³´ ì‚¬ìš©
        console.log(`âœ… ë¡œë“œëœ ìë§‰ ${loadedSubtitles.main.length}ê°œì˜ ì‹œê°„ ì •ë³´ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.`);

        matches.forEach((match, idx) => {
            const text = match[1].trim()
                .replace(/^-\s*/gm, '')  // ë¦¬ìŠ¤íŠ¸ ë§ˆì»¤ ì œê±°
                .replace(/^[""\"]|[""\"]$/g, '')  // ë”°ì˜´í‘œ ì œê±°
                .split('\n')
                .filter(line => line.trim() && !line.includes('ê°•ì¡°') && !line.includes('ë°°ì¹˜'))
                .join(' ')
                .trim();

            if (text && idx < loadedSubtitles.main.length) {
                const subtitle = loadedSubtitles.main[idx];
                srtContent += `${index}\n`;
                srtContent += `${subtitle.start} --> ${subtitle.end}\n`;
                srtContent += `${text}\n\n`;
                index++;
            }
        });
    } else {
        // ìë§‰ ì •ë³´ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ ì‹œê°„ ê°„ê²© ì‚¬ìš© (3ì´ˆ)
        console.log('âš ï¸ ë¡œë“œëœ ìë§‰ ì •ë³´ê°€ ì—†ì–´ ê¸°ë³¸ ì‹œê°„ ê°„ê²©(3ì´ˆ)ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.');

        let startTime = 0;
        matches.forEach((match) => {
            const text = match[1].trim()
                .replace(/^-\s*/gm, '')  // ë¦¬ìŠ¤íŠ¸ ë§ˆì»¤ ì œê±°
                .replace(/^[""\"]|[""\"]$/g, '')  // ë”°ì˜´í‘œ ì œê±°
                .split('\n')
                .filter(line => line.trim() && !line.includes('ê°•ì¡°') && !line.includes('ë°°ì¹˜'))
                .join(' ')
                .trim();

            if (text) {
                const endTime = startTime + 3; // 3ì´ˆ ê°„ê²©
                srtContent += `${index}\n`;
                srtContent += `00:00:${String(startTime).padStart(2, '0')},000 --> 00:00:${String(endTime).padStart(2, '0')},000\n`;
                srtContent += `${text}\n\n`;
                index++;
                startTime = endTime;
            }
        });
    }

    if (!srtContent) {
        alert('í•œê¸€ìë§‰ ë‚´ìš©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    downloadFile(srtContent, 'korean_subtitles_2-0.srt', 'text/plain;charset=utf-8');

    if (hasLoadedSubtitles) {
        alert('ğŸ“¥ í•œê¸€ìë§‰2-0 íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.\n\nâœ… ë¡œë“œëœ ìë§‰ì˜ ì‹œê°„ ì •ë³´ë¥¼ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.\ní”„ë¦¬ë¯¸ì–´ í”„ë¡œ, ë‹¤ë¹ˆì¹˜ ë¦¬ì¡¸ë¸Œ ë“±ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.');
    } else {
        alert('ğŸ“¥ í•œê¸€ìë§‰2-0 íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.\n\nâš ï¸ ê¸°ë³¸ ì‹œê°„ ê°„ê²©(3ì´ˆ)ì„ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.\ní”„ë¦¬ë¯¸ì–´ í”„ë¡œ, ë‹¤ë¹ˆì¹˜ ë¦¬ì¡¸ë¸Œ ë“±ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.');
    }
}

// ì£¼ìë§‰2-1 ë‹¤ìš´ë¡œë“œ (AI ë¶„ì„ ê²°ê³¼ì˜ "2-1. ì£¼ ìë§‰" ì„¹ì…˜)
function exportMainSubtitles() {
    const content = document.getElementById('frame-analysis-content').value;

    if (!content || content.trim() === '') {
        alert('ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    // "2-1. ì£¼ ìë§‰" ì„¹ì…˜ ì¶”ì¶œ (ë‹¤ì–‘í•œ í˜•ì‹ ì§€ì›)
    // ### 2-1. ì£¼ ìë§‰, ### 2-1.ì£¼ìë§‰, ### 2-1 ì£¼ìë§‰ ë“± ëª¨ë‘ ì§€ì›
    const subtitleRegex = /###\s*2[-.]?\s*1\s*[.:)~-]?\s*ì£¼\s*ìë§‰[^\n]*\n([\s\S]*?)(?=###|$)/gi;
    const matches = Array.from(content.matchAll(subtitleRegex));

    if (matches.length === 0) {
        alert('ì£¼ìë§‰ ë‚´ìš©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    let srtContent = '';
    let index = 1;

    // ë¡œë“œëœ ìë§‰ ì •ë³´ê°€ ìˆëŠ”ì§€ í™•ì¸
    const hasLoadedSubtitles = loadedSubtitles.main && loadedSubtitles.main.length > 0;

    if (hasLoadedSubtitles && loadedSubtitles.main.length === matches.length) {
        // ìë§‰ ë¶ˆëŸ¬ì˜¤ê¸°ì—ì„œ ë¡œë“œëœ ì‹œê°„ ì •ë³´ ì‚¬ìš©
        console.log(`âœ… ë¡œë“œëœ ìë§‰ ${loadedSubtitles.main.length}ê°œì˜ ì‹œê°„ ì •ë³´ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.`);

        matches.forEach((match, idx) => {
            const text = match[1].trim()
                .replace(/^-\s*/gm, '')  // ë¦¬ìŠ¤íŠ¸ ë§ˆì»¤ ì œê±°
                .split('\n')
                .filter(line => line.trim() && !line.includes('ê°•ì¡°'))
                .join(' ')
                .trim();

            if (text && idx < loadedSubtitles.main.length) {
                const subtitle = loadedSubtitles.main[idx];
                srtContent += `${index}\n`;
                srtContent += `${subtitle.start} --> ${subtitle.end}\n`;
                srtContent += `${text}\n\n`;
                index++;
            }
        });
    } else {
        // ìë§‰ ì •ë³´ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ ì‹œê°„ ê°„ê²© ì‚¬ìš© (3ì´ˆ)
        console.log('âš ï¸ ë¡œë“œëœ ìë§‰ ì •ë³´ê°€ ì—†ì–´ ê¸°ë³¸ ì‹œê°„ ê°„ê²©(3ì´ˆ)ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.');

        let startTime = 0;
        matches.forEach((match) => {
            const text = match[1].trim()
                .replace(/^-\s*/gm, '')  // ë¦¬ìŠ¤íŠ¸ ë§ˆì»¤ ì œê±°
                .split('\n')
                .filter(line => line.trim() && !line.includes('ê°•ì¡°'))
                .join(' ')
                .trim();

            if (text) {
                const endTime = startTime + 3; // 3ì´ˆ ê°„ê²©
                srtContent += `${index}\n`;
                srtContent += `00:00:${String(startTime).padStart(2, '0')},000 --> 00:00:${String(endTime).padStart(2, '0')},000\n`;
                srtContent += `${text}\n\n`;
                index++;
                startTime = endTime;
            }
        });
    }

    if (!srtContent) {
        alert('ì£¼ìë§‰ ë‚´ìš©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    downloadFile(srtContent, 'main_subtitles_2-1.srt', 'text/plain;charset=utf-8');

    if (hasLoadedSubtitles) {
        alert('ğŸ“¥ ì£¼ìë§‰2-1 íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.\n\nâœ… ë¡œë“œëœ ìë§‰ì˜ ì‹œê°„ ì •ë³´ë¥¼ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.\ní”„ë¦¬ë¯¸ì–´ í”„ë¡œ, ë‹¤ë¹ˆì¹˜ ë¦¬ì¡¸ë¸Œ ë“±ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.');
    } else {
        alert('ğŸ“¥ ì£¼ìë§‰2-1 íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.\n\nâš ï¸ ê¸°ë³¸ ì‹œê°„ ê°„ê²©(3ì´ˆ)ì„ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.\ní”„ë¦¬ë¯¸ì–´ í”„ë¡œ, ë‹¤ë¹ˆì¹˜ ë¦¬ì¡¸ë¸Œ ë“±ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.');
    }
}

// ë³´ì¡° ìë§‰2-2 ë‹¤ìš´ë¡œë“œ (AI ë¶„ì„ ê²°ê³¼ì˜ "2-2. ë³´ì¡° ìë§‰" ì„¹ì…˜)
function exportSecondarySubtitles() {
    const content = document.getElementById('frame-analysis-content').value;

    if (!content || content.trim() === '') {
        alert('ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    // "2-2. ë³´ì¡° ìë§‰" ì„¹ì…˜ ì¶”ì¶œ (ë‹¤ì–‘í•œ í˜•ì‹ ì§€ì›)
    // ### 2-2. ë³´ì¡° ìë§‰, ### 2-2.ë³´ì¡°ìë§‰, ### 2-2 ë³´ì¡°ìë§‰ ë“± ëª¨ë‘ ì§€ì›
    const descriptionRegex = /###\s*2[-.]?\s*2\s*[.:)~-]?\s*ë³´ì¡°\s*ìë§‰[^\n]*\n([\s\S]*?)(?=###|$)/gi;
    const matches = Array.from(content.matchAll(descriptionRegex));

    if (matches.length === 0) {
        alert('ë³´ì¡° ìë§‰ ë‚´ìš©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    let srtContent = '';
    let index = 1;

    // ë¡œë“œëœ ìë§‰ ì •ë³´ê°€ ìˆëŠ”ì§€ í™•ì¸
    const hasLoadedSubtitles = loadedSubtitles.main && loadedSubtitles.main.length > 0;

    if (hasLoadedSubtitles && loadedSubtitles.main.length === matches.length) {
        // ìë§‰ ë¶ˆëŸ¬ì˜¤ê¸°ì—ì„œ ë¡œë“œëœ ì‹œê°„ ì •ë³´ ì‚¬ìš©
        console.log(`âœ… ë¡œë“œëœ ìë§‰ ${loadedSubtitles.main.length}ê°œì˜ ì‹œê°„ ì •ë³´ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.`);

        matches.forEach((match, idx) => {
            const text = match[1].trim()
                .replace(/^-\s*/gm, '')  // ë¦¬ìŠ¤íŠ¸ ë§ˆì»¤ ì œê±°
                .split('\n')
                .filter(line => line.trim())
                .join(' ')
                .trim();

            if (text && idx < loadedSubtitles.main.length) {
                const subtitle = loadedSubtitles.main[idx];
                srtContent += `${index}\n`;
                srtContent += `${subtitle.start} --> ${subtitle.end}\n`;
                srtContent += `${text}\n\n`;
                index++;
            }
        });
    } else {
        // ìë§‰ ì •ë³´ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ ì‹œê°„ ê°„ê²© ì‚¬ìš© (4ì´ˆ)
        console.log('âš ï¸ ë¡œë“œëœ ìë§‰ ì •ë³´ê°€ ì—†ì–´ ê¸°ë³¸ ì‹œê°„ ê°„ê²©(4ì´ˆ)ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.');

        let startTime = 0;
        matches.forEach((match) => {
            const text = match[1].trim()
                .replace(/^-\s*/gm, '')  // ë¦¬ìŠ¤íŠ¸ ë§ˆì»¤ ì œê±°
                .split('\n')
                .filter(line => line.trim())
                .join(' ')
                .trim();

            if (text) {
                const endTime = startTime + 4; // 4ì´ˆ ê°„ê²© (ì„¤ëª…ì´ ë” ê¸¸ ìˆ˜ ìˆìœ¼ë¯€ë¡œ)
                srtContent += `${index}\n`;
                srtContent += `00:00:${String(startTime).padStart(2, '0')},000 --> 00:00:${String(endTime).padStart(2, '0')},000\n`;
                srtContent += `${text}\n\n`;
                index++;
                startTime = endTime;
            }
        });
    }

    if (!srtContent) {
        alert('ë³´ì¡° ìë§‰ ë‚´ìš©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    downloadFile(srtContent, 'secondary_subtitles_2-2.srt', 'text/plain;charset=utf-8');

    if (hasLoadedSubtitles) {
        alert('ğŸ“¥ ë³´ì¡° ìë§‰2-2 íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.\n\nâœ… ë¡œë“œëœ ìë§‰ì˜ ì‹œê°„ ì •ë³´ë¥¼ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.\ní”„ë¦¬ë¯¸ì–´ í”„ë¡œ, ë‹¤ë¹ˆì¹˜ ë¦¬ì¡¸ë¸Œ ë“±ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.');
    } else {
        alert('ğŸ“¥ ë³´ì¡° ìë§‰2-2 íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.\n\nâš ï¸ ê¸°ë³¸ ì‹œê°„ ê°„ê²©(4ì´ˆ)ì„ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.\ní”„ë¦¬ë¯¸ì–´ í”„ë¡œ, ë‹¤ë¹ˆì¹˜ ë¦¬ì¡¸ë¸Œ ë“±ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.');
    }
}

// ë‚˜ë ˆì´ì…˜ ì¶”ì¶œ (TXT í˜•ì‹)
function exportNarration() {
    const content = document.getElementById('frame-analysis-content').value;

    if (!content || content.trim() === '') {
        alert('ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    // "ë‚˜ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸" ì„¹ì…˜ ì¶”ì¶œ
    const narrationRegex = /###\s*3\.\s*ë‚˜ë ˆì´ì…˜\s*ìŠ¤í¬ë¦½íŠ¸[^\n]*\n([\s\S]*?)(?=###|$)/gi;
    const matches = content.matchAll(narrationRegex);

    let narrationContent = '';
    let frameNum = 1;

    for (const match of matches) {
        const text = match[1].trim()
            .replace(/^-\s*/gm, '')
            .split('\n')
            .filter(line => line.trim() && !line.includes('ì˜ˆìƒ') && !line.includes('ì½ê¸°'))
            .join(' ')
            .trim();

        if (text) {
            narrationContent += `[í”„ë ˆì„ ${frameNum}]\n${text}\n\n`;
            frameNum++;
        }
    }

    if (!narrationContent) {
        alert('ë‚˜ë ˆì´ì…˜ ë‚´ìš©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    downloadFile(narrationContent, 'narration.txt', 'text/plain;charset=utf-8');
    alert('ğŸ™ï¸ ë‚˜ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.\n\nTypecast, VREW ë“± TTS ì„œë¹„ìŠ¤ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.');
}

// ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ ì¶”ì¶œ (TXT í˜•ì‹)
function exportImagePrompts() {
    const content = document.getElementById('frame-analysis-content').value;

    if (!content || content.trim() === '') {
        alert('ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    // "AI ì´ë¯¸ì§€ ìƒì„± í”„ë¡¬í”„íŠ¸" ì„¹ì…˜ ì¶”ì¶œ
    const promptRegex = /###\s*4\.\s*AI\s*ì´ë¯¸ì§€\s*ìƒì„±\s*í”„ë¡¬í”„íŠ¸[^\n]*\n([\s\S]*?)(?=###|$)/gi;
    const matches = content.matchAll(promptRegex);

    let promptsContent = '';
    let frameNum = 1;

    for (const match of matches) {
        const text = match[1].trim()
            .replace(/^-\s*/gm, '')
            .split('\n')
            .filter(line => line.trim() && !line.includes('DALL-E') && !line.includes('ì˜ˆì‹œ'))
            .join(' ')
            .trim();

        if (text) {
            promptsContent += `Frame ${frameNum}:\n${text}\n\n`;
            frameNum++;
        }
    }

    if (!promptsContent) {
        alert('ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    downloadFile(promptsContent, 'image_prompts.txt', 'text/plain;charset=utf-8');
    alert('ğŸ¨ ì´ë¯¸ì§€ ìƒì„± í”„ë¡¬í”„íŠ¸ê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.\n\nDALL-E, Midjourney ë“±ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.');
}

// ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ ë³µì‚¬
function copyImagePrompts() {
    const content = document.getElementById('frame-analysis-content').value;

    if (!content || content.trim() === '') {
        alert('ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    // "AI ì´ë¯¸ì§€ ìƒì„± í”„ë¡¬í”„íŠ¸" ì„¹ì…˜ ì¶”ì¶œ
    const promptRegex = /###\s*4\.\s*AI\s*ì´ë¯¸ì§€\s*ìƒì„±\s*í”„ë¡¬í”„íŠ¸[^\n]*\n([\s\S]*?)(?=###|$)/gi;
    const matches = content.matchAll(promptRegex);

    let promptsContent = '';
    let frameNum = 1;

    for (const match of matches) {
        const text = match[1].trim()
            .replace(/^-\s*/gm, '')
            .split('\n')
            .filter(line => line.trim() && !line.includes('DALL-E') && !line.includes('ì˜ˆì‹œ') && !line.includes('IMPORTANT'))
            .join(' ')
            .trim();

        if (text) {
            promptsContent += `Frame ${frameNum}:\n${text}\n\n`;
            frameNum++;
        }
    }

    if (!promptsContent) {
        alert('ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    // í´ë¦½ë³´ë“œì— ë³µì‚¬
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(promptsContent)
            .then(() => {
                alert(`ğŸ“‹ ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\n\nì´ ${frameNum - 1}ê°œ í”„ë ˆì„ì˜ í”„ë¡¬í”„íŠ¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.\nDALL-E, Midjourney ë“±ì— ë°”ë¡œ ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”.`);
            })
            .catch(err => {
                console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', err);
                // í´ë°±: textareaë¥¼ ì‚¬ìš©í•œ ë³µì‚¬
                fallbackCopyToClipboard(promptsContent);
            });
    } else {
        // êµ¬í˜• ë¸Œë¼ìš°ì €ìš© í´ë°±
        fallbackCopyToClipboard(promptsContent);
    }
}

// ì˜ìƒ í”„ë¡¬í”„íŠ¸ ì¶”ì¶œ (TXT í˜•ì‹)
function exportVideoPrompts() {
    const content = document.getElementById('frame-analysis-content').value;

    if (!content || content.trim() === '') {
        alert('ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    // "AI ì˜ìƒ ìƒì„± í”„ë¡¬í”„íŠ¸" ì„¹ì…˜ ì¶”ì¶œ
    const promptRegex = /###\s*5\.\s*AI\s*ì˜ìƒ\s*ìƒì„±\s*í”„ë¡¬í”„íŠ¸[^\n]*\n([\s\S]*?)(?=###|$)/gi;
    const matches = content.matchAll(promptRegex);

    let promptsContent = '';
    let frameNum = 1;

    for (const match of matches) {
        const text = match[1]
            .split('\n')
            .filter(line => line.trim() && !line.startsWith('---'))
            .map(line => line.replace(/^[-*]\s*/, '').trim())
            .join('\n')
            .trim();

        if (text) {
            promptsContent += `Scene ${frameNum}:\n${text}\n\n`;
            frameNum++;
        }
    }

    if (!promptsContent) {
        alert('ì˜ìƒ í”„ë¡¬í”„íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    downloadFile(promptsContent, 'video_prompts.txt', 'text/plain;charset=utf-8');
    alert('ğŸ¥ ì˜ìƒ ìƒì„± í”„ë¡¬í”„íŠ¸ê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.\n\nSora, Kling, Runway ë“±ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.');
}

// ì˜ìƒ í”„ë¡¬í”„íŠ¸ ë³µì‚¬
function copyVideoPrompts() {
    const content = document.getElementById('frame-analysis-content').value;

    if (!content || content.trim() === '') {
        alert('ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    // "AI ì˜ìƒ ìƒì„± í”„ë¡¬í”„íŠ¸" ì„¹ì…˜ ì¶”ì¶œ
    const promptRegex = /###\s*5\.\s*AI\s*ì˜ìƒ\s*ìƒì„±\s*í”„ë¡¬í”„íŠ¸[^\n]*\n([\s\S]*?)(?=###|$)/gi;
    const matches = content.matchAll(promptRegex);

    let promptsContent = '';
    let frameNum = 1;

    for (const match of matches) {
        const text = match[1].trim()
            .replace(/^-\s*/gm, '')
            .split('\n')
            .filter(line => line.trim() && !line.includes('Sora') && !line.includes('ì˜ˆì‹œ') && !line.includes('IMPORTANT'))
            .join(' ')
            .trim();

        if (text) {
            promptsContent += `Scene ${frameNum}:\n${text}\n\n`;
            frameNum++;
        }
    }

    if (!promptsContent) {
        alert('ì˜ìƒ í”„ë¡¬í”„íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    // í´ë¦½ë³´ë“œì— ë³µì‚¬
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(promptsContent)
            .then(() => {
                alert(`ğŸ“‹ ì˜ìƒ í”„ë¡¬í”„íŠ¸ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\n\nì´ ${frameNum - 1}ê°œ ì¥ë©´ì˜ í”„ë¡¬í”„íŠ¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.\nSora, Kling, Runway ë“±ì— ë°”ë¡œ ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”.`);
            })
            .catch(err => {
                console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', err);
                fallbackCopyToClipboard(promptsContent);
            });
    } else {
        fallbackCopyToClipboard(promptsContent);
    }
}

// í´ë°± í´ë¦½ë³´ë“œ ë³µì‚¬ í•¨ìˆ˜
function fallbackCopyToClipboard(text) {
    const textarea = document.createElement('textarea');
    textarea.value = text;
    textarea.style.position = 'fixed';
    textarea.style.opacity = '0';
    document.body.appendChild(textarea);
    textarea.select();

    try {
        document.execCommand('copy');
        alert('ğŸ“‹ ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
    } catch (err) {
        console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
        alert('âŒ í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\nìˆ˜ë™ìœ¼ë¡œ í…ìŠ¤íŠ¸ë¥¼ ì„ íƒí•˜ì—¬ ë³µì‚¬í•´ì£¼ì„¸ìš”.');
    } finally {
        document.body.removeChild(textarea);
    }
}

// ì¥ë©´ë³„ í”„ë¡¬í”„íŠ¸ ì„ íƒê¸° í‘œì‹œ
function showScenePromptSelector() {
    const content = document.getElementById('frame-analysis-content').value;

    if (!content || content.trim() === '') {
        alert('ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    // "AI ì´ë¯¸ì§€ ìƒì„± í”„ë¡¬í”„íŠ¸" ì„¹ì…˜ ì¶”ì¶œ
    const imagePromptRegex = /###\s*4\.\s*AI\s*ì´ë¯¸ì§€\s*ìƒì„±\s*í”„ë¡¬í”„íŠ¸[^\n]*\n([\s\S]*?)(?=###|$)/gi;
    const imageMatches = content.matchAll(imagePromptRegex);

    // "AI ì˜ìƒ ìƒì„± í”„ë¡¬í”„íŠ¸" ì„¹ì…˜ ì¶”ì¶œ
    const videoPromptRegex = /###\s*5\.\s*AI\s*ì˜ìƒ\s*ìƒì„±\s*í”„ë¡¬í”„íŠ¸[^\n]*\n([\s\S]*?)(?=###|$)/gi;
    const videoMatches = content.matchAll(videoPromptRegex);

    const imagePrompts = [];
    const videoPrompts = [];
    let frameNum = 1;

    // ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ ì¶”ì¶œ
    for (const match of imageMatches) {
        const text = match[1]
            .split('\n')
            .filter(line => line.trim() && !line.startsWith('---'))
            .map(line => line.replace(/^[-*]\s*/, '').trim())
            .join('\n')
            .trim();

        if (text) {
            imagePrompts.push({
                frameNum: frameNum,
                text: text
            });
            frameNum++;
        }
    }

    // ì˜ìƒ í”„ë¡¬í”„íŠ¸ ì¶”ì¶œ
    frameNum = 1;
    for (const match of videoMatches) {
        const text = match[1]
            .split('\n')
            .filter(line => line.trim() && !line.startsWith('---'))
            .map(line => line.replace(/^[-*]\s*/, '').trim())
            .join('\n')
            .trim();

        if (text) {
            videoPrompts.push({
                frameNum: frameNum,
                text: text
            });
            frameNum++;
        }
    }

    if (imagePrompts.length === 0 && videoPrompts.length === 0) {
        alert('í”„ë¡¬í”„íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    const totalScenes = Math.max(imagePrompts.length, videoPrompts.length);

    // ë‹¤ì´ì–¼ë¡œê·¸ ìƒì„±
    const backdrop = document.createElement('div');
    backdrop.id = 'scene-prompt-backdrop';
    backdrop.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        backdrop-filter: blur(4px);
    `;

    const dialog = document.createElement('div');
    dialog.style.cssText = `
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        border-radius: 16px;
        padding: 24px;
        max-width: 900px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        border: 1px solid rgba(255, 255, 255, 0.1);
    `;

    // í—¤ë”
    const header = document.createElement('div');
    header.style.cssText = `
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 2px solid rgba(255, 255, 255, 0.1);
    `;
    header.innerHTML = `
        <h3 style="margin: 0; color: #fff; font-size: 1.3rem; font-weight: 600;">
            ğŸ¬ ì¥ë©´ë³„ í”„ë¡¬í”„íŠ¸ (ì´ ${totalScenes}ê°œ)
        </h3>
        <button onclick="document.getElementById('scene-prompt-backdrop').remove()"
                style="background: rgba(255, 255, 255, 0.1); border: none; color: #fff;
                       padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 0.9rem;
                       transition: all 0.2s;">
            âœ• ë‹«ê¸°
        </button>
    `;

    // í”„ë¡¬í”„íŠ¸ ì¹´ë“œë“¤
    const promptsContainer = document.createElement('div');
    promptsContainer.style.cssText = `
        display: flex;
        flex-direction: column;
        gap: 12px;
    `;

    for (let i = 0; i < totalScenes; i++) {
        const imagePrompt = imagePrompts[i];
        const videoPrompt = videoPrompts[i];
        const card = document.createElement('div');
        card.style.cssText = `
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px;
            transition: all 0.3s;
        `;
        card.onmouseenter = () => {
            card.style.background = 'rgba(255, 255, 255, 0.08)';
            card.style.borderColor = 'rgba(168, 85, 247, 0.5)';
            card.style.transform = 'translateY(-2px)';
        };
        card.onmouseleave = () => {
            card.style.background = 'rgba(255, 255, 255, 0.05)';
            card.style.borderColor = 'rgba(255, 255, 255, 0.1)';
            card.style.transform = 'translateY(0)';
        };

        const cardHeader = document.createElement('div');
        cardHeader.style.cssText = `
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        `;

        const title = document.createElement('div');
        title.style.cssText = `
            color: #a855f7;
            font-weight: 600;
            font-size: 0.95rem;
        `;
        title.textContent = `ì¥ë©´ ${i + 1}`;

        cardHeader.appendChild(title);
        card.appendChild(cardHeader);

        // ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ ì„¹ì…˜
        if (imagePrompt) {
            const imageSection = document.createElement('div');
            imageSection.style.cssText = `
                margin-bottom: 12px;
                padding: 12px;
                background: rgba(236, 72, 153, 0.1);
                border-radius: 8px;
                border: 1px solid rgba(236, 72, 153, 0.2);
            `;

            const imageHeader = document.createElement('div');
            imageHeader.style.cssText = `
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 8px;
            `;

            const imageLabel = document.createElement('div');
            imageLabel.style.cssText = `
                color: #ec4899;
                font-weight: 600;
                font-size: 0.85rem;
            `;
            imageLabel.textContent = 'ğŸ¨ ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸';

            const imageCopyBtn = document.createElement('button');
            imageCopyBtn.style.cssText = `
                background: linear-gradient(135deg, #ec4899 0%, #d946ef 100%);
                border: none;
                color: white;
                padding: 4px 10px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 0.8rem;
                font-weight: 500;
                transition: all 0.2s;
            `;
            imageCopyBtn.innerHTML = 'ğŸ“‹ ë³µì‚¬';
            imageCopyBtn.onclick = () => copyScenePrompt(imagePrompt.text, imagePrompt.frameNum, imageCopyBtn, 'ì´ë¯¸ì§€');

            imageHeader.appendChild(imageLabel);
            imageHeader.appendChild(imageCopyBtn);

            const imageText = document.createElement('div');
            imageText.style.cssText = `
                color: #e0e6ed;
                font-size: 0.85rem;
                line-height: 1.6;
                white-space: pre-wrap;
                word-wrap: break-word;
            `;
            imageText.textContent = imagePrompt.text.length > 150
                ? imagePrompt.text.substring(0, 150) + '...'
                : imagePrompt.text;

            imageSection.appendChild(imageHeader);
            imageSection.appendChild(imageText);
            card.appendChild(imageSection);
        }

        // ì˜ìƒ í”„ë¡¬í”„íŠ¸ ì„¹ì…˜
        if (videoPrompt) {
            const videoSection = document.createElement('div');
            videoSection.style.cssText = `
                padding: 12px;
                background: rgba(6, 182, 212, 0.1);
                border-radius: 8px;
                border: 1px solid rgba(6, 182, 212, 0.2);
            `;

            const videoHeader = document.createElement('div');
            videoHeader.style.cssText = `
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 8px;
            `;

            const videoLabel = document.createElement('div');
            videoLabel.style.cssText = `
                color: #06b6d4;
                font-weight: 600;
                font-size: 0.85rem;
            `;
            videoLabel.textContent = 'ğŸ¥ ì˜ìƒ í”„ë¡¬í”„íŠ¸';

            const videoCopyBtn = document.createElement('button');
            videoCopyBtn.style.cssText = `
                background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
                border: none;
                color: white;
                padding: 4px 10px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 0.8rem;
                font-weight: 500;
                transition: all 0.2s;
            `;
            videoCopyBtn.innerHTML = 'ğŸ“‹ ë³µì‚¬';
            videoCopyBtn.onclick = () => copyScenePrompt(videoPrompt.text, videoPrompt.frameNum, videoCopyBtn, 'ì˜ìƒ');

            videoHeader.appendChild(videoLabel);
            videoHeader.appendChild(videoCopyBtn);

            const videoText = document.createElement('div');
            videoText.style.cssText = `
                color: #e0e6ed;
                font-size: 0.85rem;
                line-height: 1.6;
                white-space: pre-wrap;
                word-wrap: break-word;
            `;
            videoText.textContent = videoPrompt.text.length > 150
                ? videoPrompt.text.substring(0, 150) + '...'
                : videoPrompt.text;

            videoSection.appendChild(videoHeader);
            videoSection.appendChild(videoText);
            card.appendChild(videoSection);
        }

        promptsContainer.appendChild(card);
    }

    dialog.appendChild(header);
    dialog.appendChild(promptsContainer);
    backdrop.appendChild(dialog);
    document.body.appendChild(backdrop);

    // ESC í‚¤ë¡œ ë‹«ê¸°
    const handleEscape = (e) => {
        if (e.key === 'Escape') {
            backdrop.remove();
            document.removeEventListener('keydown', handleEscape);
        }
    };
    document.addEventListener('keydown', handleEscape);

    // ë°°ê²½ í´ë¦­ìœ¼ë¡œ ë‹«ê¸°
    backdrop.onclick = (e) => {
        if (e.target === backdrop) {
            backdrop.remove();
            document.removeEventListener('keydown', handleEscape);
        }
    };
}

// ê°œë³„ ì¥ë©´ í”„ë¡¬í”„íŠ¸ ë³µì‚¬
function copyScenePrompt(text, frameNum, buttonElement, promptType = 'ì´ë¯¸ì§€') {
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text)
            .then(() => {
                const originalText = buttonElement.innerHTML;
                const originalBg = buttonElement.style.background;

                buttonElement.innerHTML = 'âœ“ ë³µì‚¬ë¨!';
                buttonElement.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';

                setTimeout(() => {
                    buttonElement.innerHTML = originalText;
                    buttonElement.style.background = originalBg || (
                        promptType === 'ì˜ìƒ'
                            ? 'linear-gradient(135deg, #06b6d4 0%, #0891b2 100%)'
                            : 'linear-gradient(135deg, #ec4899 0%, #d946ef 100%)'
                    );
                }, 2000);
            })
            .catch(err => {
                console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', err);
                fallbackCopyToClipboard(text);
            });
    } else {
        fallbackCopyToClipboard(text);
    }
}

// íŒŒì¼ ë‹¤ìš´ë¡œë“œ í—¬í¼ í•¨ìˆ˜
function downloadFile(content, filename, mimeType) {
    const videoName = currentVideoInfo.name || 'video';
    const baseName = videoName.replace(/\.[^/.]+$/, '');
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
    const finalFilename = `${baseName}_${filename.replace('.', '_' + timestamp + '.')}`;

    const blob = new Blob([content], { type: mimeType });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = finalFilename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// í”„ë ˆì„ ë¶„ì„ ê²°ê³¼ ì „ì²´ ì €ì¥ (íŒŒì¼ë¡œ)
function saveFrameAnalysisResult() {
    const resultContent = document.getElementById('frame-analysis-content').value;

    if (!resultContent || resultContent.trim() === '' || resultContent.includes('ë¶„ì„ ì¤‘')) {
        alert('ì €ì¥í•  ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    downloadFile(resultContent, 'AIë¶„ì„ê²°ê³¼.txt', 'text/plain;charset=utf-8');
    alert('ğŸ“¥ ì „ì²´ ë¶„ì„ ê²°ê³¼ê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
}

// ë¶„ì„ ê²°ê³¼ë¥¼ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
function saveAnalysisToStorage() {
    try {
        const resultContent = document.getElementById('frame-analysis-content').value;
        console.log('ì €ì¥ ì‹œë„:', resultContent.substring(0, 100) + '...');

        if (!resultContent || resultContent.trim() === '' || resultContent.includes('ë¶„ì„ ì¤‘')) {
            alert('ì €ì¥í•  ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        // ì €ì¥í•  ì´ë¦„ ì…ë ¥
        const name = prompt('ì €ì¥í•  ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:', currentVideoInfo.name || 'ì‡¼ì¸  ë¶„ì„');
        if (!name) {
            console.log('ì €ì¥ ì·¨ì†Œë¨');
            return;
        }

        // ì €ì¥í•  ë°ì´í„° êµ¬ì„±
        const analysisData = {
            id: Date.now(),
            timestamp: new Date().toISOString(),
            name: name,
            videoName: currentVideoInfo.name || 'unknown',
            content: resultContent,
            frameCount: document.querySelectorAll('.frame-item').length
        };

        // ê¸°ì¡´ ì €ì¥ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        const savedAnalyses = JSON.parse(localStorage.getItem('savedAnalyses') || '[]');
        console.log('ê¸°ì¡´ ì €ì¥ ê°œìˆ˜:', savedAnalyses.length);

        // ìƒˆ ë¶„ì„ ì¶”ê°€
        savedAnalyses.push(analysisData);
        console.log('ìƒˆë¡œ ì¶”ê°€ í›„ ê°œìˆ˜:', savedAnalyses.length);

        // ì €ì¥ (ìµœëŒ€ 20ê°œê¹Œì§€ë§Œ ìœ ì§€)
        if (savedAnalyses.length > 20) {
            savedAnalyses.shift(); // ê°€ì¥ ì˜¤ë˜ëœ ê²ƒ ì‚­ì œ
        }

        localStorage.setItem('savedAnalyses', JSON.stringify(savedAnalyses));
        console.log('localStorageì— ì €ì¥ ì™„ë£Œ');

        // ì €ì¥ í™•ì¸
        const verification = localStorage.getItem('savedAnalyses');
        console.log('ì €ì¥ í™•ì¸:', verification ? 'ì„±ê³µ' : 'ì‹¤íŒ¨');

        alert(`ğŸ“Œ "${name}" ë¶„ì„ ê²°ê³¼ê°€ ë³´ê´€í•¨ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.\n\ní˜„ì¬ ì´ ${savedAnalyses.length}ê°œì˜ ë¶„ì„ ê²°ê³¼ê°€ ë³´ê´€í•¨ì— ìˆìŠµë‹ˆë‹¤.\n\nğŸ’¡ "ğŸ“‚ ë³´ê´€í•¨ ì—´ê¸°" ë²„íŠ¼ìœ¼ë¡œ ì–¸ì œë“ ì§€ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
    } catch (error) {
        console.error('ì €ì¥ ì˜¤ë¥˜:', error);
        alert('âŒ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:\n' + error.message);
    }
}

// ì €ì¥ëœ ë¶„ì„ ê²°ê³¼ ë¶ˆëŸ¬ì˜¤ê¸° ë‹¤ì´ì–¼ë¡œê·¸ í‘œì‹œ
function showLoadAnalysisDialog() {
    let savedAnalyses;

    try {
        const savedData = localStorage.getItem('savedAnalyses');
        console.log('localStorageì—ì„œ ì½ì€ ë°ì´í„°:', savedData);

        savedAnalyses = JSON.parse(savedData || '[]');
        console.log('íŒŒì‹±ëœ ë¶„ì„ ê²°ê³¼ ê°œìˆ˜:', savedAnalyses.length);

        if (savedAnalyses.length === 0) {
            alert('ğŸ“‚ ë³´ê´€í•¨ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.\n\nğŸ’¡ íŒ: "ğŸ“Œ ë³´ê´€í•¨ì— ì €ì¥" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ AI ë¶„ì„ ê²°ê³¼ë¥¼ ë¸Œë¼ìš°ì €ì— ì„ì‹œ ë³´ê´€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\nâš ï¸ ë¸Œë¼ìš°ì € ìºì‹œë¥¼ ì‚­ì œí•˜ë©´ ë³´ê´€í•¨ì˜ ë°ì´í„°ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.');
            return;
        }
    } catch (error) {
        console.error('ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:', error);
        alert('âŒ ë¶ˆëŸ¬ì˜¤ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:\n' + error.message);
        return;
    }

    // ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬
    savedAnalyses.sort((a, b) => b.id - a.id);

    // ë‹¤ì´ì–¼ë¡œê·¸ HTML ìƒì„±
    let dialogHtml = '<div style="max-height: 400px; overflow-y: auto;">';
    savedAnalyses.forEach((analysis, index) => {
        const date = new Date(analysis.timestamp).toLocaleString('ko-KR');
        dialogHtml += `
            <div style="padding: 10px; margin-bottom: 8px; background: rgba(0, 0, 0, 0.2); border-radius: 6px; border: 1px solid rgba(255, 255, 255, 0.1);">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: #10b981; margin-bottom: 4px;">${analysis.name}</div>
                        <div style="font-size: 0.85rem; color: #a0aec0;">
                            ğŸ“… ${date}<br>
                            ğŸ¬ ${analysis.videoName} (${analysis.frameCount}ê°œ í”„ë ˆì„)
                        </div>
                    </div>
                    <div style="display: flex; gap: 5px;">
                        <button onclick="loadAnalysisFromStorage(${analysis.id}); document.getElementById('load-analysis-dialog').remove();" style="padding: 4px 10px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">ë¶ˆëŸ¬ì˜¤ê¸°</button>
                        <button onclick="deleteAnalysisFromStorage(${analysis.id}); showLoadAnalysisDialog(); document.getElementById('load-analysis-dialog').remove();" style="padding: 4px 10px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">ì‚­ì œ</button>
                    </div>
                </div>
            </div>
        `;
    });
    dialogHtml += '</div>';

    // ê¸°ì¡´ ë‹¤ì´ì–¼ë¡œê·¸ ì œê±°
    const existingDialog = document.getElementById('load-analysis-dialog');
    if (existingDialog) existingDialog.remove();

    // ë‹¤ì´ì–¼ë¡œê·¸ ìƒì„±
    const dialog = document.createElement('div');
    dialog.id = 'load-analysis-dialog';
    dialog.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 600px; max-width: 90%; background: #1a1a2e; padding: 20px; border-radius: 12px; border: 2px solid rgba(102, 126, 234, 0.5); box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5); z-index: 10000;';
    dialog.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="margin: 0; color: #667eea;">ğŸ“‚ ì €ì¥ëœ ë¶„ì„ ê²°ê³¼</h3>
            <button onclick="this.closest('#load-analysis-dialog').remove()" style="padding: 5px 10px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer;">âœ• ë‹«ê¸°</button>
        </div>
        ${dialogHtml}
    `;

    // ë°±ë“œë¡­ ìƒì„±
    const backdrop = document.createElement('div');
    backdrop.id = 'dialog-backdrop';
    backdrop.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 9999;';
    backdrop.onclick = () => {
        dialog.remove();
        backdrop.remove();
    };

    document.body.appendChild(backdrop);
    document.body.appendChild(dialog);
}

// ì €ì¥ëœ ë¶„ì„ ê²°ê³¼ ë¶ˆëŸ¬ì˜¤ê¸°
function loadAnalysisFromStorage(id) {
    const savedAnalyses = JSON.parse(localStorage.getItem('savedAnalyses') || '[]');
    const analysis = savedAnalyses.find(a => a.id === id);

    if (!analysis) {
        alert('ë¶„ì„ ê²°ê³¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    // ê²°ê³¼ í‘œì‹œ
    const resultDiv = document.getElementById('frame-analysis-result');
    const contentDiv = document.getElementById('frame-analysis-content');
    resultDiv.style.display = 'block';
    contentDiv.value = analysis.content;

    // ë°±ë“œë¡­ ì œê±°
    const backdrop = document.getElementById('dialog-backdrop');
    if (backdrop) backdrop.remove();

    alert(`ğŸ“‚ "${analysis.name}" ë¶„ì„ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.\n\nì´ì œ í¸ì§‘í•˜ê±°ë‚˜ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
}

// ì €ì¥ëœ ë¶„ì„ ê²°ê³¼ ì‚­ì œ
function deleteAnalysisFromStorage(id) {
    if (!confirm('ì´ ë¶„ì„ ê²°ê³¼ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
    }

    let savedAnalyses = JSON.parse(localStorage.getItem('savedAnalyses') || '[]');
    savedAnalyses = savedAnalyses.filter(a => a.id !== id);
    localStorage.setItem('savedAnalyses', JSON.stringify(savedAnalyses));

    alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
}

// íŒŒì¼ì—ì„œ ë¶„ì„ ê²°ê³¼ ë¶ˆëŸ¬ì˜¤ê¸°
function loadAnalysisFromFile(event) {
    const file = event.target.files[0];

    if (!file) {
        return;
    }

    // íŒŒì¼ í™•ì¥ì í™•ì¸
    if (!file.name.endsWith('.txt')) {
        alert('âŒ TXT íŒŒì¼ë§Œ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        event.target.value = ''; // íŒŒì¼ ì„ íƒ ì´ˆê¸°í™”
        return;
    }

    const reader = new FileReader();

    reader.onload = function(e) {
        try {
            const content = e.target.result;

            if (!content || content.trim() === '') {
                alert('âŒ íŒŒì¼ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
                return;
            }

            // ê²°ê³¼ í‘œì‹œ
            const resultDiv = document.getElementById('frame-analysis-result');
            const contentDiv = document.getElementById('frame-analysis-content');
            resultDiv.style.display = 'block';
            contentDiv.value = content;

            alert(`ğŸ“„ íŒŒì¼ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.\n\níŒŒì¼ëª…: ${file.name}\ní¬ê¸°: ${(file.size / 1024).toFixed(2)} KB\n\nì´ì œ í¸ì§‘í•˜ê±°ë‚˜ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
        } catch (error) {
            console.error('íŒŒì¼ ì½ê¸° ì˜¤ë¥˜:', error);
            alert('âŒ íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:\n' + error.message);
        } finally {
            // íŒŒì¼ ì„ íƒ ì´ˆê¸°í™” (ê°™ì€ íŒŒì¼ ë‹¤ì‹œ ì„ íƒ ê°€ëŠ¥í•˜ë„ë¡)
            event.target.value = '';
        }
    };

    reader.onerror = function() {
        alert('âŒ íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        event.target.value = '';
    };

    // í…ìŠ¤íŠ¸ íŒŒì¼ë¡œ ì½ê¸°
    reader.readAsText(file, 'UTF-8');
}

// ìƒˆë¡œìš´ ì‡¼ì¸  ì½˜í…ì¸  ìƒì„± (AI ê¸°ë°˜)
async function generateNewShortsContent() {
    const frameItems = document.querySelectorAll('.frame-item');

    if (frameItems.length === 0) {
        alert('ìƒì„±í•  í”„ë ˆì„ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì˜ìƒì—ì„œ í”„ë ˆì„ì„ ì¶”ì¶œí•˜ì„¸ìš”.');
        return;
    }

    // ì„ íƒëœ í”„ë ˆì„ë§Œ ìˆ˜ì§‘
    const frames = [];
    frameItems.forEach((item, index) => {
        const checkbox = item.querySelector('.frame-select-checkbox');
        if (checkbox && checkbox.checked) {
            const frameData = item.dataset.frame;
            const label = item.dataset.label || `frame_${index + 1}`;
            frames.push({
                index: index + 1,
                label: label,
                image_data: frameData
            });
        }
    });

    if (frames.length === 0) {
        alert('í”„ë ˆì„ì„ ì„ íƒí•˜ì„¸ìš”. ì²´í¬ë°•ìŠ¤ë¥¼ í´ë¦­í•˜ì—¬ ì‡¼ì¸ ì— ì‚¬ìš©í•  í”„ë ˆì„ì„ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        return;
    }

    // AI ëª¨ë¸ê³¼ ìë§‰ ì–¸ì–´ ì„ íƒ
    const selectedModel = document.getElementById('frame-ai-model-select').value;
    const selectedLanguagePrimary = document.getElementById('subtitle-language-primary').value;
    const selectedLanguageSecondary = document.getElementById('subtitle-language-secondary').value;

    const modelNames = {
        'gpt-4o-mini': 'GPT-4o Mini',
        'sonnet': 'Claude Sonnet',
        'haiku': 'Claude Haiku',
        'gpt-4o': 'GPT-4o'
    };

    const languageNames = {
        'korean': 'í•œêµ­ì–´',
        'english': 'English',
        'japanese': 'æ—¥æœ¬èª'
    };

    // ìë§‰ ì–¸ì–´ ë©”ì‹œì§€ êµ¬ì„±
    let subtitleLangMsg = languageNames[selectedLanguagePrimary];
    if (selectedLanguageSecondary) {
        subtitleLangMsg += ` + ${languageNames[selectedLanguageSecondary]}`;
    }

    // í™•ì¸
    if (!confirm(`${frames.length}ê°œì˜ í”„ë ˆì„ìœ¼ë¡œ ìƒˆë¡œìš´ ì‡¼ì¸  ì½˜í…ì¸ ë¥¼ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n${modelNames[selectedModel]} ëª¨ë¸ì„ ì‚¬ìš©í•˜ì—¬ ì™„ì „íˆ ìƒˆë¡œìš´ ì‹œë‚˜ë¦¬ì˜¤, ìë§‰(${subtitleLangMsg}), ë‚˜ë ˆì´ì…˜, ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.`)) {
        return;
    }

    // ê²°ê³¼ ì˜ì—­ í‘œì‹œ
    const resultDiv = document.getElementById('frame-analysis-result');
    const contentDiv = document.getElementById('frame-analysis-content');
    resultDiv.style.display = 'block';

    // ì˜ˆìƒ ì‹œê°„ ê³„ì‚°
    const estimatedSeconds = Math.ceil(frames.length * 4);
    const estimatedMinutes = Math.floor(estimatedSeconds / 60);
    const remainingSeconds = estimatedSeconds % 60;
    const estimatedTime = estimatedMinutes > 0
        ? `ì•½ ${estimatedMinutes}ë¶„ ${remainingSeconds}ì´ˆ`
        : `ì•½ ${estimatedSeconds}ì´ˆ`;

    contentDiv.value = `ğŸ¬ ìƒˆë¡œìš´ ì‡¼ì¸  ì½˜í…ì¸  ìƒì„± ì¤‘...\n\nğŸ“Š ì§„í–‰ ìƒí™©:\n- ì„ íƒëœ í”„ë ˆì„: ${frames.length}ê°œ\n- ì‚¬ìš© ëª¨ë¸: ${modelNames[selectedModel]}\n- ì˜ˆìƒ ì†Œìš” ì‹œê°„: ${estimatedTime}\n\nâ³ AIê°€ ì°½ì˜ì ì¸ ì‡¼ì¸  ì½˜í…ì¸ ë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...`;

    // ì§„í–‰ë¥  ì• ë‹ˆë©”ì´ì…˜
    let dots = 0;
    const progressInterval = setInterval(() => {
        dots = (dots + 1) % 4;
        const dotString = '.'.repeat(dots);
        contentDiv.value = `ğŸ¬ ìƒˆë¡œìš´ ì‡¼ì¸  ì½˜í…ì¸  ìƒì„± ì¤‘${dotString}\n\nğŸ“Š ì§„í–‰ ìƒí™©:\n- ì„ íƒëœ í”„ë ˆì„: ${frames.length}ê°œ\n- ì‚¬ìš© ëª¨ë¸: ${modelNames[selectedModel]}\n- ì˜ˆìƒ ì†Œìš” ì‹œê°„: ${estimatedTime}\n\nâ³ AIê°€ ì°½ì˜ì ì¸ ì‡¼ì¸  ì½˜í…ì¸ ë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤${dotString}`;
    }, 500);

    try {
        // ìƒˆë¡œìš´ ì‡¼ì¸  ì½˜í…ì¸  ìƒì„±ì„ ìœ„í•œ íŠ¹ë³„ í”„ë¡¬í”„íŠ¸
        const customPrompt = `ë‹¤ìŒ ${frames.length}ê°œì˜ ì´ë¯¸ì§€ë¥¼ í™œìš©í•˜ì—¬ ì™„ì „íˆ ìƒˆë¡œìš´ ìœ íŠœë¸Œ ì‡¼ì¸  ì˜ìƒ ì½˜í…ì¸ ë¥¼ ê¸°íší•´ì£¼ì„¸ìš”.

ğŸ¯ **ëª©í‘œ**: 60ì´ˆ ì´ë‚´ì˜ ì„íŒ©íŠ¸ ìˆëŠ” ì‡¼ì¸  ì˜ìƒ ì œì‘

ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”:

## ğŸ“‹ ì „ì²´ ì‹œë‚˜ë¦¬ì˜¤ (60ì´ˆ ì‡¼ì¸ )

### ğŸ¬ ì½˜ì…‰íŠ¸
- ë©”ì¸ ì£¼ì œ ë° ì»¨ì…‰ ì„¤ëª…
- íƒ€ê²Ÿ ì‹œì²­ìì¸µ
- ê¸°ëŒ€ íš¨ê³¼ ë° ë©”ì‹œì§€

### â±ï¸ íƒ€ì„ë¼ì¸ (ê° í”„ë ˆì„ë³„)

#### [í”„ë ˆì„ 1] (0-${Math.floor(60/frames.length)}ì´ˆ)
**ğŸ“ í™”ë©´ í…ìŠ¤íŠ¸ (ìë§‰)**
- í™”ë©´ì— í‘œì‹œë  ì„íŒ©íŠ¸ ìˆëŠ” í…ìŠ¤íŠ¸ (15ì ì´ë‚´)
- ê°•ì¡°í•  í‚¤ì›Œë“œ

**ğŸ™ï¸ ë‚˜ë ˆì´ì…˜ ëŒ€ì‚¬**
- ìì—°ìŠ¤ëŸ¬ìš´ êµ¬ì–´ì²´ ëŒ€ì‚¬ (3-5ì´ˆ ë¶„ëŸ‰)
- ê°ì • í‘œí˜„ ì§€ì‹œì‚¬í•­

**ğŸ¨ AI ì´ë¯¸ì§€ ìƒì„± í”„ë¡¬í”„íŠ¸**
- DALL-E/Midjourneyìš© ìƒì„¸ ì˜ë¬¸ í”„ë¡¬í”„íŠ¸
- ì˜ˆì‹œ: "A vibrant YouTube shorts scene, close-up shot, dynamic lighting, person expressing excitement, modern minimalist background, high contrast, 9:16 vertical format, professional quality"

**ğŸï¸ í¸ì§‘ ì§€ì‹œì‚¬í•­**
- ì „í™˜ íš¨ê³¼ (í˜ì´ë“œ, ì»·, ì¤Œ ë“±)
- BGM ë¶„ìœ„ê¸°
- íŠ¹ìˆ˜ íš¨ê³¼

${frames.length > 1 ? `\n#### [í”„ë ˆì„ 2-${frames.length}] (ê³„ì†...)\n(ìœ„ì™€ ë™ì¼í•œ í˜•ì‹ìœ¼ë¡œ ê° í”„ë ˆì„ë³„ ìƒì„¸ ë‚´ìš© ì‘ì„±)` : ''}

### ğŸµ ìŒì•… & ì‚¬ìš´ë“œ
- BGM ì¥ë¥´ ë° ë¶„ìœ„ê¸°
- íš¨ê³¼ìŒ ì œì•ˆ

### ğŸ¯ í•µì‹¬ ìš”ì†Œ
- í›…(Hook): ì²˜ìŒ 3ì´ˆì—ì„œ ì‹œì²­ìë¥¼ ì‚¬ë¡œì¡ëŠ” ìš”ì†Œ
- í´ë¼ì´ë§¥ìŠ¤: ê°€ì¥ ì„íŒ©íŠ¸ ìˆëŠ” ìˆœê°„
- CTA(Call To Action): ë§ˆì§€ë§‰ í–‰ë™ ìœ ë„

**ì¤‘ìš”**: ê° í”„ë ˆì„ì„ ì°½ì˜ì ìœ¼ë¡œ í™œìš©í•˜ì—¬ ì™„ì „íˆ ìƒˆë¡œìš´ ìŠ¤í† ë¦¬ë¥¼ ë§Œë“¤ì–´ì£¼ì„¸ìš”. ë‹¨ìˆœ ë¶„ì„ì´ ì•„ë‹Œ, ì‹¤ì œ ì‡¼ì¸  ì˜ìƒ ì œì‘ì— ë°”ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” êµ¬ì²´ì ì¸ ì½˜í…ì¸ ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.`;

        // API í˜¸ì¶œ
        const response = await fetch('/api/video-analyzer/analyze-frames-with-ai', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                frames: frames,
                model: selectedModel,
                analysis_type: 'custom',
                custom_prompt: customPrompt,
                video_name: currentVideoInfo.name || 'new_shorts',
                subtitle_language_primary: selectedLanguagePrimary,
                subtitle_language_secondary: selectedLanguageSecondary
            })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.detail || 'ì‡¼ì¸  ì½˜í…ì¸  ìƒì„± ì‹¤íŒ¨');
        }

        const result = await response.json();

        // ì§„í–‰ë¥  ì• ë‹ˆë©”ì´ì…˜ ì¤‘ì§€
        clearInterval(progressInterval);

        // ê²°ê³¼ í‘œì‹œ
        contentDiv.value = result.analysis_result;

        // ì„±ê³µ ì•Œë¦¼
        alert('âœ… ìƒˆë¡œìš´ ì‡¼ì¸  ì½˜í…ì¸ ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!\n\nì´ì œ ìë§‰, ë‚˜ë ˆì´ì…˜, ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ë¥¼ ê°ê° ì¶”ì¶œí•˜ì—¬ ì˜ìƒ ì œì‘ì— í™œìš©í•˜ì„¸ìš”.');

    } catch (error) {
        // ì§„í–‰ë¥  ì• ë‹ˆë©”ì´ì…˜ ì¤‘ì§€
        clearInterval(progressInterval);

        console.error('ì‡¼ì¸  ì½˜í…ì¸  ìƒì„± ì˜¤ë¥˜:', error);
        contentDiv.value = `âŒ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`;
        alert(`ì‡¼ì¸  ì½˜í…ì¸  ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:\n${error.message}`);
    }
}

// ì´ì–´ì„œ ì‡¼ì¸  ì½˜í…ì¸  ìƒì„±
async function continueGeneratingShortsContent() {
    const contentDiv = document.getElementById('frame-analysis-content');
    const existingContent = contentDiv.value;

    // ê¸°ì¡´ ë‚´ìš©ì´ ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸
    if (!existingContent || existingContent.trim() === '' || existingContent.includes('âœ¨ í”„ë ˆì„ì„ ì„ íƒí•˜ê³ ')) {
        alert('âš ï¸ ê¸°ì¡´ ì½˜í…ì¸ ê°€ ì—†ìŠµë‹ˆë‹¤.\n\në¨¼ì € "ğŸ¬ ìƒˆ ì‡¼ì¸  ì½˜í…ì¸  ìƒì„±" ë²„íŠ¼ì„ ì‚¬ìš©í•˜ê±°ë‚˜ "ğŸ¤– AI í”„ë ˆì„ ë¶„ì„ ì‹œì‘"ì„ í†µí•´ ê¸°ë³¸ ì½˜í…ì¸ ë¥¼ ìƒì„±í•œ í›„ ì´ì–´ì„œ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        return;
    }

    const frameItems = document.querySelectorAll('.frame-item');

    if (frameItems.length === 0) {
        alert('ìƒì„±í•  í”„ë ˆì„ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì˜ìƒì—ì„œ í”„ë ˆì„ì„ ì¶”ì¶œí•˜ì„¸ìš”.');
        return;
    }

    // ì„ íƒëœ í”„ë ˆì„ë§Œ ìˆ˜ì§‘
    const frames = [];
    frameItems.forEach((item, index) => {
        const checkbox = item.querySelector('.frame-select-checkbox');
        if (checkbox && checkbox.checked) {
            const frameData = item.dataset.frame;
            const label = item.dataset.label || `frame_${index + 1}`;
            frames.push({
                index: index + 1,
                label: label,
                image_data: frameData
            });
        }
    });

    if (frames.length === 0) {
        alert('í”„ë ˆì„ì„ ì„ íƒí•˜ì„¸ìš”. ì²´í¬ë°•ìŠ¤ë¥¼ í´ë¦­í•˜ì—¬ ì‡¼ì¸ ì— ì‚¬ìš©í•  í”„ë ˆì„ì„ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        return;
    }

    // AI ëª¨ë¸ê³¼ ìë§‰ ì–¸ì–´ ì„ íƒ
    const selectedModel = document.getElementById('frame-ai-model-select').value;
    const selectedLanguagePrimary = document.getElementById('subtitle-language-primary').value;
    const selectedLanguageSecondary = document.getElementById('subtitle-language-secondary').value;

    const modelNames = {
        'gpt-4o-mini': 'GPT-4o Mini',
        'sonnet': 'Claude Sonnet',
        'haiku': 'Claude Haiku',
        'gpt-4o': 'GPT-4o'
    };

    const languageNames = {
        'korean': 'í•œêµ­ì–´',
        'english': 'English',
        'japanese': 'æ—¥æœ¬èª'
    };

    // ìë§‰ ì–¸ì–´ ë©”ì‹œì§€ êµ¬ì„±
    let subtitleLangMsg = languageNames[selectedLanguagePrimary];
    if (selectedLanguageSecondary) {
        subtitleLangMsg += ` + ${languageNames[selectedLanguageSecondary]}`;
    }

    // í™•ì¸
    if (!confirm(`${frames.length}ê°œì˜ í”„ë ˆì„ìœ¼ë¡œ ì¶”ê°€ ì‡¼ì¸  ì½˜í…ì¸ ë¥¼ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n${modelNames[selectedModel]} ëª¨ë¸ì„ ì‚¬ìš©í•˜ì—¬ ê¸°ì¡´ ë‚´ìš©ì— ì´ì–´ì„œ ì¶”ê°€ ì‹œë‚˜ë¦¬ì˜¤, ìë§‰(${subtitleLangMsg}), ë‚˜ë ˆì´ì…˜, ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.\n\nâš ï¸ ê¸°ì¡´ ë‚´ìš©ì€ ìœ ì§€ë©ë‹ˆë‹¤.`)) {
        return;
    }

    // ê²°ê³¼ ì˜ì—­ í‘œì‹œ
    const resultDiv = document.getElementById('frame-analysis-result');
    resultDiv.style.display = 'block';

    // ì˜ˆìƒ ì‹œê°„ ê³„ì‚°
    const estimatedSeconds = Math.ceil(frames.length * 4);
    const estimatedMinutes = Math.floor(estimatedSeconds / 60);
    const remainingSeconds = estimatedSeconds % 60;
    const estimatedTime = estimatedMinutes > 0
        ? `ì•½ ${estimatedMinutes}ë¶„ ${remainingSeconds}ì´ˆ`
        : `ì•½ ${estimatedSeconds}ì´ˆ`;

    // ê¸°ì¡´ ë‚´ìš© ì €ì¥ í›„ ì§„í–‰ ë©”ì‹œì§€ í‘œì‹œ
    const savedContent = existingContent;
    contentDiv.value = `${savedContent}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nâ• ì¶”ê°€ ì½˜í…ì¸  ìƒì„± ì¤‘...\n\nğŸ“Š ì§„í–‰ ìƒí™©:\n- ì„ íƒëœ í”„ë ˆì„: ${frames.length}ê°œ\n- ì‚¬ìš© ëª¨ë¸: ${modelNames[selectedModel]}\n- ì˜ˆìƒ ì†Œìš” ì‹œê°„: ${estimatedTime}\n\nâ³ AIê°€ ì¶”ê°€ ì½˜í…ì¸ ë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...`;

    // ì§„í–‰ë¥  ì• ë‹ˆë©”ì´ì…˜
    let dots = 0;
    const progressInterval = setInterval(() => {
        dots = (dots + 1) % 4;
        const dotString = '.'.repeat(dots);
        contentDiv.value = `${savedContent}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nâ• ì¶”ê°€ ì½˜í…ì¸  ìƒì„± ì¤‘${dotString}\n\nğŸ“Š ì§„í–‰ ìƒí™©:\n- ì„ íƒëœ í”„ë ˆì„: ${frames.length}ê°œ\n- ì‚¬ìš© ëª¨ë¸: ${modelNames[selectedModel]}\n- ì˜ˆìƒ ì†Œìš” ì‹œê°„: ${estimatedTime}\n\nâ³ AIê°€ ì¶”ê°€ ì½˜í…ì¸ ë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤${dotString}`;
    }, 500);

    try {
        // ì´ì–´ì„œ ìƒì„±ì„ ìœ„í•œ í”„ë¡¬í”„íŠ¸ (ê¸°ì¡´ ì»¨í…ìŠ¤íŠ¸ í¬í•¨)
        const customPrompt = `ë‹¤ìŒì€ ê¸°ì¡´ì— ì‘ì„±ëœ ì‡¼ì¸  ì½˜í…ì¸ ì…ë‹ˆë‹¤:

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
${savedContent}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ìœ„ ë‚´ìš©ì— ì´ì–´ì„œ, ë‹¤ìŒ ${frames.length}ê°œì˜ ìƒˆë¡œìš´ ì´ë¯¸ì§€ë¥¼ í™œìš©í•˜ì—¬ ì¶”ê°€ ì‡¼ì¸  ì½˜í…ì¸ ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.

ğŸ¯ **ëª©í‘œ**: ê¸°ì¡´ ì½˜í…ì¸ ì˜ íë¦„ì„ ìœ ì§€í•˜ë©´ì„œ ìì—°ìŠ¤ëŸ½ê²Œ ì´ì–´ì§€ëŠ” ì¶”ê°€ ì¥ë©´ ì œì‘

ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”:

## ğŸ“‹ ì¶”ê°€ ì‹œë‚˜ë¦¬ì˜¤ (ì´ì–´ì§€ëŠ” ë¶€ë¶„)

${frames.map((frame, idx) => `
#### [í”„ë ˆì„ ${idx + 1}]
**ğŸ“ í™”ë©´ í…ìŠ¤íŠ¸ (ìë§‰)**
- í™”ë©´ì— í‘œì‹œë  ì„íŒ©íŠ¸ ìˆëŠ” í…ìŠ¤íŠ¸ (15ì ì´ë‚´)
- ê°•ì¡°í•  í‚¤ì›Œë“œ

**ğŸ™ï¸ ë‚˜ë ˆì´ì…˜ ëŒ€ì‚¬**
- ìì—°ìŠ¤ëŸ¬ìš´ êµ¬ì–´ì²´ ëŒ€ì‚¬ (3-5ì´ˆ ë¶„ëŸ‰)
- ê°ì • í‘œí˜„ ì§€ì‹œì‚¬í•­

**ğŸ¨ AI ì´ë¯¸ì§€ ìƒì„± í”„ë¡¬í”„íŠ¸ (ONLY in English!)**
- DALL-E/Midjourneyìš© ìƒì„¸ ì˜ë¬¸ í”„ë¡¬í”„íŠ¸
- ì˜ˆì‹œ: "A vibrant YouTube shorts scene, close-up shot, dynamic lighting, person expressing excitement, modern minimalist background, high contrast, 9:16 vertical format, professional quality"

**ğŸï¸ í¸ì§‘ ì§€ì‹œì‚¬í•­**
- ì „í™˜ íš¨ê³¼ (í˜ì´ë“œ, ì»·, ì¤Œ ë“±)
- BGM ë¶„ìœ„ê¸°
- íŠ¹ìˆ˜ íš¨ê³¼
`).join('\n')}

**ì¤‘ìš”**:
1. ê¸°ì¡´ ì½˜í…ì¸ ì˜ í†¤, ìŠ¤íƒ€ì¼, ë©”ì‹œì§€ì™€ ì¼ê´€ì„±ì„ ìœ ì§€í•˜ì„¸ìš”.
2. ìì—°ìŠ¤ëŸ½ê²Œ ì´ì–´ì§€ëŠ” ìŠ¤í† ë¦¬ë¥¼ ë§Œë“¤ì–´ì£¼ì„¸ìš”.
3. ì‹¤ì œ ì‡¼ì¸  ì˜ìƒ ì œì‘ì— ë°”ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” êµ¬ì²´ì ì¸ ì½˜í…ì¸ ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.`;

        // API í˜¸ì¶œ
        const response = await fetch('/api/video-analyzer/analyze-frames-with-ai', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                frames: frames,
                model: selectedModel,
                analysis_type: 'custom',
                custom_prompt: customPrompt,
                video_name: currentVideoInfo.name || 'shorts_continued',
                subtitle_language_primary: selectedLanguagePrimary,
                subtitle_language_secondary: selectedLanguageSecondary
            })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.detail || 'ì¶”ê°€ ì½˜í…ì¸  ìƒì„± ì‹¤íŒ¨');
        }

        const result = await response.json();

        // ì§„í–‰ë¥  ì• ë‹ˆë©”ì´ì…˜ ì¤‘ì§€
        clearInterval(progressInterval);

        // ê²°ê³¼ í‘œì‹œ (ê¸°ì¡´ ë‚´ìš© + êµ¬ë¶„ì„  + ìƒˆ ë‚´ìš©)
        contentDiv.value = `${savedContent}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n${result.analysis_result}`;

        // ì„±ê³µ ì•Œë¦¼
        alert('âœ… ì¶”ê°€ ì½˜í…ì¸ ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!\n\nê¸°ì¡´ ë‚´ìš©ì— ì´ì–´ì„œ ìƒˆë¡œìš´ ì¥ë©´ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');

    } catch (error) {
        // ì§„í–‰ë¥  ì• ë‹ˆë©”ì´ì…˜ ì¤‘ì§€
        clearInterval(progressInterval);

        console.error('ì¶”ê°€ ì½˜í…ì¸  ìƒì„± ì˜¤ë¥˜:', error);
        contentDiv.value = `${savedContent}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nâŒ ì¶”ê°€ ì½˜í…ì¸  ìƒì„± ì˜¤ë¥˜: ${error.message}`;
        alert(`ì¶”ê°€ ì½˜í…ì¸  ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:\n${error.message}`);
    }
}

// ìë§‰ íŒŒì¼ì—ì„œ ì›ë³¸ ì œëª© ì¶”ì¶œ (ì‹œê°„ êµ¬ê°„ í¬í•¨)
function extractOriginalTitlesFromSubtitles() {
    // loadedSubtitles ê°ì²´ì—ì„œ ë©”ì¸ ìë§‰ ê°€ì ¸ì˜¤ê¸°
    const mainSubtitles = loadedSubtitles.main || [];
    const titles = [];

    console.log(`ğŸ“ ìë§‰ì—ì„œ ì œëª© ì¶”ì¶œ ì¤‘... (ìë§‰ ìˆ˜: ${mainSubtitles.length}ê°œ)`);

    mainSubtitles.forEach((subtitle, index) => {
        const text = subtitle.text;
        const start = subtitle.start;  // SRT í˜•ì‹: 00:00:00,000
        const end = subtitle.end;

        if (text) {
            // í˜•ì‹: [1] funny cat and dog fights#shorts [iZHTZZv5_cg]
            // ëŒ€ê´„í˜¸ ì•ˆì˜ ì œëª© ì¶”ì¶œ
            const match = text.match(/\[(\d+)\]\s*(.+?)\s*\[([^\]]+)\]/);
            if (match) {
                const frameNum = match[1];
                const title = match[2].trim();
                const videoId = match[3];

                // SRT ì‹œê°„ì„ ì´ˆë¡œ ë³€í™˜
                const startSeconds = srtTimeToSeconds(start);
                const endSeconds = srtTimeToSeconds(end);

                titles.push({
                    frame: parseInt(frameNum),
                    title: title,
                    videoId: videoId,
                    startTime: startSeconds,
                    endTime: endSeconds
                });

                console.log(`  âœ… ì œëª© ì¶”ì¶œ ì„±ê³µ: [${frameNum}] "${title}" (${startSeconds}ì´ˆ~${endSeconds}ì´ˆ)`);
            } else {
                console.log(`  âš ï¸ ì œëª© í˜•ì‹ ë§¤ì¹­ ì‹¤íŒ¨ (ìë§‰ ${index + 1}): "${text}"`);
            }
        }
    });

    console.log(`ğŸ“Š ì´ ${titles.length}ê°œì˜ ì œëª© ì¶”ì¶œ ì™„ë£Œ`);
    return titles;
}

// AI í”„ë ˆì„ ë¶„ì„ ì‹¤í–‰
async function analyzeFramesWithAI() {
    const frameItems = document.querySelectorAll('.frame-item');

    if (frameItems.length === 0) {
        alert('ë¶„ì„í•  í”„ë ˆì„ì´ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    // ì„ íƒëœ í”„ë ˆì„ë§Œ ìˆ˜ì§‘
    const frames = [];
    frameItems.forEach((item, index) => {
        const checkbox = item.querySelector('.frame-select-checkbox');
        if (checkbox && checkbox.checked) {
            const frameData = item.dataset.frame;
            const label = item.dataset.label || `frame_${index + 1}`;
            const time = parseFloat(item.dataset.time) || 0; // íƒ€ì„ìŠ¤íƒ¬í”„
            frames.push({
                index: index + 1,
                label: label,
                image_data: frameData,
                time: time  // íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€
            });
        }
    });

    if (frames.length === 0) {
        alert('ë¶„ì„í•  í”„ë ˆì„ì„ ì„ íƒí•˜ì„¸ìš”. ì²´í¬ë°•ìŠ¤ë¥¼ í´ë¦­í•˜ì—¬ í”„ë ˆì„ì„ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        return;
    }

    // ë“œë¡­ë‹¤ìš´ì—ì„œ ì„ íƒí•œ ê°’ ê°€ì ¸ì˜¤ê¸°
    const selectedModel = document.getElementById('frame-ai-model-select').value;
    const selectedType = document.getElementById('frame-analysis-type').value;
    const selectedLanguagePrimary = document.getElementById('subtitle-language-primary').value;
    const selectedLanguageSecondary = document.getElementById('subtitle-language-secondary').value;

    // ëª¨ë¸ ì´ë¦„ ë§¤í•‘
    const modelNames = {
        'gpt-4o-mini': 'GPT-4o Mini',
        'sonnet': 'Claude Sonnet',
        'haiku': 'Claude Haiku',
        'gpt-4o': 'GPT-4o'
    };

    const languageNames = {
        'korean': 'í•œêµ­ì–´',
        'english': 'English',
        'japanese': 'æ—¥æœ¬èª'
    };

    const typeNames = {
        'shorts-production': 'ì‡¼ì¸  ì œì‘ìš©',
        'scene-description': 'ì¥ë©´ ì„¤ëª…',
        'object-detection': 'ê°ì²´ ì¸ì‹',
        'text-extraction': 'í…ìŠ¤íŠ¸ ì¶”ì¶œ',
        'story-flow': 'ìŠ¤í† ë¦¬ íë¦„',
        'thumbnail-suggest': 'ì¸ë„¤ì¼ ì¶”ì²œ',
        'custom': 'ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸'
    };

    // ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸ ì²˜ë¦¬
    let customPrompt = null;
    if (selectedType === 'custom') {
        customPrompt = document.getElementById('custom-prompt-input').value.trim();
        if (!customPrompt) {
            alert('ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
            return;
        }
    }

    // í™•ì¸
    if (!confirm(`${frames.length}ê°œì˜ í”„ë ˆì„ì„ ${modelNames[selectedModel]}ë¡œ ë¶„ì„í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\në¶„ì„ ìœ í˜•: ${typeNames[selectedType]}`)) {
        return;
    }

    // ê²°ê³¼ ì˜ì—­ í‘œì‹œ
    const resultDiv = document.getElementById('frame-analysis-result');
    const contentDiv = document.getElementById('frame-analysis-content');
    resultDiv.style.display = 'block';

    // ì˜ˆìƒ ì‹œê°„ ê³„ì‚° (í”„ë ˆì„ë‹¹ ì•½ 3ì´ˆ)
    const estimatedSeconds = Math.ceil(frames.length * 3);
    const estimatedMinutes = Math.floor(estimatedSeconds / 60);
    const remainingSeconds = estimatedSeconds % 60;
    const estimatedTime = estimatedMinutes > 0
        ? `ì•½ ${estimatedMinutes}ë¶„ ${remainingSeconds}ì´ˆ`
        : `ì•½ ${estimatedSeconds}ì´ˆ`;

    contentDiv.value = `ğŸ”„ AI ë¶„ì„ ì¤‘...\n\nğŸ“Š ì§„í–‰ ìƒí™©:\n- ì„ íƒëœ í”„ë ˆì„: ${frames.length}ê°œ\n- ì‚¬ìš© ëª¨ë¸: ${modelNames[selectedModel]}\n- ì˜ˆìƒ ì†Œìš” ì‹œê°„: ${estimatedTime}\n\nâ³ ë¶„ì„ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...`;

    // ì§„í–‰ë¥  ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
    let dots = 0;
    const progressInterval = setInterval(() => {
        dots = (dots + 1) % 4;
        const dotString = '.'.repeat(dots);
        contentDiv.value = `ğŸ”„ AI ë¶„ì„ ì¤‘${dotString}\n\nğŸ“Š ì§„í–‰ ìƒí™©:\n- ì„ íƒëœ í”„ë ˆì„: ${frames.length}ê°œ\n- ì‚¬ìš© ëª¨ë¸: ${modelNames[selectedModel]}\n- ì˜ˆìƒ ì†Œìš” ì‹œê°„: ${estimatedTime}\n\nâ³ ë¶„ì„ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”${dotString}`;
    }, 500);

    try {
        // ì²´í¬ë°•ìŠ¤ ê°’ ê°€ì ¸ì˜¤ê¸°
        const includeExtractedFrames = document.getElementById('include-extracted-frames').checked;
        const includeTitleSubtitle = document.getElementById('include-title-subtitle').checked;

        // ìë§‰ì—ì„œ ì›ë³¸ ì œëª© ì¶”ì¶œ
        const originalTitles = extractOriginalTitlesFromSubtitles();

        // API í˜¸ì¶œ
        const requestBody = {
            frames: frames,
            model: selectedModel,
            analysis_type: selectedType,
            video_name: currentVideoInfo.name || 'unknown',
            subtitle_language_primary: selectedLanguagePrimary,
            subtitle_language_secondary: selectedLanguageSecondary,
            include_extracted_frames: includeExtractedFrames,
            include_title_subtitle: includeTitleSubtitle,
            original_titles: originalTitles  // ì›ë³¸ ì œëª© ì¶”ê°€
        };

        // ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸ê°€ ìˆìœ¼ë©´ ì¶”ê°€
        if (customPrompt) {
            requestBody.custom_prompt = customPrompt;
        }

        const response = await fetch('/api/video-analyzer/analyze-frames-with-ai', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.detail || 'AI ë¶„ì„ ì‹¤íŒ¨');
        }

        const result = await response.json();

        // ì§„í–‰ë¥  ì• ë‹ˆë©”ì´ì…˜ ì¤‘ì§€
        clearInterval(progressInterval);

        // ê²°ê³¼ í‘œì‹œ
        contentDiv.value = result.analysis_result;

        // ì„±ê³µ ì•Œë¦¼
        alert('âœ… AI í”„ë ˆì„ ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');

    } catch (error) {
        // ì§„í–‰ë¥  ì• ë‹ˆë©”ì´ì…˜ ì¤‘ì§€
        clearInterval(progressInterval);

        console.error('AI í”„ë ˆì„ ë¶„ì„ ì˜¤ë¥˜:', error);
        contentDiv.value = `âŒ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`;
        alert(`AI í”„ë ˆì„ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:\n${error.message}`);
    }
}

// ============================================
// AI ìë§‰ ë¶„ì„ ê´€ë ¨ í•¨ìˆ˜ë“¤
// ============================================

// AI ìë§‰ ë¶„ì„ ì‹¤í–‰
async function analyzeSubtitlesWithAI() {
    // í˜„ì¬ ìë§‰ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    const subtitleItems = document.querySelectorAll('.subtitle-item');

    if (subtitleItems.length === 0) {
        alert('ë¶„ì„í•  ìë§‰ì´ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    // ë“œë¡­ë‹¤ìš´ì—ì„œ ì„ íƒí•œ ê°’ ê°€ì ¸ì˜¤ê¸°
    const selectedModel = document.getElementById('ai-model-select').value;
    const selectedType = document.getElementById('analysis-type-select').value;

    // ëª¨ë¸ ì´ë¦„ ë§¤í•‘ (í‘œì‹œìš©)
    const modelNames = {
        'gpt-4o-mini': 'GPT-4o Mini',
        'sonnet': 'Claude Sonnet',
        'haiku': 'Claude Haiku',
        'gpt-4o': 'GPT-4o'
    };

    const typeNames = {
        'enhanced-shorts': '60ì´ˆ ì‡¼ì¸ ',
        'enhanced-summary': 'ê¸´ ì˜ìƒ ìš”ì•½',
        'enhanced-education': 'êµìœ¡ ì½˜í…ì¸ ',
        'enhanced': 'Enhanced',
        'shorts': 'Shorts'
    };

    // ìë§‰ ë°ì´í„°ë¥¼ SRT í˜•ì‹ìœ¼ë¡œ ë³€í™˜
    let srtContent = '';
    subtitleItems.forEach((item, index) => {
        const start = item.dataset.start;
        const end = item.dataset.end;
        const text = item.dataset.text;

        srtContent += `${index + 1}\n`;
        srtContent += `${start} --> ${end}\n`;
        srtContent += `${text}\n\n`;
    });

    try {
        // ì‚¬ìš©ìì—ê²Œ ë¶„ì„ ì‹œì‘ ì•Œë¦¼
        const confirmMsg = `AI ë¶„ì„ì„ ì‹œì‘í•©ë‹ˆë‹¤.\n\n` +
            `ğŸ“Œ ëª¨ë¸: ${modelNames[selectedModel]}\n` +
            `ğŸ“Œ íƒ€ì…: ${typeNames[selectedType]}\n` +
            `ğŸ“Œ ìë§‰ ìˆ˜: ${subtitleItems.length}ê°œ\n\n` +
            `ë¶„ì„ì— 10-30ì´ˆ ì •ë„ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;

        if (!confirm(confirmMsg)) {
            return;
        }

        // ë¶„ì„ ë²„íŠ¼ ë¹„í™œì„±í™” ë° ë¡œë”© í‘œì‹œ
        const analyzeBtn = event.target;
        const originalText = analyzeBtn.textContent;
        analyzeBtn.disabled = true;
        analyzeBtn.textContent = 'ğŸ”„ ë¶„ì„ ì¤‘...';
        analyzeBtn.style.opacity = '0.6';

        // API í˜¸ì¶œ
        const response = await fetch('/api/video-analyzer/analyze-subtitles-with-ai', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                subtitle_content: srtContent,
                model: selectedModel,
                analysis_type: selectedType
            })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.detail || 'AI ë¶„ì„ ì‹¤íŒ¨');
        }

        const data = await response.json();
        const result = data.result;

        // ë¶„ì„ ê²°ê³¼ í‘œì‹œ
        displayAnalysisResult(result);

        // ë²„íŠ¼ ë³µì›
        analyzeBtn.disabled = false;
        analyzeBtn.textContent = originalText;
        analyzeBtn.style.opacity = '1';

    } catch (error) {
        console.error('AI ë¶„ì„ ì‹¤íŒ¨:', error);
        alert('AI ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);

        // ë²„íŠ¼ ë³µì›
        const analyzeBtn = event.target;
        analyzeBtn.disabled = false;
        analyzeBtn.textContent = 'ğŸ¤– ë¶„ì„ ì‹œì‘';
        analyzeBtn.style.opacity = '1';
    }
}

// ëª©ì—… ë¶„ì„ ê²°ê³¼ ìƒì„± (í…ŒìŠ¤íŠ¸ìš©)
function generateMockAnalysisResult(subtitleItems, analysisType) {
    const totalCount = subtitleItems.length;

    // íƒ€ì…ë³„ ì‚­ì œìœ¨ ì¡°ì •
    let deleteRate, textAddRate, narrationAddRate;

    switch (analysisType) {
        case 'enhanced-shorts':
            deleteRate = 0.65; // 60-70% ì‚­ì œ
            textAddRate = 0.10; // í…ìŠ¤íŠ¸ ì¶”ê°€ ë§ì´
            narrationAddRate = 0.08;
            break;
        case 'enhanced-summary':
            deleteRate = 0.45; // 40-50% ì‚­ì œ
            textAddRate = 0.05;
            narrationAddRate = 0.10; // ë‚˜ë ˆì´ì…˜ ë§ì´
            break;
        case 'enhanced-education':
            deleteRate = 0.25; // 20-30% ì‚­ì œ (ì ê²Œ)
            textAddRate = 0.15; // í…ìŠ¤íŠ¸ ê°•ì¡° ë§ì´
            narrationAddRate = 0.05;
            break;
        default:
            deleteRate = 0.50;
            textAddRate = 0.05;
            narrationAddRate = 0.05;
    }

    const keptCount = Math.floor(totalCount * (1 - deleteRate));
    const deleteCount = totalCount - keptCount;
    const textAddCount = Math.floor(totalCount * textAddRate);
    const narrationAddCount = Math.floor(totalCount * narrationAddRate);

    const result = {
        video_type: analysisType,
        kept_originals: [],
        deletions: [],
        text_additions: [],
        narration_additions: [],
        statistics: {
            original_count: totalCount,
            kept_count: keptCount,
            delete_count: deleteCount,
            text_add_count: textAddCount,
            narration_add_count: narrationAddCount
        }
    };

    // ëª©ì—… ë°ì´í„° ìƒì„±
    subtitleItems.forEach((item, index) => {
        const start = item.dataset.start;
        const end = item.dataset.end;
        const text = item.dataset.text;

        if (index < keptCount) {
            result.kept_originals.push({
                index: index,
                time: `${start} --> ${end}`,
                text: text,
                reason: 'í•µì‹¬ ë‚´ìš©',
                importance: 'high'
            });
        } else if (index < keptCount + deleteCount) {
            result.deletions.push({
                index: index,
                time: `${start} --> ${end}`,
                text: text,
                reason: 'ë°˜ë³µ ë‚´ìš© / ë¶ˆí•„ìš”',
                category: 'ë°˜ë³µ'
            });
        }
    });

    // íƒ€ì…ë³„ í…ìŠ¤íŠ¸ ì¶”ê°€ ì˜ˆì‹œ
    for (let i = 0; i < textAddCount; i++) {
        let textContent, textType;

        switch (analysisType) {
            case 'enhanced-shorts':
                textContent = [`ğŸ’¥ ì£¼ëª©!`, `ğŸ”¥ í•µì‹¬`, `ğŸ’¡ íŒ`, `âš¡ ì¤‘ìš”`, `âœ¨ í¬ì¸íŠ¸`][i % 5];
                textType = 'í›„í‚¹';
                break;
            case 'enhanced-summary':
                textContent = [`[ì±•í„° ${i + 1}]`, `[í•µì‹¬ ìš”ì•½]`, `[ì£¼ìš” í¬ì¸íŠ¸]`][i % 3];
                textType = 'ì±•í„°ì œëª©';
                break;
            case 'enhanced-education':
                textContent = [`ğŸ“Œ ê°œë… ${i + 1}`, `ğŸ“ ì˜ˆì‹œ`, `ğŸ’¡ ë³µìŠµ í¬ì¸íŠ¸`, `ğŸ¯ í•µì‹¬ ê³µì‹`][i % 4];
                textType = 'ê°œë…ì •ì˜';
                break;
            default:
                textContent = `[í™”ë©´ ì „í™˜ ${i + 1}]`;
                textType = 'ê°•ì¡°';
        }

        result.text_additions.push({
            insert_after: Math.floor(i * totalCount / textAddCount),
            estimated_time: '00:00:10',
            text: textContent,
            type: textType,
            position: 'top'
        });
    }

    // íƒ€ì…ë³„ ë‚˜ë ˆì´ì…˜ ì¶”ê°€ ì˜ˆì‹œ
    for (let i = 0; i < narrationAddCount; i++) {
        let narrationText, purpose, tone;

        switch (analysisType) {
            case 'enhanced-shorts':
                narrationText = `ì´ì œ ê°€ì¥ ì¤‘ìš”í•œ ë¶€ë¶„ì…ë‹ˆë‹¤!`;
                purpose = 'ì˜¤í”„ë‹';
                tone = 'ì—´ì •ì ';
                break;
            case 'enhanced-summary':
                narrationText = `ì§€ê¸ˆê¹Œì§€ ì‚´í´ë³¸ ë‚´ìš©ì„ ì •ë¦¬í•˜ë©´...`;
                purpose = 'ì„¹ì…˜ìš”ì•½';
                tone = 'ì „ë¬¸ì ';
                break;
            case 'enhanced-education':
                narrationText = `ì´ ê°œë…ì„ ì´í•´í•˜ê¸° ìœ„í•´ì„œëŠ”...`;
                purpose = 'ê°œë…ì„¤ëª…';
                tone = 'ì°¨ë¶„í•œ';
                break;
            default:
                narrationText = `ìš”ì•½: ì´ ë¶€ë¶„ì˜ í•µì‹¬ì€...`;
                purpose = 'ì „í™˜';
                tone = 'ì „ë¬¸ì ';
        }

        result.narration_additions.push({
            insert_after: Math.floor(i * totalCount / narrationAddCount),
            estimated_time: '00:00:15',
            narration_text: narrationText,
            subtitle_text: 'ë‚˜ë ˆì´ì…˜',
            purpose: purpose,
            tone: tone
        });
    }

    return result;
}

// ë¶„ì„ ê²°ê³¼ í‘œì‹œ
function displayAnalysisResult(result) {
    // ì „ì—­ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
    currentAnalysisResult = result;

    // ê¸°ë³¸ ìë§‰ ë·° ìˆ¨ê¸°ê¸°
    document.getElementById('default-subtitle-view').style.display = 'none';

    // AI ë¶„ì„ ê²°ê³¼ í‘œì‹œ
    document.getElementById('ai-analysis-result').style.display = 'block';

    // í†µê³„ ì—…ë°ì´íŠ¸
    const stats = result.statistics || {};
    const originalCount = stats.original_count || result.kept_originals.length + result.deletions.length;
    const finalCount = result.kept_originals.length + result.text_additions.length + result.narration_additions.length;
    const deletionRate = originalCount > 0 ? ((result.deletions.length / originalCount) * 100).toFixed(1) : 0;

    // ì‹œê°„ ê³„ì‚° (ê°„ë‹¨ ì¶”ì •: 1ìë§‰ = 3ì´ˆ)
    const originalDuration = originalCount * 3;
    const finalDuration = finalCount * 3;

    document.getElementById('original-duration').textContent = formatDuration(originalDuration);
    document.getElementById('summary-duration').textContent = formatDuration(finalDuration);
    document.getElementById('deletion-rate').textContent = `${deletionRate}%`;

    // ì í•©ë„ ì²´í¬ (ì €ì¥ëœ ê°’ ë˜ëŠ” ìë™ íŒë‹¨)
    let isShortsCandidate, isSummaryCandidate, isEducationCandidate;

    if (result.suitability) {
        // ë¶ˆëŸ¬ì˜¨ íŒŒì¼ì— ì í•©ë„ ì •ë³´ê°€ ìˆìœ¼ë©´ ì‚¬ìš©
        isShortsCandidate = result.suitability.shorts;
        isSummaryCandidate = result.suitability.summary;
        isEducationCandidate = result.suitability.education;
    } else {
        // ì—†ìœ¼ë©´ ìë™ íŒë‹¨
        isShortsCandidate = finalDuration <= 60;
        isSummaryCandidate = finalDuration > 60 && finalDuration <= 300;
        isEducationCandidate = result.video_type === 'education';
    }

    document.getElementById('suitable-shorts').checked = isShortsCandidate;
    document.getElementById('suitable-summary').checked = isSummaryCandidate;
    document.getElementById('suitable-education').checked = isEducationCandidate;

    document.getElementById('shorts-score').textContent = isShortsCandidate ? 'âœ“ ì í•©' : '- ë¶€ì í•©';
    document.getElementById('summary-score').textContent = isSummaryCandidate ? 'âœ“ ì í•©' : '- ë¶€ì í•©';
    document.getElementById('education-score').textContent = isEducationCandidate ? 'âœ“ ì í•©' : '- ë³´í†µ';

    // ê° ì¹´í…Œê³ ë¦¬ í‘œì‹œ
    displayCategoryItems('kept-originals', result.kept_originals, 'kept');
    displayCategoryItems('deletions', result.deletions, 'deletion');
    displayCategoryItems('text-additions', result.text_additions, 'text-add');
    displayCategoryItems('narration-additions', result.narration_additions, 'narration-add');

    // ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
    document.getElementById('kept-count').textContent = result.kept_originals.length;
    document.getElementById('deletions-count').textContent = result.deletions.length;
    document.getElementById('text-additions-count').textContent = result.text_additions.length;
    document.getElementById('narration-additions-count').textContent = result.narration_additions.length;

    alert('AI ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
}

// ì‹œê°„ í¬ë§· (ì´ˆ -> MM:SS)
function formatDuration(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${secs.toString().padStart(2, '0')}`;
}

// ì¹´í…Œê³ ë¦¬ë³„ ì•„ì´í…œ í‘œì‹œ
function displayCategoryItems(categoryId, items, cssClass) {
    const container = document.getElementById(categoryId);
    container.innerHTML = '';

    if (items.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
    }

    items.forEach((item, index) => {
        const itemDiv = document.createElement('div');
        itemDiv.className = `category-item ${cssClass}`;
        itemDiv.dataset.index = item.index || index;

        let content = `
            <div class="category-item-header">
                <div>
                    ${item.time ? `<div class="category-item-time">${item.time}</div>` : ''}
                    ${item.estimated_time ? `<div class="category-item-time">ì˜ˆìƒ ì‹œê°„: ${item.estimated_time}</div>` : ''}
                </div>
                <button onclick="deleteCategoryItem(this)" class="item-delete-btn" title="ì‚­ì œ">ğŸ—‘ï¸</button>
            </div>
            <div class="category-item-text">
                ${item.text || item.narration_text || '-'}
            </div>
        `;

        // ì¶”ê°€ ì •ë³´
        if (item.reason) {
            content += `<div class="category-item-reason">ì´ìœ : ${item.reason}</div>`;
        }
        if (item.importance) {
            content += `<div class="category-item-reason">ì¤‘ìš”ë„: ${item.importance}</div>`;
        }
        if (item.type) {
            content += `<div class="category-item-reason">íƒ€ì…: ${item.type}</div>`;
        }
        if (item.purpose) {
            content += `<div class="category-item-reason">ëª©ì : ${item.purpose}</div>`;
        }
        if (item.subtitle_text && item.subtitle_text !== item.narration_text) {
            content += `<div class="category-item-reason">ìë§‰: ${item.subtitle_text}</div>`;
        }

        itemDiv.innerHTML = content;
        container.appendChild(itemDiv);
    });
}

// ì¹´í…Œê³ ë¦¬ ì ‘ê¸°/í¼ì¹˜ê¸°
function toggleCategory(categoryId) {
    const category = document.getElementById(categoryId);
    category.classList.toggle('collapsed');
}

// ê°œë³„ í•­ëª© ì‚­ì œ
function deleteCategoryItem(button) {
    const item = button.closest('.category-item');

    if (!item) return;

    // ì‚­ì œ ì• ë‹ˆë©”ì´ì…˜
    item.classList.add('removing');

    setTimeout(() => {
        item.remove();
        updateCategoryCounts();
    }, 300);
}

// ì‚­ì œ í‘œì‹œ ì¼ê´„ ì‚­ì œ
function batchDeleteMarkedForDeletion() {
    const deletionItems = document.querySelectorAll('#deletions .category-item');

    if (deletionItems.length === 0) {
        alert('ì‚­ì œí•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    if (!confirm(`${deletionItems.length}ê°œì˜ ì‚­ì œ í‘œì‹œ í•­ëª©ì„ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        return;
    }

    deletionItems.forEach(item => {
        item.classList.add('removing');
    });

    setTimeout(() => {
        deletionItems.forEach(item => item.remove());
        updateCategoryCounts();
        alert('ì‚­ì œ í‘œì‹œ í•­ëª©ì´ ì¼ê´„ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }, 300);
}

// ì¹´í…Œê³ ë¦¬ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
function updateCategoryCounts() {
    document.getElementById('kept-count').textContent =
        document.querySelectorAll('#kept-originals .category-item').length;
    document.getElementById('deletions-count').textContent =
        document.querySelectorAll('#deletions .category-item').length;
    document.getElementById('text-additions-count').textContent =
        document.querySelectorAll('#text-additions .category-item').length;
    document.getElementById('narration-additions-count').textContent =
        document.querySelectorAll('#narration-additions .category-item').length;
}

// ============================================
// ë¶„ì„ ê²°ê³¼ ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° ê¸°ëŠ¥
// ============================================

// ì „ì—­ ë³€ìˆ˜: í˜„ì¬ ë¶„ì„ ê²°ê³¼ì™€ íŒŒì¼ëª…
let currentAnalysisResult = null;
let currentAnalysisFileName = null;

// í˜„ì¬ ë¶„ì„ ê²°ê³¼ë¥¼ ìˆ˜ì§‘í•˜ëŠ” í•¨ìˆ˜
function collectCurrentAnalysisResult() {
    const result = {
        video_type: 'unknown',
        video_info: {
            original_duration: document.getElementById('original-duration').textContent,
            summary_duration: document.getElementById('summary-duration').textContent,
            deletion_rate: document.getElementById('deletion-rate').textContent,
        },
        suitability: {
            shorts: document.getElementById('suitable-shorts').checked,
            summary: document.getElementById('suitable-summary').checked,
            education: document.getElementById('suitable-education').checked,
        },
        kept_originals: [],
        deletions: [],
        text_additions: [],
        narration_additions: [],
        timestamp: new Date().toISOString()
    };

    // ê° ì¹´í…Œê³ ë¦¬ì˜ ì•„ì´í…œ ìˆ˜ì§‘
    document.querySelectorAll('#kept-originals .category-item').forEach(item => {
        result.kept_originals.push({
            index: item.dataset.index,
            text: item.querySelector('.category-item-text')?.textContent || '',
            time: item.querySelector('.category-item-time')?.textContent || ''
        });
    });

    document.querySelectorAll('#deletions .category-item').forEach(item => {
        result.deletions.push({
            index: item.dataset.index,
            text: item.querySelector('.category-item-text')?.textContent || '',
            time: item.querySelector('.category-item-time')?.textContent || ''
        });
    });

    document.querySelectorAll('#text-additions .category-item').forEach(item => {
        result.text_additions.push({
            text: item.querySelector('.category-item-text')?.textContent || '',
            time: item.querySelector('.category-item-time')?.textContent || ''
        });
    });

    document.querySelectorAll('#narration-additions .category-item').forEach(item => {
        result.narration_additions.push({
            text: item.querySelector('.category-item-text')?.textContent || '',
            time: item.querySelector('.category-item-time')?.textContent || ''
        });
    });

    result.statistics = {
        kept_count: result.kept_originals.length,
        deletions_count: result.deletions.length,
        text_additions_count: result.text_additions.length,
        narration_additions_count: result.narration_additions.length
    };

    return result;
}

// ì €ì¥ (í˜„ì¬ íŒŒì¼ëª…ìœ¼ë¡œ)
function saveAnalysisResult() {
    const result = collectCurrentAnalysisResult();

    // íŒŒì¼ëª…ì´ ì—†ìœ¼ë©´ "ë‹¤ë¥¸ ì´ë¦„ìœ¼ë¡œ ì €ì¥" ì‹¤í–‰
    if (!currentAnalysisFileName) {
        saveAnalysisResultAs();
        return;
    }

    downloadJSON(result, currentAnalysisFileName);
    alert('âœ… ë¶„ì„ ê²°ê³¼ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
}

// ë‹¤ë¥¸ ì´ë¦„ìœ¼ë¡œ ì €ì¥
function saveAnalysisResultAs() {
    const result = collectCurrentAnalysisResult();

    // ê¸°ë³¸ íŒŒì¼ëª… ìƒì„±
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19);
    const defaultFileName = currentAnalysisFileName || `subtitle_analysis_${timestamp}.json`;

    // íŒŒì¼ëª… ì…ë ¥ ë°›ê¸°
    const fileName = prompt('ì €ì¥í•  íŒŒì¼ëª…ì„ ì…ë ¥í•˜ì„¸ìš”:', defaultFileName);

    if (!fileName) {
        return; // ì·¨ì†Œí•œ ê²½ìš°
    }

    // .json í™•ì¥ì ìë™ ì¶”ê°€
    const finalFileName = fileName.endsWith('.json') ? fileName : `${fileName}.json`;

    // í˜„ì¬ íŒŒì¼ëª… ì—…ë°ì´íŠ¸
    currentAnalysisFileName = finalFileName;
    currentAnalysisResult = result;

    downloadJSON(result, finalFileName);
    alert(`âœ… "${finalFileName}"ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!`);
}

// JSON ë‹¤ìš´ë¡œë“œ í—¬í¼ í•¨ìˆ˜
function downloadJSON(data, filename) {
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = window.URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    window.URL.revokeObjectURL(url);
}

// ë¸Œë¼ìš°ì € localStorageì— ì €ì¥ (ìë§‰ ë¶„ì„ìš©)
function saveSubtitleAnalysisToLocalStorage() {
    const result = collectCurrentAnalysisResult();

    if (!result || (!result.kept_originals && !result.deletions)) {
        alert('ì €ì¥í•  ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    // ì €ì¥ëœ ë¶„ì„ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    const savedAnalyses = JSON.parse(localStorage.getItem('savedSubtitleAnalyses') || '[]');

    // íŒŒì¼ëª… ì…ë ¥ ë°›ê¸°
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19);
    const defaultName = `ìë§‰ë¶„ì„_${timestamp}`;
    const name = prompt('ì €ì¥í•  ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:', defaultName);

    if (!name) {
        return; // ì·¨ì†Œí•œ ê²½ìš°
    }

    // ìƒˆ ë¶„ì„ ì €ì¥
    const newAnalysis = {
        id: Date.now(),
        name: name,
        timestamp: new Date().toISOString(),
        result: result
    };

    // ëª©ë¡ì— ì¶”ê°€ (ìµœì‹  ê²ƒì´ ìœ„ë¡œ)
    savedAnalyses.unshift(newAnalysis);

    // ìµœëŒ€ 20ê°œê¹Œì§€ë§Œ ì €ì¥
    if (savedAnalyses.length > 20) {
        savedAnalyses.pop();
    }

    // localStorageì— ì €ì¥
    localStorage.setItem('savedSubtitleAnalyses', JSON.stringify(savedAnalyses));

    alert(`âœ… "${name}"ìœ¼ë¡œ ë¸Œë¼ìš°ì €ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!\n\nğŸ’¡ "ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸°" ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ ì €ì¥ëœ ëª©ë¡ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
}

// ì €ì¥ëœ ë¶„ì„ ëª©ë¡ ë‹¤ì´ì–¼ë¡œê·¸ í‘œì‹œ (ìë§‰ ë¶„ì„ìš©)
function showSubtitleAnalysisDialog() {
    const savedAnalyses = JSON.parse(localStorage.getItem('savedSubtitleAnalyses') || '[]');

    if (savedAnalyses.length === 0) {
        alert('ì €ì¥ëœ ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.\n\nğŸ’¡ "ğŸ’¾ ë¸Œë¼ìš°ì €ì— ì €ì¥" ë²„íŠ¼ì„ ì‚¬ìš©í•˜ì—¬ ë¶„ì„ ê²°ê³¼ë¥¼ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        return;
    }

    // ë‹¤ì´ì–¼ë¡œê·¸ ìƒì„±
    const backdrop = document.createElement('div');
    backdrop.id = 'load-dialog-backdrop';
    backdrop.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        backdrop-filter: blur(4px);
    `;

    const dialog = document.createElement('div');
    dialog.style.cssText = `
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        border-radius: 16px;
        padding: 24px;
        max-width: 800px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        border: 1px solid rgba(255, 255, 255, 0.1);
    `;

    // í—¤ë”
    const header = document.createElement('div');
    header.style.cssText = `
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 2px solid rgba(255, 255, 255, 0.1);
    `;
    header.innerHTML = `
        <h3 style="margin: 0; color: #fff; font-size: 1.3rem; font-weight: 600;">
            ğŸ“‚ ì €ì¥ëœ ë¶„ì„ ê²°ê³¼ (${savedAnalyses.length}ê°œ)
        </h3>
        <button onclick="document.getElementById('load-dialog-backdrop').remove()"
                style="background: rgba(255, 255, 255, 0.1); border: none; color: #fff;
                       padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 0.9rem;">
            âœ• ë‹«ê¸°
        </button>
    `;

    // ëª©ë¡ ì»¨í…Œì´ë„ˆ
    const listContainer = document.createElement('div');
    listContainer.style.cssText = `
        display: flex;
        flex-direction: column;
        gap: 10px;
    `;

    savedAnalyses.forEach((analysis) => {
        const item = document.createElement('div');
        item.style.cssText = `
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            transition: all 0.2s;
        `;
        item.onmouseenter = () => {
            item.style.background = 'rgba(255, 255, 255, 0.08)';
            item.style.borderColor = 'rgba(139, 92, 246, 0.5)';
        };
        item.onmouseleave = () => {
            item.style.background = 'rgba(255, 255, 255, 0.05)';
            item.style.borderColor = 'rgba(255, 255, 255, 0.1)';
        };

        const date = new Date(analysis.timestamp);
        const dateStr = date.toLocaleString('ko-KR');

        item.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div style="flex: 1;">
                    <div style="color: #fff; font-weight: 600; font-size: 1rem; margin-bottom: 5px;">
                        ${analysis.name}
                    </div>
                    <div style="color: #a0aec0; font-size: 0.85rem;">
                        ${dateStr}
                    </div>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button onclick="loadSubtitleSavedAnalysis('${analysis.id}')"
                            style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
                                   border: none; color: white; padding: 6px 12px; border-radius: 6px;
                                   cursor: pointer; font-size: 0.85rem; font-weight: 500;">
                        ë¶ˆëŸ¬ì˜¤ê¸°
                    </button>
                    <button onclick="deleteSubtitleSavedAnalysis('${analysis.id}'); event.stopPropagation();"
                            style="background: #ef4444; border: none; color: white; padding: 6px 12px;
                                   border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                        ğŸ—‘ï¸
                    </button>
                </div>
            </div>
        `;

        listContainer.appendChild(item);
    });

    dialog.appendChild(header);
    dialog.appendChild(listContainer);
    backdrop.appendChild(dialog);
    document.body.appendChild(backdrop);

    // ESC í‚¤ë¡œ ë‹«ê¸°
    const handleEscape = (e) => {
        if (e.key === 'Escape') {
            backdrop.remove();
            document.removeEventListener('keydown', handleEscape);
        }
    };
    document.addEventListener('keydown', handleEscape);

    // ë°°ê²½ í´ë¦­ìœ¼ë¡œ ë‹«ê¸°
    backdrop.onclick = (e) => {
        if (e.target === backdrop) {
            backdrop.remove();
            document.removeEventListener('keydown', handleEscape);
        }
    };
}

// ì €ì¥ëœ ë¶„ì„ ë¶ˆëŸ¬ì˜¤ê¸° (ìë§‰ ë¶„ì„ìš©)
function loadSubtitleSavedAnalysis(id) {
    const savedAnalyses = JSON.parse(localStorage.getItem('savedSubtitleAnalyses') || '[]');
    const analysis = savedAnalyses.find(a => a.id.toString() === id.toString());

    if (!analysis) {
        alert('ë¶„ì„ ê²°ê³¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    // ë¶„ì„ ê²°ê³¼ í‘œì‹œ
    displayAnalysisResult(analysis.result);

    // ë‹¤ì´ì–¼ë¡œê·¸ ë‹«ê¸°
    const backdrop = document.getElementById('load-dialog-backdrop');
    if (backdrop) backdrop.remove();

    alert(`âœ… "${analysis.name}"ì„(ë¥¼) ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!`);
}

// ì €ì¥ëœ ë¶„ì„ ì‚­ì œ (ìë§‰ ë¶„ì„ìš©)
function deleteSubtitleSavedAnalysis(id) {
    if (!confirm('ì´ ë¶„ì„ ê²°ê³¼ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
    }

    let savedAnalyses = JSON.parse(localStorage.getItem('savedSubtitleAnalyses') || '[]');
    savedAnalyses = savedAnalyses.filter(a => a.id.toString() !== id.toString());
    localStorage.setItem('savedSubtitleAnalyses', JSON.stringify(savedAnalyses));

    // ë‹¤ì´ì–¼ë¡œê·¸ ìƒˆë¡œê³ ì¹¨
    const backdrop = document.getElementById('load-dialog-backdrop');
    if (backdrop) backdrop.remove();
    showSubtitleAnalysisDialog();
}

// íŒŒì¼ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸° (ê¸°ì¡´ ê¸°ëŠ¥)
function loadAnalysisFromFile() {
    document.getElementById('load-analysis-input').click();
}

// ë¶ˆëŸ¬ì˜¤ê¸°
function loadAnalysisResult() {
    document.getElementById('load-analysis-input').click();
}

// íŒŒì¼ ë¡œë“œ ì²˜ë¦¬
function handleAnalysisFileLoad(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();

    reader.onload = function(e) {
        try {
            const result = JSON.parse(e.target.result);

            // íŒŒì¼ëª… ì €ì¥
            currentAnalysisFileName = file.name;
            currentAnalysisResult = result;

            // ë¶„ì„ ê²°ê³¼ í‘œì‹œ
            displayAnalysisResult(result);

            alert(`âœ… "${file.name}"ì„(ë¥¼) ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!`);
        } catch (error) {
            console.error('íŒŒì¼ ë¡œë“œ ì˜¤ë¥˜:', error);
            alert('âŒ JSON íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + error.message);
        }
    };

    reader.readAsText(file);

    // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™” (ê°™ì€ íŒŒì¼ì„ ë‹¤ì‹œ ì„ íƒí•  ìˆ˜ ìˆë„ë¡)
    event.target.value = '';
}

// ============================================
// ì˜ìƒ í•©ì¹˜ê¸° ê¸°ëŠ¥
// ============================================

async function mergeSelectedVideos() {
    if (selectedVideos.length < 2) {
        alert('ìµœì†Œ 2ê°œì˜ ì˜ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }

    // ì¶œë ¥ íŒŒì¼ëª… ì…ë ¥ë°›ê¸°
    const defaultName = `merged_video_${new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19)}.mp4`;
    const outputName = prompt('í•©ì³ì§„ ì˜ìƒ íŒŒì¼ëª…ì„ ì…ë ¥í•˜ì„¸ìš”:', defaultName);

    if (!outputName) {
        return;  // ì·¨ì†Œ
    }

    // ë¡œë”© í‘œì‹œ
    const statusEl = document.getElementById('folder-status');
    statusEl.textContent = `ğŸ”„ ${selectedVideos.length}ê°œ ì˜ìƒì„ í•©ì¹˜ëŠ” ì¤‘...`;
    statusEl.style.color = '#fbbf24';

    try {
        // API í˜¸ì¶œ
        const response = await fetch('/api/video-analyzer/merge-videos', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                video_paths: selectedVideos.map(v => v.path),
                output_name: outputName
            })
        });

        const result = await response.json();

        if (!response.ok) {
            throw new Error(result.detail || 'ì˜ìƒ í•©ì¹˜ê¸° ì‹¤íŒ¨');
        }

        statusEl.textContent = `âœ… ì˜ìƒì´ ì„±ê³µì ìœ¼ë¡œ í•©ì³ì¡ŒìŠµë‹ˆë‹¤: ${result.output_path}`;
        statusEl.style.color = '#10b981';

        alert(`âœ… ì˜ìƒì´ ì„±ê³µì ìœ¼ë¡œ í•©ì³ì¡ŒìŠµë‹ˆë‹¤!\n\nê²½ë¡œ: ${result.output_path}\níŒŒì¼ í¬ê¸°: ${result.size_mb} MB`);

        // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        await loadVideoFilesFromFolder();

    } catch (error) {
        console.error('ì˜ìƒ í•©ì¹˜ê¸° ì˜¤ë¥˜:', error);
        statusEl.textContent = `âŒ ì˜¤ë¥˜: ${error.message}`;
        statusEl.style.color = '#ef4444';
        alert('ì˜ìƒ í•©ì¹˜ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:\n' + error.message);
    }
}

// ì˜ìƒ íŒŒì¼ ì´ë¦„ ë°”ê¾¸ê¸° ê¸°ëŠ¥
async function renameVideoFile(videoPath, videoName, directory) {
    // íŒŒì¼ í™•ì¥ì ì¶”ì¶œ
    const lastDotIndex = videoName.lastIndexOf('.');
    const extension = lastDotIndex !== -1 ? videoName.substring(lastDotIndex) : '';
    const nameWithoutExt = lastDotIndex !== -1 ? videoName.substring(0, lastDotIndex) : videoName;

    // ìƒˆ ì´ë¦„ ì…ë ¥ë°›ê¸°
    const newName = prompt('ìƒˆ íŒŒì¼ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš” (í™•ì¥ì ì œì™¸):', nameWithoutExt);

    if (!newName) {
        return;  // ì·¨ì†Œ
    }

    if (newName.trim() === '') {
        alert('íŒŒì¼ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }

    // í™•ì¥ì ì¶”ê°€
    const newFullName = newName.trim() + extension;

    if (newFullName === videoName) {
        alert('ë™ì¼í•œ ì´ë¦„ì…ë‹ˆë‹¤.');
        return;
    }

    // ë¡œë”© í‘œì‹œ
    const statusEl = document.getElementById('folder-status');
    statusEl.textContent = `âœï¸ íŒŒì¼ ì´ë¦„ ë³€ê²½ ì¤‘...`;
    statusEl.style.color = '#fbbf24';

    try {
        // API í˜¸ì¶œ
        const response = await fetch('/api/video-analyzer/rename-file', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                old_path: videoPath,
                new_name: newFullName
            })
        });

        const result = await response.json();

        if (!response.ok) {
            throw new Error(result.detail || 'íŒŒì¼ ì´ë¦„ ë³€ê²½ ì‹¤íŒ¨');
        }

        statusEl.textContent = `âœ… íŒŒì¼ ì´ë¦„ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤: ${newFullName}`;
        statusEl.style.color = '#10b981';

        // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        await loadVideoFilesFromFolder();

        // 3ì´ˆ í›„ ìƒíƒœ ë©”ì‹œì§€ ì´ˆê¸°í™”
        setTimeout(() => {
            statusEl.textContent = '';
        }, 3000);

    } catch (error) {
        console.error('íŒŒì¼ ì´ë¦„ ë³€ê²½ ì˜¤ë¥˜:', error);
        statusEl.textContent = `âŒ ì˜¤ë¥˜: ${error.message}`;
        statusEl.style.color = '#ef4444';
        alert('íŒŒì¼ ì´ë¦„ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:\n' + error.message);
    }
}

// ì˜ìƒ íŒŒì¼ ì‚­ì œ ê¸°ëŠ¥
async function deleteVideoFile(videoPath, videoName) {
    // í™•ì¸ ëŒ€í™”ìƒì
    if (!confirm(`ì •ë§ë¡œ ì´ ì˜ìƒì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n${videoName}\n\nâš ï¸ ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
        return;
    }

    // ë¡œë”© í‘œì‹œ
    const statusEl = document.getElementById('folder-status');
    statusEl.textContent = `ğŸ—‘ï¸ íŒŒì¼ ì‚­ì œ ì¤‘...`;
    statusEl.style.color = '#fbbf24';

    try {
        // API í˜¸ì¶œ
        const response = await fetch('/api/video-analyzer/delete-file', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                file_path: videoPath
            })
        });

        const result = await response.json();

        if (!response.ok) {
            throw new Error(result.detail || 'íŒŒì¼ ì‚­ì œ ì‹¤íŒ¨');
        }

        statusEl.textContent = `âœ… íŒŒì¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤: ${videoName}`;
        statusEl.style.color = '#10b981';

        // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        await loadVideoFilesFromFolder();

        // 3ì´ˆ í›„ ìƒíƒœ ë©”ì‹œì§€ ì´ˆê¸°í™”
        setTimeout(() => {
            statusEl.textContent = '';
        }, 3000);

    } catch (error) {
        console.error('íŒŒì¼ ì‚­ì œ ì˜¤ë¥˜:', error);
        statusEl.textContent = `âŒ ì˜¤ë¥˜: ${error.message}`;
        statusEl.style.color = '#ef4444';
        alert('íŒŒì¼ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:\n' + error.message);
    }
}

// ============================================
// ê¸°ì¡´ í•¨ìˆ˜ë“¤
// ============================================

// Load video files and settings when page loads
document.addEventListener('DOMContentLoaded', () => {
    console.log('ğŸ¬ í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ - DOMContentLoaded ì´ë²¤íŠ¸ ë°œìƒ');

    loadSettings();
    setupAutoSave();

    // ì˜ìƒ íŒŒì¼ ì„ íƒ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
    const videoFileInput = document.getElementById('video_file');
    if (videoFileInput) {
        videoFileInput.addEventListener('change', handleVideoFileSelect);
    }

    // ì €ì¥ëœ ì˜ìƒ ì •ë³´ì™€ í”„ë ˆì„ë“¤ ë³µì›
    restoreCurrentVideoInfo();
    restoreExtractedFrames();

    // ì €ì¥ëœ ì˜ìƒí´ë” ê²½ë¡œê°€ ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    const videoPathInput = document.getElementById('video_path');
    const savedPath = videoPathInput ? videoPathInput.value.trim() : '';

    console.log('ğŸ“‚ ì €ì¥ëœ ê²½ë¡œ:', savedPath || '(ì—†ìŒ)');

    if (savedPath) {
        // ì €ì¥ëœ ê²½ë¡œê°€ ìˆìœ¼ë©´ ê·¸ê²ƒìœ¼ë¡œ ë¶ˆëŸ¬ì˜¤ê¸°
        console.log('âœ… ì €ì¥ëœ ê²½ë¡œë¡œ ì˜ìƒ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°:', savedPath);
        loadVideoFiles(savedPath);
    } else {
        // ì €ì¥ëœ ê²½ë¡œê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ ê²½ë¡œë¡œ ìë™ ë¶ˆëŸ¬ì˜¤ê¸°
        const defaultPath = '/home/sk/ws/youtubeanalysis/youtube/download';
        console.log('âœ… ê¸°ë³¸ ê²½ë¡œë¡œ ì˜ìƒ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°:', defaultPath);

        if (videoPathInput) {
            videoPathInput.value = defaultPath;
        }

        // ìë§‰ ê²€ìƒ‰ ë””ë ‰í† ë¦¬ë„ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
        const searchDirInput = document.getElementById('search_directory');
        if (searchDirInput && !searchDirInput.value.trim()) {
            searchDirInput.value = defaultPath;
        }

        loadVideoFiles(defaultPath);
    }

    // í”„ë ˆì„ ë¶„ì„ í…œí”Œë¦¿ ë¶ˆëŸ¬ì˜¤ê¸°
    loadSavedTemplates();

    // í”„ë ˆì„ ë¶„ì„ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
    loadFrameAnalysisSettings();

    // í”„ë ˆì„ ë¶„ì„ ìœ í˜• ë³€ê²½ ì´ë²¤íŠ¸ (ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸ í‘œì‹œ/ìˆ¨ê¹€)
    const frameAnalysisType = document.getElementById('frame-analysis-type');
    if (frameAnalysisType) {
        frameAnalysisType.addEventListener('change', (e) => {
            const customPromptContainer = document.getElementById('custom-prompt-container');
            if (e.target.value === 'custom') {
                customPromptContainer.style.display = 'block';
            } else {
                customPromptContainer.style.display = 'none';
            }
            // ì„¤ì • ì €ì¥
            saveFrameAnalysisSettings();
        });
    }

    // AI ëª¨ë¸ ë³€ê²½ ì‹œ ì„¤ì • ì €ì¥
    const frameAiModelSelect = document.getElementById('frame-ai-model-select');
    if (frameAiModelSelect) {
        frameAiModelSelect.addEventListener('change', () => {
            saveFrameAnalysisSettings();
            updateFrameAnalysisCost();
        });
    }

    // ìë§‰ ì–¸ì–´ ë³€ê²½ ì‹œ ì„¤ì • ì €ì¥
    const subtitleLanguagePrimarySelect = document.getElementById('subtitle-language-primary');
    if (subtitleLanguagePrimarySelect) {
        subtitleLanguagePrimarySelect.addEventListener('change', () => {
            saveFrameAnalysisSettings();
        });
    }

    const subtitleLanguageSecondarySelect = document.getElementById('subtitle-language-secondary');
    if (subtitleLanguageSecondarySelect) {
        subtitleLanguageSecondarySelect.addEventListener('change', () => {
            saveFrameAnalysisSettings();
        });
    }

    // ì´ˆê¸° ë¹„ìš© ê³„ì‚°
    updateFrameAnalysisCost();
});

// ============================================
// ë¹ ë¥¸ ì ‘ê·¼ ìŠ¤í¬ë¡¤ í•¨ìˆ˜ë“¤
// ============================================

// AI í”„ë ˆì„ ë¶„ì„ ì„¹ì…˜ìœ¼ë¡œ ìŠ¤í¬ë¡¤
function scrollToFrameAnalysis() {
    const section = document.getElementById('frame-analysis-section');

    if (!section) {
        alert('âš ï¸ í”„ë ˆì„ ë¶„ì„ ì„¹ì…˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\në¨¼ì € ì˜ìƒì„ ì„ íƒí•˜ê³  í”„ë ˆì„ì„ ì¶”ì¶œí•´ì£¼ì„¸ìš”.');
        return;
    }

    // ì„¹ì…˜ì´ ìˆ¨ê²¨ì ¸ ìˆë‹¤ë©´ ë³´ì´ê²Œ í•¨
    const extractedGallery = document.getElementById('extracted-frames-gallery');
    if (extractedGallery && extractedGallery.style.display === 'none') {
        alert('âš ï¸ í”„ë ˆì„ ë¶„ì„ì„ í•˜ë ¤ë©´ ë¨¼ì € í”„ë ˆì„ì„ ì¶”ì¶œí•´ì£¼ì„¸ìš”.\n\nì˜ìƒ ë¯¸ë¦¬ë³´ê¸° ì„¹ì…˜ì—ì„œ "â±ï¸ ì¶”ì¶œ" ë˜ëŠ” "ğŸ“ ìë§‰ ê¸°ì¤€ í”„ë ˆì„ ì¶”ì¶œ" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.');
        return;
    }

    // ë¶€ë“œëŸ½ê²Œ ìŠ¤í¬ë¡¤
    section.scrollIntoView({ behavior: 'smooth', block: 'center' });

    // ì„¹ì…˜ ê°•ì¡° íš¨ê³¼
    section.style.boxShadow = '0 0 30px rgba(102, 126, 234, 0.8)';
    setTimeout(() => {
        section.style.boxShadow = '';
    }, 2000);
}

// AI ìë§‰ ë¶„ì„ ì„¹ì…˜ìœ¼ë¡œ ìŠ¤í¬ë¡¤
function scrollToSubtitleAnalysis() {
    const section = document.getElementById('subtitle-analysis-section');

    if (!section) {
        alert('âš ï¸ ìë§‰ ë¶„ì„ ì„¹ì…˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\në¨¼ì € ì˜ìƒì„ ì„ íƒí•˜ê³  "ìë§‰ ë¶ˆëŸ¬ì˜¤ê¸°" ë²„íŠ¼ì„ í´ë¦­í•´ì£¼ì„¸ìš”.');
        return;
    }

    // ë¶€ë“œëŸ½ê²Œ ìŠ¤í¬ë¡¤
    section.scrollIntoView({ behavior: 'smooth', block: 'center' });

    // ì„¹ì…˜ ê°•ì¡° íš¨ê³¼
    section.style.boxShadow = '0 0 30px rgba(102, 126, 234, 0.8)';
    setTimeout(() => {
        section.style.boxShadow = '';
    }, 2000);
}

// AI í”„ë ˆì„ ë¶„ì„ ë‚´ìš© ë¹„ìš°ê¸°
function clearFrameAnalysisContent() {
    const content = document.getElementById('frame-analysis-content');

    if (!content) {
        alert('í”„ë ˆì„ ë¶„ì„ ê²°ê³¼ ì˜ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    if (!content.value || content.value.trim() === '') {
        alert('ë¹„ìš¸ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    if (confirm('ğŸ—‘ï¸ AI í”„ë ˆì„ ë¶„ì„ ê²°ê³¼ë¥¼ ëª¨ë‘ ì§€ìš°ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
        content.value = '';
        alert('âœ… AI í”„ë ˆì„ ë¶„ì„ ê²°ê³¼ê°€ ë¹„ì›Œì¡ŒìŠµë‹ˆë‹¤.');
    }
}

// AI ìë§‰ ë¶„ì„ ë‚´ìš© ë¹„ìš°ê¸°
function clearSubtitleAnalysisContent() {
    const aiAnalysisResult = document.getElementById('ai-analysis-result');
    const defaultSubtitleView = document.getElementById('default-subtitle-view');

    if (!aiAnalysisResult) {
        alert('ìë§‰ ë¶„ì„ ê²°ê³¼ ì˜ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    // AI ë¶„ì„ ê²°ê³¼ê°€ í‘œì‹œë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
    if (aiAnalysisResult.style.display === 'none' || !aiAnalysisResult.style.display) {
        alert('ë¹„ìš¸ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    if (confirm('ğŸ—‘ï¸ AI ìë§‰ ë¶„ì„ ê²°ê³¼ë¥¼ ëª¨ë‘ ì§€ìš°ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
        // AI ë¶„ì„ ê²°ê³¼ ìˆ¨ê¸°ê¸°
        aiAnalysisResult.style.display = 'none';

        // ê¸°ë³¸ ìë§‰ ë·° ë³´ì´ê¸°
        if (defaultSubtitleView) {
            defaultSubtitleView.style.display = 'block';
        }

        // ì „ì—­ ë¶„ì„ ê²°ê³¼ ë³€ìˆ˜ ì´ˆê¸°í™”
        if (typeof currentAnalysisResult !== 'undefined') {
            currentAnalysisResult = null;
        }

        alert('âœ… AI ìë§‰ ë¶„ì„ ê²°ê³¼ê°€ ë¹„ì›Œì¡ŒìŠµë‹ˆë‹¤.');
    }
}

// ==================== í¼ì¹˜ê¸°/ì ‘ê¸° ê¸°ëŠ¥ ====================

// í”„ë ˆì„ ì¶”ì¶œ ë²„íŠ¼ í¼ì¹˜ê¸°/ì ‘ê¸°
function toggleFrameExtractionButtons() {
    const buttonsArea = document.getElementById('frame-extraction-buttons');
    const toggleIcon = document.getElementById('frame-extraction-toggle-icon');

    if (buttonsArea.style.display === 'none' || buttonsArea.style.display === '') {
        buttonsArea.style.display = 'flex';
        toggleIcon.textContent = 'â–²';
    } else {
        buttonsArea.style.display = 'none';
        toggleIcon.textContent = 'â–¼';
    }
}

// AI í”„ë ˆì„ ë¶„ì„ ì„¹ì…˜ í¼ì¹˜ê¸°/ì ‘ê¸°
function toggleFrameAnalysisSection() {
    const contentArea = document.getElementById('frame-analysis-content-area');
    const toggleIcon = document.getElementById('frame-analysis-toggle-icon');

    if (contentArea.style.display === 'none' || contentArea.style.display === '') {
        contentArea.style.display = 'block';
        toggleIcon.textContent = 'â–²';
    } else {
        contentArea.style.display = 'none';
        toggleIcon.textContent = 'â–¼';
    }
}

// AI ìë§‰ ë¶„ì„ ì„¹ì…˜ í¼ì¹˜ê¸°/ì ‘ê¸°
function toggleSubtitleAnalysisSection() {
    const contentArea = document.getElementById('subtitle-analysis-content-area');
    const toggleIcon = document.getElementById('subtitle-analysis-toggle-icon');

    if (contentArea.style.display === 'none' || contentArea.style.display === '') {
        contentArea.style.display = 'block';
        toggleIcon.textContent = 'â–²';
    } else {
        contentArea.style.display = 'none';
        toggleIcon.textContent = 'â–¼';
    }
}

// ==================== í…ìŠ¤íŠ¸ ì˜¤ë²„ë ˆì´ ê¸°ëŠ¥ ====================

// í…ìŠ¤íŠ¸ ì˜¤ë²„ë ˆì´ë¥¼ ë“œë˜ê·¸ ê°€ëŠ¥í•˜ê²Œ ë§Œë“œëŠ” í•¨ìˆ˜
function makeOverlayDraggable(overlayElement) {
    let isDragging = false;
    let currentX;
    let currentY;
    let initialX;
    let initialY;
    let xOffset = 0;
    let yOffset = 0;

    overlayElement.addEventListener('mousedown', dragStart);
    document.addEventListener('mousemove', drag);
    document.addEventListener('mouseup', dragEnd);

    function dragStart(e) {
        initialX = e.clientX - xOffset;
        initialY = e.clientY - yOffset;

        if (e.target === overlayElement) {
            isDragging = true;
        }
    }

    function drag(e) {
        if (isDragging) {
            e.preventDefault();

            currentX = e.clientX - initialX;
            currentY = e.clientY - initialY;

            xOffset = currentX;
            yOffset = currentY;

            setTranslate(currentX, currentY, overlayElement);
        }
    }

    function dragEnd(e) {
        initialX = currentX;
        initialY = currentY;
        isDragging = false;
    }

    function setTranslate(xPos, yPos, el) {
        el.style.transform = `translate(${xPos}px, ${yPos}px)`;
    }
}

// í…ìŠ¤íŠ¸ íš¨ê³¼ ì ìš© í•¨ìˆ˜
function applyTextEffect(element, staticEffect, dynamicEffect) {
    // ê¸°ì¡´ íš¨ê³¼ í´ë˜ìŠ¤ ì œê±°
    element.classList.remove('effect-outline', 'effect-shadow', 'effect-glow',
                           'effect-gradient', 'effect-neon',
                           'effect-fade', 'effect-slide-up', 'effect-slide-down',
                           'effect-bounce', 'effect-pulse');

    // ì •ì  íš¨ê³¼ ì ìš©
    if (staticEffect && staticEffect !== 'none') {
        element.classList.add(`effect-${staticEffect}`);
    }

    // ë™ì  íš¨ê³¼ ì ìš©
    if (dynamicEffect && dynamicEffect !== 'none') {
        element.classList.add(`effect-${dynamicEffect}`);
    }
}

// í…ìŠ¤íŠ¸ ì˜¤ë²„ë ˆì´ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
function updateTextOverlays() {
    const titleOverlay = document.getElementById('video-title-overlay');
    const subtitleOverlay = document.getElementById('video-subtitle-overlay');

    // ì œëª©
    const titleInput = document.getElementById('overlay-title-input');
    const titleSize = document.getElementById('overlay-title-size');
    const titleColor = document.getElementById('overlay-title-color');
    const titleStaticEffect = document.getElementById('overlay-title-static-effect');
    const titleDynamicEffect = document.getElementById('overlay-title-dynamic-effect');

    // ì œëª© ìˆ¨ê¹€ ì²´í¬ë°•ìŠ¤ ìƒíƒœ í™•ì¸
    const hideTitleCheckbox = document.getElementById('hide-title-overlay');
    const isTitleHidden = hideTitleCheckbox && hideTitleCheckbox.checked;

    if (titleInput && titleInput.value.trim()) {
        titleOverlay.textContent = titleInput.value;
        titleOverlay.style.display = isTitleHidden ? 'none' : 'block';
        titleOverlay.style.opacity = '1';
        titleOverlay.classList.remove('empty');
        titleOverlay.style.fontSize = titleSize.value + 'px';
        titleOverlay.style.color = titleColor.value;
        applyTextEffect(titleOverlay, titleStaticEffect.value, titleDynamicEffect.value);
    } else {
        titleOverlay.textContent = 'ì˜ìƒ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”';
        titleOverlay.style.display = isTitleHidden ? 'none' : 'block';
        titleOverlay.style.opacity = '0.5';
        titleOverlay.style.fontSize = '48px';
        titleOverlay.style.color = 'white';
    }

    // ë¶€ì œëª©
    const subtitleInput = document.getElementById('overlay-subtitle-input');
    const subtitleSize = document.getElementById('overlay-subtitle-size');
    const subtitleColor = document.getElementById('overlay-subtitle-color');
    const subtitleStaticEffect = document.getElementById('overlay-subtitle-static-effect');
    const subtitleDynamicEffect = document.getElementById('overlay-subtitle-dynamic-effect');

    // ë¶€ì œëª© ìˆ¨ê¹€ ì²´í¬ë°•ìŠ¤ ìƒíƒœ í™•ì¸
    const hideSubtitleCheckbox = document.getElementById('hide-subtitle-overlay');
    const isSubtitleHidden = hideSubtitleCheckbox && hideSubtitleCheckbox.checked;

    if (subtitleInput && subtitleInput.value.trim()) {
        subtitleOverlay.textContent = subtitleInput.value;
        subtitleOverlay.style.display = isSubtitleHidden ? 'none' : 'block';
        subtitleOverlay.style.opacity = '1';
        subtitleOverlay.classList.remove('empty');
        subtitleOverlay.style.fontSize = subtitleSize.value + 'px';
        subtitleOverlay.style.color = subtitleColor.value;
        applyTextEffect(subtitleOverlay, subtitleStaticEffect.value, subtitleDynamicEffect.value);
    } else {
        subtitleOverlay.textContent = 'ë¶€ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”';
        subtitleOverlay.style.display = isSubtitleHidden ? 'none' : 'block';
        subtitleOverlay.style.opacity = '0.5';
        subtitleOverlay.style.fontSize = '32px';
        subtitleOverlay.style.color = '#ffe14d';
    }

    // ì£¼ìë§‰ (Korean) ì—…ë°ì´íŠ¸
    const koreanInput = document.getElementById('overlay-korean-input');
    const koreanSize = document.getElementById('overlay-korean-size');
    const koreanColor = document.getElementById('overlay-korean-color');
    const koreanX = document.getElementById('overlay-korean-x');
    const koreanY = document.getElementById('overlay-korean-y');
    const koreanEffect = document.getElementById('overlay-korean-effect');

    if (koreanInput && koreanSize && koreanColor && koreanX && koreanY && koreanEffect) {
        // updateSubtitleOverlay í•¨ìˆ˜ í˜¸ì¶œí•˜ì—¬ ì£¼ìë§‰ ì—…ë°ì´íŠ¸
        if (typeof updateSubtitleOverlay === 'function') {
            updateSubtitleOverlay(
                koreanInput.value,
                koreanSize.value,
                koreanColor.value,
                koreanX.value,
                koreanY.value,
                koreanEffect.value
            );
        }
    }

    // ë³´ì¡°ìë§‰ (English) ì—…ë°ì´íŠ¸
    const englishInput = document.getElementById('overlay-english-input');
    const englishSize = document.getElementById('overlay-english-size');
    const englishColor = document.getElementById('overlay-english-color');
    const englishX = document.getElementById('overlay-english-x');
    const englishY = document.getElementById('overlay-english-y');
    const englishEffect = document.getElementById('overlay-english-effect');

    if (englishInput && englishSize && englishColor && englishX && englishY && englishEffect) {
        // updateSecondarySubtitleOverlay í•¨ìˆ˜ í˜¸ì¶œí•˜ì—¬ ë³´ì¡°ìë§‰ ì—…ë°ì´íŠ¸
        if (typeof updateSecondarySubtitleOverlay === 'function') {
            updateSecondarySubtitleOverlay(
                englishInput.value,
                englishSize.value,
                englishColor.value,
                englishX.value,
                englishY.value,
                englishEffect.value
            );
        }
    }

    // Canvas í…ìŠ¤íŠ¸ ì˜¤ë²„ë ˆì´ ë™ê¸°í™”
    updateCanvasText();
}

// í…ìŠ¤íŠ¸ ì˜¤ë²„ë ˆì´ ì„¤ì • ì €ì¥
function saveTextOverlaySettings() {
    const settings = {
        title: {
            text: document.getElementById('overlay-title-input').value,
            size: document.getElementById('overlay-title-size').value,
            color: document.getElementById('overlay-title-color').value,
            staticEffect: document.getElementById('overlay-title-static-effect').value,
            dynamicEffect: document.getElementById('overlay-title-dynamic-effect').value,
            position: document.getElementById('video-title-overlay').style.transform
        },
        subtitle: {
            text: document.getElementById('overlay-subtitle-input').value,
            size: document.getElementById('overlay-subtitle-size').value,
            color: document.getElementById('overlay-subtitle-color').value,
            staticEffect: document.getElementById('overlay-subtitle-static-effect').value,
            dynamicEffect: document.getElementById('overlay-subtitle-dynamic-effect').value,
            position: document.getElementById('video-subtitle-overlay').style.transform
        }
    };

    try {
        localStorage.setItem('videoAnalyzerTextOverlay', JSON.stringify(settings));
        alert('âœ… í…ìŠ¤íŠ¸ ì˜¤ë²„ë ˆì´ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
        console.log('ğŸ’¾ ì„¤ì • ì €ì¥ë¨:', settings);
    } catch (e) {
        console.error('âŒ ì„¤ì • ì €ì¥ ì‹¤íŒ¨:', e);
        alert('âŒ ì„¤ì • ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
}

// í…ìŠ¤íŠ¸ ì˜¤ë²„ë ˆì´ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
function loadTextOverlaySettings() {
    try {
        const saved = localStorage.getItem('videoAnalyzerTextOverlay');
        if (!saved) {
            alert('âš ï¸ ì €ì¥ëœ ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        const settings = JSON.parse(saved);

        // ì œëª© ì„¤ì • ë³µì›
        if (settings.title) {
            document.getElementById('overlay-title-input').value = settings.title.text || '';
            document.getElementById('overlay-title-size').value = settings.title.size || '48';
            document.getElementById('overlay-title-color').value = settings.title.color || '#ffffff';
            document.getElementById('overlay-title-static-effect').value = settings.title.staticEffect || 'none';
            document.getElementById('overlay-title-dynamic-effect').value = settings.title.dynamicEffect || 'none';

            // í¬ê¸° í‘œì‹œ ì—…ë°ì´íŠ¸
            document.getElementById('title-size-display').textContent = settings.title.size + 'px';

            // ìœ„ì¹˜ ë³µì›
            if (settings.title.position) {
                document.getElementById('video-title-overlay').style.transform = settings.title.position;
            }
        }

        // ë¶€ì œëª© ì„¤ì • ë³µì›
        if (settings.subtitle) {
            document.getElementById('overlay-subtitle-input').value = settings.subtitle.text || '';
            document.getElementById('overlay-subtitle-size').value = settings.subtitle.size || '32';
            document.getElementById('overlay-subtitle-color').value = settings.subtitle.color || '#ffe14d';
            document.getElementById('overlay-subtitle-static-effect').value = settings.subtitle.staticEffect || 'none';
            document.getElementById('overlay-subtitle-dynamic-effect').value = settings.subtitle.dynamicEffect || 'none';

            // í¬ê¸° í‘œì‹œ ì—…ë°ì´íŠ¸
            document.getElementById('subtitle-size-display').textContent = settings.subtitle.size + 'px';

            // ìœ„ì¹˜ ë³µì›
            if (settings.subtitle.position) {
                document.getElementById('video-subtitle-overlay').style.transform = settings.subtitle.position;
            }
        }

        // í•œê¸€ ìë§‰ ì„¤ì • ë³µì›
        if (settings.korean) {
            document.getElementById('overlay-korean-input').value = settings.korean.text || '';
            document.getElementById('overlay-korean-size').value = settings.korean.size || '32';
            document.getElementById('overlay-korean-color').value = settings.korean.color || '#000000';
            document.getElementById('overlay-korean-x').value = settings.korean.x || '50';
            document.getElementById('overlay-korean-y').value = settings.korean.y || '65';
            // í•˜ìœ„ í˜¸í™˜ì„±: ê¸°ì¡´ effect ê°’ì´ ìˆìœ¼ë©´ staticEffectë¡œ ì‚¬ìš©
            if (settings.korean.staticEffect !== undefined) {
                document.getElementById('overlay-korean-static-effect').value = settings.korean.staticEffect || 'outline';
            } else if (settings.korean.effect) {
                document.getElementById('overlay-korean-static-effect').value = settings.korean.effect || 'outline';
            }
            if (settings.korean.dynamicEffect !== undefined) {
                document.getElementById('overlay-korean-dynamic-effect').value = settings.korean.dynamicEffect || 'none';
            }

            // í¬ê¸° í‘œì‹œ ì—…ë°ì´íŠ¸
            document.getElementById('korean-size-display').textContent = settings.korean.size + 'px';
        }

        // ì¼ë³¸ì–´ ìë§‰ ì„¤ì • ë³µì›
        if (settings.japanese) {
            document.getElementById('overlay-japanese-input').value = settings.japanese.text || '';
            document.getElementById('overlay-japanese-size').value = settings.japanese.size || '30';
            document.getElementById('overlay-japanese-color').value = settings.japanese.color || '#000000';
            document.getElementById('overlay-japanese-x').value = settings.japanese.x || '50';
            document.getElementById('overlay-japanese-y').value = settings.japanese.y || '83';
            // í•˜ìœ„ í˜¸í™˜ì„±: ê¸°ì¡´ effect ê°’ì´ ìˆìœ¼ë©´ staticEffectë¡œ ì‚¬ìš©
            if (settings.japanese.staticEffect !== undefined) {
                document.getElementById('overlay-japanese-static-effect').value = settings.japanese.staticEffect || 'outline';
            } else if (settings.japanese.effect) {
                document.getElementById('overlay-japanese-static-effect').value = settings.japanese.effect || 'outline';
            }
            if (settings.japanese.dynamicEffect !== undefined) {
                document.getElementById('overlay-japanese-dynamic-effect').value = settings.japanese.dynamicEffect || 'none';
            }

            // í¬ê¸° í‘œì‹œ ì—…ë°ì´íŠ¸
            document.getElementById('japanese-size-display').textContent = settings.japanese.size + 'px';
        }

        // ì˜ì–´ ìë§‰ ì„¤ì • ë³µì›
        if (settings.english) {
            document.getElementById('overlay-english-input').value = settings.english.text || '';
            document.getElementById('overlay-english-size').value = settings.english.size || '28';
            document.getElementById('overlay-english-color').value = settings.english.color || '#000000';
            document.getElementById('overlay-english-x').value = settings.english.x || '50';
            document.getElementById('overlay-english-y').value = settings.english.y || '90';
            // í•˜ìœ„ í˜¸í™˜ì„±: ê¸°ì¡´ effect ê°’ì´ ìˆìœ¼ë©´ staticEffectë¡œ ì‚¬ìš©
            if (settings.english.staticEffect !== undefined) {
                document.getElementById('overlay-english-static-effect').value = settings.english.staticEffect || 'outline';
            } else if (settings.english.effect) {
                document.getElementById('overlay-english-static-effect').value = settings.english.effect || 'outline';
            }
            if (settings.english.dynamicEffect !== undefined) {
                document.getElementById('overlay-english-dynamic-effect').value = settings.english.dynamicEffect || 'none';
            }

            // í¬ê¸° í‘œì‹œ ì—…ë°ì´íŠ¸
            document.getElementById('english-size-display').textContent = settings.english.size + 'px';
        }

        // ê²€ì • ë°°ê²½ ì„¤ì • ë³µì›
        if (settings.blackBars) {
            // ìƒë‹¨ ë°°ê²½
            if (settings.blackBars.top) {
                document.getElementById('top-bar-enable').checked = settings.blackBars.top.enabled || false;
                document.getElementById('top-bar-height').value = settings.blackBars.top.height || '15';
                document.getElementById('top-bar-opacity').value = settings.blackBars.top.opacity || '80';

                if (settings.blackBars.top.enabled) {
                    toggleBlackBar('top');
                }
            }

            // í•˜ë‹¨ ë°°ê²½
            if (settings.blackBars.bottom) {
                document.getElementById('bottom-bar-enable').checked = settings.blackBars.bottom.enabled || false;
                document.getElementById('bottom-bar-height').value = settings.blackBars.bottom.height || '15';
                document.getElementById('bottom-bar-opacity').value = settings.blackBars.bottom.opacity || '80';

                if (settings.blackBars.bottom.enabled) {
                    toggleBlackBar('bottom');
                }
            }
        }

        // ì˜¤ë²„ë ˆì´ ì—…ë°ì´íŠ¸
        updateTextOverlays();

        alert('âœ… í…ìŠ¤íŠ¸ ì˜¤ë²„ë ˆì´ ë° ê²€ì • ë°°ê²½ ì„¤ì •ì´ ë¶ˆëŸ¬ì™€ì¡ŒìŠµë‹ˆë‹¤!');
        console.log('ğŸ“‚ ì„¤ì • ë¶ˆëŸ¬ì˜´:', settings);
    } catch (e) {
        console.error('âŒ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', e);
        alert('âŒ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
}

// í…ìŠ¤íŠ¸ ì˜¤ë²„ë ˆì´ ì§€ìš°ê¸°
function clearTextOverlay() {
    if (confirm('ğŸ—‘ï¸ ëª¨ë“  í…ìŠ¤íŠ¸ ì˜¤ë²„ë ˆì´ë¥¼ ì§€ìš°ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
        document.getElementById('overlay-title-input').value = '';
        document.getElementById('overlay-subtitle-input').value = '';
        document.getElementById('overlay-korean-input').value = '';
        document.getElementById('overlay-japanese-input').value = '';
        document.getElementById('overlay-english-input').value = '';
        document.getElementById('overlay-source-input').value = '';

        // ì˜¤ë²„ë ˆì´ë¥¼ ì˜ˆì‹œ í…ìŠ¤íŠ¸ë¡œ ë³µì›
        const titleOverlay = document.getElementById('video-title-overlay');
        titleOverlay.textContent = 'ì˜ìƒ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”';
        titleOverlay.style.display = 'block';
        titleOverlay.style.opacity = '0.5';

        const subtitleOverlay = document.getElementById('video-subtitle-overlay');
        subtitleOverlay.textContent = 'ë¶€ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”';
        subtitleOverlay.style.display = 'block';
        subtitleOverlay.style.opacity = '0.5';

        const koreanOverlay = document.getElementById('korean-subtitle-overlay');
        koreanOverlay.textContent = '';
        koreanOverlay.style.display = 'none';

        const japaneseOverlay = document.getElementById('japanese-subtitle-overlay');
        japaneseOverlay.textContent = '';
        japaneseOverlay.style.display = 'none';

        const englishOverlay = document.getElementById('english-subtitle-overlay');
        englishOverlay.textContent = '';
        englishOverlay.style.display = 'none';

        const sourceOverlay = document.getElementById('source-overlay');
        sourceOverlay.textContent = '';
        sourceOverlay.style.display = 'none';

        console.log('ğŸ—‘ï¸ í…ìŠ¤íŠ¸ ì˜¤ë²„ë ˆì´ ì§€ì›€');
    }
}

// ========================================
// ê²€ì • ë°°ê²½ ê¸°ëŠ¥
// ========================================

// ê²€ì • ë°°ê²½ í† ê¸€
function toggleBlackBar(position) {
    const bar = document.getElementById(`${position}-black-bar`);
    const checkbox = document.getElementById(`${position}-bar-enable`);

    if (checkbox.checked) {
        bar.style.display = 'block';
        updateBlackBar(position);
        console.log(`âœ… ${position === 'top' ? 'ìƒë‹¨' : 'í•˜ë‹¨'} ê²€ì • ë°°ê²½ í™œì„±í™”`);
    } else {
        bar.style.display = 'none';
        console.log(`âŒ ${position === 'top' ? 'ìƒë‹¨' : 'í•˜ë‹¨'} ê²€ì • ë°°ê²½ ë¹„í™œì„±í™”`);
    }

    // Canvas ì—…ë°ì´íŠ¸
    updateCanvasBlackBars();
}

// ê²€ì • ë°°ê²½ ì—…ë°ì´íŠ¸
function updateBlackBar(position) {
    const bar = document.getElementById(`${position}-black-bar`);
    const height = document.getElementById(`${position}-bar-height`).value;
    const opacity = document.getElementById(`${position}-bar-opacity`).value;

    // ë†’ì´ ì—…ë°ì´íŠ¸
    bar.style.height = height + '%';
    document.getElementById(`${position}-bar-height-display`).textContent = height + '%';

    // íˆ¬ëª…ë„ ì—…ë°ì´íŠ¸
    const opacityValue = opacity / 100;
    bar.style.background = `rgba(0, 0, 0, ${opacityValue})`;
    document.getElementById(`${position}-bar-opacity-display`).textContent = opacity + '%';

    // Canvas ì—…ë°ì´íŠ¸
    updateCanvasBlackBars();
}

// ========================================
// í•œê¸€/ì˜ì–´ ìë§‰ ê¸°ëŠ¥
// ========================================

// í•œê¸€ ìë§‰ ì ìš©
function applyKoreanSubtitle() {
    const overlay = document.getElementById('korean-subtitle-overlay');
    const text = document.getElementById('overlay-korean-input').value.trim();
    const size = document.getElementById('overlay-korean-size').value;
    const color = document.getElementById('overlay-korean-color').value;
    const x = document.getElementById('overlay-korean-x').value;
    const y = document.getElementById('overlay-korean-y').value;
    const staticEffect = document.getElementById('overlay-korean-static-effect').value;
    const dynamicEffect = document.getElementById('overlay-korean-dynamic-effect').value;

    if (!text) {
        overlay.textContent = '';
        overlay.style.display = 'none';
        overlay.classList.add('empty');
        return;
    }

    overlay.textContent = text;
    overlay.style.display = 'block';
    overlay.style.opacity = '1';
    overlay.classList.remove('empty');
    overlay.style.fontSize = size + 'px';
    overlay.style.color = color;
    overlay.style.left = x + '%';
    overlay.style.top = y + '%';

    // ğŸŒ ì–¸ì–´ ìë™ ê°ì§€ ë° ìµœì  í°íŠ¸ ì ìš©
    const detectedLang = detectLanguage(text);
    const optimalFont = getFontFamilyForLanguage(detectedLang);
    overlay.style.fontFamily = optimalFont;

    // íš¨ê³¼ ì œê±° í›„ ì¬ì ìš©
    overlay.className = 'custom-subtitle-overlay';
    overlay.setAttribute('data-lang', detectedLang);
    overlay.setAttribute('lang', detectedLang);

    // ì •ì  íš¨ê³¼ ì ìš©
    if (staticEffect && staticEffect !== 'none') {
        overlay.classList.add(`effect-${staticEffect}`);
    }

    // ë™ì  íš¨ê³¼ ì ìš©
    if (dynamicEffect && dynamicEffect !== 'none') {
        overlay.classList.add(`effect-${dynamicEffect}`);
    }

    // Canvasì—ë„ ë™ê¸°í™”
    if (typeof updateCanvasText === 'function') {
        updateCanvasText();
    }

    console.log(`âœ… ì£¼ ìë§‰ ì ìš©: ${text} (ì–¸ì–´: ${detectedLang})`);
}

// ì¼ë³¸ì–´ ìë§‰ ì ìš© (ë©”ì¸ ìë§‰)
function applyJapaneseSubtitle() {
    const overlay = document.getElementById('japanese-subtitle-overlay');
    const text = document.getElementById('overlay-japanese-input').value.trim();
    const size = document.getElementById('overlay-japanese-size').value;
    const color = document.getElementById('overlay-japanese-color').value;
    const x = document.getElementById('overlay-japanese-x').value;
    const y = document.getElementById('overlay-japanese-y').value;
    const staticEffect = document.getElementById('overlay-japanese-static-effect').value;
    const dynamicEffect = document.getElementById('overlay-japanese-dynamic-effect').value;

    if (!text) {
        overlay.textContent = '';
        overlay.style.display = 'none';
        overlay.classList.add('empty');
        return;
    }

    overlay.textContent = text;
    overlay.style.display = 'block';
    overlay.style.opacity = '1';
    overlay.classList.remove('empty');
    overlay.style.fontSize = size + 'px';
    overlay.style.color = color;
    overlay.style.left = x + '%';
    overlay.style.top = y + '%';

    // ì¼ë³¸ì–´ í°íŠ¸ ìµœì í™” (ì´ëª¨ì§€ í°íŠ¸ í¬í•¨)
    const optimalFont = getFontFamilyForLanguage('ja');
    overlay.style.fontFamily = optimalFont;

    // íš¨ê³¼ ì œê±° í›„ ì¬ì ìš©
    overlay.className = 'custom-subtitle-overlay';
    overlay.setAttribute('data-lang', 'japanese');
    overlay.setAttribute('lang', 'ja');

    // ì •ì  íš¨ê³¼ ì ìš©
    if (staticEffect && staticEffect !== 'none') {
        overlay.classList.add(`effect-${staticEffect}`);
    }

    // ë™ì  íš¨ê³¼ ì ìš©
    if (dynamicEffect && dynamicEffect !== 'none') {
        overlay.classList.add(`effect-${dynamicEffect}`);
    }

    console.log(`âœ… ë©”ì¸ ìë§‰ (ì¼ë³¸ì–´) ì ìš©: ${text}`);
}

// ì˜ì–´ ìë§‰ ì ìš©
function applyEnglishSubtitle() {
    const overlay = document.getElementById('english-subtitle-overlay');
    const text = document.getElementById('overlay-english-input').value.trim();
    const size = document.getElementById('overlay-english-size').value;
    const color = document.getElementById('overlay-english-color').value;
    const x = document.getElementById('overlay-english-x').value;
    const y = document.getElementById('overlay-english-y').value;
    const staticEffect = document.getElementById('overlay-english-static-effect').value;
    const dynamicEffect = document.getElementById('overlay-english-dynamic-effect').value;

    if (!text) {
        overlay.textContent = '';
        overlay.style.display = 'none';
        overlay.classList.add('empty');
        return;
    }

    overlay.textContent = text;
    overlay.style.display = 'block';
    overlay.style.opacity = '1';
    overlay.classList.remove('empty');
    overlay.style.fontSize = size + 'px';
    overlay.style.color = color;
    overlay.style.left = x + '%';
    overlay.style.top = y + '%';

    // ğŸŒ ì–¸ì–´ ìë™ ê°ì§€ ë° ìµœì  í°íŠ¸ ì ìš©
    const detectedLang = detectLanguage(text);
    const optimalFont = getFontFamilyForLanguage(detectedLang);
    overlay.style.fontFamily = optimalFont;

    // íš¨ê³¼ ì œê±° í›„ ì¬ì ìš©
    overlay.className = 'custom-subtitle-overlay';
    overlay.setAttribute('data-lang', detectedLang);
    overlay.setAttribute('lang', detectedLang);

    // ì •ì  íš¨ê³¼ ì ìš©
    if (staticEffect && staticEffect !== 'none') {
        overlay.classList.add(`effect-${staticEffect}`);
    }

    // ë™ì  íš¨ê³¼ ì ìš©
    if (dynamicEffect && dynamicEffect !== 'none') {
        overlay.classList.add(`effect-${dynamicEffect}`);
    }

    // Canvasì—ë„ ë™ê¸°í™”
    if (typeof updateCanvasText === 'function') {
        updateCanvasText();
    }

    console.log(`âœ… ë³´ì¡° ìë§‰ ì ìš©: ${text} (ì–¸ì–´: ${detectedLang})`);
}

// ì œëª© ì ìš©
// AI ì œëª© & ë¶€ì œëª© ìƒì„±
async function generateAITitleSubtitle() {
    const statusDiv = document.getElementById('ai-generation-status');
    const statusText = document.getElementById('ai-status-text');
    const statusTimer = document.getElementById('ai-status-timer');
    const titleInput = document.getElementById('overlay-title-input');
    const subtitleInput = document.getElementById('overlay-subtitle-input');

    // íƒ€ì´ë¨¸ ê´€ë ¨ ë³€ìˆ˜
    let startTime = Date.now();
    let timerInterval = null;

    try {
        // ìƒíƒœ í‘œì‹œ
        if (statusDiv) {
            statusDiv.style.display = 'block';
        }
        if (statusText) {
            statusText.textContent = 'â³ AIê°€ ì œëª©ê³¼ ë¶€ì œëª©ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...';
        }

        // ê²½ê³¼ ì‹œê°„ í‘œì‹œ íƒ€ì´ë¨¸ ì‹œì‘
        timerInterval = setInterval(() => {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            if (statusTimer) {
                statusTimer.textContent = `ê²½ê³¼ ì‹œê°„: ${elapsed}ì´ˆ`;
            }
        }, 100);

        // í˜„ì¬ ì˜ìƒ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const savedVideoInfo = localStorage.getItem(VIDEO_INFO_STORAGE_KEY);
        if (!savedVideoInfo) {
            throw new Error('ì˜ìƒ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì˜ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        }

        const videoInfo = JSON.parse(savedVideoInfo);
        const videoPath = videoInfo.path || videoInfo.file_path;

        if (!videoPath) {
            throw new Error('ì˜ìƒ ê²½ë¡œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }

        // ì„ íƒëœ AI ëª¨ë¸ ê°€ì ¸ì˜¤ê¸°
        const selectedModel = document.getElementById('ai-model-select')?.value || 'claude';

        // íƒ€ì„ì•„ì›ƒ ì„¤ì • (30ì´ˆ)
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000);

        // AI ì œëª©/ë¶€ì œëª© ìƒì„± API í˜¸ì¶œ
        const response = await fetch('/api/video-analyzer/generate-title-subtitle', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                video_path: videoPath,
                video_info: videoInfo,
                model: selectedModel
            }),
            signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.detail || 'AI ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }

        const data = await response.json();

        // íƒ€ì´ë¨¸ ì¤‘ì§€
        if (timerInterval) {
            clearInterval(timerInterval);
        }

        // ì´ ì†Œìš” ì‹œê°„ ê³„ì‚°
        const totalTime = ((Date.now() - startTime) / 1000).toFixed(1);

        // ìƒì„±ëœ ì œëª©ê³¼ ë¶€ì œëª©ì„ ì…ë ¥ í•„ë“œì— ì„¤ì •
        if (titleInput && data.title) {
            titleInput.value = data.title;
            // ì œëª© ìë™ ì ìš©
            try {
                applyTitle();
                console.log('âœ… ì œëª© ìë™ ì ìš© ì™„ë£Œ');
            } catch (e) {
                console.warn('âš ï¸ ì œëª© ìë™ ì ìš© ì‹¤íŒ¨:', e);
            }
        }

        if (subtitleInput && data.subtitle) {
            subtitleInput.value = data.subtitle;
            // ë¶€ì œëª© ìë™ ì ìš©
            try {
                applySubtitle();
                console.log('âœ… ë¶€ì œëª© ìë™ ì ìš© ì™„ë£Œ');
            } catch (e) {
                console.warn('âš ï¸ ë¶€ì œëª© ìë™ ì ìš© ì‹¤íŒ¨:', e);
            }
        }

        // ì„±ê³µ ë©”ì‹œì§€
        if (statusText) {
            statusText.innerHTML = 'âœ… AI ì œëª©ê³¼ ë¶€ì œëª©ì´ ìƒì„±ë˜ì–´ ì…ë ¥ í•„ë“œì— ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤!';
        }
        if (statusTimer) {
            statusTimer.innerHTML = `ì™„ë£Œ ì‹œê°„: ${totalTime}ì´ˆ | ëª¨ë¸: ${data.model || selectedModel}<br><small style="color: #94a3b8;">ğŸ’¡ ì•„ë˜ "âœ… ì œëª© ì ìš©" / "âœ… ë¶€ì œëª© ì ìš©" ë²„íŠ¼ì„ ëˆŒëŸ¬ ì˜ìƒì— ì ìš©í•˜ì„¸ìš”.</small>`;
        }
        if (statusDiv) {
            statusDiv.style.color = '#4ade80';
            setTimeout(() => {
                statusDiv.style.display = 'none';
                statusDiv.style.color = '#94a3b8';
            }, 5000);
        }

        console.log(`âœ… AI ì œëª©/ë¶€ì œëª© ìƒì„± ì™„ë£Œ (${totalTime}ì´ˆ):`, { title: data.title, subtitle: data.subtitle, model: data.model });

    } catch (error) {
        console.error('âŒ AI ì œëª©/ë¶€ì œëª© ìƒì„± ì‹¤íŒ¨:', error);

        // íƒ€ì´ë¨¸ ì¤‘ì§€
        if (timerInterval) {
            clearInterval(timerInterval);
        }

        // ì—ëŸ¬ ë©”ì‹œì§€ ì²˜ë¦¬
        let errorMessage = error.message;
        if (error.name === 'AbortError') {
            errorMessage = 'ìš”ì²­ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤ (30ì´ˆ). ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
        }

        if (statusText) {
            statusText.innerHTML = `âŒ ${errorMessage}`;
        }
        if (statusTimer) {
            statusTimer.textContent = '';
        }
        if (statusDiv) {
            statusDiv.style.color = '#f87171';
            setTimeout(() => {
                statusDiv.style.display = 'none';
                statusDiv.style.color = '#94a3b8';
            }, 8000);
        }

        alert(`AI ì œëª©/ë¶€ì œëª© ìƒì„± ì‹¤íŒ¨: ${errorMessage}`);
    }
}

/**
 * í…ìŠ¤íŠ¸ ì–¸ì–´ ìë™ ê°ì§€ (í•œêµ­ì–´/ì¼ë³¸ì–´/ì˜ì–´)
 */
function detectLanguage(text) {
    if (!text) return 'ko'; // ê¸°ë³¸ê°’: í•œêµ­ì–´

    // ì¼ë³¸ì–´ ê°ì§€: íˆë¼ê°€ë‚˜, ê°€íƒ€ì¹´ë‚˜
    const hasHiragana = /[\u3040-\u309F]/.test(text);
    const hasKatakana = /[\u30A0-\u30FF]/.test(text);
    if (hasHiragana || hasKatakana) {
        return 'ja';
    }

    // í•œêµ­ì–´ ê°ì§€: í•œê¸€
    const hasHangul = /[\uAC00-\uD7AF\u1100-\u11FF]/.test(text);
    if (hasHangul) {
        return 'ko';
    }

    // í•œì(CJK Unified Ideographs) - í•œì¤‘ì¼ ê³µí†µ
    const hasCJK = /[\u4E00-\u9FFF]/.test(text);
    if (hasCJK) {
        // í•œìë§Œ ìˆëŠ” ê²½ìš°, ì „ì²´ í…ìŠ¤íŠ¸ ë¶„ì„ìœ¼ë¡œ ì¶”ê°€ íŒë‹¨
        // ì¼ë³¸ì–´ëŠ” í•œì+íˆë¼ê°€ë‚˜ í˜¼ìš©ì´ ì¼ë°˜ì ì´ë¯€ë¡œ í•œêµ­ì–´ë¡œ ê°„ì£¼
        return 'ko';
    }

    // ê·¸ ì™¸ëŠ” ì˜ì–´
    return 'en';
}

/**
 * ì–¸ì–´ì— ë§ëŠ” ìµœì ì˜ font-family ë°˜í™˜
 */
function getFontFamilyForLanguage(lang) {
    const fontStacks = {
        // ì¼ë³¸ì–´: ì‹œìŠ¤í…œ í°íŠ¸ ìš°ì„  + Google Fonts fallback + ì´ëª¨ì§€ í°íŠ¸
        'ja': "'ãƒ’ãƒ©ã‚®ãƒè§’ã‚´ ProN', 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', 'Yu Gothic', 'ãƒ¡ã‚¤ãƒªã‚ª', Meiryo, 'MS PGothic', 'Noto Sans JP', 'Noto Sans CJK JP', 'Apple Color Emoji', 'Segoe UI Emoji', 'Noto Color Emoji', 'Segoe UI Symbol', sans-serif",

        // í•œêµ­ì–´: ì‹œìŠ¤í…œ í°íŠ¸ ìš°ì„  + Google Fonts fallback + ì´ëª¨ì§€ í°íŠ¸
        'ko': "'ë§‘ì€ ê³ ë”•', 'Malgun Gothic', 'Apple SD Gothic Neo', 'Noto Sans KR', 'Noto Sans CJK KR', 'Apple Color Emoji', 'Segoe UI Emoji', 'Noto Color Emoji', 'Segoe UI Symbol', sans-serif",

        // ì˜ì–´: ì‹œìŠ¤í…œ í°íŠ¸ + ì´ëª¨ì§€ í°íŠ¸
        'en': "-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Apple Color Emoji', 'Segoe UI Emoji', 'Noto Color Emoji', 'Segoe UI Symbol', sans-serif"
    };

    return fontStacks[lang] || fontStacks['ko'];
}

function applyTitle() {
    const titleOverlay = document.getElementById('video-title-overlay') || document.querySelector('.video-title-overlay');
    const text = document.getElementById('overlay-title-input').value.trim();
    const size = document.getElementById('overlay-title-size').value;
    const color = document.getElementById('overlay-title-color').value;
    const staticEffect = document.getElementById('overlay-title-static-effect')?.value || 'none';
    const dynamicEffect = document.getElementById('overlay-title-dynamic-effect')?.value || 'none';

    if (!titleOverlay) {
        console.error('âŒ ì œëª© ì˜¤ë²„ë ˆì´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        alert('âš ï¸ ì˜ìƒì„ ë¨¼ì € ë¶ˆëŸ¬ì™€ì£¼ì„¸ìš”.');
        return;
    }

    if (!text) {
        titleOverlay.textContent = 'ì˜ìƒ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”';
        titleOverlay.style.opacity = '0.5';
    } else {
        titleOverlay.textContent = text;
        titleOverlay.style.fontSize = `${size}px`;
        titleOverlay.style.color = color;
        titleOverlay.style.opacity = '1';
        titleOverlay.style.display = 'block';

        // ğŸŒ ì–¸ì–´ ìë™ ê°ì§€ ë° ìµœì  í°íŠ¸ ì ìš©
        const detectedLang = detectLanguage(text);
        const optimalFont = getFontFamilyForLanguage(detectedLang);
        titleOverlay.style.fontFamily = optimalFont;
        titleOverlay.setAttribute('lang', detectedLang);
        console.log(`ğŸŒ ì œëª© ì–¸ì–´ ê°ì§€: ${detectedLang}, í°íŠ¸: ${optimalFont}`);

        // ì •ì  íš¨ê³¼ ì ìš©
        titleOverlay.className = 'video-title-overlay video-text-overlay';
        if (staticEffect && staticEffect !== 'none') {
            titleOverlay.classList.add(`effect-${staticEffect}`);
        }

        // ë™ì  íš¨ê³¼ ì ìš©
        if (dynamicEffect && dynamicEffect !== 'none') {
            titleOverlay.classList.add(`effect-${dynamicEffect}`);
        }
    }
    console.log(`âœ… ì œëª© ì ìš©: ${text}`);

    // Canvas ì˜¤ë²„ë ˆì´ ë™ê¸°í™”
    syncOverlaysToCanvas();
}

// ë¶€ì œëª© ì ìš©
function applySubtitle() {
    const subtitleOverlay = document.getElementById('video-subtitle-overlay') || document.querySelector('.video-subtitle-overlay');
    const text = document.getElementById('overlay-subtitle-input').value.trim();
    const size = document.getElementById('overlay-subtitle-size').value;
    const color = document.getElementById('overlay-subtitle-color').value;
    const staticEffect = document.getElementById('overlay-subtitle-static-effect')?.value || 'none';
    const dynamicEffect = document.getElementById('overlay-subtitle-dynamic-effect')?.value || 'none';

    if (!subtitleOverlay) {
        console.error('âŒ ë¶€ì œëª© ì˜¤ë²„ë ˆì´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        alert('âš ï¸ ì˜ìƒì„ ë¨¼ì € ë¶ˆëŸ¬ì™€ì£¼ì„¸ìš”.');
        return;
    }

    if (!text) {
        subtitleOverlay.textContent = 'ë¶€ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”';
        subtitleOverlay.style.opacity = '0.5';
    } else {
        subtitleOverlay.textContent = text;
        subtitleOverlay.style.fontSize = `${size}px`;
        subtitleOverlay.style.color = color;
        subtitleOverlay.style.opacity = '1';
        subtitleOverlay.style.display = 'block';

        // ğŸŒ ì–¸ì–´ ìë™ ê°ì§€ ë° ìµœì  í°íŠ¸ ì ìš©
        const detectedLang = detectLanguage(text);
        const optimalFont = getFontFamilyForLanguage(detectedLang);
        subtitleOverlay.style.fontFamily = optimalFont;
        subtitleOverlay.setAttribute('lang', detectedLang);
        console.log(`ğŸŒ ë¶€ì œëª© ì–¸ì–´ ê°ì§€: ${detectedLang}, í°íŠ¸: ${optimalFont}`);

        // ì •ì  íš¨ê³¼ ì ìš©
        subtitleOverlay.className = 'video-subtitle-overlay video-text-overlay';
        if (staticEffect && staticEffect !== 'none') {
            subtitleOverlay.classList.add(`effect-${staticEffect}`);
        }

        // ë™ì  íš¨ê³¼ ì ìš©
        if (dynamicEffect && dynamicEffect !== 'none') {
            subtitleOverlay.classList.add(`effect-${dynamicEffect}`);
        }
    }
    console.log(`âœ… ë¶€ì œëª© ì ìš©: ${text}`);

    // Canvas ì˜¤ë²„ë ˆì´ ë™ê¸°í™”
    syncOverlaysToCanvas();
}

// ì¶œì²˜ ì ìš©
function applySource() {
    const overlay = document.getElementById('source-overlay');
    const text = document.getElementById('overlay-source-input').value.trim();
    const size = document.getElementById('overlay-source-size').value;
    const color = document.getElementById('overlay-source-color').value;
    const x = document.getElementById('overlay-source-x').value;
    const y = document.getElementById('overlay-source-y').value;
    const staticEffect = document.getElementById('overlay-source-static-effect').value;
    const dynamicEffect = document.getElementById('overlay-source-dynamic-effect').value;

    if (!text) {
        overlay.textContent = 'ì¶œì²˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”';
        overlay.style.display = 'block';
        overlay.style.opacity = '0.5';
        overlay.style.fontSize = '18px';
        overlay.style.color = '#cccccc';
        overlay.classList.add('empty');
        return;
    }

    // í…ìŠ¤íŠ¸ ì ìš©
    overlay.textContent = text;
    overlay.style.fontSize = `${size}px`;
    overlay.style.color = color;
    overlay.style.display = 'block';
    overlay.style.opacity = '1';
    overlay.classList.remove('empty');

    // ìœ„ì¹˜ ì ìš©
    overlay.style.top = `${y}%`;
    overlay.style.left = `${x}%`;

    // ğŸŒ ì–¸ì–´ ìë™ ê°ì§€ ë° ìµœì  í°íŠ¸ ì ìš© (ì´ëª¨ì§€ í°íŠ¸ í¬í•¨)
    const detectedLang = detectLanguage(text);
    const optimalFont = getFontFamilyForLanguage(detectedLang);
    overlay.style.fontFamily = optimalFont;

    // íš¨ê³¼ ì œê±° í›„ ì¬ì ìš©
    overlay.className = 'custom-subtitle-overlay';
    overlay.setAttribute('data-lang', detectedLang);

    // ì •ì  íš¨ê³¼ ì ìš©
    if (staticEffect && staticEffect !== 'none') {
        overlay.classList.add(`effect-${staticEffect}`);
    }

    // ë™ì  íš¨ê³¼ ì ìš©
    if (dynamicEffect && dynamicEffect !== 'none') {
        overlay.classList.add(`effect-${dynamicEffect}`);
    }

    console.log(`âœ… ì¶œì²˜ ì ìš©: ${text}`);
}

// ë¹ ë¥¸ ìë§‰ ë¶ˆëŸ¬ì˜¤ê¸° ë¹„ìš°ê¸° í•¨ìˆ˜
function clearQuickSubtitle() {
    if (confirm('ğŸ—‘ï¸ ë¶ˆëŸ¬ì˜¨ ìë§‰ì„ ë¹„ìš°ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
        const fileInput = document.getElementById('quick-subtitle-file-input');
        if (fileInput) {
            fileInput.value = '';
        }

        // í‘œì‹œëœ íŒŒì¼ëª… ì´ˆê¸°í™”
        const fileNameSpan = document.getElementById('loaded-subtitle-files');
        if (fileNameSpan) {
            fileNameSpan.textContent = '';
        }

        console.log('ğŸ—‘ï¸ ë¹ ë¥¸ ìë§‰ ë¶ˆëŸ¬ì˜¤ê¸° ë¹„ì›€');
        alert('âœ… ë¶ˆëŸ¬ì˜¨ ìë§‰ì´ ë¹„ì›Œì¡ŒìŠµë‹ˆë‹¤.');
    }
}

// íƒ€ì„ë¼ì¸ ìë§‰ì„ í™”ë©´ ì˜¤ë²„ë ˆì´ì— í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
function updateSubtitleOverlaysFromTimeline(currentTime) {
    // ì²´í¬ë°•ìŠ¤ ìƒíƒœ í™•ì¸
    const mainEnabled = document.getElementById('track-main-subtitle-enable')?.checked;
    const translationEnabled = document.getElementById('track-translation-subtitle-enable')?.checked;
    const descriptionEnabled = document.getElementById('track-description-subtitle-enable')?.checked;

    // ë©”ì¸ ìë§‰ ì˜¤ë²„ë ˆì´ ì—…ë°ì´íŠ¸ (main - ì¼ë³¸ì–´)
    const japaneseOverlay = document.getElementById('japanese-subtitle-overlay');
    const japaneseInput = document.getElementById('overlay-japanese-input');

    if (japaneseOverlay) {
        let subtitleChanged = false;
        // íƒ€ì„ë¼ì¸ íŠ¸ë™ì´ í™œì„±í™”ë˜ì–´ ìˆê³  ìë§‰ ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš°
        if (mainEnabled && loadedSubtitles.main && loadedSubtitles.main.length > 0) {
            const currentSubtitle = findSubtitleAtTime(loadedSubtitles.main, currentTime);
            if (currentSubtitle) {
                // ìë§‰ ë‚´ìš©ì´ ë°”ë€ ê²½ìš°ì—ë§Œ ì—…ë°ì´íŠ¸
                if (japaneseOverlay.textContent !== currentSubtitle.text) {
                    japaneseOverlay.textContent = currentSubtitle.text;
                    subtitleChanged = true;
                }

                // ì»¨íŠ¸ë¡¤ì—ì„œ ì„¤ì •ëœ ìŠ¤íƒ€ì¼ ì ìš©
                const size = document.getElementById('overlay-japanese-size')?.value || '30';
                const color = document.getElementById('overlay-japanese-color')?.value || '#000000';
                const x = document.getElementById('overlay-japanese-x')?.value || '50';
                const y = document.getElementById('overlay-japanese-y')?.value || '73';
                const staticEffect = document.getElementById('overlay-japanese-static-effect')?.value || 'outline';
                const dynamicEffect = document.getElementById('overlay-japanese-dynamic-effect')?.value || 'none';

                japaneseOverlay.style.display = 'block';
                japaneseOverlay.style.opacity = '1';
                japaneseOverlay.style.fontSize = size + 'px';
                japaneseOverlay.style.color = color;
                japaneseOverlay.style.left = x + '%';
                japaneseOverlay.style.top = y + '%';
                japaneseOverlay.classList.remove('empty');

                // ì¼ë³¸ì–´ í°íŠ¸ ìµœì í™”
                const optimalFont = getFontFamilyForLanguage('ja');
                japaneseOverlay.style.fontFamily = optimalFont;

                // íš¨ê³¼ ì œê±° í›„ ì¬ì ìš©
                japaneseOverlay.className = 'custom-subtitle-overlay';
                japaneseOverlay.setAttribute('data-lang', 'japanese');
                japaneseOverlay.setAttribute('lang', 'ja');

                // ì •ì  íš¨ê³¼ ì ìš©
                if (staticEffect && staticEffect !== 'none') {
                    japaneseOverlay.classList.add(`effect-${staticEffect}`);
                }

                // ë™ì  íš¨ê³¼ ì ìš©
                if (dynamicEffect && dynamicEffect !== 'none') {
                    japaneseOverlay.classList.add(`effect-${dynamicEffect}`);
                }
            } else {
                // í˜„ì¬ ì‹œê°„ì— ìë§‰ì´ ì—†ìœ¼ë©´ ìˆ¨ê¹€
                if (japaneseOverlay.textContent !== '') {
                    subtitleChanged = true;
                }
                japaneseOverlay.textContent = '';
                japaneseOverlay.style.display = 'none';
                japaneseOverlay.classList.add('empty');
            }
        } else if (!mainEnabled) {
            // íƒ€ì„ë¼ì¸ íŠ¸ë™ì´ ë¹„í™œì„±í™”ëœ ê²½ìš° - ìˆ˜ë™ ì…ë ¥ëœ í…ìŠ¤íŠ¸ê°€ ìˆë‹¤ë©´ ìœ ì§€, ì—†ìœ¼ë©´ ìˆ¨ê¹€
            if (!japaneseInput || !japaneseInput.value.trim()) {
                if (japaneseOverlay.textContent !== '') {
                    subtitleChanged = true;
                }
                japaneseOverlay.textContent = '';
                japaneseOverlay.style.display = 'none';
                japaneseOverlay.classList.add('empty');
            }
            // ìˆ˜ë™ ì…ë ¥ í…ìŠ¤íŠ¸ê°€ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ìœ ì§€ (applyJapaneseSubtitleë¡œ ì„¤ì •ëœ ìƒíƒœ)
        }

        // Canvas ë™ê¸°í™” (ìë§‰ì´ ë³€ê²½ëœ ê²½ìš°ì—ë§Œ)
        if (subtitleChanged && typeof updateCanvasText === 'function') {
            updateCanvasText();
        }
    }

    // ì£¼ìë§‰ ì˜¤ë²„ë ˆì´ ì—…ë°ì´íŠ¸ (translation)
    const koreanOverlay = document.getElementById('korean-subtitle-overlay');
    const koreanInput = document.getElementById('overlay-korean-input');

    if (koreanOverlay) {
        let subtitleChanged = false;
        // íƒ€ì„ë¼ì¸ íŠ¸ë™ì´ í™œì„±í™”ë˜ì–´ ìˆê³  ìë§‰ ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš°
        if (translationEnabled && loadedSubtitles.translation && loadedSubtitles.translation.length > 0) {
            const currentSubtitle = findSubtitleAtTime(loadedSubtitles.translation, currentTime);
            if (currentSubtitle) {
                // ìë§‰ ë‚´ìš©ì´ ë°”ë€ ê²½ìš°ì—ë§Œ ì—…ë°ì´íŠ¸
                if (koreanOverlay.textContent !== currentSubtitle.text) {
                    koreanOverlay.textContent = currentSubtitle.text;
                    subtitleChanged = true;
                }

                // ì»¨íŠ¸ë¡¤ì—ì„œ ì„¤ì •ëœ ìŠ¤íƒ€ì¼ ì ìš©
                const size = document.getElementById('overlay-korean-size')?.value || '32';
                const color = document.getElementById('overlay-korean-color')?.value || '#ffffff';
                const x = document.getElementById('overlay-korean-x')?.value || '50';
                const y = document.getElementById('overlay-korean-y')?.value || '65';
                const staticEffect = document.getElementById('overlay-korean-static-effect')?.value || 'outline';
                const dynamicEffect = document.getElementById('overlay-korean-dynamic-effect')?.value || 'none';

                koreanOverlay.style.display = 'block';
                koreanOverlay.style.opacity = '1';
                koreanOverlay.style.fontSize = size + 'px';
                koreanOverlay.style.color = color;
                koreanOverlay.style.left = x + '%';
                koreanOverlay.style.top = y + '%';
                koreanOverlay.classList.remove('empty');

                // ì–¸ì–´ ê°ì§€ ë° í°íŠ¸ ì ìš©
                const detectedLang = detectLanguage(currentSubtitle.text);
                const optimalFont = getFontFamilyForLanguage(detectedLang);
                koreanOverlay.style.fontFamily = optimalFont;

                // íš¨ê³¼ ì œê±° í›„ ì¬ì ìš©
                koreanOverlay.className = 'custom-subtitle-overlay';
                koreanOverlay.setAttribute('data-lang', detectedLang);
                koreanOverlay.setAttribute('lang', detectedLang);

                // ì •ì  íš¨ê³¼ ì ìš©
                if (staticEffect && staticEffect !== 'none') {
                    koreanOverlay.classList.add(`effect-${staticEffect}`);
                }

                // ë™ì  íš¨ê³¼ ì ìš©
                if (dynamicEffect && dynamicEffect !== 'none') {
                    koreanOverlay.classList.add(`effect-${dynamicEffect}`);
                }
            } else {
                // í˜„ì¬ ì‹œê°„ì— ìë§‰ì´ ì—†ìœ¼ë©´ ìˆ¨ê¹€
                if (koreanOverlay.textContent !== '') {
                    subtitleChanged = true;
                }
                koreanOverlay.textContent = '';
                koreanOverlay.style.display = 'none';
                koreanOverlay.classList.add('empty');
            }
        } else if (!translationEnabled) {
            // íƒ€ì„ë¼ì¸ íŠ¸ë™ì´ ë¹„í™œì„±í™”ëœ ê²½ìš° - ìˆ˜ë™ ì…ë ¥ëœ í…ìŠ¤íŠ¸ê°€ ìˆë‹¤ë©´ ìœ ì§€, ì—†ìœ¼ë©´ ìˆ¨ê¹€
            if (!koreanInput || !koreanInput.value.trim()) {
                if (koreanOverlay.textContent !== '') {
                    subtitleChanged = true;
                }
                koreanOverlay.textContent = '';
                koreanOverlay.style.display = 'none';
                koreanOverlay.classList.add('empty');
            }
            // ìˆ˜ë™ ì…ë ¥ í…ìŠ¤íŠ¸ê°€ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ìœ ì§€ (applyKoreanSubtitleë¡œ ì„¤ì •ëœ ìƒíƒœ)
        }

        // Canvas ë™ê¸°í™” (ìë§‰ì´ ë³€ê²½ëœ ê²½ìš°ì—ë§Œ)
        if (subtitleChanged && typeof updateCanvasText === 'function') {
            updateCanvasText();
        }
    }

    // ë³´ì¡°ìë§‰ ì˜¤ë²„ë ˆì´ ì—…ë°ì´íŠ¸ (description)
    const englishOverlay = document.getElementById('english-subtitle-overlay');
    const englishInput = document.getElementById('overlay-english-input');

    if (englishOverlay) {
        let subtitleChanged = false;
        // íƒ€ì„ë¼ì¸ íŠ¸ë™ì´ í™œì„±í™”ë˜ì–´ ìˆê³  ìë§‰ ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš°
        if (descriptionEnabled && loadedSubtitles.description && loadedSubtitles.description.length > 0) {
            const currentSubtitle = findSubtitleAtTime(loadedSubtitles.description, currentTime);
            if (currentSubtitle) {
                // ìë§‰ ë‚´ìš©ì´ ë°”ë€ ê²½ìš°ì—ë§Œ ì—…ë°ì´íŠ¸
                if (englishOverlay.textContent !== currentSubtitle.text) {
                    englishOverlay.textContent = currentSubtitle.text;
                    subtitleChanged = true;
                }

                // ì»¨íŠ¸ë¡¤ì—ì„œ ì„¤ì •ëœ ìŠ¤íƒ€ì¼ ì ìš©
                const size = document.getElementById('overlay-english-size')?.value || '28';
                const color = document.getElementById('overlay-english-color')?.value || '#ffe14d';
                const x = document.getElementById('overlay-english-x')?.value || '50';
                const y = document.getElementById('overlay-english-y')?.value || '95';
                const staticEffect = document.getElementById('overlay-english-static-effect')?.value || 'outline';
                const dynamicEffect = document.getElementById('overlay-english-dynamic-effect')?.value || 'none';

                englishOverlay.style.display = 'block';
                englishOverlay.style.opacity = '1';
                englishOverlay.style.fontSize = size + 'px';
                englishOverlay.style.color = color;
                englishOverlay.style.left = x + '%';
                englishOverlay.style.top = y + '%';
                englishOverlay.classList.remove('empty');

                // ì–¸ì–´ ê°ì§€ ë° í°íŠ¸ ì ìš©
                const detectedLang = detectLanguage(currentSubtitle.text);
                const optimalFont = getFontFamilyForLanguage(detectedLang);
                englishOverlay.style.fontFamily = optimalFont;

                // íš¨ê³¼ ì œê±° í›„ ì¬ì ìš©
                englishOverlay.className = 'custom-subtitle-overlay';
                englishOverlay.setAttribute('data-lang', detectedLang);
                englishOverlay.setAttribute('lang', detectedLang);

                // ì •ì  íš¨ê³¼ ì ìš©
                if (staticEffect && staticEffect !== 'none') {
                    englishOverlay.classList.add(`effect-${staticEffect}`);
                }

                // ë™ì  íš¨ê³¼ ì ìš©
                if (dynamicEffect && dynamicEffect !== 'none') {
                    englishOverlay.classList.add(`effect-${dynamicEffect}`);
                }
            } else {
                // í˜„ì¬ ì‹œê°„ì— ìë§‰ì´ ì—†ìœ¼ë©´ ìˆ¨ê¹€
                if (englishOverlay.textContent !== '') {
                    subtitleChanged = true;
                }
                englishOverlay.textContent = '';
                englishOverlay.style.display = 'none';
                englishOverlay.classList.add('empty');
            }
        } else if (!descriptionEnabled) {
            // íƒ€ì„ë¼ì¸ íŠ¸ë™ì´ ë¹„í™œì„±í™”ëœ ê²½ìš° - ìˆ˜ë™ ì…ë ¥ëœ í…ìŠ¤íŠ¸ê°€ ìˆë‹¤ë©´ ìœ ì§€, ì—†ìœ¼ë©´ ìˆ¨ê¹€
            if (!englishInput || !englishInput.value.trim()) {
                if (englishOverlay.textContent !== '') {
                    subtitleChanged = true;
                }
                englishOverlay.textContent = '';
                englishOverlay.style.display = 'none';
                englishOverlay.classList.add('empty');
            }
            // ìˆ˜ë™ ì…ë ¥ í…ìŠ¤íŠ¸ê°€ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ìœ ì§€ (applyEnglishSubtitleë¡œ ì„¤ì •ëœ ìƒíƒœ)
        }

        // Canvas ë™ê¸°í™” (ìë§‰ì´ ë³€ê²½ëœ ê²½ìš°ì—ë§Œ)
        if (subtitleChanged && typeof updateCanvasText === 'function') {
            updateCanvasText();
        }
    }
}

// íŠ¹ì • ì‹œê°„ì— í•´ë‹¹í•˜ëŠ” ìë§‰ ì°¾ê¸°
function findSubtitleAtTime(subtitles, currentTime) {
    if (!subtitles || subtitles.length === 0) return null;

    for (const subtitle of subtitles) {
        const startSeconds = srtTimeToSeconds(subtitle.start);
        const endSeconds = srtTimeToSeconds(subtitle.end);

        if (currentTime >= startSeconds && currentTime <= endSeconds) {
            return subtitle;
        }
    }

    return null;
}

// ìë§‰ ë“œë˜ê·¸ ê¸°ëŠ¥ ì´ˆê¸°í™”
function initSubtitleDragging() {
    const koreanOverlay = document.getElementById('korean-subtitle-overlay');
    const englishOverlay = document.getElementById('english-subtitle-overlay');
    const sourceOverlay = document.getElementById('source-overlay');

    if (koreanOverlay) {
        makeSubtitleDraggable(koreanOverlay, 'korean');
    }
    if (englishOverlay) {
        makeSubtitleDraggable(englishOverlay, 'english');
    }
    if (sourceOverlay) {
        makeSubtitleDraggable(sourceOverlay, 'source');
    }
}

// ìë§‰ ë“œë˜ê·¸ ê°€ëŠ¥í•˜ê²Œ ë§Œë“¤ê¸°
function makeSubtitleDraggable(element, lang) {
    let isDragging = false;
    let startX = 0;
    let startY = 0;
    let startLeft = 0;
    let startTop = 0;

    // mousedown ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
    const handleMouseDown = (e) => {
        if (element.classList.contains('empty') || element.style.display === 'none') return;

        isDragging = true;
        startX = e.clientX;
        startY = e.clientY;

        const rect = element.getBoundingClientRect();
        const wrapper = element.closest('.video-subtitle-wrapper');
        const wrapperRect = wrapper.getBoundingClientRect();

        startLeft = rect.left - wrapperRect.left;
        startTop = rect.top - wrapperRect.top;

        element.style.cursor = 'grabbing';
        e.preventDefault();
    };

    // mousemove ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
    const handleMouseMove = (e) => {
        if (!isDragging) return;

        const deltaX = e.clientX - startX;
        const deltaY = e.clientY - startY;

        const wrapper = element.closest('.video-subtitle-wrapper');
        const wrapperRect = wrapper.getBoundingClientRect();
        const newLeft = startLeft + deltaX;
        const newTop = startTop + deltaY;

        // í¼ì„¼íŠ¸ë¡œ ë³€í™˜
        const leftPercent = (newLeft / wrapperRect.width) * 100;
        const topPercent = (newTop / wrapperRect.height) * 100;

        // ë²”ìœ„ ì œí•œ
        const clampedLeft = Math.max(0, Math.min(100, leftPercent));
        const clampedTop = Math.max(0, Math.min(100, topPercent));

        element.style.left = clampedLeft + '%';
        element.style.top = clampedTop + '%';

        // ì…ë ¥ í•„ë“œ ì—…ë°ì´íŠ¸
        const xInput = document.getElementById(`overlay-${lang}-x`);
        const yInput = document.getElementById(`overlay-${lang}-y`);
        if (xInput) xInput.value = Math.round(clampedLeft);
        if (yInput) yInput.value = Math.round(clampedTop);

        e.preventDefault();
    };

    // mouseup ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
    const handleMouseUp = () => {
        if (isDragging) {
            isDragging = false;
            element.style.cursor = 'move';
        }
    };

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
    element.addEventListener('mousedown', handleMouseDown);
    document.addEventListener('mousemove', handleMouseMove);
    document.addEventListener('mouseup', handleMouseUp);
}

// í…ìŠ¤íŠ¸ ì˜¤ë²„ë ˆì´ ì„¤ì • ì €ì¥ (ê¸°ì¡´ í•¨ìˆ˜ì— ìë§‰ ì¶”ê°€)
function saveTextOverlaySettingsWithSubtitles() {
    const settings = {
        title: {
            text: document.getElementById('overlay-title-input').value,
            size: document.getElementById('overlay-title-size').value,
            color: document.getElementById('overlay-title-color').value,
            staticEffect: document.getElementById('overlay-title-static-effect').value,
            dynamicEffect: document.getElementById('overlay-title-dynamic-effect').value,
            position: document.getElementById('video-title-overlay').style.transform
        },
        subtitle: {
            text: document.getElementById('overlay-subtitle-input').value,
            size: document.getElementById('overlay-subtitle-size').value,
            color: document.getElementById('overlay-subtitle-color').value,
            staticEffect: document.getElementById('overlay-subtitle-static-effect').value,
            dynamicEffect: document.getElementById('overlay-subtitle-dynamic-effect').value,
            position: document.getElementById('video-subtitle-overlay').style.transform
        },
        korean: {
            text: document.getElementById('overlay-korean-input').value,
            size: document.getElementById('overlay-korean-size').value,
            color: document.getElementById('overlay-korean-color').value,
            x: document.getElementById('overlay-korean-x').value,
            y: document.getElementById('overlay-korean-y').value,
            staticEffect: document.getElementById('overlay-korean-static-effect').value,
            dynamicEffect: document.getElementById('overlay-korean-dynamic-effect').value
        },
        japanese: {
            text: document.getElementById('overlay-japanese-input').value,
            size: document.getElementById('overlay-japanese-size').value,
            color: document.getElementById('overlay-japanese-color').value,
            x: document.getElementById('overlay-japanese-x').value,
            y: document.getElementById('overlay-japanese-y').value,
            staticEffect: document.getElementById('overlay-japanese-static-effect').value,
            dynamicEffect: document.getElementById('overlay-japanese-dynamic-effect').value
        },
        english: {
            text: document.getElementById('overlay-english-input').value,
            size: document.getElementById('overlay-english-size').value,
            color: document.getElementById('overlay-english-color').value,
            x: document.getElementById('overlay-english-x').value,
            y: document.getElementById('overlay-english-y').value,
            staticEffect: document.getElementById('overlay-english-static-effect').value,
            dynamicEffect: document.getElementById('overlay-english-dynamic-effect').value
        },
        blackBars: {
            top: {
                enabled: document.getElementById('top-bar-enable').checked,
                height: document.getElementById('top-bar-height').value,
                opacity: document.getElementById('top-bar-opacity').value
            },
            bottom: {
                enabled: document.getElementById('bottom-bar-enable').checked,
                height: document.getElementById('bottom-bar-height').value,
                opacity: document.getElementById('bottom-bar-opacity').value
            }
        }
    };

    try {
        // ì €ì¥ ì‹œê°„ ì¶”ê°€
        settings.savedAt = new Date().toISOString();
        settings.name = 'ê¸°ë³¸ ì„¤ì •';

        localStorage.setItem('videoAnalyzerTextOverlay', JSON.stringify(settings));
        updateSettingsStatus('ê¸°ë³¸ ì„¤ì •', new Date());
        alert('âœ… í…ìŠ¤íŠ¸ ì˜¤ë²„ë ˆì´ ë° ê²€ì • ë°°ê²½ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
        console.log('ğŸ’¾ ì„¤ì • ì €ì¥ë¨:', settings);
    } catch (e) {
        console.error('âŒ ì„¤ì • ì €ì¥ ì‹¤íŒ¨:', e);
        alert('âŒ ì„¤ì • ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
}

// ë‹¤ë¥¸ ì´ë¦„ìœ¼ë¡œ ì €ì¥
function saveTextOverlaySettingsAs() {
    const name = prompt('ì„¤ì • ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:', `ì„¤ì •_${new Date().toLocaleDateString()}`);
    if (!name) return;

    // í˜„ì¬ ì„¤ì • ìˆ˜ì§‘ (ê¸°ì¡´ í•¨ìˆ˜ì™€ ë™ì¼)
    const settings = {
        name: name,
        savedAt: new Date().toISOString(),
        title: {
            text: document.getElementById('overlay-title-input').value,
            size: document.getElementById('overlay-title-size').value,
            color: document.getElementById('overlay-title-color').value,
            staticEffect: document.getElementById('overlay-title-static-effect').value,
            dynamicEffect: document.getElementById('overlay-title-dynamic-effect').value,
            position: document.getElementById('video-title-overlay')?.style.transform || ''
        },
        subtitle: {
            text: document.getElementById('overlay-subtitle-input').value,
            size: document.getElementById('overlay-subtitle-size').value,
            color: document.getElementById('overlay-subtitle-color').value,
            staticEffect: document.getElementById('overlay-subtitle-static-effect').value,
            dynamicEffect: document.getElementById('overlay-subtitle-dynamic-effect').value,
            position: document.getElementById('video-subtitle-overlay')?.style.transform || ''
        },
        source: {
            text: document.getElementById('overlay-source-input').value,
            size: document.getElementById('overlay-source-size').value,
            color: document.getElementById('overlay-source-color').value,
            x: document.getElementById('overlay-source-x').value,
            y: document.getElementById('overlay-source-y').value,
            staticEffect: document.getElementById('overlay-source-static-effect').value,
            dynamicEffect: document.getElementById('overlay-source-dynamic-effect').value,
            hide: document.getElementById('source-overlay-hide').checked
        },
        korean: {
            text: document.getElementById('overlay-korean-input').value,
            size: document.getElementById('overlay-korean-size').value,
            color: document.getElementById('overlay-korean-color').value,
            x: document.getElementById('overlay-korean-x').value,
            y: document.getElementById('overlay-korean-y').value,
            staticEffect: document.getElementById('overlay-korean-static-effect').value,
            dynamicEffect: document.getElementById('overlay-korean-dynamic-effect').value
        },
        japanese: {
            text: document.getElementById('overlay-japanese-input').value,
            size: document.getElementById('overlay-japanese-size').value,
            color: document.getElementById('overlay-japanese-color').value,
            x: document.getElementById('overlay-japanese-x').value,
            y: document.getElementById('overlay-japanese-y').value,
            staticEffect: document.getElementById('overlay-japanese-static-effect').value,
            dynamicEffect: document.getElementById('overlay-japanese-dynamic-effect').value
        },
        english: {
            text: document.getElementById('overlay-english-input').value,
            size: document.getElementById('overlay-english-size').value,
            color: document.getElementById('overlay-english-color').value,
            x: document.getElementById('overlay-english-x').value,
            y: document.getElementById('overlay-english-y').value,
            staticEffect: document.getElementById('overlay-english-static-effect').value,
            dynamicEffect: document.getElementById('overlay-english-dynamic-effect').value
        },
        blackBars: {
            top: {
                enabled: document.getElementById('top-bar-enable').checked,
                height: document.getElementById('top-bar-height').value,
                opacity: document.getElementById('top-bar-opacity').value  // 0-100 ë²”ìœ„ë¡œ ì €ì¥
            },
            bottom: {
                enabled: document.getElementById('bottom-bar-enable').checked,
                height: document.getElementById('bottom-bar-height').value,
                opacity: document.getElementById('bottom-bar-opacity').value  // 0-100 ë²”ìœ„ë¡œ ì €ì¥
            }
        },
        // Canvas ìë§‰ ìœ„ì¹˜ ì •ë³´ ì €ì¥
        canvasSubtitlePositions: canvasPreview ? {
            main: canvasPreview.subtitleStyles.main.yPosition,
            translation: canvasPreview.subtitleStyles.translation.yPosition,
            description: canvasPreview.subtitleStyles.description.yPosition
        } : null,
        // Canvas ì˜¤ë²„ë ˆì´ ìœ„ì¹˜ ì •ë³´ ì €ì¥ (title, subtitle)
        canvasOverlayPositions: canvasPreview && canvasPreview.overlays ?
            canvasPreview.overlays.map(overlay => ({
                type: overlay.type,
                text: overlay.text,
                x: overlay.x,
                y: overlay.y,
                fontSize: overlay.fontSize,
                color: overlay.color,
                borderWidth: overlay.borderWidth,
                borderColor: overlay.borderColor
            })) : null
    };

    try {
        // ëª¨ë“  ì„¤ì • ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        const allSettings = JSON.parse(localStorage.getItem('videoAnalyzerAllSettings') || '{}');
        allSettings[name] = settings;
        localStorage.setItem('videoAnalyzerAllSettings', JSON.stringify(allSettings));

        updateSettingsStatus(name, new Date());
        alert(`âœ… "${name}" ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!`);
        console.log('ğŸ’¾ ì„¤ì • ì €ì¥ë¨:', settings);
    } catch (e) {
        console.error('âŒ ì„¤ì • ì €ì¥ ì‹¤íŒ¨:', e);
        alert('âŒ ì„¤ì • ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
}

// ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° (ê°œì„ ëœ ë²„ì „)
function loadTextOverlaySettings() {
    try {
        // ì €ì¥ëœ ëª¨ë“  ì„¤ì • ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        const allSettings = JSON.parse(localStorage.getItem('videoAnalyzerAllSettings') || '{}');
        const settingsList = Object.keys(allSettings);

        if (settingsList.length === 0) {
            // ê¸°ë³¸ ì„¤ì •ë§Œ ìˆëŠ” ê²½ìš°
            const saved = localStorage.getItem('videoAnalyzerTextOverlay');
            if (!saved) {
                alert('âš ï¸ ì €ì¥ëœ ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            const settings = JSON.parse(saved);
            applySettings(settings);
            updateSettingsStatus(settings.name || 'ê¸°ë³¸ ì„¤ì •', settings.savedAt ? new Date(settings.savedAt) : null);
            return;
        }

        // ì„¤ì • ì„ íƒ ë‹¤ì´ì–¼ë¡œê·¸
        let message = 'ë¶ˆëŸ¬ì˜¬ ì„¤ì •ì„ ì„ íƒí•˜ì„¸ìš”:\n\n';
        settingsList.forEach((name, index) => {
            const setting = allSettings[name];
            const date = setting.savedAt ? new Date(setting.savedAt).toLocaleString() : 'ì•Œ ìˆ˜ ì—†ìŒ';
            message += `${index + 1}. ${name} (${date})\n`;
        });
        message += '\në²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:';

        const choice = prompt(message);
        if (!choice) return;

        const index = parseInt(choice) - 1;
        if (index < 0 || index >= settingsList.length) {
            alert('âŒ ì˜ëª»ëœ ë²ˆí˜¸ì…ë‹ˆë‹¤.');
            return;
        }

        const selectedName = settingsList[index];
        const settings = allSettings[selectedName];
        applySettings(settings);
        updateSettingsStatus(selectedName, settings.savedAt ? new Date(settings.savedAt) : null);
        alert(`âœ… "${selectedName}" ì„¤ì •ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!`);

    } catch (e) {
        console.error('âŒ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', e);
        console.error('ì—ëŸ¬ ìƒì„¸:', e.message, e.stack);
        alert(`âŒ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\nì—ëŸ¬: ${e.message}\n\në¸Œë¼ìš°ì € ì½˜ì†”(F12)ì„ í™•ì¸í•˜ì„¸ìš”.`);
    }
}

// íŒŒì¼ì—ì„œ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
function browseSettingsFile() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = function(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(event) {
            try {
                const settings = JSON.parse(event.target.result);
                applySettings(settings);
                updateSettingsStatus(settings.name || file.name, settings.savedAt ? new Date(settings.savedAt) : null);
                alert(`âœ… "${file.name}" íŒŒì¼ì—ì„œ ì„¤ì •ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!`);
            } catch (e) {
                console.error('âŒ íŒŒì¼ ì½ê¸° ì‹¤íŒ¨:', e);
                alert('âŒ ìœ íš¨í•˜ì§€ ì•Šì€ ì„¤ì • íŒŒì¼ì…ë‹ˆë‹¤.');
            }
        };
        reader.readAsText(file);
    };
    input.click();
}

// ì„¤ì • ì ìš© í—¬í¼ í•¨ìˆ˜
function applySettings(settings) {
    // ì œëª© ì„¤ì • ì ìš©
    if (settings.title) {
        document.getElementById('overlay-title-input').value = settings.title.text || '';
        document.getElementById('overlay-title-size').value = settings.title.size || 48;
        document.getElementById('overlay-title-color').value = settings.title.color || '#ffffff';
        if (settings.title.staticEffect) document.getElementById('overlay-title-static-effect').value = settings.title.staticEffect;
        if (settings.title.dynamicEffect) document.getElementById('overlay-title-dynamic-effect').value = settings.title.dynamicEffect;

        // í¬ê¸° í‘œì‹œ ì—…ë°ì´íŠ¸
        const titleSizeDisplay = document.getElementById('title-size-display');
        if (titleSizeDisplay) titleSizeDisplay.textContent = (settings.title.size || 48) + 'px';

        // ì‹¤ì œ ì˜¤ë²„ë ˆì´ì— ì ìš©
        const titleOverlay = document.getElementById('video-title-overlay');
        if (titleOverlay) {
            if (settings.title.text) {
                try {
                    applyTitle();
                } catch (err) {
                    console.warn('ì œëª© ì ìš© ì‹¤íŒ¨ (ì˜ìƒì´ ë¡œë“œë˜ì§€ ì•Šì•˜ì„ ìˆ˜ ìˆìŒ):', err);
                }
            }
            // ìœ„ì¹˜ ë³µì›
            if (settings.title.position) {
                titleOverlay.style.transform = settings.title.position;
            }
        }
    }

    // ë¶€ì œëª© ì„¤ì • ì ìš©
    if (settings.subtitle) {
        document.getElementById('overlay-subtitle-input').value = settings.subtitle.text || '';
        document.getElementById('overlay-subtitle-size').value = settings.subtitle.size || 32;
        document.getElementById('overlay-subtitle-color').value = settings.subtitle.color || '#ffe14d';
        if (settings.subtitle.staticEffect) document.getElementById('overlay-subtitle-static-effect').value = settings.subtitle.staticEffect;
        if (settings.subtitle.dynamicEffect) document.getElementById('overlay-subtitle-dynamic-effect').value = settings.subtitle.dynamicEffect;

        // í¬ê¸° í‘œì‹œ ì—…ë°ì´íŠ¸
        const subtitleSizeDisplay = document.getElementById('subtitle-size-display');
        if (subtitleSizeDisplay) subtitleSizeDisplay.textContent = (settings.subtitle.size || 32) + 'px';

        // ì‹¤ì œ ì˜¤ë²„ë ˆì´ì— ì ìš©
        const subtitleOverlay = document.getElementById('video-subtitle-overlay');
        if (subtitleOverlay) {
            if (settings.subtitle.text) {
                try {
                    applySubtitle();
                } catch (err) {
                    console.warn('ë¶€ì œëª© ì ìš© ì‹¤íŒ¨ (ì˜ìƒì´ ë¡œë“œë˜ì§€ ì•Šì•˜ì„ ìˆ˜ ìˆìŒ):', err);
                }
            }
            // ìœ„ì¹˜ ë³µì›
            if (settings.subtitle.position) {
                subtitleOverlay.style.transform = settings.subtitle.position;
            }
        }
    }

    // ì¶œì²˜ ì„¤ì • ì ìš©
    if (settings.source) {
        if (document.getElementById('overlay-source-input')) document.getElementById('overlay-source-input').value = settings.source.text || '';
        if (document.getElementById('overlay-source-size')) document.getElementById('overlay-source-size').value = settings.source.size || 16;
        if (document.getElementById('overlay-source-color')) document.getElementById('overlay-source-color').value = settings.source.color || '#ffffff';
        if (document.getElementById('overlay-source-x')) document.getElementById('overlay-source-x').value = settings.source.x || 10;
        if (document.getElementById('overlay-source-y')) document.getElementById('overlay-source-y').value = settings.source.y || 10;
        // í•˜ìœ„ í˜¸í™˜ì„±
        if (settings.source.staticEffect !== undefined && document.getElementById('overlay-source-static-effect')) {
            document.getElementById('overlay-source-static-effect').value = settings.source.staticEffect || 'none';
        } else if (settings.source.effect && document.getElementById('overlay-source-static-effect')) {
            document.getElementById('overlay-source-static-effect').value = settings.source.effect || 'none';
        }
        if (settings.source.dynamicEffect !== undefined && document.getElementById('overlay-source-dynamic-effect')) {
            document.getElementById('overlay-source-dynamic-effect').value = settings.source.dynamicEffect || 'none';
        }
        if (document.getElementById('source-overlay-hide')) document.getElementById('source-overlay-hide').checked = settings.source.hide || false;
    }

    // í•œê¸€ ìë§‰ ì„¤ì • ì ìš©
    if (settings.korean) {
        if (document.getElementById('overlay-korean-input')) document.getElementById('overlay-korean-input').value = settings.korean.text || '';
        if (document.getElementById('overlay-korean-size')) document.getElementById('overlay-korean-size').value = settings.korean.size || 24;
        if (document.getElementById('overlay-korean-color')) document.getElementById('overlay-korean-color').value = settings.korean.color || '#ffffff';
        if (document.getElementById('overlay-korean-x')) document.getElementById('overlay-korean-x').value = settings.korean.x || 50;
        if (document.getElementById('overlay-korean-y')) document.getElementById('overlay-korean-y').value = settings.korean.y || 80;
        // í•˜ìœ„ í˜¸í™˜ì„±
        if (settings.korean.staticEffect !== undefined && document.getElementById('overlay-korean-static-effect')) {
            document.getElementById('overlay-korean-static-effect').value = settings.korean.staticEffect || 'none';
        } else if (settings.korean.effect && document.getElementById('overlay-korean-static-effect')) {
            document.getElementById('overlay-korean-static-effect').value = settings.korean.effect || 'none';
        }
        if (settings.korean.dynamicEffect !== undefined && document.getElementById('overlay-korean-dynamic-effect')) {
            document.getElementById('overlay-korean-dynamic-effect').value = settings.korean.dynamicEffect || 'none';
        }
    }

    // ì¼ë³¸ì–´ ìë§‰ ì„¤ì • ì ìš©
    if (settings.japanese) {
        if (document.getElementById('overlay-japanese-input')) document.getElementById('overlay-japanese-input').value = settings.japanese.text || '';
        if (document.getElementById('overlay-japanese-size')) document.getElementById('overlay-japanese-size').value = settings.japanese.size || 30;
        if (document.getElementById('overlay-japanese-color')) document.getElementById('overlay-japanese-color').value = settings.japanese.color || '#000000';
        if (document.getElementById('overlay-japanese-x')) document.getElementById('overlay-japanese-x').value = settings.japanese.x || 50;
        if (document.getElementById('overlay-japanese-y')) document.getElementById('overlay-japanese-y').value = settings.japanese.y || 83;
        // í•˜ìœ„ í˜¸í™˜ì„±
        if (settings.japanese.staticEffect !== undefined && document.getElementById('overlay-japanese-static-effect')) {
            document.getElementById('overlay-japanese-static-effect').value = settings.japanese.staticEffect || 'outline';
        } else if (settings.japanese.effect && document.getElementById('overlay-japanese-static-effect')) {
            document.getElementById('overlay-japanese-static-effect').value = settings.japanese.effect || 'outline';
        }
        if (settings.japanese.dynamicEffect !== undefined && document.getElementById('overlay-japanese-dynamic-effect')) {
            document.getElementById('overlay-japanese-dynamic-effect').value = settings.japanese.dynamicEffect || 'none';
        }
    }

    // ì˜ì–´ ìë§‰ ì„¤ì • ì ìš©
    if (settings.english) {
        if (document.getElementById('overlay-english-input')) document.getElementById('overlay-english-input').value = settings.english.text || '';
        if (document.getElementById('overlay-english-size')) document.getElementById('overlay-english-size').value = settings.english.size || 20;
        if (document.getElementById('overlay-english-color')) document.getElementById('overlay-english-color').value = settings.english.color || '#ffe14d';
        if (document.getElementById('overlay-english-x')) document.getElementById('overlay-english-x').value = settings.english.x || 50;
        if (document.getElementById('overlay-english-y')) document.getElementById('overlay-english-y').value = settings.english.y || 90;
        // í•˜ìœ„ í˜¸í™˜ì„±
        if (settings.english.staticEffect !== undefined && document.getElementById('overlay-english-static-effect')) {
            document.getElementById('overlay-english-static-effect').value = settings.english.staticEffect || 'none';
        } else if (settings.english.effect && document.getElementById('overlay-english-static-effect')) {
            document.getElementById('overlay-english-static-effect').value = settings.english.effect || 'none';
        }
        if (settings.english.dynamicEffect !== undefined && document.getElementById('overlay-english-dynamic-effect')) {
            document.getElementById('overlay-english-dynamic-effect').value = settings.english.dynamicEffect || 'none';
        }
    }

    // Canvas ìë§‰ ìœ„ì¹˜ ë³µì›
    if (settings.canvasSubtitlePositions && canvasPreview) {
        console.log('ğŸ“ Canvas ìë§‰ ìœ„ì¹˜ ë³µì›:', settings.canvasSubtitlePositions);
        if (settings.canvasSubtitlePositions.main !== undefined) {
            canvasPreview.updateSubtitlePosition('main', settings.canvasSubtitlePositions.main);
        }
        if (settings.canvasSubtitlePositions.translation !== undefined) {
            canvasPreview.updateSubtitlePosition('translation', settings.canvasSubtitlePositions.translation);
        }
        if (settings.canvasSubtitlePositions.description !== undefined) {
            canvasPreview.updateSubtitlePosition('description', settings.canvasSubtitlePositions.description);
        }
    }

    // Canvas ì˜¤ë²„ë ˆì´ ìœ„ì¹˜ ë³µì› (title, subtitle)
    if (settings.canvasOverlayPositions && canvasPreview) {
        console.log('ğŸ“ Canvas ì˜¤ë²„ë ˆì´ ìœ„ì¹˜ ë³µì›:', settings.canvasOverlayPositions);
        canvasPreview.clearOverlays();
        settings.canvasOverlayPositions.forEach(overlay => {
            canvasPreview.addOverlay({
                type: overlay.type,
                text: overlay.text,
                x: overlay.x,
                y: overlay.y,
                fontSize: overlay.fontSize,
                color: overlay.color,
                borderWidth: overlay.borderWidth,
                borderColor: overlay.borderColor
            });
        });
    }

    // ê²€ì • ë°°ê²½ ì„¤ì • ì ìš©
    if (settings.blackBars) {
        // ìƒë‹¨ ê²€ì • ë°”
        if (settings.blackBars.top) {
            const topEnable = document.getElementById('top-bar-enable');
            const topHeight = document.getElementById('top-bar-height');
            const topOpacity = document.getElementById('top-bar-opacity');

            if (topEnable) topEnable.checked = settings.blackBars.top.enabled || false;
            if (topHeight) topHeight.value = settings.blackBars.top.height || 15;
            // opacityëŠ” 0-100 ë²”ìœ„ë¡œ ì €ì¥ë˜ë¯€ë¡œ ê·¸ëŒ€ë¡œ ì‚¬ìš©
            if (topOpacity) topOpacity.value = settings.blackBars.top.opacity || 80;

            // í‘œì‹œ ì—…ë°ì´íŠ¸
            const topHeightDisplay = document.getElementById('top-bar-height-display');
            const topOpacityDisplay = document.getElementById('top-bar-opacity-display');
            if (topHeightDisplay) topHeightDisplay.textContent = (settings.blackBars.top.height || 15) + '%';
            if (topOpacityDisplay) topOpacityDisplay.textContent = (settings.blackBars.top.opacity || 80) + '%';
        }

        // í•˜ë‹¨ ê²€ì • ë°”
        if (settings.blackBars.bottom) {
            const bottomEnable = document.getElementById('bottom-bar-enable');
            const bottomHeight = document.getElementById('bottom-bar-height');
            const bottomOpacity = document.getElementById('bottom-bar-opacity');

            if (bottomEnable) bottomEnable.checked = settings.blackBars.bottom.enabled || false;
            if (bottomHeight) bottomHeight.value = settings.blackBars.bottom.height || 15;
            // opacityëŠ” 0-100 ë²”ìœ„ë¡œ ì €ì¥ë˜ë¯€ë¡œ ê·¸ëŒ€ë¡œ ì‚¬ìš©
            if (bottomOpacity) bottomOpacity.value = settings.blackBars.bottom.opacity || 80;

            // í‘œì‹œ ì—…ë°ì´íŠ¸
            const bottomHeightDisplay = document.getElementById('bottom-bar-height-display');
            const bottomOpacityDisplay = document.getElementById('bottom-bar-opacity-display');
            if (bottomHeightDisplay) bottomHeightDisplay.textContent = (settings.blackBars.bottom.height || 15) + '%';
            if (bottomOpacityDisplay) bottomOpacityDisplay.textContent = (settings.blackBars.bottom.opacity || 80) + '%';
        }

        // ê²€ì • ë°°ê²½ ì‹¤ì œ ì ìš©
        if (settings.blackBars.top) {
            const topBar = document.getElementById('top-black-bar');
            const topCheckbox = document.getElementById('top-bar-enable');
            if (topBar && topCheckbox) {
                if (topCheckbox.checked) {
                    topBar.style.display = 'block';
                    updateBlackBar('top');
                } else {
                    topBar.style.display = 'none';
                }
            }
        }
        if (settings.blackBars.bottom) {
            const bottomBar = document.getElementById('bottom-black-bar');
            const bottomCheckbox = document.getElementById('bottom-bar-enable');
            if (bottomBar && bottomCheckbox) {
                if (bottomCheckbox.checked) {
                    bottomBar.style.display = 'block';
                    updateBlackBar('bottom');
                } else {
                    bottomBar.style.display = 'none';
                }
            }
        }
    }

    console.log('âœ… ì„¤ì •ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤:', settings);
}

// í˜„ì¬ ì„¤ì • ìƒíƒœ ì—…ë°ì´íŠ¸
function updateSettingsStatus(name, savedAt) {
    const nameEl = document.getElementById('saved-settings-name');
    const timeEl = document.getElementById('saved-settings-time');

    if (nameEl) nameEl.textContent = name || 'ê¸°ë³¸ ì„¤ì •';
    if (timeEl && savedAt) {
        const date = new Date(savedAt);
        timeEl.textContent = `ì €ì¥ ì‹œê°„: ${date.toLocaleString()}`;
    } else if (timeEl) {
        timeEl.textContent = 'ë¯¸ì €ì¥';
    }
}

// ê¸°ì¡´ ì €ì¥ í•¨ìˆ˜ë¥¼ ìƒˆ í•¨ìˆ˜ë¡œ ëŒ€ì²´
saveTextOverlaySettings = saveTextOverlaySettingsWithSubtitles;

// ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ (DOMContentLoadedì— ì¶”ê°€)
document.addEventListener('DOMContentLoaded', function() {
    // ê¸°ì¡´ DOMContentLoaded ì½”ë“œëŠ” ìœ ì§€í•˜ê³ , ì—¬ê¸°ì— ì¶”ê°€

    // í…ìŠ¤íŠ¸ ì˜¤ë²„ë ˆì´ ë“œë˜ê·¸ ê°€ëŠ¥í•˜ê²Œ ì„¤ì •
    const titleOverlay = document.getElementById('video-title-overlay');
    const subtitleOverlay = document.getElementById('video-subtitle-overlay');

    if (titleOverlay) makeOverlayDraggable(titleOverlay);
    if (subtitleOverlay) makeOverlayDraggable(subtitleOverlay);

    // ì œëª© ì…ë ¥ ì´ë²¤íŠ¸
    const titleInput = document.getElementById('overlay-title-input');
    if (titleInput) {
        titleInput.addEventListener('input', updateTextOverlays);
    }

    // ì œëª© í¬ê¸° ìŠ¬ë¼ì´ë”
    const titleSize = document.getElementById('overlay-title-size');
    if (titleSize) {
        titleSize.addEventListener('input', function() {
            document.getElementById('title-size-display').textContent = this.value + 'px';
            updateTextOverlays();
        });
    }

    // ì œëª© ìƒ‰ìƒ
    const titleColor = document.getElementById('overlay-title-color');
    if (titleColor) {
        titleColor.addEventListener('input', updateTextOverlays);
    }

    // ì œëª© íš¨ê³¼
    const titleStaticEffect = document.getElementById('overlay-title-static-effect');
    if (titleStaticEffect) {
        titleStaticEffect.addEventListener('change', updateTextOverlays);
    }

    const titleDynamicEffect = document.getElementById('overlay-title-dynamic-effect');
    if (titleDynamicEffect) {
        titleDynamicEffect.addEventListener('change', updateTextOverlays);
    }

    // ë¶€ì œëª© ì…ë ¥ ì´ë²¤íŠ¸
    const subtitleInput = document.getElementById('overlay-subtitle-input');
    if (subtitleInput) {
        subtitleInput.addEventListener('input', updateTextOverlays);
    }

    // ë¶€ì œëª© í¬ê¸° ìŠ¬ë¼ì´ë”
    const subtitleSize = document.getElementById('overlay-subtitle-size');
    if (subtitleSize) {
        subtitleSize.addEventListener('input', function() {
            document.getElementById('subtitle-size-display').textContent = this.value + 'px';
            updateTextOverlays();
        });
    }

    // ë¶€ì œëª© ìƒ‰ìƒ
    const subtitleColor = document.getElementById('overlay-subtitle-color');
    if (subtitleColor) {
        subtitleColor.addEventListener('input', updateTextOverlays);
    }

    // ë¶€ì œëª© íš¨ê³¼
    const subtitleStaticEffect = document.getElementById('overlay-subtitle-static-effect');
    if (subtitleStaticEffect) {
        subtitleStaticEffect.addEventListener('change', updateTextOverlays);
    }

    const subtitleDynamicEffect = document.getElementById('overlay-subtitle-dynamic-effect');
    if (subtitleDynamicEffect) {
        subtitleDynamicEffect.addEventListener('change', updateTextOverlays);
    }

    // ì¼ë³¸ì–´ ìë§‰ í¬ê¸° ìŠ¬ë¼ì´ë”
    const japaneseSize = document.getElementById('overlay-japanese-size');
    if (japaneseSize) {
        japaneseSize.addEventListener('input', function() {
            const sizeValue = this.value + 'px';
            document.getElementById('japanese-size-display').textContent = sizeValue;

            // ë©”ì¸ ìë§‰ ì˜¤ë²„ë ˆì´ì— ì‹¤ì‹œê°„ ì ìš©
            const japaneseOverlay = document.getElementById('japanese-subtitle-overlay');
            if (japaneseOverlay && !japaneseOverlay.classList.contains('empty')) {
                japaneseOverlay.style.fontSize = sizeValue;
            }

            // Canvasì—ë„ ë™ê¸°í™”
            if (typeof updateCanvasText === 'function') {
                updateCanvasText();
            }
        });
    }

    // ì¼ë³¸ì–´ ìë§‰ ìƒ‰ìƒ
    const japaneseColor = document.getElementById('overlay-japanese-color');
    if (japaneseColor) {
        japaneseColor.addEventListener('input', function() {
            const japaneseOverlay = document.getElementById('japanese-subtitle-overlay');
            if (japaneseOverlay && !japaneseOverlay.classList.contains('empty')) {
                japaneseOverlay.style.color = this.value;
            }
            if (typeof updateCanvasText === 'function') {
                updateCanvasText();
            }
        });
    }

    // ì¼ë³¸ì–´ ìë§‰ X ìœ„ì¹˜
    const japaneseX = document.getElementById('overlay-japanese-x');
    if (japaneseX) {
        japaneseX.addEventListener('input', function() {
            const japaneseOverlay = document.getElementById('japanese-subtitle-overlay');
            if (japaneseOverlay && !japaneseOverlay.classList.contains('empty')) {
                japaneseOverlay.style.left = this.value + '%';
            }
            if (typeof updateCanvasText === 'function') {
                updateCanvasText();
            }
        });
    }

    // ì¼ë³¸ì–´ ìë§‰ Y ìœ„ì¹˜
    const japaneseY = document.getElementById('overlay-japanese-y');
    if (japaneseY) {
        japaneseY.addEventListener('input', function() {
            const japaneseOverlay = document.getElementById('japanese-subtitle-overlay');
            if (japaneseOverlay && !japaneseOverlay.classList.contains('empty')) {
                japaneseOverlay.style.top = this.value + '%';
            }
            if (typeof updateCanvasText === 'function') {
                updateCanvasText();
            }
        });
    }

    // ì¼ë³¸ì–´ ìë§‰ ì •ì  íš¨ê³¼
    const japaneseStaticEffect = document.getElementById('overlay-japanese-static-effect');
    if (japaneseStaticEffect) {
        japaneseStaticEffect.addEventListener('change', function() {
            const japaneseOverlay = document.getElementById('japanese-subtitle-overlay');
            if (japaneseOverlay && !japaneseOverlay.classList.contains('empty')) {
                // ê¸°ì¡´ íš¨ê³¼ ì œê±°
                japaneseOverlay.className = 'custom-subtitle-overlay';
                japaneseOverlay.setAttribute('data-lang', 'japanese');
                japaneseOverlay.setAttribute('lang', 'ja');

                // ìƒˆ íš¨ê³¼ ì ìš©
                if (this.value && this.value !== 'none') {
                    japaneseOverlay.classList.add(`effect-${this.value}`);
                }

                // ë™ì  íš¨ê³¼ë„ ë‹¤ì‹œ ì¶”ê°€
                const dynamicEffect = document.getElementById('overlay-japanese-dynamic-effect')?.value;
                if (dynamicEffect && dynamicEffect !== 'none') {
                    japaneseOverlay.classList.add(`effect-${dynamicEffect}`);
                }
            }
            if (typeof updateCanvasText === 'function') {
                updateCanvasText();
            }
        });
    }

    // ì¼ë³¸ì–´ ìë§‰ ë™ì  íš¨ê³¼
    const japaneseDynamicEffect = document.getElementById('overlay-japanese-dynamic-effect');
    if (japaneseDynamicEffect) {
        japaneseDynamicEffect.addEventListener('change', function() {
            const japaneseOverlay = document.getElementById('japanese-subtitle-overlay');
            if (japaneseOverlay && !japaneseOverlay.classList.contains('empty')) {
                // ê¸°ì¡´ íš¨ê³¼ ì œê±°
                japaneseOverlay.className = 'custom-subtitle-overlay';
                japaneseOverlay.setAttribute('data-lang', 'japanese');
                japaneseOverlay.setAttribute('lang', 'ja');

                // ì •ì  íš¨ê³¼ ë‹¤ì‹œ ì¶”ê°€
                const staticEffect = document.getElementById('overlay-japanese-static-effect')?.value;
                if (staticEffect && staticEffect !== 'none') {
                    japaneseOverlay.classList.add(`effect-${staticEffect}`);
                }

                // ìƒˆ ë™ì  íš¨ê³¼ ì ìš©
                if (this.value && this.value !== 'none') {
                    japaneseOverlay.classList.add(`effect-${this.value}`);
                }
            }
            if (typeof updateCanvasText === 'function') {
                updateCanvasText();
            }
        });
    }

    // í•œê¸€ ìë§‰ í¬ê¸° ìŠ¬ë¼ì´ë”
    const koreanSize = document.getElementById('overlay-korean-size');
    if (koreanSize) {
        koreanSize.addEventListener('input', function() {
            const sizeValue = this.value + 'px';
            document.getElementById('korean-size-display').textContent = sizeValue;

            // ì£¼ìë§‰ ì˜¤ë²„ë ˆì´ì— ì‹¤ì‹œê°„ ì ìš©
            const koreanOverlay = document.getElementById('korean-subtitle-overlay');
            if (koreanOverlay && !koreanOverlay.classList.contains('empty')) {
                koreanOverlay.style.fontSize = sizeValue;
            }

            // Canvasì—ë„ ë™ê¸°í™”
            if (typeof updateCanvasText === 'function') {
                updateCanvasText();
            }
        });
    }

    // í•œê¸€ ìë§‰ ìƒ‰ìƒ
    const koreanColor = document.getElementById('overlay-korean-color');
    if (koreanColor) {
        koreanColor.addEventListener('input', function() {
            const koreanOverlay = document.getElementById('korean-subtitle-overlay');
            if (koreanOverlay && !koreanOverlay.classList.contains('empty')) {
                koreanOverlay.style.color = this.value;
            }
            if (typeof updateCanvasText === 'function') {
                updateCanvasText();
            }
        });
    }

    // í•œê¸€ ìë§‰ X ìœ„ì¹˜
    const koreanX = document.getElementById('overlay-korean-x');
    if (koreanX) {
        koreanX.addEventListener('input', function() {
            const koreanOverlay = document.getElementById('korean-subtitle-overlay');
            if (koreanOverlay && !koreanOverlay.classList.contains('empty')) {
                koreanOverlay.style.left = this.value + '%';
            }
            if (typeof updateCanvasText === 'function') {
                updateCanvasText();
            }
        });
    }

    // í•œê¸€ ìë§‰ Y ìœ„ì¹˜
    const koreanY = document.getElementById('overlay-korean-y');
    if (koreanY) {
        koreanY.addEventListener('input', function() {
            const koreanOverlay = document.getElementById('korean-subtitle-overlay');
            if (koreanOverlay && !koreanOverlay.classList.contains('empty')) {
                koreanOverlay.style.top = this.value + '%';
            }
            if (typeof updateCanvasText === 'function') {
                updateCanvasText();
            }
        });
    }

    // í•œê¸€ ìë§‰ ì •ì  íš¨ê³¼
    const koreanStaticEffect = document.getElementById('overlay-korean-static-effect');
    if (koreanStaticEffect) {
        koreanStaticEffect.addEventListener('change', function() {
            const koreanOverlay = document.getElementById('korean-subtitle-overlay');
            if (koreanOverlay && !koreanOverlay.classList.contains('empty')) {
                // ê¸°ì¡´ íš¨ê³¼ ì œê±°
                koreanOverlay.className = 'custom-subtitle-overlay';
                const lang = koreanOverlay.getAttribute('data-lang') || 'korean';
                koreanOverlay.setAttribute('data-lang', lang);

                // ìƒˆ íš¨ê³¼ ì ìš©
                if (this.value && this.value !== 'none') {
                    koreanOverlay.classList.add(`effect-${this.value}`);
                }

                // ë™ì  íš¨ê³¼ë„ ë‹¤ì‹œ ì¶”ê°€
                const dynamicEffect = document.getElementById('overlay-korean-dynamic-effect')?.value;
                if (dynamicEffect && dynamicEffect !== 'none') {
                    koreanOverlay.classList.add(`effect-${dynamicEffect}`);
                }
            }
            if (typeof updateCanvasText === 'function') {
                updateCanvasText();
            }
        });
    }

    // í•œê¸€ ìë§‰ ë™ì  íš¨ê³¼
    const koreanDynamicEffect = document.getElementById('overlay-korean-dynamic-effect');
    if (koreanDynamicEffect) {
        koreanDynamicEffect.addEventListener('change', function() {
            const koreanOverlay = document.getElementById('korean-subtitle-overlay');
            if (koreanOverlay && !koreanOverlay.classList.contains('empty')) {
                // ê¸°ì¡´ íš¨ê³¼ ì œê±°
                koreanOverlay.className = 'custom-subtitle-overlay';
                const lang = koreanOverlay.getAttribute('data-lang') || 'korean';
                koreanOverlay.setAttribute('data-lang', lang);

                // ì •ì  íš¨ê³¼ ë‹¤ì‹œ ì¶”ê°€
                const staticEffect = document.getElementById('overlay-korean-static-effect')?.value;
                if (staticEffect && staticEffect !== 'none') {
                    koreanOverlay.classList.add(`effect-${staticEffect}`);
                }

                // ìƒˆ ë™ì  íš¨ê³¼ ì ìš©
                if (this.value && this.value !== 'none') {
                    koreanOverlay.classList.add(`effect-${this.value}`);
                }
            }
            if (typeof updateCanvasText === 'function') {
                updateCanvasText();
            }
        });
    }

    // ì˜ì–´ ìë§‰ í¬ê¸° ìŠ¬ë¼ì´ë”
    const englishSize = document.getElementById('overlay-english-size');
    if (englishSize) {
        englishSize.addEventListener('input', function() {
            const sizeValue = this.value + 'px';
            document.getElementById('english-size-display').textContent = sizeValue;

            // ë³´ì¡°ìë§‰ ì˜¤ë²„ë ˆì´ì— ì‹¤ì‹œê°„ ì ìš©
            const englishOverlay = document.getElementById('english-subtitle-overlay');
            if (englishOverlay && !englishOverlay.classList.contains('empty')) {
                englishOverlay.style.fontSize = sizeValue;
            }

            // Canvasì—ë„ ë™ê¸°í™”
            if (typeof updateCanvasText === 'function') {
                updateCanvasText();
            }
        });
    }

    // ì˜ì–´ ìë§‰ ìƒ‰ìƒ
    const englishColor = document.getElementById('overlay-english-color');
    if (englishColor) {
        englishColor.addEventListener('input', function() {
            const englishOverlay = document.getElementById('english-subtitle-overlay');
            if (englishOverlay && !englishOverlay.classList.contains('empty')) {
                englishOverlay.style.color = this.value;
            }
            if (typeof updateCanvasText === 'function') {
                updateCanvasText();
            }
        });
    }

    // ì˜ì–´ ìë§‰ X ìœ„ì¹˜
    const englishX = document.getElementById('overlay-english-x');
    if (englishX) {
        englishX.addEventListener('input', function() {
            const englishOverlay = document.getElementById('english-subtitle-overlay');
            if (englishOverlay && !englishOverlay.classList.contains('empty')) {
                englishOverlay.style.left = this.value + '%';
            }
            if (typeof updateCanvasText === 'function') {
                updateCanvasText();
            }
        });
    }

    // ì˜ì–´ ìë§‰ Y ìœ„ì¹˜
    const englishY = document.getElementById('overlay-english-y');
    if (englishY) {
        englishY.addEventListener('input', function() {
            const englishOverlay = document.getElementById('english-subtitle-overlay');
            if (englishOverlay && !englishOverlay.classList.contains('empty')) {
                englishOverlay.style.top = this.value + '%';
            }
            if (typeof updateCanvasText === 'function') {
                updateCanvasText();
            }
        });
    }

    // ì˜ì–´ ìë§‰ ì •ì  íš¨ê³¼
    const englishStaticEffect = document.getElementById('overlay-english-static-effect');
    if (englishStaticEffect) {
        englishStaticEffect.addEventListener('change', function() {
            const englishOverlay = document.getElementById('english-subtitle-overlay');
            if (englishOverlay && !englishOverlay.classList.contains('empty')) {
                // ê¸°ì¡´ íš¨ê³¼ ì œê±°
                englishOverlay.className = 'custom-subtitle-overlay';
                const lang = englishOverlay.getAttribute('data-lang') || 'english';
                englishOverlay.setAttribute('data-lang', lang);

                // ìƒˆ íš¨ê³¼ ì ìš©
                if (this.value && this.value !== 'none') {
                    englishOverlay.classList.add(`effect-${this.value}`);
                }

                // ë™ì  íš¨ê³¼ë„ ë‹¤ì‹œ ì¶”ê°€
                const dynamicEffect = document.getElementById('overlay-english-dynamic-effect')?.value;
                if (dynamicEffect && dynamicEffect !== 'none') {
                    englishOverlay.classList.add(`effect-${dynamicEffect}`);
                }
            }
            if (typeof updateCanvasText === 'function') {
                updateCanvasText();
            }
        });
    }

    // ì˜ì–´ ìë§‰ ë™ì  íš¨ê³¼
    const englishDynamicEffect = document.getElementById('overlay-english-dynamic-effect');
    if (englishDynamicEffect) {
        englishDynamicEffect.addEventListener('change', function() {
            const englishOverlay = document.getElementById('english-subtitle-overlay');
            if (englishOverlay && !englishOverlay.classList.contains('empty')) {
                // ê¸°ì¡´ íš¨ê³¼ ì œê±°
                englishOverlay.className = 'custom-subtitle-overlay';
                const lang = englishOverlay.getAttribute('data-lang') || 'english';
                englishOverlay.setAttribute('data-lang', lang);

                // ì •ì  íš¨ê³¼ ë‹¤ì‹œ ì¶”ê°€
                const staticEffect = document.getElementById('overlay-english-static-effect')?.value;
                if (staticEffect && staticEffect !== 'none') {
                    englishOverlay.classList.add(`effect-${staticEffect}`);
                }

                // ìƒˆ ë™ì  íš¨ê³¼ ì ìš©
                if (this.value && this.value !== 'none') {
                    englishOverlay.classList.add(`effect-${this.value}`);
                }
            }
            if (typeof updateCanvasText === 'function') {
                updateCanvasText();
            }
        });
    }

    // ì¶œì²˜ í¬ê¸° ìŠ¬ë¼ì´ë”
    const sourceSize = document.getElementById('overlay-source-size');
    if (sourceSize) {
        sourceSize.addEventListener('input', function() {
            document.getElementById('source-size-display').textContent = this.value + 'px';
        });
    }

    // ìë§‰ ë“œë˜ê·¸ ì´ˆê¸°í™”
    initSubtitleDragging();

    // ì¶œì²˜ ì˜¤ë²„ë ˆì´ ìˆ¨ê¸°ê¸° ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸
    const sourceHideCheckbox = document.getElementById('source-overlay-hide');
    const sourceOverlay = document.getElementById('source-overlay');

    if (sourceHideCheckbox && sourceOverlay) {
        sourceHideCheckbox.addEventListener('change', function() {
            if (this.checked) {
                sourceOverlay.style.display = 'none';
            } else {
                sourceOverlay.style.display = 'block';
            }
        });
    }
});

// ìë§‰ ë¯¸ë¦¬ë³´ê¸° í•¨ìˆ˜
async function previewSubtitle(subtitlePath, videoName) {
    try {
        // ìë§‰ íŒŒì¼ ì½ê¸°
        const response = await fetch(`/api/video-analyzer/read-subtitle?path=${encodeURIComponent(subtitlePath)}`);

        if (!response.ok) {
            throw new Error('ìë§‰ íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }

        const data = await response.json();

        // ëª¨ë‹¬ í‘œì‹œ
        showSubtitleModal(data.subtitles, videoName, data.count);

    } catch (error) {
        console.error('ìë§‰ ë¯¸ë¦¬ë³´ê¸° ì˜¤ë¥˜:', error);
        alert('ìë§‰ ë¯¸ë¦¬ë³´ê¸° ì‹¤íŒ¨: ' + error.message);
    }
}

// ìë§‰ ëª¨ë‹¬ í‘œì‹œ
function showSubtitleModal(subtitles, videoName, count) {
    const modal = document.getElementById('subtitle-preview-modal');
    const titleEl = document.getElementById('subtitle-modal-title');
    const countEl = document.getElementById('subtitle-modal-count');
    const contentEl = document.getElementById('subtitle-modal-content');

    titleEl.textContent = videoName;
    countEl.textContent = `ì´ ${count}ê°œì˜ ìë§‰`;

    // ìë§‰ ë‚´ìš© HTML ìƒì„±
    let html = '';
    subtitles.forEach(sub => {
        html += `
            <div class="subtitle-preview-item">
                <div class="subtitle-preview-time">${sub.start} â†’ ${sub.end}</div>
                <div class="subtitle-preview-text">${sub.text}</div>
            </div>
        `;
    });

    contentEl.innerHTML = html;
    modal.style.display = 'flex';
}

// ìë§‰ ëª¨ë‹¬ ë‹«ê¸°
function closeSubtitleModal() {
    const modal = document.getElementById('subtitle-preview-modal');
    modal.style.display = 'none';
}

// ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
window.addEventListener('click', (event) => {
    const modal = document.getElementById('subtitle-preview-modal');
    if (event.target === modal) {
        closeSubtitleModal();
    }
});

</script>

<!-- ìë§‰ ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ -->
<div id="subtitle-preview-modal" class="subtitle-modal" style="display: none;">
    <div class="subtitle-modal-content">
        <div class="subtitle-modal-header">
            <h2 style="margin: 0; color: #fff;">ğŸ“Œ ì œëª©ìë§‰ ë¯¸ë¦¬ë³´ê¸°</h2>
            <button onclick="closeSubtitleModal()" class="subtitle-modal-close">&times;</button>
        </div>
        <div class="subtitle-modal-info">
            <div style="font-size: 1.1rem; font-weight: bold; color: #10b981;" id="subtitle-modal-title"></div>
            <div style="color: #10b981; font-size: 0.9rem;" id="subtitle-modal-count"></div>
        </div>
        <div class="subtitle-modal-body" id="subtitle-modal-content">
            <!-- ìë§‰ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
        </div>
    </div>
</div>

<style>
.subtitle-modal {
    display: none;
    position: fixed;
    z-index: 10000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    align-items: center;
    justify-content: center;
}

.subtitle-modal-content {
    background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
    border-radius: 12px;
    width: 90%;
    max-width: 800px;
    max-height: 85vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.subtitle-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 25px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.subtitle-modal-info {
    padding: 15px 25px;
    background: rgba(0, 0, 0, 0.2);
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}

.subtitle-modal-close {
    background: none;
    border: none;
    color: #fff;
    font-size: 2rem;
    cursor: pointer;
    padding: 0;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.2s;
}

.subtitle-modal-close:hover {
    background: rgba(239, 68, 68, 0.2);
    color: #ef4444;
}

.subtitle-modal-body {
    padding: 20px 25px;
    overflow-y: auto;
    max-height: calc(85vh - 200px);
}

.subtitle-preview-item {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 12px;
    border-left: 3px solid #10b981;
    transition: all 0.2s;
}

.subtitle-preview-item:hover {
    background: rgba(255, 255, 255, 0.08);
    transform: translateX(5px);
}

.subtitle-preview-time {
    color: #10b981;
    font-size: 0.85rem;
    font-weight: bold;
    margin-bottom: 8px;
    font-family: 'Courier New', monospace;
}

.subtitle-preview-text {
    color: #10b981;
    font-size: 1rem;
    line-height: 1.6;
    white-space: pre-wrap;
}

/* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ë§ */
.subtitle-modal-body::-webkit-scrollbar {
    width: 8px;
}

.subtitle-modal-body::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 4px;
}

.subtitle-modal-body::-webkit-scrollbar-thumb {
    background: rgba(16, 185, 129, 0.5);
    border-radius: 4px;
}

.subtitle-modal-body::-webkit-scrollbar-thumb:hover {
    background: rgba(16, 185, 129, 0.7);
}

/* ì§„í–‰ë¥  ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
#progress-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    z-index: 10000;
    justify-content: center;
    align-items: center;
}

.progress-modal-content {
    background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
    padding: 40px;
    border-radius: 16px;
    width: 500px;
    max-width: 90%;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    border: 1px solid rgba(16, 185, 129, 0.3);
}

.progress-modal-header {
    text-align: center;
    margin-bottom: 30px;
}

.progress-modal-header h3 {
    color: #10b981;
    font-size: 24px;
    margin: 0 0 10px 0;
}

.progress-modal-header p {
    color: #94a3b8;
    font-size: 14px;
    margin: 0;
}

.progress-bar-container {
    width: 100%;
    height: 30px;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 15px;
    overflow: hidden;
    margin-bottom: 15px;
    position: relative;
    border: 1px solid rgba(16, 185, 129, 0.2);
}

.progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #10b981 0%, #34d399 100%);
    border-radius: 15px;
    transition: width 0.3s ease;
    position: relative;
    overflow: hidden;
}

.progress-bar::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    bottom: 0;
    right: 0;
    background: linear-gradient(
        90deg,
        transparent 0%,
        rgba(255, 255, 255, 0.3) 50%,
        transparent 100%
    );
    animation: shimmer 2s infinite;
}

@keyframes shimmer {
    0% {
        transform: translateX(-100%);
    }
    100% {
        transform: translateX(100%);
    }
}

.progress-text {
    text-align: center;
    color: #e0e6ed;
    font-size: 18px;
    font-weight: bold;
    margin-bottom: 10px;
}

.progress-message {
    text-align: center;
    color: #94a3b8;
    font-size: 14px;
    min-height: 20px;
}

.progress-spinner {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid rgba(16, 185, 129, 0.3);
    border-top-color: #10b981;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-right: 8px;
    vertical-align: middle;
}

@keyframes spin {
    to {
        transform: rotate(360deg);
    }
}
</style>

<!-- ì§„í–‰ë¥  ëª¨ë‹¬ -->
<div id="progress-modal">
    <div class="progress-modal-content">
        <div class="progress-modal-header">
            <h3>ğŸ¬ í”„ë¦¬ë·° ì˜ìƒ ìƒì„± ì¤‘</h3>
            <p>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</p>
        </div>
        <div class="progress-text" id="progress-percentage">0%</div>
        <div class="progress-bar-container">
            <div class="progress-bar" id="progress-bar" style="width: 0%;"></div>
        </div>
        <div class="progress-message">
            <span class="progress-spinner"></span>
            <span id="progress-message">ì´ˆê¸°í™” ì¤‘...</span>
        </div>
    </div>
</div>

<script>
// ë¡œë“œëœ ë¯¸ë””ì–´ íŒŒì¼ ì •ë³´ ì €ì¥
const loadedMedia = {
    video: null,
    audio: null,
    commentary: null,
    bgm: null
};

const AUDIO_TRACK_TYPES = ['audio', 'commentary', 'bgm'];
let audioSyncInitialized = false;
let currentAudioSelection = null;

// ë¡œë“œëœ ìë§‰ ë°ì´í„°
const loadedSubtitles = {
    main: [],
    translation: [],
    description: []
};

// ë¡œë“œëœ ìë§‰ íŒŒì¼ëª… ì €ì¥
const loadedSubtitleFiles = {
    main: null,
    translation: null,
    description: null
};

// A-B ë°˜ë³µ ì¬ìƒ ìƒíƒœ
const abRepeat = {
    pointA: null,
    pointB: null,
    enabled: false
};

// ìë§‰ íŒŒì¼ëª… í‘œì‹œ ì—…ë°ì´íŠ¸
function updateSubtitleFileDisplay() {
    const displayElement = document.getElementById('loaded-subtitle-files');
    if (!displayElement) return;

    const trackNames = {
        main: 'ë©”ì¸',
        translation: 'ë²ˆì—­',
        description: 'ì„¤ëª…'
    };

    const loadedFiles = [];
    for (const [trackType, fileName] of Object.entries(loadedSubtitleFiles)) {
        if (fileName) {
            loadedFiles.push(`${trackNames[trackType]}: ${fileName}`);
        }
    }

    if (loadedFiles.length > 0) {
        displayElement.textContent = `(${loadedFiles.join(', ')})`;
    } else {
        displayElement.textContent = '';
    }
}

// IndexedDB ì´ˆê¸°í™”
let db;
const DB_NAME = 'VideoAnalyzerDB';
const DB_VERSION = 1;
const STORE_NAME = 'mediaFiles';

function initIndexedDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);

        request.onerror = () => {
            console.error('IndexedDB ì—´ê¸° ì‹¤íŒ¨:', request.error);
            reject(request.error);
        };

        request.onsuccess = () => {
            db = request.result;
            console.log('IndexedDB ì´ˆê¸°í™” ì™„ë£Œ');
            resolve(db);
        };

        request.onupgradeneeded = (event) => {
            db = event.target.result;

            // Object Store ìƒì„±
            if (!db.objectStoreNames.contains(STORE_NAME)) {
                const objectStore = db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                objectStore.createIndex('type', 'type', { unique: false });
                console.log('Object Store ìƒì„± ì™„ë£Œ');
            }
        };
    });
}

// íŒŒì¼ì„ IndexedDBì— ì €ì¥
function saveFileToIndexedDB(id, type, file, metadata = {}) {
    return new Promise((resolve, reject) => {
        if (!db) {
            reject('IndexedDBê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            return;
        }

        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const objectStore = transaction.objectStore(STORE_NAME);

        const data = {
            id: id,
            type: type,
            file: file,
            metadata: metadata,
            timestamp: Date.now()
        };

        const request = objectStore.put(data);

        request.onsuccess = () => {
            console.log(`íŒŒì¼ ì €ì¥ ì™„ë£Œ: ${id} (${type})`);
            resolve();
        };

        request.onerror = () => {
            console.error('íŒŒì¼ ì €ì¥ ì‹¤íŒ¨:', request.error);
            reject(request.error);
        };
    });
}

// IndexedDBì—ì„œ íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°
function loadFileFromIndexedDB(id) {
    return new Promise((resolve, reject) => {
        if (!db) {
            reject('IndexedDBê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            return;
        }

        const transaction = db.transaction([STORE_NAME], 'readonly');
        const objectStore = transaction.objectStore(STORE_NAME);
        const request = objectStore.get(id);

        request.onsuccess = () => {
            if (request.result) {
                console.log(`íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ: ${id}`);
                resolve(request.result);
            } else {
                resolve(null);
            }
        };

        request.onerror = () => {
            console.error('íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', request.error);
            reject(request.error);
        };
    });
}

// IndexedDBì—ì„œ íŠ¹ì • íƒ€ì…ì˜ ëª¨ë“  íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°
function loadAllFilesByType(type) {
    return new Promise((resolve, reject) => {
        if (!db) {
            reject('IndexedDBê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            return;
        }

        const transaction = db.transaction([STORE_NAME], 'readonly');
        const objectStore = transaction.objectStore(STORE_NAME);
        const index = objectStore.index('type');
        const request = index.getAll(type);

        request.onsuccess = () => {
            console.log(`${type} íƒ€ì… íŒŒì¼ ${request.result.length}ê°œ ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ`);
            resolve(request.result);
        };

        request.onerror = () => {
            console.error('íŒŒì¼ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', request.error);
            reject(request.error);
        };
    });
}

// ì €ì¥ëœ íŒŒì¼ë“¤ì„ ë³µì›í•˜ëŠ” í•¨ìˆ˜
async function restoreSavedFiles() {
    try {
        console.log('ğŸ”„ ì €ì¥ëœ íŒŒì¼ ë³µì› ì‹œì‘...');

        let restoredCount = 0;
        const errors = [];

        // ë¹„ë””ì˜¤ íŒŒì¼ ë³µì›
        try {
            const videoData = await loadFileFromIndexedDB('video');
            if (videoData && videoData.file) {
                console.log('ğŸ“¹ ë¹„ë””ì˜¤ íŒŒì¼ ë³µì›:', videoData.metadata.fileName);
                const file = new File([videoData.file], videoData.metadata.fileName, { type: videoData.file.type });
                await handleVideoFileLoad(file, true); // silent ëª¨ë“œ
                restoredCount++;
                console.log('âœ… ë¹„ë””ì˜¤ íŒŒì¼ ë³µì› ì„±ê³µ');

                // ë¹„ë””ì˜¤ ë¯¸ë¦¬ë³´ê¸° ì„¹ì…˜ í‘œì‹œ
                const previewSection = document.getElementById('video-preview-section');
                if (previewSection) {
                    previewSection.style.display = 'block';
                    console.log('ğŸ“º ë¹„ë””ì˜¤ ë¯¸ë¦¬ë³´ê¸° ì„¹ì…˜ í‘œì‹œë¨');
                }
            } else {
                console.log('â„¹ï¸ ì €ì¥ëœ ë¹„ë””ì˜¤ íŒŒì¼ ì—†ìŒ');
            }
        } catch (error) {
            console.error('âŒ ë¹„ë””ì˜¤ íŒŒì¼ ë³µì› ì‹¤íŒ¨:', error);
            errors.push(`ë¹„ë””ì˜¤: ${error.message || error}`);
        }

        // ë©”ì¸ ìë§‰ íŒŒì¼ ë³µì›
        try {
            const mainData = await loadFileFromIndexedDB('main-subtitle');
            if (mainData && mainData.file) {
                console.log('ğŸ“ ë©”ì¸ ìë§‰ íŒŒì¼ ë³µì›:', mainData.metadata.fileName);
                const file = new File([mainData.file], mainData.metadata.fileName, { type: 'text/plain' });
                // íƒ€ì„ë¼ì¸ íŠ¸ë™ìœ¼ë¡œ ë³µì›
                handleSubtitleFileLoad(file, 'main');
                restoredCount++;
                console.log('âœ… ë©”ì¸ ìë§‰ íŒŒì¼ ë³µì› ì„±ê³µ');
            } else {
                console.log('â„¹ï¸ ì €ì¥ëœ ë©”ì¸ ìë§‰ íŒŒì¼ ì—†ìŒ');
            }
        } catch (error) {
            console.error('âŒ ë©”ì¸ ìë§‰ íŒŒì¼ ë³µì› ì‹¤íŒ¨:', error);
            errors.push(`ë©”ì¸ ìë§‰: ${error.message || error}`);
        }

        // ì£¼ìë§‰ íŒŒì¼ ë³µì›
        try {
            const translationData = await loadFileFromIndexedDB('translation-subtitle');
            if (translationData && translationData.file) {
                console.log('ğŸ“ ì£¼ìë§‰ íŒŒì¼ ë³µì›:', translationData.metadata.fileName);
                const file = new File([translationData.file], translationData.metadata.fileName, { type: 'text/plain' });
                // íƒ€ì„ë¼ì¸ íŠ¸ë™ìœ¼ë¡œ ë³µì›
                handleSubtitleFileLoad(file, 'translation');
                restoredCount++;
                console.log('âœ… ì£¼ìë§‰ íŒŒì¼ ë³µì› ì„±ê³µ');
            } else {
                console.log('â„¹ï¸ ì €ì¥ëœ ì£¼ìë§‰ íŒŒì¼ ì—†ìŒ');
            }
        } catch (error) {
            console.error('âŒ ì£¼ìë§‰ íŒŒì¼ ë³µì› ì‹¤íŒ¨:', error);
            errors.push(`ì£¼ìë§‰: ${error.message || error}`);
        }

        // ë³´ì¡°ìë§‰ íŒŒì¼ ë³µì›
        try {
            const descriptionData = await loadFileFromIndexedDB('description-subtitle');
            if (descriptionData && descriptionData.file) {
                console.log('ğŸ“ ë³´ì¡°ìë§‰ íŒŒì¼ ë³µì›:', descriptionData.metadata.fileName);
                const file = new File([descriptionData.file], descriptionData.metadata.fileName, { type: 'text/plain' });
                // íƒ€ì„ë¼ì¸ íŠ¸ë™ìœ¼ë¡œ ë³µì›
                handleSubtitleFileLoad(file, 'description');
                restoredCount++;
                console.log('âœ… ë³´ì¡°ìë§‰ íŒŒì¼ ë³µì› ì„±ê³µ');
            } else {
                console.log('â„¹ï¸ ì €ì¥ëœ ë³´ì¡°ìë§‰ íŒŒì¼ ì—†ìŒ');
            }
        } catch (error) {
            console.error('âŒ ë³´ì¡°ìë§‰ íŒŒì¼ ë³µì› ì‹¤íŒ¨:', error);
            errors.push(`ë³´ì¡°ìë§‰: ${error.message || error}`);
        }

        // ì˜¤ë””ì˜¤ íŠ¸ë™ ë³µì› (audio, commentary, bgm)
        for (const trackType of ['audio', 'commentary', 'bgm']) {
            try {
                const audioData = await loadFileFromIndexedDB(trackType);
                if (audioData && audioData.file) {
                    console.log(`ğŸµ ${trackType} íŒŒì¼ ë³µì›:`, audioData.metadata.fileName);
                    const file = new File([audioData.file], audioData.metadata.fileName, { type: audioData.file.type });
                    await handleAudioFileLoad(file, trackType);
                    restoredCount++;
                    console.log(`âœ… ${trackType} íŒŒì¼ ë³µì› ì„±ê³µ`);
                } else {
                    console.log(`â„¹ï¸ ì €ì¥ëœ ${trackType} íŒŒì¼ ì—†ìŒ`);
                }
            } catch (error) {
                console.error(`âŒ ${trackType} íŒŒì¼ ë³µì› ì‹¤íŒ¨:`, error);
                errors.push(`${trackType}: ${error.message || error}`);
            }
        }

        // ê²°ê³¼ ë©”ì‹œì§€ í‘œì‹œ
        if (restoredCount > 0 || errors.length > 0) {
            const statusMsg = document.createElement('div');
            statusMsg.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${errors.length > 0 ? '#ef4444' : '#10b981'};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                font-weight: bold;
                max-width: 300px;
            `;

            if (restoredCount > 0) {
                statusMsg.textContent = `âœ… ${restoredCount}ê°œ íŒŒì¼ ë³µì›ë¨`;
                console.log(`âœ… íŒŒì¼ ë³µì› ì™„ë£Œ (${restoredCount}ê°œ)`);
            }

            if (errors.length > 0) {
                statusMsg.innerHTML = `âŒ ë³µì› ì˜¤ë¥˜<br><small>${errors.join('<br>')}</small>`;
                console.error('âŒ ë³µì› ì˜¤ë¥˜:', errors);
            }

            document.body.appendChild(statusMsg);
            setTimeout(() => statusMsg.remove(), 5000);
        } else {
            console.log('â„¹ï¸ ë³µì›í•  íŒŒì¼ ì—†ìŒ');
        }
    } catch (error) {
        console.error('âŒ íŒŒì¼ ë³µì› ì¤‘ ì¹˜ëª…ì  ì˜¤ë¥˜:', error);
        alert(`íŒŒì¼ ë³µì› ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message || error}`);
    }
}

// íŒŒì¼ ë¡œë“œ ê¸°ëŠ¥ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', async function() {
    // IndexedDB ì´ˆê¸°í™”
    try {
        await initIndexedDB();
        console.log('âœ… IndexedDB ì´ˆê¸°í™” ì„±ê³µ');

        // ì €ì¥ëœ íŒŒì¼ ë³µì›
        await restoreSavedFiles();
    } catch (error) {
        console.error('âŒ IndexedDB ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
    }

    // í…ìŠ¤íŠ¸ ì˜¤ë²„ë ˆì´ ì„¤ì • ìë™ ë³µì›
    try {
        const saved = localStorage.getItem('videoAnalyzerTextOverlay');
        if (saved) {
            const settings = JSON.parse(saved);
            console.log('ğŸ”„ í…ìŠ¤íŠ¸ ì˜¤ë²„ë ˆì´ ì„¤ì • ë³µì› ì¤‘...');

            // ì„¤ì •ì„ ë³µì›í•˜ì§€ë§Œ ì‹¤ì œ ì˜¤ë²„ë ˆì´ëŠ” ì˜ìƒ ë¡œë“œ í›„ì—ë§Œ ì ìš©
            // ì…ë ¥ í•„ë“œ ê°’ë§Œ ë³µì›
            if (settings.title) {
                const titleInput = document.getElementById('overlay-title-input');
                const titleSize = document.getElementById('overlay-title-size');
                const titleColor = document.getElementById('overlay-title-color');
                if (titleInput) titleInput.value = settings.title.text || '';
                if (titleSize) {
                    titleSize.value = settings.title.size || 48;
                    const titleSizeDisplay = document.getElementById('title-size-display');
                    if (titleSizeDisplay) titleSizeDisplay.textContent = (settings.title.size || 48) + 'px';
                }
                if (titleColor) titleColor.value = settings.title.color || '#ffffff';
            }

            if (settings.subtitle) {
                const subtitleInput = document.getElementById('overlay-subtitle-input');
                const subtitleSize = document.getElementById('overlay-subtitle-size');
                const subtitleColor = document.getElementById('overlay-subtitle-color');
                if (subtitleInput) subtitleInput.value = settings.subtitle.text || '';
                if (subtitleSize) {
                    subtitleSize.value = settings.subtitle.size || 32;
                    const subtitleSizeDisplay = document.getElementById('subtitle-size-display');
                    if (subtitleSizeDisplay) subtitleSizeDisplay.textContent = (settings.subtitle.size || 32) + 'px';
                }
                if (subtitleColor) subtitleColor.value = settings.subtitle.color || '#ffe14d';
            }

            // ê²€ì • ë°°ê²½ ì„¤ì • ë³µì›
            if (settings.blackBars) {
                if (settings.blackBars.top) {
                    const topEnable = document.getElementById('top-bar-enable');
                    const topHeight = document.getElementById('top-bar-height');
                    const topOpacity = document.getElementById('top-bar-opacity');
                    if (topEnable) topEnable.checked = settings.blackBars.top.enabled || false;
                    if (topHeight) topHeight.value = settings.blackBars.top.height || 15;
                    if (topOpacity) topOpacity.value = settings.blackBars.top.opacity || 70;
                }
                if (settings.blackBars.bottom) {
                    const bottomEnable = document.getElementById('bottom-bar-enable');
                    const bottomHeight = document.getElementById('bottom-bar-height');
                    const bottomOpacity = document.getElementById('bottom-bar-opacity');
                    if (bottomEnable) bottomEnable.checked = settings.blackBars.bottom.enabled || false;
                    if (bottomHeight) bottomHeight.value = settings.blackBars.bottom.height || 15;
                    if (bottomOpacity) bottomOpacity.value = settings.blackBars.bottom.opacity || 70;
                }
            }

            updateSettingsStatus(settings.name || 'ê¸°ë³¸ ì„¤ì •', settings.savedAt ? new Date(settings.savedAt) : null);
            console.log('âœ… í…ìŠ¤íŠ¸ ì˜¤ë²„ë ˆì´ ì„¤ì • ë³µì› ì™„ë£Œ');
        }
    } catch (error) {
        console.error('âŒ í…ìŠ¤íŠ¸ ì˜¤ë²„ë ˆì´ ì„¤ì • ë³µì› ì‹¤íŒ¨:', error);
    }

    // íƒ€ì„ë¼ì¸ ì¤Œ ë³€ê²½ ì´ë²¤íŠ¸
    const timelineZoom = document.getElementById('timeline-zoom');
    if (timelineZoom) {
        timelineZoom.addEventListener('input', function() {
            updateAllClipSizes();
        });
    }

    // ì˜ìƒ íŒŒì¼ ë¡œë“œ
    const videoFileInput = document.getElementById('video-file-input');
    if (videoFileInput) {
        videoFileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                handleVideoFileLoad(file).catch((error) => {
                    console.error('ì˜ìƒ íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨:', error);
                });
            }
        });
    }

    // ì œëª©/ë¶€ì œëª© ìˆ¨ê¸°ê¸° ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸
    const hideTitleCheckbox = document.getElementById('hide-title-overlay');
    const hideSubtitleCheckbox = document.getElementById('hide-subtitle-overlay');

    if (hideTitleCheckbox) {
        hideTitleCheckbox.addEventListener('change', function() {
            const titleOverlay = document.getElementById('video-title-overlay');
            if (titleOverlay) {
                titleOverlay.style.display = this.checked ? 'none' : 'block';
            }
        });
    }

    if (hideSubtitleCheckbox) {
        hideSubtitleCheckbox.addEventListener('change', function() {
            const subtitleOverlay = document.getElementById('video-subtitle-overlay');
            if (subtitleOverlay) {
                subtitleOverlay.style.display = this.checked ? 'none' : 'block';
            }
        });
    }

    // ìŒì„± íŒŒì¼ ë¡œë“œ
    const audioFileInput = document.getElementById('audio-file-input');
    if (audioFileInput) {
        audioFileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                handleAudioFileLoad(file, 'audio').catch((error) => {
                    console.error('ìŒì„± íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨:', error);
                });
            }
        });
    }

    // í•´ì„¤ ìŒì„± íŒŒì¼ ë¡œë“œ
    const commentaryFileInput = document.getElementById('commentary-file-input');
    if (commentaryFileInput) {
        commentaryFileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                handleAudioFileLoad(file, 'commentary').catch((error) => {
                    console.error('í•´ì„¤ ìŒì„± íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨:', error);
                });
            }
        });
    }

    // ë°°ê²½ ìŒì•… íŒŒì¼ ë¡œë“œ
    const bgmFileInput = document.getElementById('bgm-file-input');
    if (bgmFileInput) {
        bgmFileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                handleAudioFileLoad(file, 'bgm').catch((error) => {
                    console.error('ë°°ê²½ ìŒì•… íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨:', error);
                });
            }
        });
    }

    // ë©”ì¸ ìë§‰ íŒŒì¼ ë¡œë“œ
    const mainSubtitleInput = document.getElementById('main-subtitle-file-input');
    if (mainSubtitleInput) {
        mainSubtitleInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                handleSubtitleFileLoad(file, 'main');
            }
        });
    }

    // ì˜¤ë””ì˜¤ í¸ì§‘ ë²„íŠ¼ ë™ì‘
    document.querySelectorAll('[data-audio-action]').forEach((button) => {
        button.addEventListener('click', async function() {
            const action = this.dataset.audioAction;
            const trackType = this.dataset.track;
            if (!trackType || !action) {
                return;
            }

            if (action === 'clear-selection') {
                clearAudioSelection(trackType);
                return;
            }

            const originalText = this.textContent;
            this.disabled = true;
            this.textContent = 'â³ ì²˜ë¦¬ ì¤‘...';

            try {
                if (action === 'trim-to-video') {
                    await trimAudioToVideoLength(trackType);
                } else if (action === 'delete-from-selection') {
                    await deleteAudioFromSelection(trackType);
                }
            } catch (error) {
                console.error('ì˜¤ë””ì˜¤ í¸ì§‘ ì‘ì—… ì‹¤íŒ¨:', error);
            } finally {
                this.disabled = false;
                this.textContent = originalText;
            }
        });
    });

    updateAudioSelectionUI();

    // ì£¼ìë§‰ íŒŒì¼ ë¡œë“œ
    const translationSubtitleInput = document.getElementById('translation-subtitle-file-input');
    if (translationSubtitleInput) {
        translationSubtitleInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                handleSubtitleFileLoad(file, 'translation');
            }
        });
    }

    // ë³´ì¡°ìë§‰ íŒŒì¼ ë¡œë“œ
    const descriptionSubtitleInput = document.getElementById('description-subtitle-file-input');
    if (descriptionSubtitleInput) {
        descriptionSubtitleInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                handleSubtitleFileLoad(file, 'description');
            }
        });
    }

    attachAudioTrackToggleListeners();

    // ë¹ ë¥¸ ìë§‰ íŒŒì¼ ë¡œë“œ (ì œëª©ìë§‰ í¬í•¨ ì˜† ë²„íŠ¼)
    const quickSubtitleInput = document.getElementById('quick-subtitle-file-input');
    if (quickSubtitleInput) {
        quickSubtitleInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                handleSubtitleFileLoad(file, 'main');
                // ìë§‰ì„ ë¡œë“œí•˜ë©´ ìë™ìœ¼ë¡œ ì²´í¬ë°•ìŠ¤ ì²´í¬
                const checkbox = document.getElementById('include-title-subtitle');
                if (checkbox) {
                    checkbox.checked = true;
                }
            }
        });
    }

    // ì¬ìƒ ì»¨íŠ¸ë¡¤ ë²„íŠ¼ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
    const playPauseBtn = document.getElementById('play-pause-btn');
    const stopBtn = document.getElementById('stop-btn');
    const rewindBtn = document.getElementById('rewind-btn');
    const forwardBtn = document.getElementById('forward-btn');
    const skipToStartBtn = document.getElementById('skip-to-start-btn');
    const skipToEndBtn = document.getElementById('skip-to-end-btn');

    // ì¬ìƒ/ì¼ì‹œì •ì§€
    if (playPauseBtn) {
        playPauseBtn.addEventListener('click', function() {
            const videoPlayer = document.getElementById('video-preview-player');
            if (videoPlayer && videoPlayer.src) {
                if (videoPlayer.paused) {
                    videoPlayer.play();
                    playPauseBtn.textContent = 'â¸ï¸';
                } else {
                    videoPlayer.pause();
                    playPauseBtn.textContent = 'â–¶ï¸';
                }
            } else {
                alert('ì˜ìƒì„ ë¨¼ì € ë¡œë“œí•´ì£¼ì„¸ìš”.');
            }
        });
    }

    // ì •ì§€
    if (stopBtn) {
        stopBtn.addEventListener('click', function() {
            const videoPlayer = document.getElementById('video-preview-player');
            if (videoPlayer && videoPlayer.src) {
                videoPlayer.pause();
                videoPlayer.currentTime = 0;
                if (playPauseBtn) playPauseBtn.textContent = 'â–¶ï¸';
            }
        });
    }

    // ë˜ê°ê¸° (5ì´ˆ ë’¤ë¡œ)
    if (rewindBtn) {
        rewindBtn.addEventListener('click', function() {
            const videoPlayer = document.getElementById('video-preview-player');
            if (videoPlayer && videoPlayer.src) {
                videoPlayer.currentTime = Math.max(0, videoPlayer.currentTime - 5);
            }
        });
    }

    // ë¹¨ë¦¬ê°ê¸° (5ì´ˆ ì•ìœ¼ë¡œ)
    if (forwardBtn) {
        forwardBtn.addEventListener('click', function() {
            const videoPlayer = document.getElementById('video-preview-player');
            if (videoPlayer && videoPlayer.src) {
                videoPlayer.currentTime = Math.min(videoPlayer.duration, videoPlayer.currentTime + 5);
            }
        });
    }

    // ì²˜ìŒìœ¼ë¡œ
    if (skipToStartBtn) {
        skipToStartBtn.addEventListener('click', function() {
            const videoPlayer = document.getElementById('video-preview-player');
            if (videoPlayer && videoPlayer.src) {
                videoPlayer.currentTime = 0;
            }
        });
    }

    // ëìœ¼ë¡œ
    if (skipToEndBtn) {
        skipToEndBtn.addEventListener('click', function() {
            const videoPlayer = document.getElementById('video-preview-player');
            if (videoPlayer && videoPlayer.src) {
                videoPlayer.currentTime = videoPlayer.duration;
            }
        });
    }

    // ì¬ìƒ ì†ë„ ì¡°ì ˆ
    const playbackSpeedBtn = document.getElementById('playback-speed-btn');
    const playbackSpeeds = [0.25, 0.5, 0.75, 1.0, 1.25, 1.5, 1.75, 2.0];
    let currentSpeedIndex = 3; // 1.0x

    if (playbackSpeedBtn) {
        playbackSpeedBtn.addEventListener('click', function() {
            const videoPlayer = document.getElementById('video-preview-player');
            if (videoPlayer && videoPlayer.src) {
                // ë‹¤ìŒ ì†ë„ë¡œ ë³€ê²½
                currentSpeedIndex = (currentSpeedIndex + 1) % playbackSpeeds.length;
                const newSpeed = playbackSpeeds[currentSpeedIndex];
                videoPlayer.playbackRate = newSpeed;
                playbackSpeedBtn.textContent = `${newSpeed}x`;
                console.log('ì¬ìƒ ì†ë„ ë³€ê²½:', newSpeed);
            } else {
                alert('ì˜ìƒì„ ë¨¼ì € ë¡œë“œí•´ì£¼ì„¸ìš”.');
            }
        });
    }

    // A-B êµ¬ê°„ ë°˜ë³µ ì¬ìƒ
    const setPointABtn = document.getElementById('set-point-a-btn');
    const setPointBBtn = document.getElementById('set-point-b-btn');
    const toggleAbRepeatBtn = document.getElementById('toggle-ab-repeat-btn');

    // A ì§€ì  ì„¤ì •
    if (setPointABtn) {
        setPointABtn.addEventListener('click', function() {
            const videoPlayer = document.getElementById('video-preview-player');
            if (videoPlayer && videoPlayer.src) {
                abRepeat.pointA = videoPlayer.currentTime;
                const mins = Math.floor(abRepeat.pointA / 60);
                const secs = Math.floor(abRepeat.pointA % 60);
                setPointABtn.textContent = `ğŸ…°ï¸ ${mins}:${secs.toString().padStart(2, '0')}`;
                setPointABtn.style.background = '#10b981';
                console.log('A ì§€ì  ì„¤ì •:', abRepeat.pointA);
            } else {
                alert('ì˜ìƒì„ ë¨¼ì € ë¡œë“œí•´ì£¼ì„¸ìš”.');
            }
        });
    }

    // B ì§€ì  ì„¤ì •
    if (setPointBBtn) {
        setPointBBtn.addEventListener('click', function() {
            const videoPlayer = document.getElementById('video-preview-player');
            if (videoPlayer && videoPlayer.src) {
                abRepeat.pointB = videoPlayer.currentTime;
                const mins = Math.floor(abRepeat.pointB / 60);
                const secs = Math.floor(abRepeat.pointB % 60);
                setPointBBtn.textContent = `ğŸ…±ï¸ ${mins}:${secs.toString().padStart(2, '0')}`;
                setPointBBtn.style.background = '#f59e0b';
                console.log('B ì§€ì  ì„¤ì •:', abRepeat.pointB);

                // B ì§€ì  ì„¤ì • ì‹œ A ì§€ì ì´ ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ ë°˜ë³µ í™œì„±í™”
                if (abRepeat.pointA !== null && abRepeat.pointB > abRepeat.pointA) {
                    abRepeat.enabled = true;
                    toggleAbRepeatBtn.textContent = 'ğŸ” ON';
                    toggleAbRepeatBtn.style.background = '#ef4444';
                }
            } else {
                alert('ì˜ìƒì„ ë¨¼ì € ë¡œë“œí•´ì£¼ì„¸ìš”.');
            }
        });
    }

    // A-B ë°˜ë³µ í† ê¸€
    if (toggleAbRepeatBtn) {
        toggleAbRepeatBtn.addEventListener('click', function() {
            const videoPlayer = document.getElementById('video-preview-player');
            if (videoPlayer && videoPlayer.src) {
                if (abRepeat.pointA === null || abRepeat.pointB === null) {
                    alert('A ì§€ì ê³¼ B ì§€ì ì„ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”.');
                    return;
                }
                if (abRepeat.pointB <= abRepeat.pointA) {
                    alert('B ì§€ì ì€ A ì§€ì ë³´ë‹¤ ë’¤ì— ìˆì–´ì•¼ í•©ë‹ˆë‹¤.');
                    return;
                }

                abRepeat.enabled = !abRepeat.enabled;
                if (abRepeat.enabled) {
                    toggleAbRepeatBtn.textContent = 'ğŸ” ON';
                    toggleAbRepeatBtn.style.background = '#ef4444';
                    console.log('A-B ë°˜ë³µ í™œì„±í™”');
                } else {
                    toggleAbRepeatBtn.textContent = 'ğŸ” OFF';
                    toggleAbRepeatBtn.style.background = '#4a5568';
                    console.log('A-B ë°˜ë³µ ë¹„í™œì„±í™”');
                }
            } else {
                alert('ì˜ìƒì„ ë¨¼ì € ë¡œë“œí•´ì£¼ì„¸ìš”.');
            }
        });
    }

    // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
    document.addEventListener('keydown', function(e) {
        // input, textarea ë“±ì—ì„œëŠ” ë‹¨ì¶•í‚¤ ë¹„í™œì„±í™”
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
            return;
        }

        const videoPlayer = document.getElementById('video-preview-player');
        if (!videoPlayer || !videoPlayer.src) return;

        switch(e.code) {
            case 'Space': // ì¬ìƒ/ì¼ì‹œì •ì§€
                e.preventDefault();
                if (videoPlayer.paused) {
                    videoPlayer.play();
                    if (playPauseBtn) playPauseBtn.textContent = 'â¸ï¸';
                } else {
                    videoPlayer.pause();
                    if (playPauseBtn) playPauseBtn.textContent = 'â–¶ï¸';
                }
                break;

            case 'ArrowLeft': // 5ì´ˆ ë’¤ë¡œ
                e.preventDefault();
                videoPlayer.currentTime = Math.max(0, videoPlayer.currentTime - 5);
                break;

            case 'ArrowRight': // 5ì´ˆ ì•ìœ¼ë¡œ
                e.preventDefault();
                videoPlayer.currentTime = Math.min(videoPlayer.duration, videoPlayer.currentTime + 5);
                break;

            case 'Home': // ì²˜ìŒìœ¼ë¡œ
                e.preventDefault();
                videoPlayer.currentTime = 0;
                break;

            case 'End': // ëìœ¼ë¡œ
                e.preventDefault();
                videoPlayer.currentTime = videoPlayer.duration;
                break;
        }
    });
});

// ì˜ìƒ íŒŒì¼ ë¡œë“œ ì²˜ë¦¬
function handleVideoFileLoad(file, silent = false) {
    return new Promise((resolve, reject) => {
        console.log('ì˜ìƒ íŒŒì¼ ë¡œë“œ:', file.name);

        const url = URL.createObjectURL(file);
        const videoPlayer = document.getElementById('video-preview-player');

        if (!videoPlayer) {
            reject('ë¹„ë””ì˜¤ í”Œë ˆì´ì–´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        videoPlayer.src = url;
        videoPlayer.load();

        // ë¹„ë””ì˜¤ ë©”íƒ€ë°ì´í„°ê°€ ë¡œë“œë˜ë©´ íƒ€ì„ë¼ì¸ ì—…ë°ì´íŠ¸
        videoPlayer.addEventListener('loadedmetadata', async function() {
            try {
                const duration = videoPlayer.duration;
                console.log('ì˜ìƒ ê¸¸ì´:', duration, 'ì´ˆ');

                // ë¡œë“œëœ ë¯¸ë””ì–´ ì •ë³´ ì €ì¥
                loadedMedia.video = {
                    fileName: file.name,
                    duration: duration
                };

                // íƒ€ì„ë¼ì¸ì— ì˜ìƒ í´ë¦½ í‘œì‹œ
                displayVideoClipOnTimeline(file.name, duration);

                // ì¬ìƒ í—¤ë“œ í‘œì‹œ
                const playhead = document.getElementById('playhead');
                if (playhead) {
                    playhead.style.display = 'block';
                }

                // ì‹œê°„ í‘œì‹œ ë™ê¸°í™”
                initPlayheadSync();
                initAudioSync();
                syncAudioTrackVolume(videoPlayer);
                syncAudioTrackRate(videoPlayer);

                // IndexedDBì— íŒŒì¼ ì €ì¥ (ë³µì› ëª¨ë“œê°€ ì•„ë‹ ë•Œë§Œ)
                if (!silent) {
                    try {
                        await saveFileToIndexedDB('video', 'video', file, {
                            fileName: file.name,
                            duration: duration
                        });
                        console.log('âœ… ë¹„ë””ì˜¤ íŒŒì¼ì´ IndexedDBì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    } catch (error) {
                        console.error('âŒ ë¹„ë””ì˜¤ íŒŒì¼ ì €ì¥ ì‹¤íŒ¨:', error);
                    }

                    alert(`ì˜ìƒ íŒŒì¼ "${file.name}"ì´ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.\nê¸¸ì´: ${duration.toFixed(2)}ì´ˆ`);
                }

                resolve();
            } catch (error) {
                reject(error);
            }
        }, { once: true });

        // ì—ëŸ¬ ì²˜ë¦¬
        videoPlayer.addEventListener('error', function(e) {
            reject(`ë¹„ë””ì˜¤ ë¡œë“œ ì‹¤íŒ¨: ${e.message}`);
        }, { once: true });
    });
}

// ì¬ìƒ í—¤ë“œ ë™ê¸°í™” ì´ˆê¸°í™”
function initPlayheadSync() {
    const videoPlayer = document.getElementById('video-preview-player');
    const playhead = document.getElementById('playhead');
    const playheadTime = document.getElementById('playhead-time');
    const currentTimeDisplay = document.getElementById('current-time');
    const totalTimeDisplay = document.getElementById('total-time');

    if (!videoPlayer || !playhead) return;

    // ì‹œê°„ ì—…ë°ì´íŠ¸ ì´ë²¤íŠ¸
    videoPlayer.addEventListener('timeupdate', function() {
        const currentTime = videoPlayer.currentTime;
        const duration = videoPlayer.duration;

        // A-B êµ¬ê°„ ë°˜ë³µ ì²´í¬
        if (abRepeat.enabled && abRepeat.pointA !== null && abRepeat.pointB !== null) {
            if (currentTime >= abRepeat.pointB) {
                videoPlayer.currentTime = abRepeat.pointA;
                console.log('A-B ë°˜ë³µ: B ì§€ì  ë„ë‹¬, A ì§€ì ìœ¼ë¡œ ì´ë™');
            }
        }

        // ì¤Œ ë ˆë²¨ ê°€ì ¸ì˜¤ê¸°
        const zoomLevel = parseFloat(document.getElementById('timeline-zoom')?.value || 1);
        const pixelsPerSecond = 50 * zoomLevel;

        // ì¬ìƒ í—¤ë“œ ìœ„ì¹˜ ê³„ì‚° (íŠ¸ë™ í—¤ë” ë„ˆë¹„ 180px ì¶”ê°€)
        const leftPosition = 180 + (currentTime * pixelsPerSecond);
        playhead.style.left = leftPosition + 'px';

        // ì‹œê°„ í‘œì‹œ í¬ë§·íŒ…
        const formatTime = (seconds) => {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        };

        // ì¬ìƒ í—¤ë“œ ì‹œê°„ í‘œì‹œ ì—…ë°ì´íŠ¸
        if (playheadTime) {
            playheadTime.textContent = formatTime(currentTime);
        }

        // ìƒë‹¨ ì‹œê°„ í‘œì‹œ ì—…ë°ì´íŠ¸
        if (currentTimeDisplay) {
            currentTimeDisplay.textContent = formatTime(currentTime);
        }
        if (totalTimeDisplay && duration) {
            totalTimeDisplay.textContent = formatTime(duration);
        }

        // íƒ€ì„ë¼ì¸ ìë§‰ì„ í™”ë©´ì— í‘œì‹œ
        updateSubtitleOverlaysFromTimeline(currentTime);
    });
}

// íƒ€ì„ë¼ì¸ì— ì˜ìƒ í´ë¦½ í‘œì‹œ
function displayVideoClipOnTimeline(fileName, duration) {
    const videoTrack = document.getElementById('video-track');
    if (!videoTrack) return;

    // ê¸°ì¡´ í´ë¦½ ì œê±°
    videoTrack.innerHTML = '';

    // ì¤Œ ë ˆë²¨ ê°€ì ¸ì˜¤ê¸°
    const zoomLevel = parseFloat(document.getElementById('timeline-zoom')?.value || 1);
    const pixelsPerSecond = 50 * zoomLevel; // ê¸°ë³¸ 50px/ì´ˆ * ì¤Œ ë ˆë²¨ (10ì´ˆ = 500px)

    // í´ë¦½ ë„ˆë¹„ ê³„ì‚°
    const clipWidth = duration * pixelsPerSecond;

    // í´ë¦½ ìš”ì†Œ ìƒì„±
    const clip = document.createElement('div');
    clip.className = 'video-clip';
    clip.style.cssText = `
        position: absolute;
        left: 0px;
        top: 0;
        width: ${clipWidth}px;
        height: 100%;
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.3) 0%, rgba(37, 99, 235, 0.3) 100%);
        border: 2px solid rgba(59, 130, 246, 0.6);
        border-radius: 4px;
        cursor: move;
        display: flex;
        align-items: center;
        padding: 0 10px;
        font-size: 12px;
        color: #fff;
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    `;

    clip.innerHTML = `
        <span style="font-weight: bold;">ğŸ“¹ ${fileName}</span>
        <span style="margin-left: 10px; opacity: 0.7;">${duration.toFixed(2)}ì´ˆ</span>
    `;

    clip.title = `${fileName} (${duration.toFixed(2)}ì´ˆ)`;

    videoTrack.appendChild(clip);

    console.log(`ì˜ìƒ í´ë¦½ì´ íƒ€ì„ë¼ì¸ì— í‘œì‹œë˜ì—ˆìŠµë‹ˆë‹¤. ë„ˆë¹„: ${clipWidth}px`);
}

// ìŒì„± íŒŒì¼ ë¡œë“œ ì²˜ë¦¬
function handleAudioFileLoad(file, trackType, options = {}) {
    console.log(`${trackType} ìŒì„± íŒŒì¼ ë¡œë“œ:`, file.name);

    const {
        silent = false,
        alertMessage,
        skipAlert = false
    } = options || {};

    const showAlert = !silent && !skipAlert;

    const previous = loadedMedia[trackType];
    if (previous) {
        if (previous.audioElement) {
            try {
                previous.audioElement.pause();
            } catch (error) {
                console.warn('ì´ì „ ì˜¤ë””ì˜¤ íŠ¸ë™ ì¼ì‹œì •ì§€ ì‹¤íŒ¨:', error);
            }
        }
        if (previous.objectUrl) {
            URL.revokeObjectURL(previous.objectUrl);
        }
    }

    const url = URL.createObjectURL(file);
    const audio = new Audio(url);
    audio.preload = 'auto';
    audio.loop = false;

    return new Promise((resolve, reject) => {
        const cleanup = () => {
            audio.removeEventListener('loadedmetadata', onLoadedMetadata);
            audio.removeEventListener('error', onAudioError);
        };

        const onAudioError = (event) => {
            cleanup();
            console.error('ì˜¤ë””ì˜¤ ë©”íƒ€ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', event);
            if (!silent) {
                alert('âŒ ì˜¤ë””ì˜¤ íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
            URL.revokeObjectURL(url);
            reject(event instanceof Error ? event : new Error('ì˜¤ë””ì˜¤ ë¡œë“œ ì‹¤íŒ¨'));
        };

        const onLoadedMetadata = () => {
            cleanup();

            const duration = audio.duration;
            console.log(`${trackType} ìŒì„± ê¸¸ì´:`, duration, 'ì´ˆ');

            // ë¡œë“œëœ ë¯¸ë””ì–´ ì •ë³´ ì €ì¥
            loadedMedia[trackType] = {
                fileName: file.name,
                duration: duration,
                file: file,
                audioElement: audio,
                objectUrl: url
            };

            clearAudioSelection(trackType);

            // íŒŒí˜• ê·¸ë¦¬ê¸°
            drawWaveform(file, trackType, duration);

            // íƒ€ì„ë¼ì¸ì— ìŒì„± í´ë¦½ í‘œì‹œ
            displayAudioClipOnTimeline(file.name, duration, trackType);

            // íƒ€ì„ë¼ì¸ ì „ì²´ ë„ˆë¹„ ì—…ë°ì´íŠ¸
            updateAllClipSizes();

            attachAudioTrackToggleListeners();
            initAudioSync();

            const videoPlayer = document.getElementById('video-preview-player');
            if (videoPlayer) {
                syncAudioTrackRate(videoPlayer);
                syncAudioTrackVolume(videoPlayer);
                if (!videoPlayer.paused && !videoPlayer.ended) {
                    startAudioTracks(videoPlayer);
                }
            }

            if (showAlert) {
                const message = alertMessage || `ìŒì„± íŒŒì¼ "${file.name}"ì´ ${trackType} íŠ¸ë™ì— ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.\nê¸¸ì´: ${duration.toFixed(2)}ì´ˆ`;
                alert(message);
            } else {
                console.log(`ìŒì„± íŒŒì¼ì´ ${trackType} íŠ¸ë™ì— ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. (ê¸¸ì´: ${duration.toFixed(2)}ì´ˆ)`);
            }

            // ìë™ ìë¥´ê¸°: ìŒì„±ì´ ì˜ìƒë³´ë‹¤ ê¸¸ë©´ ìë™ìœ¼ë¡œ ìë¥¼ì§€ ë¬¼ì–´ë³´ê¸°
            const videoInfo = loadedMedia.video;
            if (videoInfo && videoInfo.duration && duration > videoInfo.duration + 0.5) {
                const shouldTrim = confirm(
                    `ìŒì„± ê¸¸ì´(${duration.toFixed(2)}ì´ˆ)ê°€ ì˜ìƒ ê¸¸ì´(${videoInfo.duration.toFixed(2)}ì´ˆ)ë³´ë‹¤ ê¹ë‹ˆë‹¤.\n\nì˜ìƒ ê¸¸ì´ì— ë§ì¶° ìë™ìœ¼ë¡œ ìë¥´ì‹œê² ìŠµë‹ˆê¹Œ?`
                );

                if (shouldTrim) {
                    // ë¹„ë™ê¸°ë¡œ ìë¥´ê¸° ì‹¤í–‰ (resolve í›„ì— ì‹¤í–‰)
                    setTimeout(() => {
                        trimAudioToVideoLength(trackType).catch(err => {
                            console.error('ìë™ ìë¥´ê¸° ì‹¤íŒ¨:', err);
                            alert('ìŒì„± ìë¥´ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\nìˆ˜ë™ìœ¼ë¡œ "âœ‚ï¸ ì˜ìƒ ê¸¸ì´ ë§ì¶”ê¸°" ë²„íŠ¼ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.');
                        });
                    }, 100);
                }
            }

            resolve({ duration });
        };

        audio.addEventListener('loadedmetadata', onLoadedMetadata, { once: true });
        audio.addEventListener('error', onAudioError, { once: true });

        if (audio.readyState >= 1 && Number.isFinite(audio.duration) && audio.duration > 0) {
            onLoadedMetadata();
        }
    });
}

// íƒ€ì„ë¼ì¸ì— ìŒì„± í´ë¦½ í‘œì‹œ
function displayAudioClipOnTimeline(fileName, duration, trackType) {
    // íŠ¸ë™ ID ê²°ì •
    const trackId = trackType === 'audio' ? 'audio-track' :
                    trackType === 'commentary' ? 'commentary-audio-track' :
                    'bgm-audio-track';

    const audioTrack = document.getElementById(trackId);
    if (!audioTrack) return;

    // ìº”ë²„ìŠ¤ê°€ ìˆë‹¤ë©´ ê·¸ ìœ„ì— ì˜¤ë²„ë ˆì´ë¡œ í‘œì‹œ
    const canvas = audioTrack.querySelector('canvas');

    // ì¤Œ ë ˆë²¨ ê°€ì ¸ì˜¤ê¸°
    const zoomLevel = parseFloat(document.getElementById('timeline-zoom')?.value || 1);
    const pixelsPerSecond = 50 * zoomLevel;

    // í´ë¦½ ë„ˆë¹„ ê³„ì‚°
    const clipWidth = duration * pixelsPerSecond;

    console.log(`[displayAudioClipOnTimeline] ${trackType} - duration: ${duration}s, zoom: ${zoomLevel}, clipWidth: ${clipWidth}px`);

    // í´ë¦½ ì •ë³´ ì˜¤ë²„ë ˆì´ ìƒì„± (ìº”ë²„ìŠ¤ ìœ„ì— í‘œì‹œ)
    let overlay = audioTrack.querySelector('.audio-clip-overlay');
    if (!overlay) {
        overlay = document.createElement('div');
        overlay.className = 'audio-clip-overlay';
        overlay.style.cssText = `
            position: absolute;
            left: 0;
            top: 0;
            height: 20px;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.4) 0%, rgba(5, 150, 105, 0.4) 100%);
            border: 1px solid rgba(16, 185, 129, 0.6);
            border-radius: 3px;
            display: flex;
            align-items: center;
            padding: 0 8px;
            font-size: 10px;
            color: #fff;
            font-weight: bold;
            z-index: 10;
            cursor: crosshair;
            pointer-events: auto;
        `;
        audioTrack.style.position = 'relative';
        audioTrack.appendChild(overlay);
    }

    overlay.style.width = `${clipWidth}px`;
    overlay.textContent = `ğŸµ ${fileName} (${duration.toFixed(2)}ì´ˆ)`;
    overlay.title = `${fileName} (${duration.toFixed(2)}ì´ˆ)`;
    overlay.dataset.trackType = trackType;
    overlay.dataset.duration = String(duration);

    if (!overlay.dataset.selectionListenerAttached) {
        overlay.addEventListener('click', handleAudioOverlayClick);
        overlay.dataset.selectionListenerAttached = 'true';
    }

    updateAudioSelectionUI();

    console.log(`${trackType} ìŒì„± í´ë¦½ì´ íƒ€ì„ë¼ì¸ì— í‘œì‹œë˜ì—ˆìŠµë‹ˆë‹¤. ë„ˆë¹„: ${clipWidth}px`);
}

// íŒŒí˜• ê·¸ë¦¬ê¸°
async function drawWaveform(file, trackType, duration) {
    const canvasId = trackType === 'audio' ? 'timeline-waveform' :
                     trackType === 'commentary' ? 'commentary-waveform' :
                     'bgm-waveform';

    const canvas = document.getElementById(canvasId);
    if (!canvas) return;

    const ctx = canvas.getContext('2d');

    // ì¤Œ ë ˆë²¨ì— ë”°ë¥¸ ìº”ë²„ìŠ¤ ë„ˆë¹„ ì„¤ì •
    const zoomLevel = parseFloat(document.getElementById('timeline-zoom')?.value || 1);
    const pixelsPerSecond = 50 * zoomLevel;
    const calculatedWidth = duration * pixelsPerSecond;

    // ìº”ë²„ìŠ¤ ì‹¤ì œ ë„ˆë¹„ ì„¤ì • (canvas.widthëŠ” í”½ì…€ ë‹¨ìœ„)
    canvas.width = calculatedWidth;
    const height = canvas.height = 50;  // ê³ ì • ë†’ì´

    // CSS ìŠ¤íƒ€ì¼ë¡œë„ ë„ˆë¹„ ëª…ì‹œ
    canvas.style.width = calculatedWidth + 'px';

    console.log(`[drawWaveform] ${trackType} - duration: ${duration}s, zoom: ${zoomLevel}, pixelsPerSecond: ${pixelsPerSecond}, width: ${calculatedWidth}px`);

    // ê°„ë‹¨í•œ íŒŒí˜• í‘œì‹œ (ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” Web Audio API ì‚¬ìš©)
    ctx.fillStyle = 'rgba(16, 185, 129, 0.3)';
    ctx.clearRect(0, 0, calculatedWidth, height);

    // ì„ì‹œ íŒŒí˜• ê·¸ë¦¬ê¸°
    for (let i = 0; i < calculatedWidth; i += 2) {
        const barHeight = Math.random() * height * 0.8;
        const y = (height - barHeight) / 2;
        ctx.fillRect(i, y, 1, barHeight);
    }

    console.log(`${trackType} íŒŒí˜•ì´ ê·¸ë ¤ì¡ŒìŠµë‹ˆë‹¤. ë„ˆë¹„: ${calculatedWidth}px`);
}

// ìë§‰ íŒŒì¼ ë¡œë“œ ì²˜ë¦¬
async function handleSubtitleFileLoad(file, trackType) {
    console.log(`${trackType} ìë§‰ íŒŒì¼ ë¡œë“œ:`, file.name);

    const reader = new FileReader();

    reader.onload = async function(e) {
        const content = e.target.result;
        parseSubtitle(content, trackType);

        // íŒŒì¼ëª… ì €ì¥ ë° í‘œì‹œ ì—…ë°ì´íŠ¸
        loadedSubtitleFiles[trackType] = file.name;
        updateSubtitleFileDisplay();

        // ìë§‰ì„ IndexedDBì— ì €ì¥
        if (trackType === 'translation' || trackType === 'main' || trackType === 'description') {
            try {
                await saveFileToIndexedDB(`${trackType}-subtitle`, 'subtitle', file, {
                    fileName: file.name
                });
                const trackNames = {
                    main: 'ë©”ì¸ ìë§‰',
                    translation: 'ì£¼ìë§‰',
                    description: 'ë³´ì¡°ìë§‰'
                };
                console.log(`âœ… ${trackNames[trackType]} íŒŒì¼ì´ IndexedDBì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            } catch (error) {
                console.error(`âŒ ${trackNames[trackType]} íŒŒì¼ ì €ì¥ ì‹¤íŒ¨:`, error);
            }
        }

        console.log(`ìë§‰ íŒŒì¼ "${file.name}"ì´ ${trackType} íŠ¸ë™ì— ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.`);
    };

    reader.readAsText(file);
}

// ìë§‰ íŒŒì‹±
function parseSubtitle(content, trackType) {
    console.log(`${trackType} ìë§‰ íŒŒì‹± ì¤‘...`);

    // SRT í˜•ì‹ íŒŒì‹± (ê°„ë‹¨í•œ êµ¬í˜„)
    const subtitles = [];
    const blocks = content.trim().split('\n\n');

    blocks.forEach(block => {
        const lines = block.split('\n');
        if (lines.length >= 3) {
            const timeRegex = /(\d{2}:\d{2}:\d{2},\d{3}) --> (\d{2}:\d{2}:\d{2},\d{3})/;
            const timeMatch = lines[1].match(timeRegex);
            if (timeMatch) {
                const text = lines.slice(2).join(' ');
                subtitles.push({
                    start: timeMatch[1],
                    end: timeMatch[2],
                    text: text
                });
            }
        }
    });

    console.log(`${trackType} ìë§‰ íŒŒì‹± ì™„ë£Œ:`, subtitles.length, 'ê°œ');

    // ìë§‰ ë°ì´í„° ì €ì¥
    loadedSubtitles[trackType] = subtitles;

    // TODO: íƒ€ì„ë¼ì¸ì— ìë§‰ ë¸”ë¡ í‘œì‹œ
    displaySubtitlesOnTimeline(subtitles, trackType);

    // ğŸ¯ íƒ€ì„ë¼ì¸ ìë§‰ ë¡œë“œ ì‹œ ì œëª©/ë¶€ì œëª© ìë™ ìˆ¨ê¹€ (ì¤‘ë³µ ë°©ì§€)
    autoHideTitleSubtitleOnTimelineLoad(trackType);
}

// íƒ€ì„ë¼ì¸ ìë§‰ ë¡œë“œ ì‹œ ì œëª©/ë¶€ì œëª© ìë™ ìˆ¨ê¹€ í•¨ìˆ˜
function autoHideTitleSubtitleOnTimelineLoad(trackType) {
    // main, translation, description íŠ¸ë™ ì¤‘ í•˜ë‚˜ë¼ë„ ë¡œë“œë˜ë©´ ì œëª©/ë¶€ì œëª© ìˆ¨ê¹€
    if (trackType === 'main' || trackType === 'translation' || trackType === 'description') {
        console.log(`ğŸ™ˆ íƒ€ì„ë¼ì¸ ìë§‰(${trackType}) ë¡œë“œë¨ - ì œëª©/ë¶€ì œëª© ìë™ ìˆ¨ê¹€ ì²˜ë¦¬`);

        let needsCanvasUpdate = false;

        // ì œëª© ìˆ¨ê¸°ê¸° ì²´í¬ë°•ìŠ¤ ìë™ ì²´í¬
        const hideTitleCheckbox = document.getElementById('hide-title-overlay');
        if (hideTitleCheckbox && !hideTitleCheckbox.checked) {
            hideTitleCheckbox.checked = true;
            // ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸ ìˆ˜ë™ íŠ¸ë¦¬ê±°
            const titleOverlay = document.getElementById('video-title-overlay');
            if (titleOverlay) {
                titleOverlay.style.display = 'none';
                console.log('  âœ… ì œëª© ì˜¤ë²„ë ˆì´ ìˆ¨ê¹€');
                needsCanvasUpdate = true;
            }
        }

        // ë¶€ì œëª© ìˆ¨ê¸°ê¸° ì²´í¬ë°•ìŠ¤ ìë™ ì²´í¬
        const hideSubtitleCheckbox = document.getElementById('hide-subtitle-overlay');
        if (hideSubtitleCheckbox && !hideSubtitleCheckbox.checked) {
            hideSubtitleCheckbox.checked = true;
            // ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸ ìˆ˜ë™ íŠ¸ë¦¬ê±°
            const subtitleOverlay = document.getElementById('video-subtitle-overlay');
            if (subtitleOverlay) {
                subtitleOverlay.style.display = 'none';
                console.log('  âœ… ë¶€ì œëª© ì˜¤ë²„ë ˆì´ ìˆ¨ê¹€');
                needsCanvasUpdate = true;
            }
        }

        // Canvas ë™ê¸°í™”
        if (needsCanvasUpdate && typeof updateCanvasText === 'function') {
            updateCanvasText();
            console.log('  ğŸ¨ Canvas ë™ê¸°í™” ì™„ë£Œ');
        }
    }
}

// SRT ì‹œê°„ í˜•ì‹ì„ ì´ˆ ë‹¨ìœ„ë¡œ ë³€í™˜ (00:00:15,461 -> 15.461)
function srtTimeToSeconds(srtTime) {
    const parts = srtTime.split(':');
    const hours = parseInt(parts[0]);
    const minutes = parseInt(parts[1]);
    const secondsParts = parts[2].split(',');
    const seconds = parseInt(secondsParts[0]);
    const milliseconds = parseInt(secondsParts[1]);

    return hours * 3600 + minutes * 60 + seconds + milliseconds / 1000;
}

// íƒ€ì„ë¼ì¸ì— ìë§‰ í‘œì‹œ
function displaySubtitlesOnTimeline(subtitles, trackType) {
    const contentId = `${trackType}-subtitle-content`;
    const content = document.getElementById(contentId);

    if (!content) return;

    // ê¸°ì¡´ ë‚´ìš© ì œê±°
    content.innerHTML = '';

    // ì¤Œ ë ˆë²¨ ê°€ì ¸ì˜¤ê¸°
    const zoomLevel = parseFloat(document.getElementById('timeline-zoom')?.value || 1);
    const pixelsPerSecond = 50 * zoomLevel; // ê¸°ë³¸ 50px/ì´ˆ * ì¤Œ ë ˆë²¨ (10ì´ˆ = 500px)

    // ê° ìë§‰ì„ ë¸”ë¡ìœ¼ë¡œ í‘œì‹œ
    subtitles.forEach((subtitle, index) => {
        // SRT ì‹œê°„ì„ ì´ˆ ë‹¨ìœ„ë¡œ ë³€í™˜
        const startSeconds = srtTimeToSeconds(subtitle.start);
        const endSeconds = srtTimeToSeconds(subtitle.end);
        const durationSeconds = endSeconds - startSeconds;

        // í”½ì…€ ë‹¨ìœ„ë¡œ ìœ„ì¹˜ì™€ ë„ˆë¹„ ê³„ì‚°
        const leftPosition = startSeconds * pixelsPerSecond;
        const blockWidth = Math.max(durationSeconds * pixelsPerSecond, 40); // ìµœì†Œ ë„ˆë¹„ 40px

        const block = document.createElement('div');
        block.className = 'subtitle-block';
        block.style.cssText = `
            position: absolute;
            left: ${leftPosition}px;
            width: ${blockWidth}px;
            height: 40px;
            background: rgba(16, 185, 129, 0.3);
            border: 1px solid rgba(16, 185, 129, 0.5);
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #fff;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            padding: 4px;
        `;
        block.textContent = subtitle.text;
        block.title = `${subtitle.start} -> ${subtitle.end}\n${subtitle.text}`;

        content.appendChild(block);
    });

    console.log(`${trackType} íŠ¸ë™ì— ${subtitles.length}ê°œì˜ ìë§‰ ë¸”ë¡ì´ í‘œì‹œë˜ì—ˆìŠµë‹ˆë‹¤ (ì‹¤ì œ ì‹œê°„ ê¸°ë°˜)`);

    // Canvas ë¯¸ë¦¬ë³´ê¸°ë¡œ ìë§‰ ë°ì´í„° ì „ë‹¬
    updateCanvasSubtitles(trackType, subtitles);
}

// ëª¨ë“  í´ë¦½ í¬ê¸° ì—…ë°ì´íŠ¸ (ì¤Œ ë ˆë²¨ ë³€ê²½ ì‹œ)
function updateAllClipSizes() {
    console.log('íƒ€ì„ë¼ì¸ ì¤Œ ë³€ê²½ - ëª¨ë“  í´ë¦½ í¬ê¸° ì—…ë°ì´íŠ¸ ì¤‘...');

    // ê°€ì¥ ê¸´ ë¯¸ë””ì–´ ê¸¸ì´ ì°¾ê¸°
    let maxDuration = 0;
    if (loadedMedia.video) maxDuration = Math.max(maxDuration, loadedMedia.video.duration);
    if (loadedMedia.audio) maxDuration = Math.max(maxDuration, loadedMedia.audio.duration);
    if (loadedMedia.commentary) maxDuration = Math.max(maxDuration, loadedMedia.commentary.duration);
    if (loadedMedia.bgm) maxDuration = Math.max(maxDuration, loadedMedia.bgm.duration);

    // ì¤Œ ë ˆë²¨ì— ë”°ë¥¸ íƒ€ì„ë¼ì¸ ì „ì²´ ë„ˆë¹„ ê³„ì‚°
    const zoomLevel = parseFloat(document.getElementById('timeline-zoom')?.value || 1);
    const pixelsPerSecond = 50 * zoomLevel;
    const timelineWidth = Math.max(maxDuration * pixelsPerSecond, window.innerWidth - 200);

    // íƒ€ì„ë¼ì¸ ì½˜í…ì¸  ë„ˆë¹„ ì„¤ì •
    const timelineContent = document.getElementById('timeline-content');
    if (timelineContent) {
        timelineContent.style.minWidth = timelineWidth + 'px';
        console.log(`íƒ€ì„ë¼ì¸ ë„ˆë¹„ ì„¤ì •: ${timelineWidth}px (maxDuration: ${maxDuration}s, zoom: ${zoomLevel})`);
    }

    // ì˜ìƒ í´ë¦½ ì—…ë°ì´íŠ¸
    if (loadedMedia.video) {
        displayVideoClipOnTimeline(loadedMedia.video.fileName, loadedMedia.video.duration);
    }

    // ìŒì„± í´ë¦½ ì—…ë°ì´íŠ¸
    if (loadedMedia.audio) {
        displayAudioClipOnTimeline(loadedMedia.audio.fileName, loadedMedia.audio.duration, 'audio');
        drawWaveform(loadedMedia.audio.file, 'audio', loadedMedia.audio.duration);
    }

    // í•´ì„¤ ìŒì„± í´ë¦½ ì—…ë°ì´íŠ¸
    if (loadedMedia.commentary) {
        displayAudioClipOnTimeline(loadedMedia.commentary.fileName, loadedMedia.commentary.duration, 'commentary');
        drawWaveform(loadedMedia.commentary.file, 'commentary', loadedMedia.commentary.duration);
    }

    // ë°°ê²½ ìŒì•… í´ë¦½ ì—…ë°ì´íŠ¸
    if (loadedMedia.bgm) {
        displayAudioClipOnTimeline(loadedMedia.bgm.fileName, loadedMedia.bgm.duration, 'bgm');
        drawWaveform(loadedMedia.bgm.file, 'bgm', loadedMedia.bgm.duration);
    }

    console.log('ëª¨ë“  í´ë¦½ í¬ê¸° ì—…ë°ì´íŠ¸ ì™„ë£Œ');
    updateAudioSelectionUI();
}

function getAudioTrackCheckboxId(trackType) {
    switch (trackType) {
        case 'audio':
            return 'track-audio-enable';
        case 'commentary':
            return 'track-commentary-enable';
        case 'bgm':
            return 'track-bgm-enable';
        default:
            return null;
    }
}

function isAudioTrackEnabled(trackType) {
    const checkboxId = getAudioTrackCheckboxId(trackType);
    if (!checkboxId) {
        return true;
    }
    const checkbox = document.getElementById(checkboxId);
    return !checkbox || checkbox.checked;
}

function getAudioTracks(includeDisabled = false) {
    const tracks = [];
    AUDIO_TRACK_TYPES.forEach((trackType) => {
        const mediaInfo = loadedMedia[trackType];
        if (mediaInfo && mediaInfo.audioElement) {
            if (includeDisabled || isAudioTrackEnabled(trackType)) {
                tracks.push({ trackType, mediaInfo });
            }
        }
    });
    return tracks;
}

function pauseAllAudioTracks() {
    getAudioTracks(true).forEach(({ mediaInfo }) => {
        try {
            mediaInfo.audioElement.pause();
        } catch (error) {
            console.warn('ì˜¤ë””ì˜¤ ì¼ì‹œì •ì§€ ì‹¤íŒ¨:', error);
        }
    });
}

function syncAudioTrackTimes(videoPlayer) {
    if (!videoPlayer) {
        return;
    }
    const currentTime = Number.isFinite(videoPlayer.currentTime) ? videoPlayer.currentTime : 0;
    getAudioTracks().forEach(({ mediaInfo }) => {
        const audioElement = mediaInfo.audioElement;
        if (!audioElement || Number.isNaN(currentTime)) {
            return;
        }
        if (Math.abs((audioElement.currentTime || 0) - currentTime) > 0.2) {
            try {
                audioElement.currentTime = currentTime;
            } catch (error) {
                console.warn('ì˜¤ë””ì˜¤ íƒ€ì„ë¼ì¸ ë™ê¸°í™” ì‹¤íŒ¨:', error);
            }
        }
    });
}

function syncAudioTrackRate(videoPlayer) {
    if (!videoPlayer) {
        return;
    }
    const playbackRate = Number.isFinite(videoPlayer.playbackRate) ? videoPlayer.playbackRate : 1;
    getAudioTracks(true).forEach(({ mediaInfo }) => {
        const audioElement = mediaInfo.audioElement;
        if (audioElement) {
            audioElement.playbackRate = playbackRate;
        }
    });
}

function syncAudioTrackVolume(videoPlayer) {
    if (!videoPlayer) {
        return;
    }
    const baseVolume = videoPlayer.muted ? 0 : (Number.isFinite(videoPlayer.volume) ? videoPlayer.volume : 1);
    getAudioTracks(true).forEach(({ mediaInfo }) => {
        const audioElement = mediaInfo.audioElement;
        if (audioElement) {
            audioElement.volume = baseVolume;
        }
    });
}

function startAudioTracks(videoPlayer) {
    if (!videoPlayer) {
        return;
    }
    const currentTime = Number.isFinite(videoPlayer.currentTime) ? videoPlayer.currentTime : 0;
    const playbackRate = Number.isFinite(videoPlayer.playbackRate) ? videoPlayer.playbackRate : 1;
    const baseVolume = videoPlayer.muted ? 0 : (Number.isFinite(videoPlayer.volume) ? videoPlayer.volume : 1);

    getAudioTracks().forEach(({ mediaInfo }) => {
        const audioElement = mediaInfo.audioElement;
        if (!audioElement) {
            return;
        }
        if (Number.isFinite(currentTime) && Math.abs((audioElement.currentTime || 0) - currentTime) > 0.05) {
            try {
                audioElement.currentTime = currentTime;
            } catch (error) {
                console.warn('ì˜¤ë””ì˜¤ ì¬ìƒ ìœ„ì¹˜ ì„¤ì • ì‹¤íŒ¨:', error);
            }
        }
        audioElement.playbackRate = playbackRate;
        audioElement.volume = baseVolume;

        const playPromise = audioElement.play();
        if (playPromise && typeof playPromise.catch === 'function') {
            playPromise.catch((error) => {
                console.warn('ì˜¤ë””ì˜¤ íŠ¸ë™ ì¬ìƒ ì‹¤íŒ¨:', error);
            });
        }
    });
}

function attachAudioTrackToggleListeners() {
    AUDIO_TRACK_TYPES.forEach((trackType) => {
        const checkboxId = getAudioTrackCheckboxId(trackType);
        if (!checkboxId) {
            return;
        }
        const checkbox = document.getElementById(checkboxId);
        if (!checkbox || checkbox.dataset.audioToggleAttached === 'true') {
            return;
        }
        checkbox.dataset.audioToggleAttached = 'true';
        checkbox.addEventListener('change', () => {
            const trackInfo = loadedMedia[trackType];
            if (!trackInfo || !trackInfo.audioElement) {
                return;
            }
            if (checkbox.checked) {
                const videoPlayer = document.getElementById('video-preview-player');
                if (videoPlayer && !videoPlayer.paused && !videoPlayer.ended) {
                    startAudioTracks(videoPlayer);
                }
            } else {
                try {
                    trackInfo.audioElement.pause();
                } catch (error) {
                    console.warn('ì˜¤ë””ì˜¤ íŠ¸ë™ ì¼ì‹œì •ì§€ ì‹¤íŒ¨:', error);
                }
            }
        });
    });
}

function handleAudioOverlayClick(event) {
    const overlay = event.currentTarget;
    const trackType = overlay.dataset.trackType;
    const duration = parseFloat(overlay.dataset.duration || '0');
    if (!trackType || !duration) {
        return;
    }

    const rect = overlay.getBoundingClientRect();
    const offsetX = event.clientX - rect.left;
    const fraction = overlay.clientWidth > 0 ? Math.min(Math.max(offsetX / overlay.clientWidth, 0), 1) : 0;
    const time = fraction * duration;

    setAudioSelection(trackType, time);
}

function setAudioSelection(trackType, time) {
    if (!trackType || !Number.isFinite(time)) {
        return;
    }
    currentAudioSelection = {
        trackType,
        time: Math.max(0, time)
    };
    updateAudioSelectionUI();
}

function clearAudioSelection(trackType) {
    if (!currentAudioSelection) {
        updateAudioSelectionUI();
        return;
    }

    if (!trackType || currentAudioSelection.trackType === trackType) {
        currentAudioSelection = null;
        updateAudioSelectionUI();
    }
}

function getAudioTrackContentId(trackType) {
    switch (trackType) {
        case 'audio':
            return 'audio-track';
        case 'commentary':
            return 'commentary-audio-track';
        case 'bgm':
            return 'bgm-audio-track';
        default:
            return null;
    }
}

function formatSecondsWithMs(seconds) {
    const totalSeconds = Math.max(0, Number(seconds) || 0);
    const mins = Math.floor(totalSeconds / 60);
    const secs = Math.floor(totalSeconds % 60);
    const millis = Math.floor((totalSeconds - Math.floor(totalSeconds)) * 1000);
    return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}.${String(millis).padStart(3, '0')}`;
}

function updateAudioSelectionUI() {
    AUDIO_TRACK_TYPES.forEach((trackType) => {
        const trackContentId = getAudioTrackContentId(trackType);
        const trackElement = trackContentId ? document.getElementById(trackContentId) : null;
        const overlay = trackElement ? trackElement.querySelector('.audio-clip-overlay') : null;
        const infoEl = document.getElementById(`audio-selection-info-${trackType}`);
        let marker = trackElement ? trackElement.querySelector('.audio-selection-marker') : null;
        const deleteBtn = document.querySelector(`[data-audio-action="delete-from-selection"][data-track="${trackType}"]`);

        if (!currentAudioSelection || currentAudioSelection.trackType !== trackType || !overlay || !overlay.clientWidth) {
            if (marker) {
                marker.remove();
            }
            if (infoEl) {
                infoEl.textContent = 'ì„ íƒ ìœ„ì¹˜: ì—†ìŒ';
            }
            if (deleteBtn) {
                deleteBtn.disabled = true;
            }
            return;
        }

        const duration = parseFloat(overlay.dataset.duration || `${loadedMedia[trackType]?.duration || 0}`);
        if (!duration) {
            if (marker) {
                marker.remove();
            }
            if (infoEl) {
                infoEl.textContent = 'ì„ íƒ ìœ„ì¹˜: ì—†ìŒ';
            }
            if (deleteBtn) {
                deleteBtn.disabled = true;
            }
            return;
        }

        const fraction = Math.min(Math.max(currentAudioSelection.time / duration, 0), 1);
        const left = fraction * overlay.clientWidth;

        if (!marker) {
            marker = document.createElement('div');
            marker.className = 'audio-selection-marker';
            trackElement.appendChild(marker);
        }

        marker.style.left = `${left}px`;

        if (infoEl) {
            infoEl.textContent = `ì„ íƒ ìœ„ì¹˜: ${formatSecondsWithMs(currentAudioSelection.time)} / ${formatSecondsWithMs(duration)}`;
        }

        if (deleteBtn) {
            deleteBtn.disabled = false;
        }
    });
}

function initAudioSync() {
    if (audioSyncInitialized) {
        attachAudioTrackToggleListeners();
        return;
    }
    const videoPlayer = document.getElementById('video-preview-player');
    if (!videoPlayer) {
        return;
    }

    videoPlayer.addEventListener('play', () => {
        startAudioTracks(videoPlayer);
    });

    videoPlayer.addEventListener('pause', () => {
        pauseAllAudioTracks();
    });

    videoPlayer.addEventListener('ended', () => {
        pauseAllAudioTracks();
    });

    videoPlayer.addEventListener('seeking', () => {
        pauseAllAudioTracks();
    });

    videoPlayer.addEventListener('seeked', () => {
        syncAudioTrackTimes(videoPlayer);
        if (!videoPlayer.paused && !videoPlayer.ended) {
            startAudioTracks(videoPlayer);
        }
    });

    videoPlayer.addEventListener('timeupdate', () => {
        if (!videoPlayer.paused && !videoPlayer.ended) {
            syncAudioTrackTimes(videoPlayer);
        }
    });

    videoPlayer.addEventListener('ratechange', () => {
        syncAudioTrackRate(videoPlayer);
    });

    videoPlayer.addEventListener('volumechange', () => {
        syncAudioTrackVolume(videoPlayer);
    });

    attachAudioTrackToggleListeners();
    audioSyncInitialized = true;
}

function getAudioTrackDisplayName(trackType) {
    const names = {
        audio: 'ìŒì„±',
        commentary: 'í•´ì„¤ ìŒì„±',
        bgm: 'ë°°ê²½ ìŒì•…'
    };
    return names[trackType] || trackType;
}

async function decodeAudioFileToBuffer(file) {
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    if (!AudioCtx) {
        throw new Error('ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ì˜¤ë””ì˜¤ í¸ì§‘ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
    }

    const arrayBuffer = await file.arrayBuffer();
    const audioCtx = new AudioCtx();
    try {
        const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
        return audioBuffer;
    } finally {
        if (typeof audioCtx.close === 'function') {
            try {
                await audioCtx.close();
            } catch (closeError) {
                console.warn('AudioContext ì¢…ë£Œ ì‹¤íŒ¨:', closeError);
            }
        }
    }
}

function audioBufferToWav(buffer) {
    const numOfChan = buffer.numberOfChannels;
    const sampleRate = buffer.sampleRate;
    const format = 1; // PCM
    const bitDepth = 16;
    const channelData = [];

    for (let channel = 0; channel < numOfChan; channel++) {
        channelData.push(buffer.getChannelData(channel));
    }

    const interleaved = interleaveChannelData(channelData);

    const bufferLength = interleaved.length * (bitDepth / 8);
    const wavBuffer = new ArrayBuffer(44 + bufferLength);
    const view = new DataView(wavBuffer);

    // RIFF chunk descriptor
    writeString(view, 0, 'RIFF');
    view.setUint32(4, 36 + bufferLength, true);
    writeString(view, 8, 'WAVE');

    // FMT sub-chunk
    writeString(view, 12, 'fmt ');
    view.setUint32(16, 16, true); // SubChunk1Size
    view.setUint16(20, format, true); // PCM
    view.setUint16(22, numOfChan, true);
    view.setUint32(24, sampleRate, true);
    view.setUint32(28, sampleRate * numOfChan * (bitDepth / 8), true); // ByteRate
    view.setUint16(32, numOfChan * (bitDepth / 8), true); // BlockAlign
    view.setUint16(34, bitDepth, true);

    // data sub-chunk
    writeString(view, 36, 'data');
    view.setUint32(40, bufferLength, true);

    // Write PCM samples
    let offset = 44;
    for (let i = 0; i < interleaved.length; i++, offset += 2) {
        const s = Math.max(-1, Math.min(1, interleaved[i]));
        view.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
    }

    return wavBuffer;
}

function writeString(view, offset, string) {
    for (let i = 0; i < string.length; i++) {
        view.setUint8(offset + i, string.charCodeAt(i));
    }
}

function interleaveChannelData(channels) {
    const length = channels[0].length;
    const numChannels = channels.length;
    const interleaved = new Float32Array(length * numChannels);

    let writeIndex = 0;
    for (let i = 0; i < length; i++) {
        for (let channel = 0; channel < numChannels; channel++) {
            interleaved[writeIndex++] = channels[channel][i];
        }
    }
    return interleaved;
}

async function trimAudioSegment(trackType, startSec, endSec, options = {}) {
    const mediaInfo = loadedMedia[trackType];
    if (!mediaInfo || !mediaInfo.file) {
        alert(`ë¨¼ì € ${getAudioTrackDisplayName(trackType)} íŠ¸ë™ì— ì˜¤ë””ì˜¤ë¥¼ ë¡œë“œí•´ì£¼ì„¸ìš”.`);
        return;
    }

    try {
        const audioBuffer = await decodeAudioFileToBuffer(mediaInfo.file);
        const sampleRate = audioBuffer.sampleRate;
        const duration = audioBuffer.duration;

        const clampedStart = Math.max(0, Math.min(startSec, duration));
        const clampedEnd = Math.max(clampedStart, Math.min(endSec, duration));

        if (clampedEnd - clampedStart < 0.05) {
            alert('í¸ì§‘í•˜ë ¤ëŠ” êµ¬ê°„ì´ ë„ˆë¬´ ì§§ìŠµë‹ˆë‹¤. ì¡°ê¸ˆ ë” ê¸´ êµ¬ê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }

        const startSample = Math.floor(clampedStart * sampleRate);
        const endSample = Math.floor(clampedEnd * sampleRate);
        const frameCount = endSample - startSample;

        let editedBuffer;
        if (typeof AudioBuffer === 'function') {
            editedBuffer = new AudioBuffer({
                length: frameCount,
                numberOfChannels: audioBuffer.numberOfChannels,
                sampleRate
            });
        } else {
            const TempCtx = window.AudioContext || window.webkitAudioContext;
            if (!TempCtx) {
                throw new Error('ì˜¤ë””ì˜¤ í¸ì§‘ì„ ìœ„í•œ AudioBufferë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
            const tempCtx = new TempCtx();
            try {
                editedBuffer = tempCtx.createBuffer(audioBuffer.numberOfChannels, frameCount, sampleRate);
            } finally {
                if (typeof tempCtx.close === 'function') {
                    tempCtx.close();
                }
            }
        }

        for (let channel = 0; channel < audioBuffer.numberOfChannels; channel++) {
            const sourceData = audioBuffer.getChannelData(channel).subarray(startSample, endSample);
            editedBuffer.copyToChannel(sourceData, channel, 0);
        }

        const wavArrayBuffer = audioBufferToWav(editedBuffer);
        const blob = new Blob([wavArrayBuffer], { type: 'audio/wav' });

        const baseName = (mediaInfo.fileName || mediaInfo.file.name || `${trackType}_audio`).replace(/\.[^.]+$/, '');
        const suffix = options.nameSuffix || 'edited';
        const newFileName = `${baseName}_${suffix}.wav`;
        const editedFile = new File([blob], newFileName, { type: 'audio/wav' });

        await handleAudioFileLoad(editedFile, trackType, { silent: true, skipAlert: true });
        clearAudioSelection(trackType);
        updateAudioSelectionUI();

        if (!options.skipAlert) {
            const message = options.successMessage || 'ì˜¤ë””ì˜¤ê°€ í¸ì§‘ë˜ì—ˆìŠµë‹ˆë‹¤.';
            alert(message);
        }

        return {
            file: editedFile,
            duration: editedBuffer.length / sampleRate
        };
    } catch (error) {
        console.error('ì˜¤ë””ì˜¤ í¸ì§‘ ì‹¤íŒ¨:', error);
        if (!options.skipAlert) {
            alert(`âŒ ì˜¤ë””ì˜¤ í¸ì§‘ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\n${error.message || error}`);
        }
        throw error;
    }
}

async function trimAudioToVideoLength(trackType) {
    const videoInfo = loadedMedia.video;
    if (!videoInfo || !videoInfo.duration) {
        alert('ë¨¼ì € ì˜ìƒì„ ë¡œë“œí•´ì£¼ì„¸ìš”.');
        return;
    }

    const mediaInfo = loadedMedia[trackType];
    if (!mediaInfo || !mediaInfo.duration) {
        alert(`ë¨¼ì € ${getAudioTrackDisplayName(trackType)} íŠ¸ë™ì— ì˜¤ë””ì˜¤ë¥¼ ë¡œë“œí•´ì£¼ì„¸ìš”.`);
        return;
    }

    if (mediaInfo.duration <= videoInfo.duration + 0.05) {
        alert('ì´ë¯¸ ì˜ìƒ ê¸¸ì´ì™€ ê°™ê±°ë‚˜ ë” ì§§ì€ ì˜¤ë””ì˜¤ì…ë‹ˆë‹¤.');
        return;
    }

    const displayName = getAudioTrackDisplayName(trackType);
    await trimAudioSegment(trackType, 0, videoInfo.duration, {
        nameSuffix: 'trimmed',
        successMessage: `${displayName} íŠ¸ë™ì„ ì˜ìƒ ê¸¸ì´(${formatSecondsWithMs(videoInfo.duration)})ì— ë§ì¶° ì˜ëìŠµë‹ˆë‹¤.`
    });
}

async function deleteAudioFromSelection(trackType) {
    if (!currentAudioSelection || currentAudioSelection.trackType !== trackType) {
        alert('ë¨¼ì € íƒ€ì„ë¼ì¸ì—ì„œ ì‚­ì œí•  ìœ„ì¹˜ë¥¼ í´ë¦­í•˜ì—¬ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }

    const mediaInfo = loadedMedia[trackType];
    if (!mediaInfo || !mediaInfo.duration) {
        alert(`ë¨¼ì € ${getAudioTrackDisplayName(trackType)} íŠ¸ë™ì— ì˜¤ë””ì˜¤ë¥¼ ë¡œë“œí•´ì£¼ì„¸ìš”.`);
        return;
    }

    const targetTime = Math.max(0, Math.min(currentAudioSelection.time, mediaInfo.duration));

    if (targetTime <= 0.1) {
        if (confirm('ì„ íƒ ìœ„ì¹˜ê°€ 0ì´ˆì— ê°€ê¹ìŠµë‹ˆë‹¤. ì „ì²´ ì˜¤ë””ì˜¤ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            clearMediaTrack(trackType);
        }
        return;
    }

    const displayName = getAudioTrackDisplayName(trackType);
    await trimAudioSegment(trackType, 0, targetTime, {
        nameSuffix: 'cut',
        successMessage: `${displayName} íŠ¸ë™ì˜ ${formatSecondsWithMs(targetTime)} ì´í›„ êµ¬ê°„ì„ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.`
    });
}

// ì£¼ìë§‰ ì–¸ì–´ ì„ íƒ ë‹¤ì´ì–¼ë¡œê·¸ í‘œì‹œ
function showTranslationDialog() {
    // ë©”ì¸ ìë§‰ì´ ë¡œë“œë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
    if (!loadedSubtitles.main || loadedSubtitles.main.length === 0) {
        alert('âš ï¸ ë©”ì¸ ìë§‰ì„ ë¨¼ì € íƒ€ì„ë¼ì¸ì— ë¡œë“œí•´ì£¼ì„¸ìš”.\n\níƒ€ì„ë¼ì¸ì˜ "ğŸ“ ë©”ì¸ ìë§‰" íŠ¸ë™ì—ì„œ ğŸ“‚ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ìë§‰ íŒŒì¼ì„ ë¡œë“œí•˜ì„¸ìš”.');
        return;
    }

    // ë‹¤ì´ì–¼ë¡œê·¸ ìƒì„±
    const dialog = document.createElement('div');
    dialog.id = 'translation-lang-dialog';
    dialog.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        animation: fadeIn 0.2s ease-out;
    `;

    dialog.innerHTML = `
        <div style="background: #1e293b; border-radius: 12px; padding: 30px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);">
            <h3 style="margin: 0 0 20px 0; color: #10b981; font-size: 24px;">ğŸŒ ì£¼ìë§‰ ì¶”ì¶œ</h3>
            <p style="margin: 0 0 20px 0; color: #94a3b8; line-height: 1.6;">
                ë©”ì¸ ìë§‰ <strong style="color: #10b981;">${loadedSubtitles.main.length}ê°œ</strong>ë¥¼ AIë¡œ ë²ˆì—­í•˜ì—¬<br>
                ì£¼ìë§‰ íŠ¸ë™ì— ìë™ìœ¼ë¡œ ì¶”ê°€í•©ë‹ˆë‹¤.
            </p>
            <div style="margin-bottom: 25px;">
                <label style="display: block; margin-bottom: 10px; color: #e2e8f0; font-weight: 600;">ë²ˆì—­í•  ì–¸ì–´ ì„ íƒ</label>
                <select id="dialog-translation-lang" style="width: 100%; padding: 12px 16px; border: 2px solid #4a5568; border-radius: 8px; background: #0f172a; color: #e2e8f0; font-size: 16px; cursor: pointer;">
                    <option value="en">ğŸ‡ºğŸ‡¸ ì˜ì–´ (English)</option>
                    <option value="ja">ğŸ‡¯ğŸ‡µ ì¼ë³¸ì–´ (æ—¥æœ¬èª)</option>
                    <option value="zh">ğŸ‡¨ğŸ‡³ ì¤‘êµ­ì–´ (ä¸­æ–‡)</option>
                    <option value="es">ğŸ‡ªğŸ‡¸ ìŠ¤í˜ì¸ì–´ (EspaÃ±ol)</option>
                    <option value="fr">ğŸ‡«ğŸ‡· í”„ë‘ìŠ¤ì–´ (FranÃ§ais)</option>
                    <option value="de">ğŸ‡©ğŸ‡ª ë…ì¼ì–´ (Deutsch)</option>
                    <option value="vi">ğŸ‡»ğŸ‡³ ë² íŠ¸ë‚¨ì–´ (Tiáº¿ng Viá»‡t)</option>
                    <option value="th">ğŸ‡¹ğŸ‡­ íƒœêµ­ì–´ (à¸ à¸²à¸©à¸²à¹„à¸—à¸¢)</option>
                </select>
            </div>
            <div style="display: flex; gap: 10px;">
                <button onclick="startTranslation()" class="btn-primary" style="flex: 1; padding: 12px; background: #10b981; font-size: 16px; font-weight: 600; border-radius: 8px; cursor: pointer;">
                    ğŸš€ ë²ˆì—­ ì‹œì‘
                </button>
                <button onclick="closeTranslationDialog()" class="btn-secondary" style="flex: 1; padding: 12px; background: #64748b; font-size: 16px; font-weight: 600; border-radius: 8px; cursor: pointer;">
                    ì·¨ì†Œ
                </button>
            </div>
        </div>
    `;

    document.body.appendChild(dialog);
}

// ë‹¤ì´ì–¼ë¡œê·¸ ë‹«ê¸°
function closeTranslationDialog() {
    const dialog = document.getElementById('translation-lang-dialog');
    if (dialog) {
        dialog.remove();
    }
}

// ë²ˆì—­ ì‹œì‘
function startTranslation() {
    const targetLang = document.getElementById('dialog-translation-lang')?.value;
    closeTranslationDialog();
    extractTranslationSubtitles(targetLang);
}

// ì£¼ìë§‰ ì¶”ì¶œ í•¨ìˆ˜
async function extractTranslationSubtitles(targetLang = 'en') {
    console.log('ğŸŒ ì£¼ìë§‰ ì¶”ì¶œ ì‹œì‘...');

    // 1. ë©”ì¸ ìë§‰ì´ ë¡œë“œë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
    if (!loadedSubtitles.main || loadedSubtitles.main.length === 0) {
        alert('âš ï¸ ë©”ì¸ ìë§‰ì„ ë¨¼ì € ë¡œë“œí•´ì£¼ì„¸ìš”.');
        return;
    }

    // 2. ì–¸ì–´ ì´ë¦„ ë§¤í•‘
    const langNames = {
        'en': 'ì˜ì–´',
        'ja': 'ì¼ë³¸ì–´',
        'zh': 'ì¤‘êµ­ì–´',
        'es': 'ìŠ¤í˜ì¸ì–´',
        'fr': 'í”„ë‘ìŠ¤ì–´',
        'de': 'ë…ì¼ì–´',
        'vi': 'ë² íŠ¸ë‚¨ì–´',
        'th': 'íƒœêµ­ì–´'
    };

    console.log(`ğŸ“ ë©”ì¸ ìë§‰ ${loadedSubtitles.main.length}ê°œë¥¼ ${langNames[targetLang]}ë¡œ ë²ˆì—­ ì¤‘...`);

    // ë¡œë”© ë©”ì‹œì§€ í‘œì‹œ
    const loadingDiv = document.createElement('div');
    loadingDiv.id = 'translation-loading';
    loadingDiv.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 30px 50px;
        border-radius: 12px;
        z-index: 10000;
        text-align: center;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
    `;
    loadingDiv.innerHTML = `
        <div style="font-size: 48px; margin-bottom: 15px;">ğŸŒ</div>
        <div style="font-size: 18px; font-weight: bold; margin-bottom: 10px;">ë²ˆì—­ ì¤‘...</div>
        <div style="font-size: 14px; color: #94a3b8;">ìë§‰ ${loadedSubtitles.main.length}ê°œë¥¼ ${langNames[targetLang]}ë¡œ ë²ˆì—­í•˜ê³  ìˆìŠµë‹ˆë‹¤</div>
        <div style="margin-top: 15px;">
            <div class="spinner" style="border: 3px solid rgba(255, 255, 255, 0.3); border-top: 3px solid #10b981; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto;"></div>
        </div>
    `;
    document.body.appendChild(loadingDiv);

    try {
        // 3. ë°±ì—”ë“œ API í˜¸ì¶œ
        const response = await fetch('/api/video-analyzer/translate-subtitles', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                subtitles: loadedSubtitles.main,
                target_lang: targetLang
            })
        });

        if (!response.ok) {
            throw new Error(`ë²ˆì—­ API ì˜¤ë¥˜: ${response.status}`);
        }

        const result = await response.json();
        console.log('âœ… ë²ˆì—­ ì™„ë£Œ:', result);

        // 4. ë²ˆì—­ëœ ìë§‰ì„ ì£¼ìë§‰ íŠ¸ë™ì— í‘œì‹œ
        if (result.translated_subtitles && result.translated_subtitles.length > 0) {
            // ìë§‰ ë°ì´í„° ì €ì¥
            loadedSubtitles.translation = result.translated_subtitles;

            // íƒ€ì„ë¼ì¸ì— í‘œì‹œ
            displaySubtitlesOnTimeline(result.translated_subtitles, 'translation');

            // SRT í˜•ì‹ìœ¼ë¡œ ë³€í™˜
            const srtContent = convertToSRT(result.translated_subtitles);

            // 5. IndexedDBì— ì €ì¥ (Blobìœ¼ë¡œ ë³€í™˜)
            const blob = new Blob([srtContent], { type: 'text/plain' });
            const file = new File([blob], `translated_${targetLang}.srt`, { type: 'text/plain' });

            try {
                await saveFileToIndexedDB('translation-subtitle', 'subtitle', file, {
                    fileName: file.name,
                    targetLang: targetLang
                });
                console.log('âœ… ì£¼ìë§‰ì´ IndexedDBì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (error) {
                console.error('âŒ IndexedDB ì €ì¥ ì‹¤íŒ¨:', error);
            }

            // ë¹„ë””ì˜¤ í”Œë ˆì´ì–´ì— ì£¼ìë§‰ íŠ¸ë™ ë¡œë“œ
            const videoPlayer = document.getElementById('video-preview-player');
            if (videoPlayer) {
                const translationTrack = document.getElementById('video-translation-track');
                if (translationTrack) {
                    const blobUrl = URL.createObjectURL(blob);
                    translationTrack.src = blobUrl;

                    // ê¸°ì¡´ íŠ¸ë™ ë¹„í™œì„±í™”
                    for (let i = 0; i < videoPlayer.textTracks.length; i++) {
                        videoPlayer.textTracks[i].mode = 'hidden';
                    }

                    // ë²ˆì—­ íŠ¸ë™ í™œì„±í™”
                    const track = translationTrack.track;
                    if (track) {
                        track.mode = 'showing';
                        console.log('âœ… ì£¼ìë§‰ íŠ¸ë™ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    }
                }
            }

            // ì„±ê³µ ë©”ì‹œì§€
            loadingDiv.remove();

            const successDiv = document.createElement('div');
            successDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #10b981;
                color: white;
                padding: 20px 30px;
                border-radius: 8px;
                z-index: 10000;
                box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
                animation: slideInRight 0.3s ease-out;
            `;
            successDiv.innerHTML = `
                <div style="font-size: 24px; margin-bottom: 8px;">âœ…</div>
                <div style="font-weight: bold; margin-bottom: 5px;">ë²ˆì—­ ì™„ë£Œ!</div>
                <div style="font-size: 12px; opacity: 0.9;">${result.translated_subtitles.length}ê°œì˜ ìë§‰ì´ ${langNames[targetLang]}ë¡œ ë²ˆì—­ë˜ì—ˆìŠµë‹ˆë‹¤</div>
            `;
            document.body.appendChild(successDiv);
            setTimeout(() => successDiv.remove(), 5000);

        } else {
            throw new Error('ë²ˆì—­ ê²°ê³¼ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
        }

    } catch (error) {
        console.error('âŒ ë²ˆì—­ ì‹¤íŒ¨:', error);
        loadingDiv.remove();
        alert(`âŒ ë²ˆì—­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\n${error.message}`);
    }
}

// ìë§‰ ë°°ì—´ì„ SRT í˜•ì‹ìœ¼ë¡œ ë³€í™˜
function convertToSRT(subtitles) {
    let srtContent = '';

    subtitles.forEach((subtitle, index) => {
        srtContent += `${index + 1}\n`;
        srtContent += `${subtitle.start} --> ${subtitle.end}\n`;
        srtContent += `${subtitle.text}\n\n`;
    });

    return srtContent;
}

// íŠ¸ë™ ë¹„ìš°ê¸° ê¸°ëŠ¥
function clearTrack(trackType) {
    console.log(`ğŸ—‘ï¸ íŠ¸ë™ ë¹„ìš°ê¸°: ${trackType}`);

    const trackNames = {
        main: 'ë©”ì¸ ìë§‰',
        translation: 'ì£¼ìë§‰',
        description: 'ë³´ì¡°ìë§‰'
    };

    // í™•ì¸ ëŒ€í™”ìƒì í‘œì‹œ
    if (!confirm(`${trackNames[trackType]} íŠ¸ë™ì˜ ëª¨ë“  ìë§‰ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
        return;
    }

    // íŠ¸ë™ ì»¨í…ì¸  ì˜ì—­ ê°€ì ¸ì˜¤ê¸°
    const trackContent = document.getElementById(`${trackType}-subtitle-content`);
    if (trackContent) {
        // ëª¨ë“  ìë§‰ ë¸”ë¡ ì œê±°
        trackContent.innerHTML = '';
        console.log(`âœ… ${trackNames[trackType]} íŠ¸ë™ì´ ë¹„ì›Œì¡ŒìŠµë‹ˆë‹¤.`);

        // ë¡œë“œëœ ìë§‰ ë°ì´í„°ì—ì„œë„ ì œê±°
        if (loadedSubtitles[trackType]) {
            loadedSubtitles[trackType] = [];
        }

        // íŒŒì¼ëª…ë„ ì´ˆê¸°í™” ë° í‘œì‹œ ì—…ë°ì´íŠ¸
        loadedSubtitleFiles[trackType] = null;
        updateSubtitleFileDisplay();
    }
}

// ë¯¸ë””ì–´ íŠ¸ë™ ë¹„ìš°ê¸° ê¸°ëŠ¥
function clearMediaTrack(trackType) {
    console.log(`ğŸ—‘ï¸ ë¯¸ë””ì–´ íŠ¸ë™ ë¹„ìš°ê¸°: ${trackType}`);

    const trackNames = {
        video: 'ì˜ìƒ',
        audio: 'ìŒì„±',
        commentary: 'í•´ì„¤ ìŒì„±',
        bgm: 'ë°°ê²½ ìŒì•…'
    };

    // í™•ì¸ ëŒ€í™”ìƒì í‘œì‹œ
    if (!confirm(`${trackNames[trackType]} íŠ¸ë™ì„ ë¹„ìš°ì‹œê² ìŠµë‹ˆê¹Œ?\n\në¡œë“œëœ íŒŒì¼ì´ ì œê±°ë©ë‹ˆë‹¤.`)) {
        return;
    }

    clearAudioSelection(trackType);

    // ë¡œë“œëœ ë¯¸ë””ì–´ ë°ì´í„° ì´ˆê¸°í™”
    if (loadedMedia[trackType]) {
        const mediaInfo = loadedMedia[trackType];
        if (mediaInfo && mediaInfo.audioElement) {
            try {
                mediaInfo.audioElement.pause();
            } catch (error) {
                console.warn('ì˜¤ë””ì˜¤ íŠ¸ë™ ì¼ì‹œì •ì§€ ì‹¤íŒ¨:', error);
            }
        }
        if (mediaInfo && mediaInfo.objectUrl) {
            URL.revokeObjectURL(mediaInfo.objectUrl);
        }
        loadedMedia[trackType] = null;
    }

    // íŠ¸ë™ë³„ UI ì´ˆê¸°í™”
    if (trackType === 'video') {
        // ì˜ìƒ íŠ¸ë™ ì´ˆê¸°í™”
        const videoTrack = document.getElementById('video-track');
        if (videoTrack) {
            videoTrack.innerHTML = '';
        }
        // ë¹„ë””ì˜¤ í”Œë ˆì´ì–´ ì´ˆê¸°í™”
        const videoPlayer = document.getElementById('video-preview-player');
        if (videoPlayer) {
            videoPlayer.src = '';
            videoPlayer.load();
            pauseAllAudioTracks();
        }
    } else {
        // ì˜¤ë””ì˜¤ íŠ¸ë™ ì´ˆê¸°í™” (audio, commentary, bgm)
        const canvasId = trackType === 'audio' ? 'timeline-waveform' :
                        trackType === 'commentary' ? 'commentary-waveform' :
                        'bgm-waveform';
        const canvas = document.getElementById(canvasId);
        if (canvas) {
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
        const trackId = trackType === 'audio' ? 'audio-track' :
                        trackType === 'commentary' ? 'commentary-audio-track' :
                        'bgm-audio-track';
        const audioTrack = document.getElementById(trackId);
        if (audioTrack) {
            const overlay = audioTrack.querySelector('.audio-clip-overlay');
            if (overlay) {
                overlay.remove();
            }
        }
        pauseAllAudioTracks();
    }

    console.log(`âœ… ${trackNames[trackType]} íŠ¸ë™ì´ ë¹„ì›Œì¡ŒìŠµë‹ˆë‹¤.`);
}

// íŠ¸ë™ ë¹„ìš°ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
document.addEventListener('DOMContentLoaded', () => {
    ['main', 'translation', 'description'].forEach(trackType => {
        const clearBtn = document.querySelector(`.track-clear[data-track="${trackType}"]`);
        if (clearBtn) {
            clearBtn.addEventListener('click', () => {
                clearTrack(trackType);
            });
        }
    });
});

// ==================== ìë§‰ í…œí”Œë¦¿ ì»¨íŠ¸ë¡¤ ====================
function toggleBannerControls() {
    const template = document.querySelector('input[name="subtitle-template-video"]:checked')?.value;
    const bannerControls = document.getElementById('banner-controls-video');

    if (template === 'banner') {
        bannerControls.style.display = 'block';
    } else {
        bannerControls.style.display = 'none';
    }

    // ì„ íƒëœ ë¼ë””ì˜¤ ë²„íŠ¼ì˜ label ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
    document.querySelectorAll('input[name="subtitle-template-video"]').forEach(radio => {
        const label = radio.closest('label');
        if (radio.checked) {
            label.style.borderColor = 'rgba(74, 158, 255, 1)';
            label.style.background = 'rgba(74, 158, 255, 0.1)';
        } else {
            label.style.borderColor = 'transparent';
            label.style.background = 'rgba(42, 46, 62, 0.8)';
        }
    });
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', () => {
    toggleBannerControls();
});

// ==================== íŒ¨ë„ í† ê¸€ ê¸°ëŠ¥ ====================
function toggleBrowserPanel() {
    const content = document.getElementById('browser-panel-content');
    const toggle = document.getElementById('browser-panel-toggle');

    if (content.style.display === 'none') {
        content.style.display = 'block';
        toggle.textContent = 'â–¼';
        toggle.style.transform = 'rotate(0deg)';
    } else {
        content.style.display = 'none';
        toggle.textContent = 'â–¶';
        toggle.style.transform = 'rotate(-90deg)';
    }
}

function togglePerformancePanel() {
    const content = document.getElementById('performance-panel-content');
    const toggle = document.getElementById('performance-panel-toggle');

    if (content.style.display === 'none') {
        content.style.display = 'block';
        toggle.textContent = 'â–¼';
        toggle.style.transform = 'rotate(0deg)';
    } else {
        content.style.display = 'none';
        toggle.textContent = 'â–¶';
        toggle.style.transform = 'rotate(-90deg)';
    }
}

// ==================== ì„±ëŠ¥ ëŒ€ì‹œë³´ë“œ ====================
function showPerformanceReport() {
    const resultsDiv = document.getElementById('performance-dashboard-results');

    try {
        if (!window.performanceMonitor) {
            throw new Error('Performance Monitorê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        }

        const reportHTML = window.performanceMonitor.generateHTMLReport();
        resultsDiv.innerHTML = reportHTML;
        resultsDiv.style.display = 'block';

        // ì½˜ì†”ì—ë„ ì¶œë ¥
        window.performanceMonitor.printReport();

        console.log('ğŸ“Š ì„±ëŠ¥ ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
    } catch (error) {
        console.error('ì„±ëŠ¥ ë¦¬í¬íŠ¸ ìƒì„± ì¤‘ ì˜¤ë¥˜:', error);
        resultsDiv.innerHTML = `
            <div style="padding: 15px; background: rgba(255, 68, 68, 0.1); border: 1px solid #ff4444; border-radius: 6px; color: #ff4444;">
                <strong>âš ï¸ ë¦¬í¬íŠ¸ ìƒì„± ì‹¤íŒ¨</strong>
                <p style="margin: 5px 0 0 0; font-size: 0.9rem;">${error.message}</p>
            </div>
        `;
        resultsDiv.style.display = 'block';
    }
}

function clearPerformanceData() {
    if (confirm('ëª¨ë“  ì„±ëŠ¥ ì¸¡ì • ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        window.performanceMonitor.clear();
        const resultsDiv = document.getElementById('performance-dashboard-results');
        resultsDiv.style.display = 'none';
        console.log('âœ¨ ì„±ëŠ¥ ë°ì´í„° ì´ˆê¸°í™” ì™„ë£Œ');
    }
}

// ==================== ë¸Œë¼ìš°ì € ì§„ë‹¨ ====================
let browserCapChecker = null;

async function runBrowserDiagnostics() {
    const resultsDiv = document.getElementById('browser-diagnostic-results');
    const button = event.target;

    // ë²„íŠ¼ ë¹„í™œì„±í™” ë° ë¡œë”© í‘œì‹œ
    button.disabled = true;
    button.textContent = 'ì§„ë‹¨ ì¤‘...';

    try {
        // BrowserCapabilities ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
        if (!browserCapChecker) {
            browserCapChecker = new BrowserCapabilities();
        }

        // ì§„ë‹¨ ì‹¤í–‰
        const capabilities = await browserCapChecker.checkAll();

        // ê²°ê³¼ í‘œì‹œ
        resultsDiv.innerHTML = browserCapChecker.formatAsHTML();
        resultsDiv.style.display = 'block';

        // ì½˜ì†”ì—ë„ ì¶œë ¥
        browserCapChecker.printToConsole();

        console.log('ğŸ” ë¸Œë¼ìš°ì € ê¸°ëŠ¥ ì§„ë‹¨ ì™„ë£Œ:', capabilities);
    } catch (error) {
        console.error('ë¸Œë¼ìš°ì € ì§„ë‹¨ ì¤‘ ì˜¤ë¥˜:', error);
        resultsDiv.innerHTML = `
            <div style="padding: 15px; background: rgba(255, 68, 68, 0.1); border: 1px solid #ff4444; border-radius: 6px; color: #ff4444;">
                <strong>âš ï¸ ì§„ë‹¨ ì‹¤íŒ¨</strong>
                <p style="margin: 5px 0 0 0; font-size: 0.9rem;">${error.message}</p>
            </div>
        `;
        resultsDiv.style.display = 'block';
    } finally {
        // ë²„íŠ¼ ë³µêµ¬
        button.disabled = false;
        button.textContent = 'ì§„ë‹¨ ì¬ì‹¤í–‰';
    }
}

</script>

<!-- ë¸Œë¼ìš°ì € ê¸°ëŠ¥ íƒì§€ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ -->
<script src="/static/browser-capabilities.js"></script>

<!-- ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ -->
<script src="/static/performance-monitor.js"></script>

<!-- MP4Box.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/mp4box@0.5.2/dist/mp4box.all.min.js"></script>

<!-- MP4 ë¶„ì„ê¸° ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ -->
<script src="/static/mp4-analyzer.js"></script>

<!-- Canvas ë¯¸ë¦¬ë³´ê¸° ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ -->
<script src="/static/canvas-preview.js"></script>

<!-- í•´ìƒë„ ì„ íƒ ê¸°ëŠ¥ -->
<script>
// í˜„ì¬ í•´ìƒë„ ì„¤ì •
let currentResolution = {
    width: 1920,
    height: 1080,
    aspectRatio: '16:9',
    name: 'youtube'
};

// í•´ìƒë„ í”„ë¦¬ì…‹
const resolutionPresets = {
    youtube: { width: 1920, height: 1080, aspectRatio: '16:9', name: 'ìœ íŠœë¸Œ' },
    shorts: { width: 1080, height: 1920, aspectRatio: '9:16', name: 'ì‡¼ì¸ ' },
    '4k': { width: 3840, height: 2160, aspectRatio: '16:9', name: '4K' }
};

// í•´ìƒë„ ì„¤ì • í•¨ìˆ˜
function setPreviewResolution(preset) {
    // ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ì—…ë°ì´íŠ¸
    document.querySelectorAll('[id^="btn-"][id$="-res"]').forEach(btn => {
        btn.style.opacity = '0.6';
        btn.style.transform = 'scale(1)';
    });

    if (preset === 'custom') {
        // ì»¤ìŠ¤í…€ í•´ìƒë„ ì…ë ¥ í‘œì‹œ
        document.getElementById('custom-resolution-input').style.display = 'block';
        document.getElementById('btn-custom-res').style.opacity = '1';
        document.getElementById('btn-custom-res').style.transform = 'scale(1.05)';
        return;
    } else {
        // ì»¤ìŠ¤í…€ ì…ë ¥ ìˆ¨ê¹€
        document.getElementById('custom-resolution-input').style.display = 'none';
    }

    // ì„ íƒëœ ë²„íŠ¼ ê°•ì¡°
    const selectedBtn = document.getElementById(`btn-${preset}-res`);
    if (selectedBtn) {
        selectedBtn.style.opacity = '1';
        selectedBtn.style.transform = 'scale(1.05)';
    }

    // í•´ìƒë„ ì ìš©
    const resolution = resolutionPresets[preset];
    if (resolution) {
        currentResolution = { ...resolution, name: preset };
        applyResolutionToPreview(resolution.width, resolution.height);
        updateResolutionDisplay(`${resolution.width}Ã—${resolution.height} (${resolution.aspectRatio})`);
        console.log(`ğŸ“ í•´ìƒë„ ë³€ê²½: ${resolution.name} ${resolution.width}Ã—${resolution.height}`);
    }
}

// ì»¤ìŠ¤í…€ í•´ìƒë„ ì ìš©
function applyCustomResolution() {
    const width = parseInt(document.getElementById('custom-width').value);
    const height = parseInt(document.getElementById('custom-height').value);

    if (!width || !height || width < 320 || height < 240) {
        alert('âš ï¸ ì˜¬ë°”ë¥¸ í•´ìƒë„ë¥¼ ì…ë ¥í•˜ì„¸ìš”. (ìµœì†Œ 320Ã—240)');
        return;
    }

    const gcd = (a, b) => b === 0 ? a : gcd(b, a % b);
    const divisor = gcd(width, height);
    const aspectRatio = `${width / divisor}:${height / divisor}`;

    currentResolution = { width, height, aspectRatio, name: 'custom' };
    applyResolutionToPreview(width, height);
    updateResolutionDisplay(`${width}Ã—${height} (${aspectRatio})`);
    console.log(`ğŸ“ ì»¤ìŠ¤í…€ í•´ìƒë„ ì ìš©: ${width}Ã—${height} (${aspectRatio})`);
}

// ë¯¸ë¦¬ë³´ê¸°ì— í•´ìƒë„ ì ìš©
function applyResolutionToPreview(width, height) {
    const canvas = document.getElementById('video-canvas-preview');
    const video = document.getElementById('video-preview-player');
    const wrapper = document.querySelector('.video-subtitle-wrapper');

    if (canvas && video) {
        // Canvas í¬ê¸° ì„¤ì •
        canvas.width = width;
        canvas.height = height;

        // ë¹„ë””ì˜¤ ì»¨í…Œì´ë„ˆ ìµœëŒ€ í¬ê¸° ì„¤ì • (í™”ë©´ í¬ê¸°ì— ë§ê²Œ ìŠ¤ì¼€ì¼ë§)
        const maxWidth = 800;
        const scale = Math.min(1, maxWidth / width);
        const displayWidth = width * scale;
        const displayHeight = height * scale;

        if (wrapper) {
            wrapper.style.width = displayWidth + 'px';
            wrapper.style.height = displayHeight + 'px';
        }

        // Canvas ë Œë”ë§
        if (canvasPreview) {
            canvasPreview.render();
            syncOverlaysToCanvas();
        }
    }
}

// í•´ìƒë„ í‘œì‹œ ì—…ë°ì´íŠ¸
function updateResolutionDisplay(text) {
    const display = document.getElementById('current-res-text');
    if (display) {
        display.textContent = text;
    }
}
</script>

<!-- Canvas ë¯¸ë¦¬ë³´ê¸° ì´ˆê¸°í™” -->
<script>
// ì „ì—­ Canvas ë¯¸ë¦¬ë³´ê¸° ì¸ìŠ¤í„´ìŠ¤
let canvasPreview = null;

// Canvas ë¯¸ë¦¬ë³´ê¸° í™œì„±í™”/ë¹„í™œì„±í™”
function toggleCanvasPreview(enabled) {
    const canvas = document.getElementById('video-canvas-preview');
    const videoPlayer = document.getElementById('video-preview-player');
    const cssOverlays = document.querySelectorAll('.video-text-overlay, #top-black-bar, #bottom-black-bar');

    if (enabled) {
        // Canvas í‘œì‹œ, CSS ì˜¤ë²„ë ˆì´ ìˆ¨ê¹€
        canvas.style.display = 'block';
        cssOverlays.forEach(el => el.style.opacity = '0.3'); // ì°¸ê³ ìš©ìœ¼ë¡œ ë°˜íˆ¬ëª…í•˜ê²Œ ìœ ì§€

        // Canvas ë¯¸ë¦¬ë³´ê¸° ì´ˆê¸°í™”
        if (!canvasPreview) {
            canvasPreview = new CanvasVideoPreview('video-canvas-preview', 'video-preview-player');
            console.log('âœ… Canvas ë¯¸ë¦¬ë³´ê¸° í™œì„±í™”ë¨');
        }
    } else {
        // Canvas ìˆ¨ê¹€, CSS ì˜¤ë²„ë ˆì´ í‘œì‹œ
        canvas.style.display = 'none';
        cssOverlays.forEach(el => el.style.opacity = '1');
        console.log('ğŸ“º CSS ì˜¤ë²„ë ˆì´ ëª¨ë“œ');
    }
}

// ë¹„ë””ì˜¤ ë¡œë“œ ì‹œ Canvas ìë™ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', () => {
    const videoPlayer = document.getElementById('video-preview-player');

    // ê¸°ë³¸ í•´ìƒë„ ë²„íŠ¼ í™œì„±í™” (ìœ íŠœë¸Œ)
    const youtubeBtn = document.getElementById('btn-youtube-res');
    if (youtubeBtn) {
        youtubeBtn.style.opacity = '1';
        youtubeBtn.style.transform = 'scale(1.05)';
    }

    videoPlayer.addEventListener('loadedmetadata', () => {
        // ê¸°ë³¸ì ìœ¼ë¡œ Canvas ë¯¸ë¦¬ë³´ê¸° í™œì„±í™”
        toggleCanvasPreview(true);

        // í˜„ì¬ ì„¤ì •ëœ í•´ìƒë„ë¡œ Canvas í¬ê¸° ì„¤ì •
        applyResolutionToPreview(currentResolution.width, currentResolution.height);

        // ê²€ì • ë°°ê²½ ì´ˆê¸°ê°’ ì„¤ì • (ì˜ˆì‹œ)
        if (canvasPreview) {
            canvasPreview.setBlackBars(
                { enabled: false, height: 15, opacity: 0.8 }, // ìƒë‹¨
                { enabled: false, height: 15, opacity: 0.8 }  // í•˜ë‹¨
            );
        }
    });

    // íƒ€ì„ë¼ì¸ ìë§‰ ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    const mainSubtitleCheckbox = document.getElementById('track-main-subtitle-enable');
    const translationSubtitleCheckbox = document.getElementById('track-translation-subtitle-enable');
    const descriptionSubtitleCheckbox = document.getElementById('track-description-subtitle-enable');

    if (mainSubtitleCheckbox) {
        mainSubtitleCheckbox.addEventListener('change', (e) => {
            if (canvasPreview) {
                canvasPreview.setSubtitleEnabled('main', e.target.checked);
            }
            // ì¦‰ì‹œ ì˜¤ë²„ë ˆì´ ì—…ë°ì´íŠ¸
            const videoPlayer = document.getElementById('video-preview-player');
            if (videoPlayer && typeof updateSubtitleOverlaysFromTimeline === 'function') {
                updateSubtitleOverlaysFromTimeline(videoPlayer.currentTime);
            }
        });
    }

    if (translationSubtitleCheckbox) {
        translationSubtitleCheckbox.addEventListener('change', (e) => {
            if (canvasPreview) {
                canvasPreview.setSubtitleEnabled('translation', e.target.checked);
            }
            // ì¦‰ì‹œ ì˜¤ë²„ë ˆì´ ì—…ë°ì´íŠ¸
            const videoPlayer = document.getElementById('video-preview-player');
            if (videoPlayer && typeof updateSubtitleOverlaysFromTimeline === 'function') {
                updateSubtitleOverlaysFromTimeline(videoPlayer.currentTime);
            }
        });
    }

    if (descriptionSubtitleCheckbox) {
        descriptionSubtitleCheckbox.addEventListener('change', (e) => {
            if (canvasPreview) {
                canvasPreview.setSubtitleEnabled('description', e.target.checked);
            }
            // ì¦‰ì‹œ ì˜¤ë²„ë ˆì´ ì—…ë°ì´íŠ¸
            const videoPlayer = document.getElementById('video-preview-player');
            if (videoPlayer && typeof updateSubtitleOverlaysFromTimeline === 'function') {
                updateSubtitleOverlaysFromTimeline(videoPlayer.currentTime);
            }
        });
    }
});

// í…ìŠ¤íŠ¸ ì˜¤ë²„ë ˆì´ë¥¼ Canvasì— ë™ê¸°í™”í•˜ëŠ” í•¨ìˆ˜
function syncOverlaysToCanvas() {
    if (!canvasPreview) return;

    const titleOverlay = document.getElementById('video-title-overlay');
    const subtitleOverlay = document.getElementById('video-subtitle-overlay');
    const koreanOverlay = document.getElementById('korean-subtitle-overlay');
    const englishOverlay = document.getElementById('english-subtitle-overlay');

    canvasPreview.clearOverlays();

    // ì œëª© ì˜¤ë²„ë ˆì´
    if (titleOverlay && titleOverlay.style.display !== 'none' && titleOverlay.textContent.trim() !== 'ì˜ìƒ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”') {
        const titleStyle = window.getComputedStyle(titleOverlay);
        const fontSize = parseInt(titleStyle.fontSize) || 48;

        canvasPreview.addOverlay({
            text: titleOverlay.textContent.trim(),
            x: canvasPreview.canvas.width / 2,
            y: canvasPreview.canvas.height * 0.5, // 50% ìœ„ì¹˜ (ì¤‘ì•™)
            fontSize: fontSize,
            color: titleStyle.color || '#ffffff',
            borderWidth: 4,
            borderColor: '#000000',
            type: 'title'  // â­ type ì¶”ê°€
        });
    }

    // ë¶€ì œëª© ì˜¤ë²„ë ˆì´
    if (subtitleOverlay && subtitleOverlay.style.display !== 'none' && subtitleOverlay.textContent.trim() !== 'ë¶€ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”') {
        const subtitleStyle = window.getComputedStyle(subtitleOverlay);
        const fontSize = parseInt(subtitleStyle.fontSize) || 32;

        canvasPreview.addOverlay({
            text: subtitleOverlay.textContent.trim(),
            x: canvasPreview.canvas.width / 2,
            y: canvasPreview.canvas.height * 0.9, // 90% ìœ„ì¹˜
            fontSize: fontSize,
            color: subtitleStyle.color || '#ffe14d',
            borderWidth: 3,
            borderColor: '#000000',
            type: 'subtitle'  // â­ type ì¶”ê°€
        });
    }

    // ì£¼ìë§‰ (Korean) ì˜¤ë²„ë ˆì´
    if (koreanOverlay && koreanOverlay.style.display !== 'none' && !koreanOverlay.classList.contains('empty')) {
        const koreanStyle = window.getComputedStyle(koreanOverlay);
        const fontSize = parseInt(koreanStyle.fontSize) || 32;
        const left = parseFloat(koreanOverlay.style.left) || 50;
        const top = parseFloat(koreanOverlay.style.top) || 65;

        canvasPreview.addOverlay({
            text: koreanOverlay.textContent.trim(),
            x: canvasPreview.canvas.width * (left / 100),
            y: canvasPreview.canvas.height * (top / 100),
            fontSize: fontSize,
            color: koreanStyle.color || '#000000',
            borderWidth: 3,
            borderColor: '#ffffff',
            type: 'korean'
        });
    }

    // ë³´ì¡°ìë§‰ (English) ì˜¤ë²„ë ˆì´
    if (englishOverlay && englishOverlay.style.display !== 'none' && !englishOverlay.classList.contains('empty')) {
        const englishStyle = window.getComputedStyle(englishOverlay);
        const fontSize = parseInt(englishStyle.fontSize) || 28;
        const left = parseFloat(englishOverlay.style.left) || 50;
        const top = parseFloat(englishOverlay.style.top) || 95;

        canvasPreview.addOverlay({
            text: englishOverlay.textContent.trim(),
            x: canvasPreview.canvas.width * (left / 100),
            y: canvasPreview.canvas.height * (top / 100),
            fontSize: fontSize,
            color: englishStyle.color || '#000000',
            borderWidth: 3,
            borderColor: '#ffe14d',
            type: 'english'
        });
    }

    console.log('ğŸ¨ Canvas ì˜¤ë²„ë ˆì´ ë™ê¸°í™” ì™„ë£Œ:', canvasPreview.overlays);
}

// Canvasì— íƒ€ì„ë¼ì¸ ìë§‰ ì—…ë°ì´íŠ¸
function updateCanvasSubtitles(trackType, subtitles) {
    if (!canvasPreview) {
        console.log('â„¹ï¸ Canvas ë¯¸ë¦¬ë³´ê¸°ê°€ ì•„ì§ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        return;
    }

    // SRT í˜•ì‹ì˜ ìë§‰ì„ Canvas í˜•ì‹ìœ¼ë¡œ ë³€í™˜
    const canvasSubtitles = subtitles.map(sub => ({
        startTime: srtTimeToSeconds(sub.start),
        endTime: srtTimeToSeconds(sub.end),
        text: sub.text
    }));

    // Canvasì— ìë§‰ ë°ì´í„° ì„¤ì •
    canvasPreview.setTimelineSubtitles(trackType, canvasSubtitles);
}

// ëª¨ë“  íƒ€ì„ë¼ì¸ ìë§‰ì„ Canvasì— ì—…ë°ì´íŠ¸
function updateAllCanvasSubtitles() {
    if (!canvasPreview) return;
    canvasPreview.updateAllTimelineSubtitles(loadedSubtitles);
}

// í…ìŠ¤íŠ¸ ë³€ê²½ ì‹œ Canvas ì—…ë°ì´íŠ¸
function updateCanvasText() {
    if (canvasPreview) {
        syncOverlaysToCanvas();
    }
}

// ê²€ì • ë°°ê²½ í† ê¸€ì„ Canvasì— ë°˜ì˜
function updateCanvasBlackBars() {
    if (!canvasPreview) return;

    // ìŠ¬ë¼ì´ë”ì—ì„œ ì§ì ‘ ê°’ ê°€ì ¸ì˜¤ê¸°
    const topHeight = parseFloat(document.getElementById('top-bar-height')?.value) || 15;
    const topOpacity = parseFloat(document.getElementById('top-bar-opacity')?.value) || 80;
    const bottomHeight = parseFloat(document.getElementById('bottom-bar-height')?.value) || 15;
    const bottomOpacity = parseFloat(document.getElementById('bottom-bar-opacity')?.value) || 80;

    const topBar = document.getElementById('top-black-bar');
    const bottomBar = document.getElementById('bottom-black-bar');

    canvasPreview.setBlackBars(
        {
            enabled: topBar && topBar.style.display !== 'none',
            height: topHeight,
            opacity: topOpacity / 100  // 0~100ì„ 0~1ë¡œ ë³€í™˜
        },
        {
            enabled: bottomBar && bottomBar.style.display !== 'none',
            height: bottomHeight,
            opacity: bottomOpacity / 100  // 0~100ì„ 0~1ë¡œ ë³€í™˜
        }
    );
}

console.log('ğŸ¨ Canvas ë¯¸ë¦¬ë³´ê¸° ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ');
</script>

</body>
</html>
