<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>AI ì‡¼ì¸  ì œì‘ê¸°</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://unpkg.com/wavesurfer.js@7/dist/wavesurfer.min.js"></script>
</head>
<body>
<div class="container">
    <h1>AI ì‡¼ì¸  ì œì‘ê¸°</h1>
    <nav class="nav-links">
        <a href="/ytdl" class="nav-link">â¬‡ï¸ ë‹¤ìš´ë¡œë“œ ë„êµ¬</a>
        <a href="/subtitle-split" class="nav-link">âœ‚ï¸ ìë§‰ë¶„ë¦¬ í•˜ê¸°</a>
        <a href="/similarity" class="nav-link">ğŸï¸ ì˜ìƒ ìœ ì‚¬ë„ ê²€ì‚¬</a>
        <a href="/copyright" class="nav-link">ğŸ›¡ï¸ ì €ì‘ê¶Œ ê²€ì‚¬</a>
    </nav>

    <section class="panel">
        <h2>ìƒˆ í”„ë¡œì íŠ¸ ìƒì„±</h2>
        <form method="post" action="/generate" class="generate-form">
            <div class="field">
                <label for="topic">ì£¼ì œ</label>
                <input type="text" id="topic" name="topic" value="{{ form_values.topic }}" required>
            </div>
            <div class="field">
                <label for="style">ìŠ¤íƒ€ì¼</label>
                <input type="text" id="style" name="style" value="{{ form_values.style }}">
            </div>
            <div class="field inline">
                <label for="duration">ê¸¸ì´(ì´ˆ)</label>
                <input type="number" id="duration" name="duration" min="10" max="180" value="{{ form_values.duration }}">
                <label for="lang">ì–¸ì–´</label>
                <select id="lang" name="lang">
                    {% for value, label in lang_options %}
                    <option value="{{ value }}" {% if form_values.lang == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
                <label for="fps">FPS</label>
                <input type="number" id="fps" name="fps" min="12" max="60" value="{{ form_values.fps }}">
            </div>
            <div class="field inline">
                <label for="voice">TTS ìŒì„±</label>
                <input type="text" id="voice" name="voice" value="{{ form_values.voice }}">
                <label for="output_name">íŒŒì¼ëª…(ì„ íƒ)</label>
                <input type="text" id="output_name" name="output_name" value="{{ form_values.output_name }}" placeholder="ìë™ ìƒì„±">
            </div>
            <div class="field inline">
                <label><input type="checkbox" name="music" {% if form_values.music %}checked{% endif %}> ë°°ê²½ìŒ ì‚¬ìš©</label>
                <label>ë³¼ë¥¨<input type="number" step="0.01" min="0" max="1" name="music_volume" value="{{ form_values.music_volume }}"></label>
                <label>ë•í‚¹<input type="number" step="0.05" min="0" max="1" name="ducking" value="{{ form_values.ducking }}"></label>
            </div>
            <div class="field inline">
                <label><input type="checkbox" name="burn_subs" {% if form_values.burn_subs %}checked{% endif %}> ìë§‰ ë²ˆì¸</label>
                <label><input type="checkbox" name="dry_run" {% if form_values.dry_run %}checked{% endif %}> ë“œë¼ì´ëŸ°</label>
                <label><input type="checkbox" name="save_json" {% if form_values.save_json %}checked{% endif %}> JSON ì €ì¥</label>
            </div>
            <details class="advanced">
                <summary>ê³ ê¸‰ ì„¤ì •</summary>
                <div class="field inline">
                    <label for="script_model">ìŠ¤í¬ë¦½íŠ¸ ëª¨ë¸</label>
                    <input type="text" id="script_model" name="script_model" value="{{ form_values.script_model }}">
                    <label for="tts_model">TTS ëª¨ë¸</label>
                    <input type="text" id="tts_model" name="tts_model" value="{{ form_values.tts_model }}">
                </div>
            </details>
            <button type="submit">ìƒì„±í•˜ê¸°</button>
        </form>
    </section>

    <section class="panel">
        <h2>ê¸°ì¡´ í”„ë¡œì íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸°</h2>
        <form method="get" action="/shorts" class="existing-form">
            <label for="existing">í”„ë¡œì íŠ¸ ì„ íƒ</label>
            <select id="existing" name="existing">
                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                {% for item in project_summaries %}
                <option value="{{ item.base_name }}" {% if selected_project == item.base_name %}selected{% endif %}>
                    {{ item.base_name }} ({{ item.duration or '-' }}s)
                </option>
                {% endfor %}
            </select>
            <button type="submit">ë¶ˆëŸ¬ì˜¤ê¸°</button>
        </form>
        <ul class="existing-list">
            {% for item in project_summaries %}
            <li>{{ item.base_name }} - {{ item.topic or 'í† í”½ ì—†ìŒ' }} <small>({{ item.updated_at }})</small></li>
            {% endfor %}
        </ul>
    </section>

    {% if error %}
    <div class="alert error">
        <strong>ì˜¤ë¥˜:</strong> {{ error }}
    </div>
    {% endif %}

    {% if result %}
    <section class="panel project-detail">
        <h2>í”„ë¡œì íŠ¸ ì„¸ë¶€ ì •ë³´</h2>
        <div class="links">
            {% if result.video_url %}<a href="{{ result.video_url }}" target="_blank">ì˜ìƒ ë‹¤ìš´ë¡œë“œ</a>{% endif %}
            {% if result.audio_url %}<a href="{{ result.audio_url }}" target="_blank">ìŒì„± íŒŒì¼</a>{% endif %}
            {% if result.srt_url %}<a href="{{ result.srt_url }}" target="_blank">ìë§‰(SRT)</a>{% endif %}
            {% if result.json_url %}<a href="{{ result.json_url }}" target="_blank">ë©”íƒ€ë°ì´í„°</a>{% endif %}
        </div>
        <pre>{{ result.metadata_json }}</pre>

        <div class="timeline-visual">
            <div class="wave-controls">
                <button type="button" onclick="wavePlay()">â–¶ ì¬ìƒ</button>
                <button type="button" onclick="wavePause()">â¸ ì¼ì‹œì •ì§€</button>
                <span id="current-time">0.00s</span>
            </div>
            <div id="waveform"></div>
            <div id="timeline-overlay"></div>
        </div>

        <div class="timeline-controls">
            <h3>íƒ€ì„ë¼ì¸ ì„¸ê·¸ë¨¼íŠ¸</h3>
            <div class="control-row">
                <label>ì„¸ê·¸ë¨¼íŠ¸ ID <input type="text" id="segment-id" readonly></label>
                <label>ì‹œì‘ <input type="number" step="0.1" id="segment-start"></label>
                <label>ë <input type="number" step="0.1" id="segment-end"></label>
            </div>
            <div class="control-row">
                <label>ì†ŒìŠ¤ <input type="text" id="segment-source"></label>
                <label>íƒ€ì…
                    <select id="segment-type">
                        <option value="broll">broll</option>
                        <option value="image">image</option>
                        <option value="audio">audio</option>
                    </select>
                </label>
                <button type="button" onclick="applyTimelineEdit('{{ result.metadata.base_name }}')">ì„¸ê·¸ë¨¼íŠ¸ ì ìš©</button>
                <button type="button" onclick="refreshVersionHistory('{{ result.metadata.base_name }}')">ë²„ì „ ìƒˆë¡œê³ ì¹¨</button>
            </div>
            <div class="control-row secondary">
                <label>ìƒˆ ì‹œì‘ <input type="number" step="0.1" id="new-segment-start"></label>
                <label>ìƒˆ ë <input type="number" step="0.1" id="new-segment-end"></label>
                <label>ìƒˆ ì†ŒìŠ¤ <input type="text" id="new-segment-source" placeholder="auto"></label>
                <label>íƒ€ì…
                    <select id="new-segment-type">
                        <option value="broll" selected>broll</option>
                        <option value="image">image</option>
                        <option value="audio">audio</option>
                    </select>
                </label>
                <button type="button" onclick="addTimelineSegment()">ì„¸ê·¸ë¨¼íŠ¸ ì¶”ê°€</button>
                <button type="button" class="danger" onclick="removeTimelineSegment()">ì„ íƒ ì‚­ì œ</button>
            </div>
            <h4 class="control-subtitle">ì„ íƒ ì„¸ê·¸ë¨¼íŠ¸ ìˆ˜ë™ ì¡°ì •</h4>
            <div class="control-row extras">
                <label>Pos X <input type="number" step="1" id="segment-pos-x"></label>
                <label>Pos Y <input type="number" step="1" id="segment-pos-y"></label>
                <label>End X <input type="number" step="1" id="segment-end-pos-x"></label>
                <label>End Y <input type="number" step="1" id="segment-end-pos-y"></label>
                <label>Scale ì‹œì‘ <input type="number" step="0.05" min="0.1" id="segment-scale-start"></label>
                <label>Scale ë <input type="number" step="0.05" min="0.1" id="segment-scale-end"></label>
            </div>
            <h4 class="control-subtitle">ì„ íƒ ì„¸ê·¸ë¨¼íŠ¸ ìë™ ëª¨ì…˜</h4>
            <div class="control-row extras">
                <label><input type="checkbox" id="segment-auto-enabled" checked> ìë™ ëª¨ì…˜</label>
                <label>ëª¨ì…˜ ì¢…ë¥˜
                    <select id="segment-auto-mode">
                        <option value="">ê¸°ë³¸(Ken Burns)</option>
                        <option value="kenburns">Ken Burns</option>
                        <option value="zoom_in">Zoom In</option>
                        <option value="zoom_out">Zoom Out</option>
                        <option value="pan_left">Pan Left</option>
                        <option value="pan_right">Pan Right</option>
                        <option value="pan_up">Pan Up</option>
                        <option value="pan_down">Pan Down</option>
                        <option value="none">ì‚¬ìš© ì•ˆí•¨</option>
                    </select>
                </label>
                <label>ê°•ë„ <input type="number" step="0.01" min="0" max="0.35" id="segment-auto-strength" placeholder="0.12"></label>
                <label>ê¸°ë³¸ ìŠ¤ì¼€ì¼ <input type="number" step="0.01" min="1" id="segment-auto-base" placeholder="1.10"></label>
                <label>ì´ë™ëŸ‰(ë¹„ìœ¨) <input type="number" step="0.01" min="0" max="0.3" id="segment-auto-shift" placeholder="ìë™"></label>
            </div>
            <h4 class="control-subtitle">ìƒˆ ì„¸ê·¸ë¨¼íŠ¸ ìˆ˜ë™ ì¡°ì •</h4>
            <div class="control-row extras">
                <label>ìƒˆ Pos X <input type="number" step="1" id="new-pos-x"></label>
                <label>ìƒˆ Pos Y <input type="number" step="1" id="new-pos-y"></label>
                <label>ìƒˆ End X <input type="number" step="1" id="new-end-pos-x"></label>
                <label>ìƒˆ End Y <input type="number" step="1" id="new-end-pos-y"></label>
                <label>ìƒˆ Scale ì‹œì‘ <input type="number" step="0.05" min="0.1" id="new-scale-start"></label>
                <label>ìƒˆ Scale ë <input type="number" step="0.05" min="0.1" id="new-scale-end"></label>
            </div>
            <h4 class="control-subtitle">ìƒˆ ì„¸ê·¸ë¨¼íŠ¸ ìë™ ëª¨ì…˜</h4>
            <div class="control-row extras">
                <label><input type="checkbox" id="new-auto-enabled" checked> ìë™ ëª¨ì…˜</label>
                <label>ëª¨ì…˜ ì¢…ë¥˜
                    <select id="new-auto-mode">
                        <option value="">ê¸°ë³¸(Ken Burns)</option>
                        <option value="kenburns">Ken Burns</option>
                        <option value="zoom_in">Zoom In</option>
                        <option value="zoom_out">Zoom Out</option>
                        <option value="pan_left">Pan Left</option>
                        <option value="pan_right">Pan Right</option>
                        <option value="pan_up">Pan Up</option>
                        <option value="pan_down">Pan Down</option>
                        <option value="none">ì‚¬ìš© ì•ˆí•¨</option>
                    </select>
                </label>
                <label>ê°•ë„ <input type="number" step="0.01" min="0" max="0.35" id="new-auto-strength" placeholder="0.12"></label>
                <label>ê¸°ë³¸ ìŠ¤ì¼€ì¼ <input type="number" step="0.01" min="1" id="new-auto-base" placeholder="1.10"></label>
                <label>ì´ë™ëŸ‰(ë¹„ìœ¨) <input type="number" step="0.01" min="0" max="0.3" id="new-auto-shift" placeholder="ìë™"></label>
            </div>
        </div>

        <div class="timeline-editor">
            <h3>íƒ€ì„ë¼ì¸ JSON</h3>
            <textarea id="timeline-json">{{ result.metadata.timeline | tojson(indent=2) }}</textarea>
            <button type="button" onclick="updateTimeline('{{ result.metadata.base_name }}')">íƒ€ì„ë¼ì¸ ì €ì¥</button>
        </div>

        <div class="subtitle-editor">
            <h3>ìë§‰ í¸ì§‘</h3>
            <table>
                <thead>
                <tr>
                    <th>Start</th><th>End</th><th>Text</th><th></th>
                </tr>
                </thead>
                <tbody>
                {% for sub in result.metadata.captions %}
                <tr>
                    <td><input type="number" step="0.1" value="{{ '%.1f'|format(sub.start) if sub.start is not none else '' }}" data-sub-id="{{ sub.id }}" data-field="start"></td>
                    <td><input type="number" step="0.1" value="{{ '%.1f'|format(sub.end) if sub.end is not none else '' }}" data-sub-id="{{ sub.id }}" data-field="end"></td>
                    <td><textarea data-sub-id="{{ sub.id }}" data-field="text">{{ sub.text }}</textarea></td>
                    <td>
                        <button type="button" onclick="updateSubtitle('{{ result.metadata.base_name }}', '{{ sub.id }}')">ì €ì¥</button>
                        <button type="button" class="danger" onclick="deleteSubtitle('{{ result.metadata.base_name }}', '{{ sub.id }}')">ì‚­ì œ</button>
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
            <div class="add-subtitle">
                <h4>ìë§‰ ì¶”ê°€</h4>
                <input type="number" step="0.1" id="new-start" placeholder="start">
                <input type="number" step="0.1" id="new-end" placeholder="end">
                <input type="text" id="new-text" placeholder="text">
                <button type="button" onclick="createSubtitle('{{ result.metadata.base_name }}')">ì¶”ê°€</button>
            </div>
        </div>

        <div class="audio-editor">
            <h3>ì˜¤ë””ì˜¤ ì„¤ì •</h3>
            <label><input type="checkbox" id="music-enabled" {% if result.metadata.audio_settings.music_enabled %}checked{% endif %}> ë°°ê²½ìŒ ì‚¬ìš©</label>
            <label>ë³¼ë¥¨ <input type="number" step="0.01" min="0" max="1" id="music-volume" value="{{ result.metadata.audio_settings.music_volume }}"></label>
            <label>ë•í‚¹ <input type="number" step="0.05" min="0" max="1" id="ducking" value="{{ result.metadata.audio_settings.ducking }}"></label>
            <label>ë°°ê²½ìŒ ê²½ë¡œ <input type="text" id="music-track" value="{{ result.metadata.audio_settings.music_track or '' }}" placeholder="assets/music/..."></label>
            <button type="button" onclick="updateAudio('{{ result.metadata.base_name }}')">ì˜¤ë””ì˜¤ ì €ì¥</button>
        </div>

        <div class="subtitle-style">
            <h3>ìë§‰ ìŠ¤íƒ€ì¼</h3>
            <label>í°íŠ¸ í¬ê¸° <input type="number" min="10" max="120" id="subtitle-font-size" placeholder="62"></label>
            <label>Y ì˜¤í”„ì…‹ <input type="number" step="1" id="subtitle-y-offset" placeholder="0"></label>
            <label>ì™¸ê³½ì„  ë‘ê»˜ <input type="number" min="0" max="10" id="subtitle-stroke-width" placeholder="2"></label>
            <label>í°íŠ¸ ê²½ë¡œ <input type="text" id="subtitle-font-path" placeholder="ì˜ˆ: /usr/share/fonts/..." autocomplete="off"></label>
            <label>ë ˆì´ì•„ì›ƒ í…œí”Œë¦¿
                <select id="subtitle-template">
                    <option value="classic">1. ê¸°ë³¸ í…œí”Œë¦¿</option>
                    <option value="banner">2. í•˜ì´ë¼ì´íŠ¸ ë°°ë„ˆ</option>
                </select>
            </label>
            <div id="banner-text-wrapper" class="banner-text-wrapper is-hidden">
                <label>ë°°ë„ˆ ì²« ì¤„ í…ìŠ¤íŠ¸ <input type="text" id="banner-primary-text" placeholder="ì˜ˆ: ëª¨ë‘ë¥¼ ë†€ë¼ê²Œ í•œ" autocomplete="off"></label>
                <label>ë°°ë„ˆ ë‘˜ì§¸ ì¤„ í…ìŠ¤íŠ¸ <input type="text" id="banner-secondary-text" placeholder="ì˜ˆ: ë ˆì „ë“œ ì‹œìƒì‹ ê³µì—°" autocomplete="off"></label>
                <label>ì²« ì¤„ ê¸€ì í¬ê¸° <input type="number" min="10" max="200" id="banner-primary-size" placeholder="ìë™"></label>
                <label>ë‘˜ì§¸ ì¤„ ê¸€ì í¬ê¸° <input type="number" min="10" max="200" id="banner-secondary-size" placeholder="ìë™"></label>
                <label>ë‘ ì¤„ ê°„ê²©(í”½ì…€) <input type="number" step="1" min="-120" max="240" id="banner-line-spacing" placeholder="0"></label>
            </div>
            <label>ì• ë‹ˆë©”ì´ì…˜
                <select id="subtitle-animation">
                    <option value="none">ì—†ìŒ</option>
                    <option value="bounce">ë°”ìš´ìŠ¤</option>
                    <option value="typewriter">íƒ€ì´í•‘</option>
                    <option value="highlight">í•˜ì´ë¼ì´íŠ¸ ë°•ìŠ¤</option>
                    <option value="fire">ë¶ˆê½ƒ í…ìŠ¤íŠ¸</option>
                    <option value="slide_up">ìŠ¬ë¼ì´ë“œ ì—…</option>
                    <option value="slide_down">ìŠ¬ë¼ì´ë“œ ë‹¤ìš´</option>
                    <option value="slide_left">ìŠ¬ë¼ì´ë“œ ì¢Œë°©í–¥</option>
                    <option value="slide_right">ìŠ¬ë¼ì´ë“œ ìš°ë°©í–¥</option>
                </select>
            </label>
            <button type="button" onclick="updateSubtitleStyle('{{ result.metadata.base_name }}')">ìë§‰ ìŠ¤íƒ€ì¼ ì €ì¥</button>
        </div>

        <div class="versions">
            <h3>ë²„ì „ íˆìŠ¤í† ë¦¬</h3>
            <ul id="version-list"></ul>
        </div>

        <div class="actions">
            <label><input type="checkbox" id="burn-render"> ìë§‰ ë²ˆì¸ í›„ ì¬ë Œë”</label>
            <button type="button" onclick="requestRender('{{ result.metadata.base_name }}')">ì¬ë Œë”</button>
            <button type="button" class="danger" onclick="deleteProject('{{ result.metadata.base_name }}')">í”„ë¡œì íŠ¸ ì‚­ì œ</button>
        </div>

        <div id="message"></div>
    </section>
    {% endif %}
</div>

<script>
const messageBox = document.getElementById('message');
function showMessage(text, type = 'info') {
    if (!messageBox) return;
    messageBox.textContent = text;
    messageBox.className = type;
}

function updateBannerVisibility() {
    const wrapper = document.getElementById('banner-text-wrapper');
    const templateSelect = document.getElementById('subtitle-template');
    if (!wrapper) return;
    const shouldShow = !!templateSelect && templateSelect.value === 'banner';
    wrapper.classList.toggle('is-hidden', !shouldShow);
    const primaryInput = document.getElementById('banner-primary-text');
    const secondaryInput = document.getElementById('banner-secondary-text');
    const primarySizeInput = document.getElementById('banner-primary-size');
    const secondarySizeInput = document.getElementById('banner-secondary-size');
    const spacingInput = document.getElementById('banner-line-spacing');
    if (primaryInput) primaryInput.disabled = !shouldShow;
    if (secondaryInput) secondaryInput.disabled = !shouldShow;
    if (primarySizeInput) primarySizeInput.disabled = !shouldShow;
    if (secondarySizeInput) secondarySizeInput.disabled = !shouldShow;
    if (spacingInput) spacingInput.disabled = !shouldShow;
}

{% if result %}
const projectData = {{ result.metadata_json | safe }};
const audioUrl = {{ result.audio_url | tojson }};
const initialVersionHistory = {{ version_history_json | tojson }};
{% else %}
const projectData = null;
const audioUrl = null;
const initialVersionHistory = [];
{% endif %}

let versionHistory = Array.isArray(initialVersionHistory) ? [...initialVersionHistory] : [];
let timelineSegments = projectData ? JSON.parse(JSON.stringify(projectData.timeline || [])) : [];
let selectedSegmentIndex = null;
let wavesurferInstance = null;

const AUTO_DEFAULT_STRENGTH = 0.12;
const AUTO_DEFAULT_BASE_SCALE = 1.1;

function setAutoControls(prefix, extras = {}, fillDefaults = false) {
    const enabledEl = document.getElementById(`${prefix}-auto-enabled`);
    if (enabledEl) enabledEl.checked = extras.auto_motion !== false;

    const modeEl = document.getElementById(`${prefix}-auto-mode`);
    if (modeEl) modeEl.value = extras.auto_motion_mode ?? '';

    const strengthEl = document.getElementById(`${prefix}-auto-strength`);
    if (strengthEl) {
        let value = extras.auto_motion_strength;
        if (value === undefined || value === null || value === '') {
            value = fillDefaults ? AUTO_DEFAULT_STRENGTH : '';
        }
        strengthEl.value = value === '' ? '' : Number(value);
    }

    const baseEl = document.getElementById(`${prefix}-auto-base`);
    if (baseEl) {
        let value = extras.auto_motion_base_scale;
        if (value === undefined || value === null || value === '') {
            value = fillDefaults ? AUTO_DEFAULT_BASE_SCALE : '';
        }
        baseEl.value = value === '' ? '' : Number(value);
    }

    const shiftEl = document.getElementById(`${prefix}-auto-shift`);
    if (shiftEl) {
        let value = extras.auto_motion_shift;
        if (value === undefined || value === null || value === '') {
            value = '';
        }
        shiftEl.value = value === '' ? '' : Number(value);
    }
}

function generateSegmentId() {
    if (window.crypto && typeof window.crypto.randomUUID === 'function') {
        return window.crypto.randomUUID();
    }
    return `seg-${Date.now()}-${Math.floor(Math.random() * 1e6)}`;
}

function ensureNumber(value, fallback = 0) {
    const num = Number(value);
    return Number.isFinite(num) ? num : fallback;
}

function roundToTenths(value) {
    if (!Number.isFinite(value)) return Number.NaN;
    return Math.round(value * 10) / 10;
}

function normalizeTimelineSegments() {
    timelineSegments = (timelineSegments || []).map((seg) => {
        const start = ensureNumber(seg.start, 0);
        const end = ensureNumber(seg.end, start + 0.1);
        const extrasRaw = (seg.extras && typeof seg.extras === 'object') ? { ...seg.extras } : {};
        return {
            id: seg.id || generateSegmentId(),
            media_type: seg.media_type || 'broll',
            source: seg.source ?? 'auto',
            start,
            end: end <= start ? start + 0.1 : end,
            extras: extrasRaw,
        };
    }).sort((a, b) => a.start - b.start);
    if (projectData) {
        projectData.timeline = timelineSegments;
    }
    if (!timelineSegments.length) {
        selectedSegmentIndex = null;
    } else if (selectedSegmentIndex === null || selectedSegmentIndex >= timelineSegments.length) {
        selectedSegmentIndex = 0;
    }
}

function syncTimelineTextarea() {
    const textarea = document.getElementById('timeline-json');
    if (textarea) {
        textarea.value = JSON.stringify(timelineSegments, null, 2);
    }
    if (projectData) {
        projectData.timeline = timelineSegments;
    }
}

function renderTimelineOverlay() {
    const overlay = document.getElementById('timeline-overlay');
    if (!overlay || !projectData) return;
    overlay.innerHTML = '';
    const duration = projectData.duration || 1;
    timelineSegments.forEach((segment, idx) => {
        const bar = document.createElement('div');
        const startPct = (segment.start / duration) * 100;
        const widthPct = Math.max(((segment.end - segment.start) / duration) * 100, 0.5);
        bar.className = 'timeline-segment-bar';
        if (idx === selectedSegmentIndex) {
            bar.classList.add('selected');
        }
        bar.style.left = `${Math.max(0, Math.min(startPct, 100))}%`;
        bar.style.width = `${Math.min(widthPct, 100)}%`;
        bar.title = `${segment.media_type} â€¢ ${segment.source || 'auto'}`;
        bar.onclick = () => selectTimelineSegment(idx, { seek: true });
        overlay.appendChild(bar);
    });
}

function clearSegmentForm() {
    ['segment-id', 'segment-start', 'segment-end', 'segment-source'].forEach((id) => {
        const el = document.getElementById(id);
        if (el) el.value = '';
    });
    const typeSelect = document.getElementById('segment-type');
    if (typeSelect) typeSelect.value = 'broll';
    ['segment-pos-x', 'segment-pos-y', 'segment-end-pos-x', 'segment-end-pos-y', 'segment-scale-start', 'segment-scale-end'].forEach((id) => {
        const el = document.getElementById(id);
        if (el) el.value = '';
    });
    setAutoControls('segment', {}, true);
}

function setSegmentForm(segment) {
    document.getElementById('segment-id').value = segment.id || '';
    document.getElementById('segment-start').value = segment.start ?? 0;
    document.getElementById('segment-end').value = segment.end ?? segment.start + 0.1;
    document.getElementById('segment-source').value = segment.source || 'auto';
    document.getElementById('segment-type').value = segment.media_type || 'broll';
    const extras = segment.extras || {};
    const pos = Array.isArray(extras.position) ? extras.position : null;
    document.getElementById('segment-pos-x').value = pos ? pos[0] : '';
    document.getElementById('segment-pos-y').value = pos ? pos[1] : '';
    const endPos = Array.isArray(extras.position_end) ? extras.position_end : null;
    document.getElementById('segment-end-pos-x').value = endPos ? endPos[0] : '';
    document.getElementById('segment-end-pos-y').value = endPos ? endPos[1] : '';
    document.getElementById('segment-scale-start').value = extras.scale_start ?? '';
    document.getElementById('segment-scale-end').value = extras.scale_end ?? '';
    setAutoControls('segment', extras, true);
}

function selectTimelineSegment(index, options = {}) {
    if (!timelineSegments[index]) return;
    const { seek = true } = options;
    selectedSegmentIndex = index;
    const segment = timelineSegments[index];
    setSegmentForm(segment);
    renderTimelineOverlay();
    if (seek && wavesurferInstance && projectData?.duration) {
        const duration = projectData.duration || 1;
        const ratio = Math.min(Math.max(segment.start / duration, 0), 1);
        wavesurferInstance.seekTo(ratio);
    }
}

function applyTimelineEdit(baseName) {
    if (selectedSegmentIndex === null) {
        showMessage('í¸ì§‘í•  ì„¸ê·¸ë¨¼íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”.', 'error');
        return;
    }
    const segment = timelineSegments[selectedSegmentIndex];
    const start = ensureNumber(document.getElementById('segment-start').value, segment.start);
    const end = ensureNumber(document.getElementById('segment-end').value, segment.end);
    segment.id = document.getElementById('segment-id').value || segment.id || generateSegmentId();
   segment.start = start;
   segment.end = end <= start ? start + 0.1 : end;
    segment.source = document.getElementById('segment-source').value || 'auto';
    segment.media_type = document.getElementById('segment-type').value || 'broll';
    segment.extras = segment.extras || {};
    const extras = segment.extras;

    const autoEnabledEl = document.getElementById('segment-auto-enabled');
    const autoEnabled = autoEnabledEl ? autoEnabledEl.checked : true;
    if (!autoEnabled) {
        extras.auto_motion = false;
    } else {
        delete extras.auto_motion;
    }
    const autoModeVal = document.getElementById('segment-auto-mode').value;
    if (autoModeVal) {
        extras.auto_motion_mode = autoModeVal;
    } else {
        delete extras.auto_motion_mode;
    }
    const autoStrengthVal = parseFloat(document.getElementById('segment-auto-strength').value);
    if (!Number.isNaN(autoStrengthVal)) {
        extras.auto_motion_strength = autoStrengthVal;
    } else {
        delete extras.auto_motion_strength;
    }
    const autoBaseVal = parseFloat(document.getElementById('segment-auto-base').value);
    if (!Number.isNaN(autoBaseVal)) {
        extras.auto_motion_base_scale = autoBaseVal;
    } else {
        delete extras.auto_motion_base_scale;
    }
    const autoShiftVal = parseFloat(document.getElementById('segment-auto-shift').value);
    if (!Number.isNaN(autoShiftVal)) {
        extras.auto_motion_shift = autoShiftVal;
    } else {
        delete extras.auto_motion_shift;
    }

    const posX = parseFloat(document.getElementById('segment-pos-x').value);
    const posY = parseFloat(document.getElementById('segment-pos-y').value);
    if (!Number.isNaN(posX) && !Number.isNaN(posY)) {
        extras.position = [posX, posY];
    } else {
        delete extras.position;
    }

    const endPosX = parseFloat(document.getElementById('segment-end-pos-x').value);
    const endPosY = parseFloat(document.getElementById('segment-end-pos-y').value);
    if (!Number.isNaN(endPosX) && !Number.isNaN(endPosY)) {
        extras.position_end = [endPosX, endPosY];
    } else {
        delete extras.position_end;
    }

    const scaleStartVal = parseFloat(document.getElementById('segment-scale-start').value);
    const scaleEndVal = parseFloat(document.getElementById('segment-scale-end').value);
    if (!Number.isNaN(scaleStartVal)) {
        extras.scale_start = scaleStartVal;
    } else {
        delete extras.scale_start;
    }
    if (!Number.isNaN(scaleEndVal)) {
        extras.scale_end = scaleEndVal;
    } else {
        delete extras.scale_end;
    }

    timelineSegments.sort((a, b) => a.start - b.start);
    selectedSegmentIndex = timelineSegments.findIndex((seg) => seg.id === segment.id);
    syncTimelineTextarea();
    renderTimelineOverlay();
    showMessage('ì„¸ê·¸ë¨¼íŠ¸ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤. ì €ì¥ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë°˜ì˜í•˜ì„¸ìš”.', 'info');
}

function addTimelineSegment() {
    const start = ensureNumber(document.getElementById('new-segment-start').value, 0);
    const end = ensureNumber(document.getElementById('new-segment-end').value, start + 0.1);
    const source = document.getElementById('new-segment-source').value || 'auto';
    const mediaType = document.getElementById('new-segment-type').value || 'broll';
    const posX = parseFloat(document.getElementById('new-pos-x').value);
    const posY = parseFloat(document.getElementById('new-pos-y').value);
    const endPosX = parseFloat(document.getElementById('new-end-pos-x').value);
    const endPosY = parseFloat(document.getElementById('new-end-pos-y').value);
    const scaleStartVal = parseFloat(document.getElementById('new-scale-start').value);
    const scaleEndVal = parseFloat(document.getElementById('new-scale-end').value);
    const newAutoEnabledEl = document.getElementById('new-auto-enabled');
    const newAutoEnabled = newAutoEnabledEl ? newAutoEnabledEl.checked : true;
    const newAutoMode = document.getElementById('new-auto-mode').value;
    const newAutoStrength = parseFloat(document.getElementById('new-auto-strength').value);
    const newAutoBase = parseFloat(document.getElementById('new-auto-base').value);
    const newAutoShift = parseFloat(document.getElementById('new-auto-shift').value);

    const newSegment = {
        id: generateSegmentId(),
        media_type: mediaType,
        source,
        start,
        end: end <= start ? start + 0.1 : end,
        extras: {},
    };
    if (!newAutoEnabled) {
        newSegment.extras.auto_motion = false;
    }
    if (newAutoMode) {
        newSegment.extras.auto_motion_mode = newAutoMode;
    }
    if (!Number.isNaN(newAutoStrength)) {
        newSegment.extras.auto_motion_strength = newAutoStrength;
    }
    if (!Number.isNaN(newAutoBase)) {
        newSegment.extras.auto_motion_base_scale = newAutoBase;
    }
    if (!Number.isNaN(newAutoShift)) {
        newSegment.extras.auto_motion_shift = newAutoShift;
    }
    if (!Number.isNaN(posX) && !Number.isNaN(posY)) {
        newSegment.extras.position = [posX, posY];
    }
    if (!Number.isNaN(endPosX) && !Number.isNaN(endPosY)) {
        newSegment.extras.position_end = [endPosX, endPosY];
    }
    if (!Number.isNaN(scaleStartVal)) {
        newSegment.extras.scale_start = scaleStartVal;
    }
    if (!Number.isNaN(scaleEndVal)) {
        newSegment.extras.scale_end = scaleEndVal;
    }
    timelineSegments.push(newSegment);
    timelineSegments.sort((a, b) => a.start - b.start);
    selectedSegmentIndex = timelineSegments.findIndex((seg) => seg.id === newSegment.id);
    syncTimelineTextarea();
    renderTimelineOverlay();
    setSegmentForm(newSegment);
    document.getElementById('new-segment-start').value = '';
    document.getElementById('new-segment-end').value = '';
    document.getElementById('new-segment-source').value = '';
    document.getElementById('new-segment-type').value = 'broll';
    ['new-pos-x', 'new-pos-y', 'new-end-pos-x', 'new-end-pos-y', 'new-scale-start', 'new-scale-end'].forEach((id) => {
        const el = document.getElementById(id);
        if (el) el.value = '';
    });
    setAutoControls('new', {}, true);
    showMessage('ì„¸ê·¸ë¨¼íŠ¸ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤. ì €ì¥ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë°˜ì˜í•˜ì„¸ìš”.', 'success');
}

function removeTimelineSegment() {
    if (selectedSegmentIndex === null) {
        showMessage('ì‚­ì œí•  ì„¸ê·¸ë¨¼íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”.', 'error');
        return;
    }
    timelineSegments.splice(selectedSegmentIndex, 1);
    if (!timelineSegments.length) {
        selectedSegmentIndex = null;
        clearSegmentForm();
    } else {
        selectedSegmentIndex = Math.min(selectedSegmentIndex, timelineSegments.length - 1);
        setSegmentForm(timelineSegments[selectedSegmentIndex]);
    }
    syncTimelineTextarea();
    renderTimelineOverlay();
    showMessage('ì„¸ê·¸ë¨¼íŠ¸ê°€ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤. ì €ì¥ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë°˜ì˜í•˜ì„¸ìš”.', 'info');
}

async function updateTimeline(baseName) {
    const textarea = document.getElementById('timeline-json');
    if (!textarea) return;
    try {
        const parsed = JSON.parse(textarea.value || '[]');
        timelineSegments = Array.isArray(parsed) ? parsed : [];
    } catch (err) {
        showMessage('ìœ íš¨í•œ JSON í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.', 'error');
        return;
    }
    normalizeTimelineSegments();
    const res = await fetch(`/api/projects/${baseName}/timeline`, {
        method: 'PATCH',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ segments: timelineSegments })
    });
    if (res.ok) {
        showMessage('íƒ€ì„ë¼ì¸ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        setTimeout(() => window.location.reload(), 600);
    } else {
        const data = await res.json();
        showMessage(data.detail || 'íƒ€ì„ë¼ì¸ ì €ì¥ ì‹¤íŒ¨', 'error');
    }
}

async function updateSubtitle(baseName, subtitleId) {
    const startInput = document.querySelector(`[data-sub-id="${subtitleId}"][data-field="start"]`);
    const endInput = document.querySelector(`[data-sub-id="${subtitleId}"][data-field="end"]`);
    const textInput = document.querySelector(`[data-sub-id="${subtitleId}"][data-field="text"]`);
    if (!startInput || !endInput || !textInput) return;

    const startValue = roundToTenths(parseFloat(startInput.value));
    const endValue = roundToTenths(parseFloat(endInput.value));
    if (Number.isNaN(startValue) || Number.isNaN(endValue)) {
        showMessage('start/end ê°’ì„ í™•ì¸í•´ì£¼ì„¸ìš”. ì˜ˆ: 12.3', 'error');
        return;
    }
    startInput.value = startValue.toFixed(1);
    endInput.value = endValue.toFixed(1);

    const payload = {
        start: startValue,
        end: endValue,
        text: textInput.value
    };

    const res = await fetch(`/api/projects/${baseName}/subtitles/${subtitleId}`, {
        method: 'PATCH',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
    });
    if (res.ok) {
        showMessage('ìë§‰ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        setTimeout(() => window.location.reload(), 500);
    } else {
        const data = await res.json();
        showMessage(data.detail || 'ìë§‰ ì €ì¥ ì‹¤íŒ¨', 'error');
    }
}

async function deleteSubtitle(baseName, subtitleId) {
    if (!confirm('ì„ íƒí•œ ìë§‰ì„ ì‚­ì œí• ê¹Œìš”?')) return;
    const res = await fetch(`/api/projects/${baseName}/subtitles/${subtitleId}`, { method: 'DELETE' });
    if (res.ok) {
        showMessage('ìë§‰ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        setTimeout(() => window.location.reload(), 500);
    } else {
        const data = await res.json();
        showMessage(data.detail || 'ìë§‰ ì‚­ì œ ì‹¤íŒ¨', 'error');
    }
}

async function createSubtitle(baseName) {
    const start = roundToTenths(parseFloat(document.getElementById('new-start').value));
    const end = roundToTenths(parseFloat(document.getElementById('new-end').value));
    const text = document.getElementById('new-text').value;
    if (Number.isNaN(start) || Number.isNaN(end) || !text) {
        showMessage('start, end, textë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
        return;
    }
    document.getElementById('new-start').value = start.toFixed(1);
    document.getElementById('new-end').value = end.toFixed(1);
    const res = await fetch(`/api/projects/${baseName}/subtitles`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ start, end, text })
    });
    if (res.ok) {
        showMessage('ìë§‰ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        setTimeout(() => window.location.reload(), 500);
    } else {
        const data = await res.json();
        showMessage(data.detail || 'ìë§‰ ì¶”ê°€ ì‹¤íŒ¨', 'error');
    }
}

async function updateAudio(baseName) {
    const enabled = document.getElementById('music-enabled').checked;
    const volume = parseFloat(document.getElementById('music-volume').value);
    const ducking = parseFloat(document.getElementById('ducking').value);
    const track = document.getElementById('music-track').value;

    const res = await fetch(`/api/projects/${baseName}/audio`, {
        method: 'PATCH',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            music_enabled: enabled,
            music_volume: volume,
            ducking,
            music_track: track || null
        })
    });
    if (res.ok) {
        showMessage('ì˜¤ë””ì˜¤ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        setTimeout(() => window.location.reload(), 600);
    } else {
        const data = await res.json();
        showMessage(data.detail || 'ì˜¤ë””ì˜¤ ì €ì¥ ì‹¤íŒ¨', 'error');
    }
}

async function updateSubtitleStyle(baseName) {
    const fontSize = parseInt(document.getElementById('subtitle-font-size').value, 10);
    const yOffset = parseInt(document.getElementById('subtitle-y-offset').value, 10);
    const strokeWidth = parseInt(document.getElementById('subtitle-stroke-width').value, 10);
    const fontPathInput = document.getElementById('subtitle-font-path');
    const animationSelect = document.getElementById('subtitle-animation');
    const templateSelect = document.getElementById('subtitle-template');
    const bannerPrimaryInput = document.getElementById('banner-primary-text');
    const bannerSecondaryInput = document.getElementById('banner-secondary-text');
    const bannerPrimarySizeInput = document.getElementById('banner-primary-size');
    const bannerSecondarySizeInput = document.getElementById('banner-secondary-size');
    const bannerLineSpacingInput = document.getElementById('banner-line-spacing');

    const payload = {};
    if (!Number.isNaN(fontSize)) payload.font_size = fontSize;
    if (!Number.isNaN(yOffset)) payload.y_offset = yOffset;
    if (!Number.isNaN(strokeWidth)) payload.stroke_width = strokeWidth;
    if (fontPathInput) {
        const currentValue = fontPathInput.value.trim();
        const initialValue = fontPathInput.dataset.initial ?? '';
        if (currentValue !== initialValue) {
            payload.font_path = currentValue || null;
        }
    }
    if (animationSelect) {
        const currentAnimation = (animationSelect.value || 'none');
        const initialAnimation = animationSelect.dataset.initial ?? 'none';
        if (currentAnimation !== initialAnimation) {
            payload.animation = currentAnimation;
        }
    }
    if (templateSelect) {
        const currentTemplate = (templateSelect.value || 'classic');
        const initialTemplate = templateSelect.dataset.initial ?? 'classic';
        if (currentTemplate !== initialTemplate) {
            payload.template = currentTemplate;
        }
    }
    if (bannerPrimaryInput) {
        const currentPrimary = bannerPrimaryInput.value.trim();
        const initialPrimary = bannerPrimaryInput.dataset.initial ?? '';
        if (currentPrimary !== initialPrimary) {
            payload.banner_primary_text = currentPrimary;
        }
    }
    if (bannerSecondaryInput) {
        const currentSecondary = bannerSecondaryInput.value.trim();
        const initialSecondary = bannerSecondaryInput.dataset.initial ?? '';
        if (currentSecondary !== initialSecondary) {
            payload.banner_secondary_text = currentSecondary;
        }
    }
    if (bannerPrimarySizeInput) {
        const currentPrimarySize = bannerPrimarySizeInput.value.trim();
        const initialPrimarySize = bannerPrimarySizeInput.dataset.initial ?? '';
        if (currentPrimarySize !== initialPrimarySize) {
            payload.banner_primary_font_size = currentPrimarySize ? parseInt(currentPrimarySize, 10) : null;
        }
    }
    if (bannerSecondarySizeInput) {
        const currentSecondarySize = bannerSecondarySizeInput.value.trim();
        const initialSecondarySize = bannerSecondarySizeInput.dataset.initial ?? '';
        if (currentSecondarySize !== initialSecondarySize) {
            payload.banner_secondary_font_size = currentSecondarySize ? parseInt(currentSecondarySize, 10) : null;
        }
    }
    if (bannerLineSpacingInput) {
        const currentSpacing = bannerLineSpacingInput.value.trim();
        const initialSpacing = bannerLineSpacingInput.dataset.initial ?? '';
        if (currentSpacing !== initialSpacing) {
            payload.banner_line_spacing = currentSpacing ? parseInt(currentSpacing, 10) : null;
        }
    }

    const res = await fetch(`/api/projects/${baseName}/subtitle-style`, {
        method: 'PATCH',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload),
    });
    if (res.ok) {
        showMessage('ìë§‰ ìŠ¤íƒ€ì¼ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        setTimeout(() => window.location.reload(), 600);
    } else {
        const data = await res.json();
        showMessage(data.detail || 'ìë§‰ ìŠ¤íƒ€ì¼ ì €ì¥ ì‹¤íŒ¨', 'error');
    }
}

async function deleteProject(baseName) {
    if (!confirm('í”„ë¡œì íŠ¸ì˜ ëª¨ë“  íŒŒì¼ì„ ì‚­ì œí• ê¹Œìš”?')) return;
    const res = await fetch(`/api/projects/${baseName}`, { method: 'DELETE' });
    if (res.status === 204) {
        showMessage('í”„ë¡œì íŠ¸ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        setTimeout(() => window.location.href = '/', 500);
    } else {
        const data = await res.json();
        showMessage(data.detail || 'ì‚­ì œ ì‹¤íŒ¨', 'error');
    }
}

async function requestRender(baseName) {
    const burn = document.getElementById('burn-render')?.checked || false;
    showMessage('ì¬ë Œë”ë§ì„ ì‹œì‘í•©ë‹ˆë‹¤...', 'info');
    const res = await fetch(`/api/projects/${baseName}/render`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ burn_subs: burn })
    });
    if (res.ok) {
        showMessage('ì¬ë Œë”ë§ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        setTimeout(() => window.location.reload(), 800);
    } else {
        const data = await res.json();
        showMessage(data.detail || 'ì¬ë Œë”ë§ ì‹¤íŒ¨', 'error');
    }
}

function renderVersionList(list) {
    const container = document.getElementById('version-list');
    if (!container) return;
    container.innerHTML = '';
    if (!list.length) {
        const li = document.createElement('li');
        li.textContent = 'ì €ì¥ëœ ë²„ì „ì´ ì—†ìŠµë‹ˆë‹¤.';
        container.appendChild(li);
        return;
    }
    list
        .slice()
        .sort((a, b) => (b.version || 0) - (a.version || 0))
        .forEach((item) => {
            const li = document.createElement('li');
            const dateLabel = item.updated_at ? ` (${item.updated_at})` : '';
            const button = document.createElement('button');
            button.type = 'button';
            button.textContent = 'ë³µì›';
            button.onclick = () => restoreVersion(projectData.base_name, item.version);
            li.textContent = `v${item.version}${dateLabel} `;
            li.appendChild(button);
            container.appendChild(li);
        });
}

async function refreshVersionHistory(baseName) {
    const res = await fetch(`/api/projects/${baseName}/versions`);
    if (res.ok) {
        versionHistory = await res.json();
        renderVersionList(versionHistory);
    }
}

async function restoreVersion(baseName, version) {
    if (!confirm(`v${version} ë²„ì „ìœ¼ë¡œ ë³µì›í• ê¹Œìš”? í˜„ì¬ ìƒíƒœëŠ” ìƒˆ ë²„ì „ìœ¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤.`)) return;
    const res = await fetch(`/api/projects/${baseName}/versions/${version}/restore`, { method: 'POST' });
    if (res.ok) {
        showMessage('ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        setTimeout(() => window.location.reload(), 700);
    } else {
        const data = await res.json();
        showMessage(data.detail || 'ë³µì› ì‹¤íŒ¨', 'error');
    }
}

function wavePlay() {
    if (wavesurferInstance) {
        wavesurferInstance.play();
    }
}

function wavePause() {
    if (wavesurferInstance) {
        wavesurferInstance.pause();
    }
}

function updateCurrentTimeDisplay(time) {
    const label = document.getElementById('current-time');
    if (!label) return;
    const safeTime = Number.isFinite(time) ? time : 0;
    label.textContent = `${safeTime.toFixed(2)}s`;
}

function findSegmentIndexByTime(time) {
    return timelineSegments.findIndex((segment) => time >= segment.start && time <= segment.end + 0.05);
}

function maybeSelectSegmentByTime(time) {
    if (!timelineSegments.length) return;
    const idx = findSegmentIndexByTime(time);
    if (idx !== -1 && idx !== selectedSegmentIndex) {
        selectTimelineSegment(idx, { seek: false });
    }
}

function initWaveform() {
    if (!projectData || !audioUrl || !document.getElementById('waveform')) return;
    wavesurferInstance = WaveSurfer.create({
        container: '#waveform',
        waveColor: '#4bd4ff',
        progressColor: '#5b7fff',
        cursorColor: '#ffd166',
        height: 96,
    });
    wavesurferInstance.load(audioUrl);
    wavesurferInstance.on('ready', () => {
        updateCurrentTimeDisplay(0);
        renderTimelineOverlay();
    });
    wavesurferInstance.on('audioprocess', (time) => {
        const current = Number.isFinite(time) ? time : wavesurferInstance.getCurrentTime();
        updateCurrentTimeDisplay(current);
        maybeSelectSegmentByTime(current);
    });
    wavesurferInstance.on('seek', () => {
        const current = wavesurferInstance.getCurrentTime();
        updateCurrentTimeDisplay(current);
        maybeSelectSegmentByTime(current);
    });
}

function addInitialVersionList() {
    renderVersionList(versionHistory);
}

window.addEventListener('DOMContentLoaded', () => {
    if (projectData) {
        normalizeTimelineSegments();
        syncTimelineTextarea();
        renderTimelineOverlay();
        if (timelineSegments.length) {
            selectTimelineSegment(selectedSegmentIndex ?? 0, { seek: false });
        } else {
            clearSegmentForm();
        }
        setAutoControls('new', {}, true);
        const style = projectData.subtitle_style || {};
        const fontSizeInput = document.getElementById('subtitle-font-size');
        const yOffsetInput = document.getElementById('subtitle-y-offset');
        const strokeWidthInput = document.getElementById('subtitle-stroke-width');
        const fontPathInput = document.getElementById('subtitle-font-path');
        const animationSelect = document.getElementById('subtitle-animation');
        const templateSelect = document.getElementById('subtitle-template');
        const bannerPrimaryInput = document.getElementById('banner-primary-text');
        const bannerSecondaryInput = document.getElementById('banner-secondary-text');
        const bannerPrimarySizeInput = document.getElementById('banner-primary-size');
        const bannerSecondarySizeInput = document.getElementById('banner-secondary-size');
        const bannerLineSpacingInput = document.getElementById('banner-line-spacing');
        if (fontSizeInput) fontSizeInput.value = style.font_size ?? 62;
        if (yOffsetInput) yOffsetInput.value = style.y_offset ?? 0;
        if (strokeWidthInput) strokeWidthInput.value = style.stroke_width ?? 2;
        if (fontPathInput) {
            const currentFontPath = style.font_path ?? '';
            fontPathInput.value = currentFontPath;
            fontPathInput.dataset.initial = currentFontPath;
        }
        if (animationSelect) {
            const animationValue = style.animation ?? 'none';
            animationSelect.value = animationValue;
            animationSelect.dataset.initial = animationValue;
        }
        if (templateSelect) {
            const templateValue = (style.template ?? 'classic').toLowerCase();
            templateSelect.value = templateValue;
            templateSelect.dataset.initial = templateValue;
            templateSelect.addEventListener('change', updateBannerVisibility);
        }
        if (bannerPrimaryInput) {
            const primaryText = style.banner_primary_text ?? '';
            bannerPrimaryInput.value = primaryText;
            bannerPrimaryInput.dataset.initial = primaryText;
        }
        if (bannerSecondaryInput) {
            const secondaryText = style.banner_secondary_text ?? '';
            bannerSecondaryInput.value = secondaryText;
            bannerSecondaryInput.dataset.initial = secondaryText;
        }
        if (bannerPrimarySizeInput) {
            const primarySize = style.banner_primary_font_size;
            const primarySizeValue = primarySize ?? '';
            bannerPrimarySizeInput.value = primarySizeValue;
            bannerPrimarySizeInput.dataset.initial = primarySizeValue === '' ? '' : String(primarySizeValue);
        }
        if (bannerSecondarySizeInput) {
            const secondarySize = style.banner_secondary_font_size;
            const secondarySizeValue = secondarySize ?? '';
            bannerSecondarySizeInput.value = secondarySizeValue;
            bannerSecondarySizeInput.dataset.initial = secondarySizeValue === '' ? '' : String(secondarySizeValue);
        }
        if (bannerLineSpacingInput) {
            const spacingValue = style.banner_line_spacing;
            const spacingString = spacingValue ?? '';
            bannerLineSpacingInput.value = spacingString;
            bannerLineSpacingInput.dataset.initial = spacingString === '' ? '' : String(spacingString);
        }
        updateBannerVisibility();
        addInitialVersionList();
        refreshVersionHistory(projectData.base_name);
        initWaveform();
    } else {
        renderVersionList([]);
        [['subtitle-font-size', 62], ['subtitle-y-offset', 0], ['subtitle-stroke-width', 2]].forEach(([id, defaultVal]) => {
            const el = document.getElementById(id);
            if (!el) return;
            el.value = defaultVal;
        });
        const fontPathInput = document.getElementById('subtitle-font-path');
        if (fontPathInput) {
            fontPathInput.value = '';
            fontPathInput.dataset.initial = '';
        }
        const animationSelect = document.getElementById('subtitle-animation');
        if (animationSelect) {
            animationSelect.value = 'none';
            animationSelect.dataset.initial = 'none';
        }
        const templateSelect = document.getElementById('subtitle-template');
        if (templateSelect) {
            templateSelect.value = 'classic';
            templateSelect.dataset.initial = 'classic';
            templateSelect.addEventListener('change', updateBannerVisibility);
        }
        const bannerPrimaryInput = document.getElementById('banner-primary-text');
        const bannerSecondaryInput = document.getElementById('banner-secondary-text');
        const bannerPrimarySizeInput = document.getElementById('banner-primary-size');
        const bannerSecondarySizeInput = document.getElementById('banner-secondary-size');
        const bannerLineSpacingInput = document.getElementById('banner-line-spacing');
        if (bannerPrimaryInput) {
            bannerPrimaryInput.value = '';
            bannerPrimaryInput.dataset.initial = '';
        }
        if (bannerSecondaryInput) {
            bannerSecondaryInput.value = '';
            bannerSecondaryInput.dataset.initial = '';
        }
        if (bannerPrimarySizeInput) {
            bannerPrimarySizeInput.value = '';
            bannerPrimarySizeInput.dataset.initial = '';
        }
        if (bannerSecondarySizeInput) {
            bannerSecondarySizeInput.value = '';
            bannerSecondarySizeInput.dataset.initial = '';
        }
        if (bannerLineSpacingInput) {
            bannerLineSpacingInput.value = '';
            bannerLineSpacingInput.dataset.initial = '';
        }
        updateBannerVisibility();
        setAutoControls('segment', {}, true);
        setAutoControls('new', {}, true);
    }
});
</script>
</body>
</html>
